<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITIVIA - Enterprise Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-body-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); 
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --blur-amount: 20px;
            --sidebar-bg: rgba(13, 27, 42, 0.90); 
            --sidebar-active: rgba(52, 152, 219, 0.4); 
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --text-header: #ffffff;
            --primary: #3498db; 
            --primary-hover: #2980b9;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --info: #9b59b6;
        }

        html[dir="rtl"] { --sidebar-width: 270px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body-gradient); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

        /* --- LAYOUT & COMPONENTS --- */
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body-gradient); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .auth-card { background: rgba(13, 27, 42, 0.6); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); padding: 40px; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* Logo Update */
        .auth-logo { height: 80px; margin-bottom: 20px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(52,152,219,0.3)); }
        
        .auth-title { font-size: 1.8rem; font-weight: 700; color: white; margin-bottom: 10px; }
        .auth-subtitle { color: var(--text-muted); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white; outline: none; transition: 0.3s; }
        .form-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .social-divider { display: flex; align-items: center; margin: 25px 0; color: var(--text-muted); font-size: 0.8rem; }
        .social-divider::before, .social-divider::after { content: ""; flex: 1; height: 1px; background: var(--glass-border); margin: 0 10px; }
        .social-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .social-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: white; cursor: pointer; transition: 0.3s; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .social-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .toggle-link { color: var(--primary); cursor: pointer; margin-top: 20px; display: inline-block; font-size: 0.9rem; }
        .toggle-link:hover { text-decoration: underline; }
        .hidden { display: none !important; }
        
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; }
        #app-container.loaded { opacity: 1; }
        .sidebar { width: 270px; background: var(--sidebar-bg); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; transition: all 0.3s; flex-shrink: 0; height: 100vh; z-index: 1000; }
        html[dir="rtl"] .sidebar { border-right: none; border-left: 1px solid var(--glass-border); }
        /* Logo Area Update */
        .logo-area { height: 100px; display: flex; align-items: center; padding: 0 25px; border-bottom: 1px solid var(--glass-border); }
        .logo-area img { width: 100%; height: 60px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,255,255,0.1)); }
        
        #nav-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding-top: 15px; }
        .nav-header { padding: 20px 30px 10px 30px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); font-weight: 700; }
        .nav-links { list-style: none; padding: 0 15px; margin-bottom: 15px; }
        .nav-item { padding: 14px 15px; margin-bottom: 6px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; transition: all 0.25s ease; color: var(--text-muted); font-weight: 500; border: 1px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: var(--text-header); transform: translateX(5px); }
        .nav-item.active { background: var(--sidebar-active); color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item i { width: 25px; margin-right: 10px; text-align: center; font-size: 1.1em; }
        html[dir="rtl"] .nav-item i { margin-right: 0; margin-left: 10px; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 80px; background: rgba(13, 27, 42, 0.4); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .branding-logos { display: flex; align-items: center; gap: 15px; margin-left: 20px; padding-left: 20px; border-left: 1px solid var(--glass-border); }
        html[dir="rtl"] .branding-logos { margin-left: 0; padding-left: 0; margin-right: 20px; padding-right: 20px; border-left: none; border-right: 1px solid var(--glass-border); }
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .icon-btn { cursor: pointer; color: var(--text-main); font-size: 1.2rem; position: relative; transition: 0.2s; }
        .icon-btn:hover { color: var(--primary); transform: scale(1.1); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: #fff; font-size: 0.6rem; padding: 2px 5px; border-radius: 50%; border: 1px solid var(--bg-body-gradient); }
        .dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: 500; color: var(--text-header); }
        .dropdown img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .content-scroll { flex-grow: 1; overflow-y: auto; padding: 30px; }
        .page-title { margin-bottom: 30px; font-size: 2rem; font-weight: 700; color: var(--text-header); display: flex; justify-content: space-between; align-items: center; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .card { background: var(--glass-bg); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-radius: 16px; padding: 25px; box-shadow: var(--glass-shadow); border: 1px solid var(--glass-border); height: 100%; transition: transform 0.3s ease, box-shadow 0.3s ease; color: var(--text-main); display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); border-color: rgba(255,255,255,0.25); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .card-title { font-weight: 700; color: var(--text-header); font-size: 1.1rem; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(41, 128, 185, 0.4); transition: all 0.2s; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(41, 128, 185, 0.6); }
        .btn-outline { background-color: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .btn-outline:hover { background-color: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: #fff; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 25px; align-items: stretch; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--glass-border); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: var(--text-header); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .table-input { background: transparent; border: 1px solid transparent; color: white; padding: 5px; border-radius: 4px; width: 100%; transition: 0.2s; }
        .table-input:hover { border-color: var(--glass-border); background: rgba(0,0,0,0.2); }
        .table-input:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); outline: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: rgba(46, 204, 113, 0.9); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; backdrop-filter: blur(5px); }
        .toast.show { transform: translateY(0); }
        
        /* New: Settings Inputs */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 20px; }
        .settings-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        @media (max-width: 1200px) { .dashboard-grid, .settings-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .sidebar { position: absolute; left: -270px; height: 100%; z-index: 2000; background: rgba(13, 27, 42, 0.98); } .sidebar.active { left: 0; box-shadow: 50px 0 100px rgba(0,0,0,0.5); } html[dir="rtl"] .sidebar { left: auto; right: -270px; } html[dir="rtl"] .sidebar.active { right: 0; } .branding-logos { display: none; } }

        /* PAYROLL LAYOUT */
        .payroll-layout { display: flex; height: calc(100vh - 140px); gap: 20px; }
        .payroll-sidebar { width: 300px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; overflow-y: auto; padding-right: 5px; }
        .payroll-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .history-item { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: rgba(255,255,255,0.1); }
        .history-item.active { background: var(--sidebar-active); border-color: var(--primary); }
        .history-date { font-weight: 700; color: #fff; margin-bottom: 5px; }
        .history-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        .history-badge { font-size: 0.7rem; background: var(--success); color: #fff; padding: 2px 6px; border-radius: 4px; }
        
        /* New: Dynamic Details */
        .details-json { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .details-btn { font-size: 0.75rem; cursor: pointer; color: var(--primary); margin-left: 10px; }

        /* New: Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-card { background: rgba(13, 27, 42, 0.95); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .close-modal { float: right; cursor: pointer; color: var(--text-muted); }
        .close-modal:hover { color: white; }

        /* --- ATS KANBAN STYLES --- */
        .ats-layout { display: flex; gap: 20px; height: calc(100vh - 160px); overflow-x: auto; padding-bottom: 20px; }
        
        /* UPDATED: Sidebar for Jobs */
        .ats-sidebar { width: 250px; background: rgba(255,255,255,0.03); border-right: 1px solid var(--glass-border); padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .ats-main-board { flex-grow: 1; display: flex; gap: 20px; overflow-x: auto; padding: 10px; }
        
        .ats-job-item { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .ats-job-item:hover { background: rgba(255,255,255,0.1); }
        .ats-job-item.active { border-color: var(--primary); background: rgba(52,152,219,0.1); }
        .ats-job-title { font-weight: 600; color: white; font-size: 0.9rem; }
        .ats-job-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; margin-top: 5px; }

        .ats-column { flex: 0 0 300px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; }
        .ats-col-header { padding: 15px; font-weight: 700; color: var(--text-header); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .ats-count { background: var(--glass-bg); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; color: var(--text-muted); }
        .ats-cards { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .ats-card { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 15px; border-radius: 8px; cursor: grab; transition: 0.2s; position: relative; }
        .ats-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ats-name { font-weight: 600; color: white; margin-bottom: 5px; }
        .ats-role { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; }
        .ats-actions { display: flex; justify-content: flex-end; gap: 5px; }
        .ats-btn-hire { font-size: 0.75rem; background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* --- PERFORMANCE STYLES --- */
        .perf-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .perf-high { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.4); }
        .perf-mid { background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.4); }
        .perf-low { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.4); }
        .score-card { text-align: center; padding: 15px; border: 1px solid var(--glass-border); border-radius: 10px; background: rgba(255,255,255,0.03); }
        .score-val { font-size: 1.8rem; font-weight: 700; margin: 10px 0; }
        .cycle-switch { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px; border: 1px solid var(--glass-border); }
        .cycle-btn { padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); border: none; background: transparent; transition: 0.2s; }
        .cycle-btn.active { background: var(--primary); color: white; }

        /* ADDED: Styles for Weekday Selector in Settings Modal */
        .day-selector { display: flex; gap: 5px; margin-top: 5px; }
        .day-check { display: none; }
        .day-label { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .day-check:checked + .day-label { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-card" id="login-card">
            <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA" class="auth-logo">
            <div class="auth-title">Enterprise Access</div>
            <div class="auth-subtitle">Secure Login to Digitivia Operations</div>
            <div class="form-group"><label>Email Address</label><input type="email" id="login-email" class="form-input" placeholder="name@company.com"></div>
            <div class="form-group"><label>Password</label><input type="password" id="login-pass" class="form-input" placeholder="••••••••"></div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()">Login</button>
            <div class="social-divider">Or continue with</div>
            <div class="social-buttons">
                <div class="social-btn" onclick="socialLogin('google')" style="color:#DB4437"><i class="fa-brands fa-google"></i></div>
<div class="social-btn" onclick="socialLogin('linkedin_oidc')" style="color:#0077b5"><i class="fa-brands fa-linkedin-in"></i></div>                <div class="social-btn" onclick="socialLogin('azure')" style="color:#00a4ef"><i class="fa-brands fa-microsoft"></i></div>
            </div>
            <div class="toggle-link" onclick="toggleAuthMode('register')">Register New Organization</div>
        </div>
        <div class="auth-card hidden" id="register-card">
            <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA" class="auth-logo">
            <div class="auth-title">Start Your Business</div>
            <div class="auth-subtitle">Create Organization & CEO Account</div>
            <div class="form-group"><label>Organization Name</label><input type="text" id="reg-org-name" class="form-input" placeholder="e.g. Digitivia Corp"></div>
            <div class="form-group"><label>Full Name</label><input type="text" id="reg-name" class="form-input" placeholder="John Doe"></div>
            <div class="form-group"><label>Work Email</label><input type="email" id="reg-email" class="form-input" placeholder="ceo@company.com"></div>
            <div class="form-group"><label>Password</label><input type="password" id="reg-pass" class="form-input" placeholder="••••••••"></div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="handleRegister()">Create Organization</button>
            <div class="toggle-link" onclick="toggleAuthMode('login')">Already have an account? Login</div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="sidebar" id="sidebar">
            <div class="logo-area">
                <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA Logo">
            </div>
            <div id="nav-container"></div>
        </nav>
        <div class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <i class="fa-solid fa-bars icon-btn" onclick="toggleSidebar()" style="display:none; margin-right:10px;"></i> 
                    <span id="current-date" style="font-size: 0.9rem; color: var(--text-muted);"></span>
                </div>
                <div class="header-right">
                    <div class="branding-logos" style="border:none; padding:0; margin:0;">
                        <span id="org-display-name" style="font-weight:700; color:white; opacity:0.8; font-size:1.1rem; text-transform:uppercase; letter-spacing:1px;"></span>
                    </div>
                    <div class="user-controls">
                        <div id="role-display" class="btn-outline" style="cursor:default; border-color:var(--primary); color:var(--primary)">Loading...</div>
                        <button class="btn-outline" onclick="toggleLang()" id="lang-btn">عربي</button>
                        <div class="dropdown" onclick="handleLogout()">
                            <img src="" alt="User" id="user-avatar">
                            <span id="user-name">Loading...</span>
                            <i class="fa-solid fa-right-from-bracket" style="font-size:0.8rem; margin-left:5px; color:var(--danger)"></i>
                        </div>
                    </div>
                </div>
            </header>
            <main class="content-scroll" id="main-view"></main>
            <div id="toast" class="toast"><i class="fa-solid fa-circle-check"></i> <span id="toast-msg">Success!</span></div>
        </div>
    </div>

    <div id="job-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Smart Job Wizard
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('job-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Job Title</label>
                <input type="text" id="job-title" class="form-input" placeholder="e.g. Senior Backend Engineer">
            </div>
            <div class="form-group">
                <label>Department</label>
                <input type="text" id="job-dept" class="form-input" placeholder="e.g. Engineering">
            </div>
            <div class="form-group">
                <label>Salary Range</label>
                <input type="text" id="job-salary" class="form-input" placeholder="e.g. $80k - $120k">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="job-status" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Open">Open</option>
                    <option value="Draft">Draft</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveNewJob()">
                <i class="fa-solid fa-rocket"></i> Publish Job
            </button>
        </div>
    </div>

    <div id="onboard-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Onboard New Hire
                <i class="fa-solid fa-xmark close-modal" onclick="closeOnboardModal()"></i>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="new-name" class="form-input" placeholder="Jane Doe">
            </div>
            <div class="form-group">
                <label>Company Email</label>
                <input type="email" id="new-email" class="form-input" placeholder="jane@company.com">
            </div>
            <div class="form-group">
                <label>Temporary Password</label>
                <input type="text" id="new-pass" class="form-input" placeholder="Welcome123">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="new-role" class="form-input" style="background:rgba(255,255,255,0.05);">
                </select>
            </div>
            <div class="form-group">
                <label>Extra Details (Optional)</label>
                <input type="text" id="new-meta-phone" class="form-input" placeholder="Phone Number" style="margin-bottom:10px;">
                <input type="text" id="new-meta-dept" class="form-input" placeholder="Department">
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="executeOnboard()">Create Account</button>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Import Legacy Attendance
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('import-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Upload CSV</label>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Format: email, date, in_time, out_time</p>
                <input type="file" id="attendance-file" class="form-input" accept=".csv">
            </div>
            <div style="background:rgba(231,76,60,0.1); padding:10px; border-radius:8px; border:1px solid rgba(231,76,60,0.3); font-size:0.8rem; margin-bottom:15px;">
                <i class="fa-solid fa-triangle-exclamation"></i> Smart Merge Active: Rows that conflict with verified "Live" data will be skipped to preserve integrity.
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handleAttendanceImport()">
                Process Import
            </button>
        </div>
    </div>

    <div id="perf-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Upload Performance Data
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('perf-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Department Rules</label>
                <select id="perf-dept" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Engineering">Engineering (Qual 40 / Spd 30)</option>
                    <option value="Sales">Sales (Rev 50 / Spd 30)</option>
                    <option value="Support">Support (Qual 50 / Spd 30)</option>
                    <option value="General">General (Balanced)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Input Method</label>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn-outline" onclick="setPerfInput('file')" id="btn-file-mode" style="flex:1; border-color:var(--primary)">File Upload</button>
                    <button class="btn-outline" onclick="setPerfInput('manual')" id="btn-manual-mode" style="flex:1;">Manual Text</button>
                </div>
            </div>
            <div id="perf-input-file" class="form-group">
                <label>Upload CSV/Excel Log</label>
                <input type="file" id="perf-file" class="form-input">
            </div>
            <div id="perf-input-manual" class="form-group hidden">
                <label>Paste Raw Work Logs</label>
                <textarea id="perf-text" class="form-input" rows="5" placeholder="e.g. John completed 40 tickets with 2 errors. Sarah closed 5 deals..."></textarea>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handlePerformanceSubmit()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze with AI
            </button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Department Schedules (Option B)<i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('settings-modal').classList.add('hidden')"></i></div>
            <div class="form-group">
                <label>Department Name</label>
                <input type="text" id="set-dept" class="form-input" placeholder="e.g. Sales, Engineering, or Global">
            </div>
            <div class="form-group">
                <label>Work Days</label>
                <div class="day-selector">
                    <input type="checkbox" id="d0" class="day-check" value="0"><label for="d0" class="day-label">S</label>
                    <input type="checkbox" id="d1" class="day-check" value="1"><label for="d1" class="day-label">M</label>
                    <input type="checkbox" id="d2" class="day-check" value="2"><label for="d2" class="day-label">T</label>
                    <input type="checkbox" id="d3" class="day-check" value="3"><label for="d3" class="day-label">W</label>
                    <input type="checkbox" id="d4" class="day-check" value="4"><label for="d4" class="day-label">T</label>
                    <input type="checkbox" id="d5" class="day-check" value="5"><label for="d5" class="day-label">F</label>
                    <input type="checkbox" id="d6" class="day-check" value="6"><label for="d6" class="day-label">S</label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Start Time</label><input type="time" id="set-start" class="form-input" value="09:00"></div>
                <div class="form-group" style="flex:1"><label>End Time</label><input type="time" id="set-end" class="form-input" value="17:00"></div>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveDepartmentSchedule()">Save Rule</button>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://neepgsppcemzwapcexys.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZXBnc3BwY2VtendhcGNleHlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDI5NzEsImV4cCI6MjA4MzExODk3MX0.1gXea9dkLrE8CY80ho0wC0al04DCvMJK5UimqAj96e0';
    const N8N_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_hr_payroll'; 
    const N8N_PERF_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_performance'; 
    
    // --- TESLA-GRADE ATTENDANCE CONFIG ---
    const OFFICE_COORDS = { lat: 30.0444, lng: 31.2357 }; // Change to your HQ
    const MAX_DISTANCE_METERS = 500; // Radius

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE ---
    const state = { 
        user: null, profile: null, org: null, lang: 'en', activeView: 'dashboard',
        perfCycle: 'Monthly', perfInputMode: 'file'
    };
// --- 1. INSERT AFTER 'const state = { ... }' ---

    // BUNDLE & FEATURE CONFIGURATION
    const BUNDLE_CONFIG = {
        'free': { 
            name: 'Standard', 
            features: ['attendance', 'basic_payroll', 'dashboard', 'employees'], 
            can_broadcast: false 
        },
        'bundle_2': { 
            name: 'Growth', 
            features: ['attendance', 'basic_payroll', 'dashboard', 'employees', 'wfm', 'ats', 'broadcast'], 
            can_broadcast: true 
        },
        'bundle_3': { 
            name: 'Enterprise', 
            features: ['all'], 
            can_broadcast: true 
        }
    };

    // Helper: Check if feature is allowed
    function hasAccess(featureKey) {
        if (!state.org) return false;
        const tier = state.org.subscription_tier || 'free';
        const config = BUNDLE_CONFIG[tier] || BUNDLE_CONFIG['free'];
        
        if (config.features.includes('all')) return true;
        return config.features.includes(featureKey);
    }
    // Translations
    const i18n = {
        en: { welcome: "Welcome back,", dashboard: "Dashboard", org_profile: "Org Profile", payroll: "Payroll Automation", employees: "Employees", attendance: "Time & Attendance", ats: "ATS Recruitment", performance: "Performance", reports: "Reports", wfm: "Workforce WFM", viewAll: "View All", create: "Create New" },
        ar: { welcome: "مرحباً بعودتك،", dashboard: "لوحة التحكم", org_profile: "ملف المؤسسة", payroll: "أتمتة الرواتب", employees: "الموظفين", attendance: "الحضور والانصراف", ats: "نظام التوظيف", performance: "الأداء", reports: "التقارير", wfm: "إدارة القوى العاملة", viewAll: "عرض الكل", create: "إنشاء جديد" }
    };

    /* -------------------------------------------------------------------------
       CRITICAL: ALL HELPER FUNCTIONS DEFINED FIRST TO AVOID "NOT DEFINED" ERRORS
       ------------------------------------------------------------------------- */

    // --- NEW: AUDIT & SECURITY HELPERS ---
    async function logSystemAction(action, target, details = {}) {
        try {
            await supabaseClient.from('audit_logs').insert({
                org_id: state.org.id,
                actor_id: state.user.id,
                action_type: action,
                target_record: target,
                details: details,
                ip_address: 'client-side'
            });
        } catch(e) { console.warn("Audit Log Failed:", e); }
    }

    async function checkRoleAccess(requiredRoles) {
        if (!requiredRoles.includes(state.profile.role)) {
            document.getElementById('main-view').innerHTML = `<div class="card" style="text-align:center; padding:50px;"><i class="fa-solid fa-lock" style="font-size:3rem; color:var(--danger)"></i><h2 style="margin-top:20px;">Access Denied</h2><p>You need ${requiredRoles.join(' or ')} privileges.</p></div>`;
            return false;
        }
        return true;
    }

    // --- HELPER: LEAFLET MAP ---
    async function initLiveMap() {
        if (!document.getElementById('work-map')) return;
        const map = L.map('work-map').setView([OFFICE_COORDS.lat, OFFICE_COORDS.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        const { data: profiles } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id);
        if(!profiles) return;
        for (const p of profiles) {
            const { data: act } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', p.user_id).order('clock_in_time', {ascending:false}).limit(1).maybeSingle();
            if (act && act.check_in_lat && act.check_in_long) {
                const isActive = act.clock_out_time === null;
                const color = isActive ? 'green' : 'grey';
                const iconHtml = `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin' });
                L.marker([act.check_in_lat, act.check_in_long], { icon: customIcon }).addTo(map)
                  .bindPopup(`<b>${p.full_name}</b><br>${isActive ? 'Online' : 'Offline'}<br>${new Date(act.clock_in_time).toLocaleTimeString()}`);
            }
        }
    }

    // --- HELPER: WFM ROSTER ---
    async function loadWFMRoster() {
        const list = document.getElementById('wfm-roster-list'); if(!list) return; 
        const { data: employees } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id).limit(50);
        if (!employees || employees.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No active employees found.</div>'; return; }
        const { data: active } = await supabaseClient.from('wfm_activity').select('user_id, current_status').eq('org_id', state.org.id).is('clock_out_time', null);
        const activeMap = {}; 
        if(active) active.forEach(a => activeMap[a.user_id] = a.current_status);
        let html = ''; 
        const colors = { 'On Queue': 'var(--success)', 'Break': 'var(--warning)', 'Meeting': 'var(--info)', 'Offline': 'var(--text-muted)' }; 
        employees.forEach(emp => { 
            const isActive = activeMap.hasOwnProperty(emp.user_id);
            const status = isActive ? (activeMap[emp.user_id] || 'Online') : 'Offline'; 
            const color = isActive ? colors[status] || 'var(--success)' : 'var(--text-muted)'; 
            html += `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid var(--glass-border); opacity:${isActive?1:0.6}"><img src="${emp.avatar_url || 'https://ui-avatars.com/api/?background=random'}" style="width:35px; height:35px; border-radius:50%;"><div style="flex-grow:1;"><div style="font-weight:600; color:#fff;">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted);">${emp.role}</div></div><span style="font-size:0.75rem; padding:4px 8px; border-radius:4px; background:${color}20; color:${color}; border:1px solid ${color}40;">${status}</span></div>`; 
        }); 
        list.innerHTML = html; 
    }

    // --- HELPER: WFM CHART ---
    async function initWFMChart() {
        setTimeout(async () => {
            const ctx = document.getElementById('wfmChart');
            if(!ctx) return; 
            try {
                const { data: schedules, error: schError } = await supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
                const defaultStart = 9; const defaultEnd = 17; 
                const todayStr = new Date().toISOString().split('T')[0];
                const { data: logs } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
                const hours = Array.from({length: 24}, (_, i) => i);
                const planned = new Array(24).fill(0);
                const actual = new Array(24).fill(0);
                const { count } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
                const totalStaff = count || 10;
                
                let sStart = defaultStart, sEnd = defaultEnd;
                if(schedules && schedules.length > 0) {
                    const s = schedules[0]; 
                    sStart = parseInt(s.shift_start.split(':')[0]);
                    sEnd = parseInt(s.shift_end.split(':')[0]);
                }
                hours.forEach(h => { if (h >= sStart && h < sEnd) planned[h] = totalStaff; });
                if(logs) { logs.forEach(l => { const inH = new Date(l.clock_in_time).getHours(); const outH = l.clock_out_time ? new Date(l.clock_out_time).getHours() : 23; for(let i=inH; i<=outH; i++) actual[i]++; }); }

                if(window.wfmChartInstance) window.wfmChartInstance.destroy();
                window.wfmChartInstance = new Chart(ctx, { type: 'line', data: { labels: hours.map(h => `${h}:00`), datasets: [ { label: 'Planned', data: planned, borderColor: '#95a5a6', borderDash: [5, 5], tension: 0.4 }, { label: 'Actual', data: actual, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: true, tension: 0.4 } ] }, options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } });
            } catch(err) { console.error("WFM Chart Error:", err); }
        }, 100);
    }

    // --- HELPER: ATTENDANCE HISTORY ---
    async function loadAttendanceHistory() {
        const histDiv = document.getElementById('attendance-history');
        if(!histDiv) return;

        const { data: logs, error } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).order('clock_in_time', { ascending: false }).limit(5);
        if(error || !logs) { return; }
        let html = `<table><thead><tr><th>Date</th><th>In</th><th>Out</th><th>Source</th><th>Proof</th></tr></thead><tbody>`;
        logs.forEach(log => {
            const date = new Date(log.clock_in_time).toLocaleDateString();
            const inTime = new Date(log.clock_in_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const outTime = log.clock_out_time ? new Date(log.clock_out_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '<span style="color:var(--success)">Active</span>';
            const sourceBadge = log.record_source === 'csv_upload' ? '<span class="badge" style="background:#95a5a6; position:static">Import</span>' : '<span class="badge" style="background:var(--success); position:static">Live</span>';
            const proofLink = log.check_in_photo ? `<a href="${log.check_in_photo}" target="_blank" style="color:var(--primary)">View Selfie</a>` : '-';
            html += `<tr><td>${date}</td><td>${inTime}</td><td>${outTime}</td><td>${sourceBadge}</td><td>${proofLink}</td></tr>`;
        });
        html += `</tbody></table>`;
        histDiv.innerHTML = html;
    }

    // --- HELPER: PAYROLL TABLE ---
    function renderPayrollTable(items, isNew = true) { 
        const loader = document.getElementById('payroll-loading');
        if(loader) loader.classList.add('hidden'); 
        const container = document.getElementById('payroll-content'); 
        if (container) {
            container.classList.remove('hidden'); 
            let html = `<div style="height:100%; overflow:hidden; display:flex; flex-direction:column;"><div class="card-header" style="padding:20px; flex-shrink:0;"><div class="card-title">Payroll Data</div><button class="btn-outline" onclick="renderPayrollUI(document.getElementById('main-view'))"><i class="fa-solid fa-rotate"></i> Refresh</button></div><div style="flex-grow:1; overflow-y:auto; padding:0 20px 20px 20px;"><table><thead><tr><th>Employee</th><th>Salary</th><th>Bonus</th><th>Deductions</th><th>Net Pay</th></tr></thead><tbody>`; 
            if(items) {
                items.forEach(item => { html += `<tr><td><input class="table-input" value="${item.employee_name}" onchange="updatePayrollItem('${item.id}', 'employee_name', this.value, '${item.employee_name}')"></td><td><input type="number" class="table-input" value="${item.salary}" onchange="updatePayrollItem('${item.id}', 'salary', this.value, '${item.salary}')"></td><td><input type="number" class="table-input" value="${item.bonus}" onchange="updatePayrollItem('${item.id}', 'bonus', this.value, '${item.bonus}')"></td><td><input type="number" class="table-input" value="${item.deductions}" onchange="updatePayrollItem('${item.id}', 'deductions', this.value, '${item.deductions}')"></td><td style="color:var(--success); font-weight:bold">${item.net_pay}</td></tr>`; }); 
            }
            html += `</tbody></table></div></div>`; 
            container.innerHTML = html; 
        }
    }

    // --- HELPER: PERFORMANCE TABLE (SHOWS ALL) ---
    async function renderPerformanceTable(filteredReviews) {
        const { data: allEmployees } = await supabaseClient.from('profiles').select('user_id, full_name, email, role').eq('org_id', state.org.id);
        if(!allEmployees) return;

        const reviewMap = {};
        if (filteredReviews) {
            filteredReviews.forEach(r => reviewMap[r.user_id] = r);
        }

        let html = `<table><thead><tr><th>Employee</th><th>Role</th><th>Quality</th><th>Speed</th><th>Score</th><th>AI Insight</th></tr></thead><tbody>`;
        
        allEmployees.forEach(emp => {
            const r = reviewMap[emp.user_id];
            
            if (r) {
                const scoreClass = r.score_final >= 90 ? 'perf-high' : (r.score_final >= 75 ? 'perf-mid' : 'perf-low');
                html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>${r.score_quality}</td><td>${r.score_speed}</td><td><span class="perf-badge ${scoreClass}">${r.score_final}</span></td><td><button class="btn-outline" style="font-size:0.75rem;" onclick="showToast('${(r.ai_feedback || "").replace(/'/g, "\\'")}')">View Analysis</button></td></tr>`;
            } else {
                html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>-</td><td>-</td><td><span class="perf-badge" style="background:rgba(255,255,255,0.1); color:#aaa;">Pending</span></td><td><span style="font-size:0.8rem; color:#666;">No data</span></td></tr>`;
            }
        });

        html += `</tbody></table>`;
        const perfContent = document.getElementById('perf-content');
        if (perfContent) perfContent.innerHTML = html;
    }

    // --- HELPER: ROI TABLE & CHARTS ---
    function renderROITable(data) { 
        const tbody = document.querySelector('#roi-table tbody'); 
        if(!tbody) return;
        let html = ''; 
        if(data) {
            data.forEach(r => { const roi = r.total_cost > 0 ? ((r.productivity_score / r.total_cost) * 1000).toFixed(1) : 'N/A'; html += `<tr><td>${r.full_name}</td><td>${r.role}</td><td>$${r.total_cost}</td><td>${r.productivity_score}</td><td>${roi}</td><td><span class="badge" style="background:var(--success); position:static">Healthy</span></td></tr>`; }); 
        }
        tbody.innerHTML = html; 
    }
    
    function initReportCharts(data) { 
        const ctx1 = document.getElementById('burnoutChart');
        const ctx2 = document.getElementById('efficiencyChart');
        if(!ctx1 || !ctx2 || !data) return;

        new Chart(ctx1, { type: 'bar', data: { labels: data.map(r => r.full_name), datasets: [ { label: 'Productivity', data: data.map(r => r.productivity_score), backgroundColor: '#3498db' } ] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } }); 
        const roles = [...new Set(data.map(r => r.role))]; const efficiency = roles.map(role => { const users = data.filter(r => r.role === role); return users.reduce((sum, u) => sum + u.productivity_score, 0) / users.length; }); 
        new Chart(ctx2, { type: 'radar', data: { labels: roles, datasets: [{ label: 'Avg Prod', data: efficiency, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)' }] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false } } } } }); 
    }

    // --- HELPER: GLOBAL FUNCTIONS FOR HTML BUTTONS ---
    window.handleClockOut = async function(activityId) {
        try {
            console.log("Attempting to end shift for Activity ID:", activityId);
            const { data, error } = await supabaseClient
                .from('wfm_activity')
                .update({ clock_out_time: new Date().toISOString(), current_status: 'Offline' })
                .eq('id', activityId)
                .select();
            
            if (error) throw error;
            if (!data || data.length === 0) {
                console.error("Update succeeded but 0 rows changed. Check RLS policies.");
                showToast("Database Permission Error: Run the SQL Fix!", true);
                return;
            }
            showToast("Shift Ended. Have a great evening!");
            await renderAttendanceUI(document.getElementById('main-view'));
        } catch (err) {
            console.error("Clock Out Error:", err);
            showToast("Failed: " + err.message, true);
        }
    }
    
    async function startClockInFlow() {
        const btn = document.getElementById('btn-scan');
        const locStatus = document.getElementById('loc-status');
        const vidContainer = document.getElementById('camera-preview');
        const vid = document.getElementById('vid');
        btn.classList.add('hidden'); locStatus.innerText = "Acquiring Secure GPS Signal...";
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const deviceType = isMobile ? 'mobile_app' : 'desktop_web';

        try {
            const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject));
            const { latitude, longitude } = position.coords;
            const dist = getDistanceFromLatLonInM(latitude, longitude, OFFICE_COORDS.lat, OFFICE_COORDS.lng);
            const workMode = dist < MAX_DISTANCE_METERS ? 'Office' : 'Remote';
            locStatus.innerText = `Verified: ${workMode} (${Math.round(dist)}m from HQ)`;
            locStatus.style.color = 'var(--success)';
            vidContainer.classList.remove('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            vid.srcObject = stream;
            setTimeout(async () => {
                const canvas = document.createElement('canvas'); canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
                canvas.getContext('2d').drawImage(vid, 0, 0);
                canvas.toBlob(async (blob) => {
                    const fileName = `selfie_${state.user.id}_${Date.now()}.jpg`;
                    const { error: upErr } = await supabaseClient.storage.from('attendance_photos').upload(fileName, blob);
                    if (upErr) throw upErr;
                    const { data: { publicUrl } } = supabaseClient.storage.from('attendance_photos').getPublicUrl(fileName);
                    await supabaseClient.from('wfm_activity').insert({
                        org_id: state.org.id, user_id: state.user.id, 
                        clock_in_time: new Date().toISOString(), 
                        current_status: 'On Queue',
                        check_in_lat: latitude, check_in_long: longitude, check_in_photo: publicUrl, device_info: navigator.userAgent,
                        record_source: deviceType
                    });
                    stream.getTracks().forEach(t => t.stop());
                    showToast("Identity Verified. Welcome back!");
                    renderAttendanceUI(document.getElementById('main-view'));
                }, 'image/jpeg');
            }, 1500);
        } catch (err) { console.error(err); showToast("Access Denied: " + err.message, true); btn.classList.remove('hidden'); if(stream) stream.getTracks().forEach(t => t.stop()); }
    }

    // --- NEW: MISSING FUNCTION: Save Dept Schedule ---
    window.saveDepartmentSchedule = async function() {
        const dept = document.getElementById('set-dept').value;
        const start = document.getElementById('set-start').value;
        const end = document.getElementById('set-end').value;
        
        const days = [];
        for(let i=0; i<=6; i++) {
            if(document.getElementById(`d${i}`).checked) days.push(i);
        }

        if(!dept) return showToast("Department name required", true);

        const { error } = await supabaseClient
            .from('wfm_schedules')
            .upsert({
                org_id: state.org.id,
                department: dept,
                shift_start: start,
                shift_end: end,
                work_days: days
            }, { onConflict: 'org_id, department' }); 

        if(error) return showToast("Save Failed: " + error.message, true);
        
        showToast(`Schedule saved for ${dept}`);
        document.getElementById('settings-modal').classList.add('hidden');
        renderWFMUI(document.getElementById('main-view')); 
    }

    // --- INIT & AUTH ---
  // --- INIT & AUTH ---
    window.addEventListener('DOMContentLoaded', async () => {
        const dateEl = document.getElementById('current-date');
        if (dateEl) dateEl.innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // 1. LISTEN for Auth State Changes (Handles both Redirects and Normal Session)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                // Clear URL junk (hashes and query params) for a clean look
                if (window.location.hash || window.location.search) {
                    window.history.replaceState(null, null, window.location.pathname);
                }
                
                // Load App if not already loaded
                if (!state.user) {
                    loadAppData(session.user);
                }
            } else if (event === 'SIGNED_OUT') {
                showAuthScreen();
            }
        });

        // 2. CHECK for Initial Session
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            loadAppData(session.user);
        } else {
            // 3. SMART REDIRECT CHECK (The Fix)
            // We only show the login screen if we are SURE this isn't a Google/LinkedIn redirect.
            // We check for both '#access_token' (Implicit) and '?code=' (PKCE).
            const isRedirect = window.location.hash.includes('access_token') || 
                               window.location.search.includes('code=');

            if (isRedirect) {
                // Show a loading spinner instead of the Login Form while Supabase processes the token
                document.getElementById('auth-container').innerHTML = `
                    <div class="auth-card" style="text-align:center;">
                        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i>
                        <h3 style="margin-top:20px; color:white;">Finishing Login...</h3>
                    </div>`;
            } else {
                showAuthScreen();
            }
        }
    });
    function toggleAuthMode(mode) { if(mode === 'register') { document.getElementById('login-card').classList.add('hidden'); document.getElementById('register-card').classList.remove('hidden'); } else { document.getElementById('register-card').classList.add('hidden'); document.getElementById('login-card').classList.remove('hidden'); } }
    async function handleLogin() { const email = document.getElementById('login-email').value; const password = document.getElementById('login-pass').value; try { const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) throw error; loadAppData(data.user); } catch (err) { showToast(err.message, true); } }
    async function handleRegister() { const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-pass').value; const fullName = document.getElementById('reg-name').value; const orgName = document.getElementById('reg-org-name').value; if(!email || !password || !fullName || !orgName) { showToast("Please fill all fields", true); return; } try { const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { full_name: fullName, org_name: orgName, avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random` } } }); if (error) throw error; showToast("Registration successful! Logging in..."); if(data.session) loadAppData(data.user); else showToast("Please check your email to confirm account", false); } catch (err) { showToast(err.message || "Server Error", true); } }
    async function socialLogin(provider) { 
        // FIX: Always use origin + pathname to strip existing hashes and prevent "Double Hash" errors
        const cleanRedirect = window.location.origin + window.location.pathname;
        
        await supabaseClient.auth.signInWithOAuth({ 
            provider: provider, 
            options: { 
                redirectTo: cleanRedirect,
                // Add scopes if needed for specific providers
                scopes: provider === 'azure' ? 'email profile openid' : undefined
            } 
        }); 
    }
    async function handleLogout() { await supabaseClient.auth.signOut(); window.location.reload(); }
    function showAuthScreen() { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }

    // --- MAIN DATA LOADER ---
    // --- MAIN DATA LOADER (Fixed for Corporate Logins) ---
  // --- MAIN DATA LOADER (CEO Edition) ---
  // --- MAIN DATA LOADER (Auto-Fix Edition) ---
// --- MAIN DATA LOADER (Safety Edition) ---
    async function loadAppData(user) {
        state.user = user;
        
        let { data: profileData, error: profileError } = await supabaseClient
            .from('profiles')
            .select('*, organizations(*)')
            .eq('user_id', user.id)
            .maybeSingle();

        // --- NEW USER SETUP FLOW ---
        if (!profileData) {
            console.log("New User or Orphaned Profile Detected...");
            const meta = user.user_metadata || {};
            const fullName = meta.full_name || meta.name || user.email.split('@')[0];
            const avatarUrl = meta.avatar_url || meta.picture || `https://ui-avatars.com/api/?name=${fullName}&background=random`;
            
            // Determine Org Name
            const emailDomain = user.email.split('@')[1];
            let orgName = `${fullName}'s Company`;
            const freeDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com'];
            if (emailDomain && !freeDomains.includes(emailDomain)) {
                const companyName = emailDomain.split('.')[0];
                orgName = companyName.charAt(0).toUpperCase() + companyName.slice(1);
            }

            try {
                // 1. Create Organization
                const { data: newOrg, error: orgError } = await supabaseClient
                    .from('organizations')
                    .insert({ name: orgName })
                    .select()
                    .single();
                
                // CRITICAL FIX: Handle RLS Error here
                if (orgError) {
                    console.error("Org Creation Blocked:", orgError);
                    if (orgError.code === '42501') {
                        showToast("Database Error: Run SQL Policy!", true);
                        document.getElementById('auth-container').innerHTML = `<div class="auth-card"><h3 style="color:var(--danger)">Setup Failed</h3><p>You need to run the SQL Policy to allow Organization Creation.</p><button class="btn-primary" onclick="location.reload()">Try Again</button></div>`;
                        return; // Stop execution to prevent crash
                    }
                }

                const targetOrgId = newOrg ? newOrg.id : (state.org?.id || null);

                // 2. Create/Recover Profile
                const { data: newProfile, error: createError } = await supabaseClient
                    .from('profiles')
                    .insert({
                        user_id: user.id, email: user.email, full_name: fullName,
                        role: 'ceo', org_id: targetOrgId, avatar_url: avatarUrl
                    })
                    .select('*, organizations(*)')
                    .single();

                if (createError) {
                    // Handle Duplicate Email (Zombie Profile)
                    if (createError.code === '23505') { 
                        console.warn("Claiming zombie profile...");
                        const { data: claimedProfile, error: claimError } = await supabaseClient
                            .from('profiles')
                            .update({ user_id: user.id, role: 'ceo', avatar_url: avatarUrl })
                            .eq('email', user.email)
                            .select('*, organizations(*)')
                            .single();
                        
                        if (claimError) throw claimError;
                        profileData = claimedProfile;
                    } else {
                        throw createError;
                    }
                } else {
                    profileData = newProfile;
                }
                showToast(`Welcome, CEO of ${orgName}!`);

            } catch (err) {
                console.error("Setup Fatal Error:", err);
                showToast("Login Failed: " + err.message, true);
                return;
            }
        }

        // --- LOAD APPLICATION ---
        // Final Safety Check: Ensure we actually have data before rendering
        if (!profileData || !profileData.organizations) {
            console.error("Critical: Profile loaded but Organization data is missing.");
            // If we have a profile but no org, try to fetch org separately as fallback
            if (profileData && profileData.org_id) {
                 const { data: refetchOrg } = await supabaseClient.from('organizations').select('*').eq('id', profileData.org_id).single();
                 state.org = refetchOrg;
            }
            if (!state.org && profileData?.organizations) state.org = profileData.organizations;
            
            if (!state.org) {
                 showToast("Error: Account has no Organization linked.", true);
                 return; 
            }
        } else {
            state.profile = profileData; 
            state.org = profileData.organizations;
        }

        document.getElementById('auth-container').classList.add('hidden'); 
        document.getElementById('app-container').classList.remove('hidden'); 
        setTimeout(() => document.getElementById('app-container').classList.add('loaded'), 100);
        
        document.getElementById('user-name').innerText = state.profile.full_name; 
        document.getElementById('user-avatar').src = state.profile.avatar_url || 'default.png';
        document.getElementById('role-display').innerText = state.profile.role.toUpperCase().replace('_', ' '); 
        document.getElementById('org-display-name').innerText = state.org.name;
        
        if (state.profile.role === 'employee') state.activeView = 'employee_dash';
        else state.activeView = 'dashboard';

        renderSidebar(); 
        // Show Setup Modal if it's a brand new org (created less than 1 minute ago) 
        // OR just check a local flag for the demo
        const isNew = new Date() - new Date(state.org.created_at) < 60000; // 60 seconds
        if (isNew) {
            document.getElementById('setup-modal').classList.remove('hidden');
        }
        renderMainContent();
    }
    // 1. DASHBOARD
    async function loadDashboardView(container) {

        // --- 3. PASTE INSIDE loadDashboardView() AT THE TOP ---

    // 1. Fetch Latest Broadcast
    const { data: broadcast } = await supabaseClient
        .from('broadcast_messages')
        .select('*')
        .eq('org_id', state.org.id)
        .order('sent_at', {ascending:false})
        .limit(1)
        .maybeSingle();

    let broadcastHTML = '';
    if (broadcast) {
        const severityColor = broadcast.severity === 'urgent' ? 'var(--danger)' : 'var(--primary)';
        broadcastHTML = `
        <div class="card" style="border-left: 4px solid ${severityColor}; background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 100%); margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between;">
                <div style="font-weight:700; color:${severityColor};"><i class="fa-solid fa-bullhorn"></i> ${broadcast.subject || 'Announcement'}</div>
                <div style="font-size:0.8rem; opacity:0.7">${new Date(broadcast.sent_at).toLocaleDateString()}</div>
            </div>
            <div style="margin-top:5px; font-size:1rem;">${broadcast.content}</div>
        </div>`;
    }

    // 2. Add "Send Alert" Button (Only for Admins)
    let sendAlertBtn = '';
    if (['ceo', 'hr_manager'].includes(state.profile.role) && hasAccess('broadcast')) {
        sendAlertBtn = `<button class="btn-outline" onclick="document.getElementById('broadcast-modal').classList.remove('hidden')"><i class="fa-solid fa-paper-plane"></i> Send Alert</button>`;
    }

    // --- NOW UPDATE YOUR HEADER STRING TO INCLUDE THESE ---
    // Change your existing 'const header = ...' line to:
    const header = `<div class="page-title">
        <span>${i18n[state.lang].welcome} <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span> 
        <div style="display:flex; gap:10px;">
            ${sendAlertBtn}
            <button class="btn-outline" onclick="exportDashboardPDF()"><i class="fa-solid fa-file-pdf"></i> Export</button>
        </div>
    </div>
    ${broadcastHTML}`; // Inject the alert here

        
        if(state.profile.role === 'employee') return renderEmployeeDashboard(container); 
        
        let query = supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
        if (state.profile.role === 'manager') query = query.eq('department', state.profile.department);
        const { count: totalStaff } = await query;

        let activeQuery = supabaseClient.from('wfm_activity').select('user_id').eq('org_id', state.org.id).is('clock_out_time', null);
        if (state.profile.role === 'manager') {
            const { data: teamIds } = await supabaseClient.from('profiles').select('user_id').eq('department', state.profile.department);
            if(teamIds) activeQuery = activeQuery.in('user_id', teamIds.map(t => t.user_id));
        }
        const { data: activeData } = await activeQuery;
        const activeCount = activeData ? activeData.length : 0;

        let jobQuery = supabaseClient.from('ats_jobs').select('*', { count: 'exact', head: true });
        if (state.profile.role === 'manager') { jobQuery = jobQuery.eq('department', state.profile.department); }
        const { count: openJobs } = await jobQuery;

        // FIXED QUERY: No Join
        let schedQuery = supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
        const { data: schedules } = await schedQuery;
        let lateCount = 0; let lateListHTML = '';
        
        if (schedules && schedules.length > 0) {
            const todayStr = new Date().toISOString().split('T')[0];
            const { data: logs } = await supabaseClient.from('wfm_activity').select('clock_in_time, user_id').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
            
            if(logs && logs.length > 0) {
                const userIds = logs.map(l => l.user_id);
                const { data: logProfiles } = await supabaseClient.from('profiles').select('user_id, full_name, department').in('user_id', userIds);
                
                const profileMap = {};
                if(logProfiles) logProfiles.forEach(p => profileMap[p.user_id] = p);

                logs.forEach(log => {
                    const profile = profileMap[log.user_id];
                    if(!profile) return;
                    const rule = schedules.find(s => s.department === profile.department) || schedules[0]; 
                    if (rule) {
                        const ruleHour = parseInt(rule.shift_start.split(':')[0]);
                        const ruleMin = parseInt(rule.shift_start.split(':')[1]);
                        const clockTime = new Date(log.clock_in_time);
                        const ruleTime = new Date(log.clock_in_time); 
                        ruleTime.setHours(ruleHour, ruleMin, 0);
                        if (clockTime > ruleTime) {
                            lateCount++;
                            const diff = Math.round((clockTime - ruleTime) / 60000);
                            lateListHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between;"><span>${profile.full_name}</span> <span style="color:var(--danger)">+${diff} min</span></div>`;
                        }
                    }
                });
            }
        }
        if (lateListHTML === '') lateListHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No late arrivals today.</div>';

        container.innerHTML = `
            ${header}
            <div id="dash-content">
                <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card"><div class="card-title">Total Staff</div><div class="score-val" style="color:var(--text-main)">${totalStaff || 0}</div></div>
                    <div class="card"><div class="card-title">Online Now</div><div class="score-val" style="color:var(--success)">${activeCount}</div></div>
                    <div class="card"><div class="card-title">Open Jobs</div><div class="score-val" style="color:var(--info)">${openJobs || 0}</div></div>
                    <div class="card"><div class="card-title">Late Today</div><div class="score-val" style="color:var(--danger)">${lateCount}</div></div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card"><div class="card-title" style="margin-bottom:15px; color:var(--danger)">Late Arrival Ticker</div><div style="overflow-y:auto; max-height:200px;">${lateListHTML}</div></div>
                    <div class="card"><div class="card-title">Staff Distribution</div><div style="height:200px; position:relative;"><canvas id="dashPie"></canvas></div></div>
                </div>
                <div class="card"><div class="card-title">Recent Activity (Organization Wide)</div><div id="dash-activity">Loading...</div></div>
            </div>
        `;

        // SAFETY FIX: Chart Creation
        setTimeout(async () => {
            const chartCanvas = document.getElementById('dashPie');
            if (chartCanvas) {
                const { data: allProfs } = await supabaseClient.from('profiles').select('department').eq('org_id', state.org.id);
                if(allProfs) {
                    const deptCounts = {};
                    allProfs.forEach(p => { const d = p.department || 'Unassigned'; deptCounts[d] = (deptCounts[d] || 0) + 1; });
                    new Chart(chartCanvas, { type: 'doughnut', data: { labels: Object.keys(deptCounts), datasets: [{ data: Object.values(deptCounts), backgroundColor: ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color:'white' } } } } });
                }
            }
        }, 100);

        // Activity Feed
        const { data: feed } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).order('clock_in_time', {ascending:false}).limit(5);
        let feedHTML = '';
        if(feed && feed.length > 0) {
            const feedUserIds = feed.map(f => f.user_id);
            const { data: feedProfiles } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', feedUserIds);
            const feedProfileMap = {};
            if(feedProfiles) feedProfiles.forEach(p => feedProfileMap[p.user_id] = p.full_name);

            feed.forEach(f => {
                const name = feedProfileMap[f.user_id] || 'Unknown User';
                feedHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); font-size:0.9rem;"><span style="font-weight:600; color:var(--primary)">${name}</span> clocked in via ${f.record_source} at ${new Date(f.clock_in_time).toLocaleTimeString()}</div>`;
            });
        } else {
            feedHTML = '<div style="padding:10px; color:var(--text-muted)">No recent activity</div>';
        }
        const activityDiv = document.getElementById('dash-activity');
        if(activityDiv) activityDiv.innerHTML = feedHTML;
    }

    // 1.5 EMPLOYEE DASHBOARD (New)
    async function renderEmployeeDashboard(container) {
        container.innerHTML = `
            <div class="page-title"><span>Welcome, <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span></div>
            <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-clock" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">On-Time Score</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">98%</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-money-check-dollar" style="font-size:2rem; color:var(--warning); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Latest Payslip</div>
                    <div style="font-size:1.5rem; color:white; margin-top:5px;">Processsed</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-list-check" style="font-size:2rem; color:var(--info); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Assigned Tasks</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">3 Pending</div>
                </div>
            </div>
            <div class="card" style="margin-top:20px; padding:40px; text-align:center;">
                <h3 style="margin-bottom:15px;">Quick Actions</h3>
                <button class="btn-primary" onclick="state.activeView='attendance'; renderSidebar(); renderMainContent();">Go to Time Clock</button>
            </div>
        `;
    }

    // 2. EMPLOYEES (Restored & Fixed Button Bug)
    async function loadEmployeesView(container) { 
        // FIX: Store the Header HTML in a variable first




        
        const header = `<div class="page-title">${i18n[state.lang].employees} <button class="btn-primary" onclick="openOnboardModal()"><i class="fa-solid fa-plus"></i> Onboard New Hire</button></div>`;
        
        container.innerHTML = `${header}<div class="card">Loading...</div>`; 
        
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('org_id', state.org.id); 
        if (error) { 
            container.innerHTML = `${header}<div class="card">Error: ${error.message}</div>`; 
            return; 
        }
        
        // FIX: Start the HTML string with the Header again, so it doesn't get wiped out
        let html = `${header}<div class="card"><table><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Details</th></tr></thead><tbody>`;
        
        data.forEach(emp => { 
            const meta = emp.meta_data || {}; 
            html += `<tr>
                <td>${emp.full_name}</td>
                <td>${emp.role}</td>
                <td>${emp.email}</td>
                <td>
                    <button class="btn-outline" style="font-size:0.75rem; padding:5px 10px; margin-right:5px;" onclick="openDocsModal('${emp.user_id}', '${emp.full_name}')"><i class="fa-solid fa-folder-open"></i> Docs</button>
                    <span class="details-btn" onclick="this.parentElement.querySelector('.details-json').style.display = 'block'">Meta</span>
                    <div class="details-json">${JSON.stringify(meta, null, 2)}</div>
                </td>
            </tr>`;

        }); 
        
        container.innerHTML = html + `</tbody></table></div>`; 
    }

    // 3. PAYROLL (Fixed Bad Request Error)
    async function renderPayrollUI(container) { 
        container.innerHTML = `<div class="page-title">Payroll Intelligence <button class="btn-primary" onclick="document.getElementById('payroll-file-input').click()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Payroll File</button><input type="file" id="payroll-file-input" style="display:none" accept=".csv, .xlsx, .xls" onchange="handlePayrollUpload(this)"></div><div class="payroll-layout"><div class="payroll-sidebar" id="payroll-history-list"><div class="card" style="text-align:center; padding:20px;">Loading History...</div></div><div class="payroll-main"><div id="payroll-loading" class="card hidden" style="text-align:center; padding:40px; justify-content:center;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i><h3 style="margin-top:20px;">AI Processing...</h3></div><div id="payroll-content" class="card" style="padding:0; overflow:hidden;"><div style="padding:50px; text-align:center; color:var(--text-muted)">Select a batch from history or upload a new file.</div></div></div></div>`; 
        const { data: history, error } = await supabaseClient.from('payroll_batch_summary').select('*').eq('org_id', state.org.id).order('created_at', { ascending: false }); 
        const historyList = document.getElementById('payroll-history-list'); 
        if (!historyList) return; // <--- THIS IS THE SAFETY CHECK YOU MUST ADD
        historyList.innerHTML = '';        if(error || !history || history.length === 0) { historyList.innerHTML = `<div class="card" style="padding:15px; text-align:center; color:var(--text-muted)">No upload history</div>`; return; } 
        history.forEach((batch, index) => { 
            const date = new Date(batch.created_at).toLocaleDateString(); const time = new Date(batch.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
            const div = document.createElement('div'); div.className = 'history-item'; 
            div.innerHTML = `<div class="history-date">${date} <span style="font-weight:400; font-size:0.8em; color:#aaa">${time}</span></div><div class="history-meta" style="margin-bottom:5px;"><span><i class="fa-solid fa-user"></i> ${batch.uploader_name || 'Unknown'}</span><span class="history-badge">AI Verified</span></div><div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-main);"><span>Employees: ${batch.employee_count}</span><span style="color:var(--success); font-weight:bold">$${batch.total_net_pay}</span></div>`; 
            div.onclick = () => loadBatchData(batch.id, div); historyList.appendChild(div); if(index === 0) loadBatchData(batch.id, div); 
        }); 
    }

    // 4. ATS (UPGRADED: With Active Jobs Sidebar)
    async function loadATSView(container) {
        container.innerHTML = `
            <div class="page-title">ATS Recruitment Pipeline <button class="btn-primary" onclick="openJobModal()"><i class="fa-solid fa-plus"></i> Post New Job</button></div>
            <div class="ats-layout">
                <div class="ats-sidebar">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">Active Jobs</div>
                    <div id="ats-jobs-list">Loading Jobs...</div>
                </div>
                <div class="ats-main-board" id="ats-board" style="flex-grow:1; display:flex; gap:20px; overflow-x:auto;">
                    <div class="card" style="width:100%; text-align:center;">Loading Pipeline...</div>
                </div>
            </div>`;

        // 1. Load Jobs Sidebar
        const { data: jobs } = await supabaseClient.from('ats_jobs').select('*').eq('org_id', state.org.id).order('created_at', {ascending:false});
        const jobListEl = document.getElementById('ats-jobs-list');
        if(jobs && jobs.length > 0) {
            jobListEl.innerHTML = '';
            jobs.forEach(job => {
                jobListEl.innerHTML += `<div class="ats-job-item">
                    <div class="ats-job-title">${job.title}</div>
                    <div class="ats-job-meta"><span>${job.department}</span><span style="color:var(--success)">${job.status}</span></div>
                </div>`;
            });
        } else {
            jobListEl.innerHTML = `<div style="font-size:0.8rem; color:var(--text-muted); padding:10px;">No jobs posted yet.</div>`;
        }

        // 2. Load Candidates Board
        const { data: candidates, error } = await supabaseClient.from('ats_applications').select('*, ats_jobs(title, department)').order('created_at', { ascending: false });
        if (error) { container.innerHTML += `<div class="card">Error loading pipeline</div>`; return; }
        
        const stages = ['Applied', 'Screening', 'Interview', 'Offer', 'Hired']; 
        const board = document.getElementById('ats-board'); 
        board.innerHTML = '';
        
        stages.forEach(stage => {
            const col = document.createElement('div'); col.className = 'ats-column'; const stageCandidates = candidates.filter(c => c.status === stage);
            col.innerHTML = `<div class="ats-col-header">${stage} <span class="ats-count">${stageCandidates.length}</span></div><div class="ats-cards" id="stage-${stage}"></div>`;
            const cardContainer = col.querySelector('.ats-cards');
            stageCandidates.forEach(cand => {
                const card = document.createElement('div'); card.className = 'ats-card'; card.draggable = true; let actionBtn = '';
                if (stage === 'Hired') actionBtn = `<button class="ats-btn-hire" onclick="promoteCandidateToEmployee('${cand.id}')">Promote to Employee</button>`;
                card.innerHTML = `<div class="ats-name">${cand.full_name}</div><div class="ats-role">${cand.ats_jobs?.title || 'General Application'}</div><div class="ats-actions">${actionBtn}<i class="fa-regular fa-eye icon-btn" onclick="showToast('View Details: ${cand.id}')" style="font-size:0.9rem;"></i></div>`;
                cardContainer.appendChild(card);
            }); board.appendChild(col);
        });
    }

    // New ATS Helper Functions
    function openJobModal() {
        document.getElementById('job-title').value = '';
        document.getElementById('job-dept').value = '';
        document.getElementById('job-salary').value = '';
        document.getElementById('job-status').value = 'Open';
        document.getElementById('job-modal').classList.remove('hidden');
    }

    async function saveNewJob() {
        const title = document.getElementById('job-title').value;
        const dept = document.getElementById('job-dept').value;
        const salary = document.getElementById('job-salary').value;
        const status = document.getElementById('job-status').value;

        if(!title || !dept) return showToast("Title and Department are required", true);

        const { error } = await supabaseClient.from('ats_jobs').insert({
            org_id: state.org.id,
            title: title,
            department: dept,
            salary_range: salary,
            status: status
        });

        if(error) return showToast("Failed to post job: " + error.message, true);
        
        showToast("Job Posted Successfully!");
        document.getElementById('job-modal').classList.add('hidden');
        loadATSView(document.getElementById('main-view')); // Refresh view to show new job
    }

    // 5. WFM (Restored)
    async function renderWFMUI(container) { 
        container.innerHTML = `<div class="page-title">Workforce Management <button class="btn-outline" onclick="document.getElementById('settings-modal').classList.remove('hidden')"><i class="fa-solid fa-gear"></i> Schedule Rules</button></div><div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;"><div class="card"><div class="card-title" style="margin-bottom:20px;">Intraday Adherence (Actual vs Scheduled)</div><div style="position: relative; height: 200px; width: 100%;"><canvas id="wfmChart"></canvas></div></div><div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column;"><div style="padding:20px; border-bottom:1px solid var(--glass-border); font-weight:bold; background:rgba(0,0,0,0.2);">Live Roster</div><div id="wfm-roster-list" style="overflow-y:auto; flex-grow:1; padding:10px;"><div style="text-align:center; padding:20px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div></div></div></div>`; 
        initWFMChart(); loadWFMRoster(); 
    }

    // 6. PERFORMANCE (UPGRADED: With Time Filters & Dependent Data)
    async function renderPerformanceUI(container) {
        container.innerHTML = `
            <div class="page-title">
                <div>Performance AI 
                    <div class="cycle-switch" style="display:inline-flex; margin-left:15px; vertical-align:middle;">
                        <button class="cycle-btn ${state.perfCycle==='Daily'?'active':''}" onclick="changePerfCycle('Daily')">Day</button>
                        <button class="cycle-btn ${state.perfCycle==='Weekly'?'active':''}" onclick="changePerfCycle('Weekly')">Week</button>
                        <button class="cycle-btn ${state.perfCycle==='Monthly'?'active':''}" onclick="changePerfCycle('Monthly')">Month</button>
                        <button class="cycle-btn ${state.perfCycle==='Quarterly'?'active':''}" onclick="changePerfCycle('Quarterly')">Qtr</button>
                    </div>
                </div>
                <button class="btn-primary" onclick="openPerformanceModal()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Data</button>
            </div>
            
            <div class="dashboard-grid" id="perf-dependent-stats">
               <div class="card">
                   <div class="card-title">Attendance Factor</div>
                   <div class="score-val" style="color:var(--success)">95%</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Avg On-Time Rate</div>
               </div>
               <div class="card">
                   <div class="card-title">Avg Payroll Bonus</div>
                   <div class="score-val" style="color:var(--warning)">$450</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Last Cycle</div>
               </div>
               <div class="card">
                   <div class="card-title">Manager AI Score</div>
                   <div class="score-val" style="color:var(--info)" id="ai-avg-score">--</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Based on Reviews</div>
               </div>
            </div>

            <div class="card" id="perf-content"><div style="padding:40px; text-align:center;">Loading Performance Data...</div></div>
        `;
        
        // Calculate Date Range based on selection
        let timeFilter = new Date();
        timeFilter.setHours(0,0,0,0); // Start of today default

        if(state.perfCycle === 'Daily') {
            // Already today
        } else if (state.perfCycle === 'Weekly') {
            timeFilter.setDate(timeFilter.getDate() - 7);
        } else if (state.perfCycle === 'Monthly') {
            timeFilter.setDate(timeFilter.getDate() - 30);
        } else if (state.perfCycle === 'Quarterly') {
            timeFilter.setDate(timeFilter.getDate() - 90);
        }

        const { data: reviews, error } = await supabaseClient
            .from('performance_reviews')
            .select(`*, profiles( full_name, email, role )`)
            .eq('org_id', state.org.id)
            .gte('period_start', timeFilter.toISOString())
            .order('score_final', { ascending: false });

        if (error) { 
            document.getElementById('perf-content').innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted)">Error loading data.</div>`; 
            return; 
        }
        
        // Calculate Avg AI Score if reviews exist
        if(reviews && reviews.length > 0) {
            const avgScore = (reviews.reduce((sum, r) => sum + (r.score_final || 0), 0) / reviews.length).toFixed(1);
            const scoreEl = document.getElementById('ai-avg-score');
            if(scoreEl) scoreEl.innerText = avgScore;
        }

        renderPerformanceTable(reviews);
    }

    // 7. REPORTS (Restored)
    async function renderReportsUI(container) { 
        container.innerHTML = `<div class="page-title">Strategic Reports <button class="btn-outline" onclick="exportReportsSummary()"><i class="fa-solid fa-download"></i> Export Summary</button></div><div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;"><div class="card"><div class="card-title">Burnout Risk (Hours Worked vs Scheduled)</div><canvas id="burnoutChart" height="200"></canvas></div><div class="card"><div class="card-title">Department Efficiency</div><canvas id="efficiencyChart" height="200"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Labor ROI Analysis</div><span class="badge" style="position:static; background:var(--info)">Live Data</span></div><div style="overflow-x:auto;"><table id="roi-table"><thead><tr><th>Employee</th><th>Role</th><th>Monthly Cost</th><th>Productivity</th><th>ROI Factor</th><th>Risk Status</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody></table></div></div>`; 
        const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
        if(error || !reports) { document.querySelector('#roi-table tbody').innerHTML = '<tr><td colspan="6" style="color:red">View not ready. Run SQL.</td></tr>'; return; }
        
        // SAFETY FIX: Wait for DOM
        setTimeout(() => { initReportCharts(reports); }, 100);
        renderROITable(reports); 
    }

    // 8. ATTENDANCE (Restored)
    async function renderAttendanceUI(container) {
        const { data: activity } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).is('clock_out_time', null).maybeSingle();
        const isClockedIn = !!activity;
        const startTime = activity ? new Date(activity.clock_in_time) : null;
        let durationHTML = '';
        if (isClockedIn) {
            const diffMs = new Date() - startTime; const hrs = Math.floor(diffMs / 3600000); const mins = Math.floor((diffMs % 3600000) / 60000);
            durationHTML = `<div style="text-align:center; margin-bottom:20px;"><div style="font-size:3rem; font-weight:700; color:var(--success); text-shadow:0 0 20px rgba(46,204,113,0.4);">${hrs}h ${mins}m</div><div class="perf-badge" style="background:rgba(46,204,113,0.2); color:var(--success);">Active Session</div></div>`;
        }
        const isAdmin = ['ceo','admin','hr_manager'].includes(state.profile.role);
        let adminControls = '';
        if(isAdmin) {
            adminControls = `<div class="card" style="margin-top:25px; height:500px;"><div class="card-header"><div class="card-title">Live Organization Map (Last Known Locations)</div><button class="btn-outline" onclick="handleExportAttendance()"><i class="fa-solid fa-download"></i> Export CSV Dump</button></div><div id="work-map" style="width:100%; height:100%; border-radius:12px; z-index:1;"></div></div>`;
        }
        container.innerHTML = `<div class="page-title">Smart Attendance Workspace ${isAdmin ? `<button class="btn-outline" onclick="document.getElementById('import-modal').classList.remove('hidden')"><i class="fa-solid fa-file-import"></i> Import Legacy</button>` : ''}</div><div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;"><div class="card" style="align-items:center; justify-content:center; position:relative; overflow:hidden;">${durationHTML}<div id="camera-preview" class="hidden" style="width:100%; max-width:300px; border-radius:12px; margin-bottom:15px; border:2px solid var(--primary);"><video id="vid" autoplay style="width:100%; border-radius:10px;"></video></div>${!isClockedIn ? `<button id="btn-scan" class="btn-primary" style="padding:15px 40px; font-size:1.2rem;" onclick="startClockInFlow()"><i class="fa-solid fa-fingerprint"></i> Biometric Clock In</button><div id="loc-status" style="margin-top:10px; color:var(--text-muted); font-size:0.8rem;"><i class="fa-solid fa-location-dot"></i> Waiting for GPS...</div>` : `<button class="btn-outline" style="border-color:var(--danger); color:var(--danger); padding:15px 40px;" onclick="handleClockOut('${activity.id}')"><i class="fa-solid fa-power-off"></i> End Shift</button>`}</div><div class="card" style="overflow-y:auto"><div class="card-title">My Recent Activity</div><div id="attendance-history" style="margin-top:15px;">Loading...</div></div></div>${adminControls}`;
        loadAttendanceHistory();
        if(isAdmin) setTimeout(initLiveMap, 500); 
    }

    // --- NEW: ORG PROFILE (CEO ONLY) ---
    async function renderOrgProfile(container) {
        if(!await checkRoleAccess(['ceo'])) return;

        container.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Enterprise Settings...</div>`;
        
        // Fetch fresh org data
        const { data: org, error } = await supabaseClient.from('organizations').select('*').eq('id', state.org.id).single();
        if(error) return showToast("Failed to load org data", true);

        // Parse JSON settings safely
        const security = org.security_settings || { mfa_enforced: false, session_timeout: 30 };
        const retention = org.retention_policy || { cv_months: 12, logs_months: 24 };

        container.innerHTML = `
            <div class="page-title">Organization Settings <span class="badge" style="position:static; font-size:0.9rem; background:var(--info)">Enterprise Tier</span></div>
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fa-solid fa-building"></i> Identity</div></div>
                    <div class="form-group">
                        <label>Organization Name</label>
                        <input type="text" id="set-org-name" class="form-input" value="${org.name}">
                    </div>
                    <div class="form-group">
                        <label>CEO / Owner</label>
                        <input type="text" class="form-input" value="${state.profile.full_name}" disabled style="opacity:0.5">
                    </div>
                    <button class="btn-primary" onclick="saveOrgIdentity()">Save Changes</button>
                </div>

                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fa-solid fa-shield-halved"></i> Security & Compliance</div></div>
                    
                    <div class="settings-section">
                        <div class="settings-header"><i class="fa-solid fa-user-lock"></i> Access Control</div>
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                            <span>Enforce 2FA (MFA)</span>
                            <input type="checkbox" id="set-mfa" ${security.mfa_enforced ? 'checked' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Session Timeout (Minutes)</label>
                            <input type="number" id="set-timeout" class="form-input" value="${security.session_timeout}">
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-header"><i class="fa-solid fa-database"></i> Data Retention (GDPR)</div>
                        <div class="form-group">
                            <label>Delete CVs after (Months)</label>
                            <input type="number" id="set-ret-cv" class="form-input" value="${retention.cv_months}">
                        </div>
                        <div class="form-group">
                            <label>Delete Audit Logs after (Months)</label>
                            <input type="number" id="set-ret-logs" class="form-input" value="${retention.logs_months}">
                        </div>
                    </div>
                    
                    <button class="btn-outline" style="width:100%; border-color:var(--success); color:var(--success)" onclick="saveSecuritySettings()">Update Compliance Rules</button>
                </div>
            </div>
            
            <div class="card" style="margin-top:20px;">
                <div class="card-header"><div class="card-title">Audit Trail (Recent Sensitive Actions)</div></div>
                <div id="audit-list">Loading logs...</div>
            </div>
        `;
        
        loadAuditLogs();
    }

    async function loadAuditLogs() {
        // FIX 1: Safety Check - Ensure element exists before loading
        const listContainer = document.getElementById('audit-list');
        if(!listContainer) return; 

        const { data: logs } = await supabaseClient.from('audit_logs').select('actor_id, action_type, target_record, created_at').eq('org_id', state.org.id).order('created_at', {ascending:false}).limit(10);
        let html = `<table style="font-size:0.9rem;"><thead><tr><th>Actor</th><th>Action</th><th>Target</th><th>Time</th></tr></thead><tbody>`;
        if(logs && logs.length > 0) {
            const actorIds = logs.map(l => l.actor_id);
            const { data: actors } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', actorIds);
            const actorMap = {};
            if(actors) actors.forEach(a => actorMap[a.user_id] = a.full_name);
            logs.forEach(l => {
                const name = actorMap[l.actor_id] || 'System';
                html += `<tr><td>${name}</td><td>${l.action_type}</td><td>${l.target_record || '-'}</td><td>${new Date(l.created_at).toLocaleString()}</td></tr>`;
            });
        } else { html += `<tr><td colspan="4" style="text-align:center">No logs found</td></tr>`; }
        html += `</tbody></table>`;
        
        // FIX 1: Use variable, don't query DOM again
        listContainer.innerHTML = html;
    }

    // --- SAVE FUNCTIONS (CEO ONLY) ---
    window.saveOrgIdentity = async function() {
        const newName = document.getElementById('set-org-name').value;
        const { error } = await supabaseClient.from('organizations').update({ name: newName }).eq('id', state.org.id);
        if(error) return showToast("Update Failed: " + error.message, true);
        await logSystemAction('UPDATE_ORG_IDENTITY', state.org.id, { old: state.org.name, new: newName });
        state.org.name = newName;
        showToast("Organization Updated");
        loadAuditLogs();
    }

    window.saveSecuritySettings = async function() {
        const settings = {
            security_settings: {
                mfa_enforced: document.getElementById('set-mfa').checked,
                session_timeout: parseInt(document.getElementById('set-timeout').value)
            },
            retention_policy: {
                cv_months: parseInt(document.getElementById('set-ret-cv').value),
                logs_months: parseInt(document.getElementById('set-ret-logs').value)
            }
        };
        const { error } = await supabaseClient.from('organizations').update(settings).eq('id', state.org.id);
        if(error) return showToast("Security Update Failed", true);
        await logSystemAction('UPDATE_SECURITY_POLICY', state.org.id, settings);
        showToast("Compliance Rules Saved");
        loadAuditLogs();
    }

    // --- MAIN ROUTER ---
    function renderMainContent() {
        const view = state.activeView; const main = document.getElementById('main-view'); if(!main) return; main.innerHTML = ''; 
        if(view === 'dashboard') loadDashboardView(main);
        else if(view === 'employee_dash') renderEmployeeDashboard(main); // NEW EMPLOYEE DASH
        else if(view === 'org_profile') renderOrgProfile(main); 
        else if(view === 'employees') { if(['ceo','hr_manager','manager'].includes(state.profile.role)) loadEmployeesView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'payroll') { if(['ceo','hr_manager'].includes(state.profile.role)) renderPayrollUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'wfm') { if(['ceo','admin','manager'].includes(state.profile.role)) renderWFMUI(main); else renderEmployeeWFM(main); }
        else if(view === 'reports') { if(['ceo','admin'].includes(state.profile.role)) renderReportsUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'ats') { if(['ceo','admin','hr_manager'].includes(state.profile.role)) loadATSView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'performance') { if(['ceo','admin','hr_manager','manager'].includes(state.profile.role)) renderPerformanceUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'attendance') { renderAttendanceUI(main); }
        else main.innerHTML = `<div class="card"><h2>${view.toUpperCase()}</h2><p>Module active for ${state.profile.role}</p></div>`;
    }

    // --- RBAC HIERARCHY SIDEBAR ---
    function renderSidebar() {
        const t = i18n[state.lang]; const role = state.profile.role; 
        const container = document.getElementById('nav-container'); if(!container) return; container.innerHTML = '';
        
        // 0. EMPLOYEE VIEW
        if (role === 'employee') {
             const ul = document.createElement('ul'); ul.className = 'nav-links';
             ul.innerHTML += `<li class="nav-item ${state.activeView==='employee_dash'?'active':''}" onclick="state.activeView='employee_dash';renderSidebar();renderMainContent()"><i class="fa-solid fa-home"></i> <span>My Home</span></li>`;
             ul.innerHTML += `<li class="nav-item ${state.activeView==='attendance'?'active':''}" onclick="state.activeView='attendance';renderSidebar();renderMainContent()"><i class="fa-solid fa-clock"></i> <span>Time Clock</span></li>`;
             container.appendChild(ul);
             return;
        }

        // 1. EXECUTIVE SUITE (CEO + ADMIN + HR MANAGER now included for Dashboard)
        // MODIFICATION 1: Expanded access here so HR Manager sees Dashboard
        if (['ceo', 'admin', 'hr_manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">Executive Suite</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            ul.innerHTML += `<li class="nav-item ${state.activeView==='dashboard'?'active':''}" onclick="state.activeView='dashboard';renderSidebar();renderMainContent()"><i class="fa-solid fa-chart-pie"></i> <span>${t.dashboard}</span></li>`;
            
            // CEO Only: Org Settings
            if (role === 'ceo') {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='org_profile'?'active':''}" onclick="state.activeView='org_profile';renderSidebar();renderMainContent()"><i class="fa-solid fa-building-shield"></i> <span>${t.org_profile}</span></li>`;
            }
            
            // Reports for CEO/Admin only (kept strictly private)
            if (['ceo', 'admin'].includes(role)) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='reports'?'active':''}" onclick="state.activeView='reports';renderSidebar();renderMainContent()"><i class="fa-solid fa-file-alt"></i> <span>${t.reports}</span></li>`;
            }
            sec.appendChild(ul); container.appendChild(sec);
        }

        // 2. HR OPS (CEO + HR Manager)
        if (['ceo', 'admin', 'hr_manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">HR Operations</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            ul.innerHTML += `<li class="nav-item ${state.activeView==='employees'?'active':''}" onclick="state.activeView='employees';renderSidebar();renderMainContent()"><i class="fa-solid fa-users"></i> <span>${t.employees}</span></li>`;
            
            // Payroll restricted to CEO/HR
            if(['ceo','hr_manager'].includes(role)) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='payroll'?'active':''}" onclick="state.activeView='payroll';renderSidebar();renderMainContent()"><i class="fa-solid fa-money-bill-wave"></i> <span>${t.payroll}</span></li>`;
            }
            
            ul.innerHTML += `<li class="nav-item ${state.activeView==='ats'?'active':''}" onclick="state.activeView='ats';renderSidebar();renderMainContent()"><i class="fa-solid fa-briefcase"></i> <span>${t.ats}</span></li>`;
            sec.appendChild(ul); container.appendChild(sec);
        }

        // 3. TEAM OPS (CEO + HR + Manager)
       // --- 2. REPLACE THE 'TEAM OPS' SECTION IN renderSidebar() ---

        // 3. TEAM OPS (Gated by Bundle)
        if (['ceo', 'admin', 'hr_manager', 'manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">Team Management</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            
            // Only show WFM if they have the Bundle
            if (hasAccess('wfm')) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='wfm'?'active':''}" onclick="state.activeView='wfm';renderSidebar();renderMainContent()"><i class="fa-solid fa-timeline"></i> <span>${t.wfm}</span></li>`;
            } else {
                // locked item
                ul.innerHTML += `<li class="nav-item" style="opacity:0.5; cursor:not-allowed;" onclick="showToast('Upgrade to Growth Bundle to access WFM', true)"><i class="fa-solid fa-lock"></i> <span>${t.wfm}</span></li>`;
            }

            if (hasAccess('ats')) { // ATS is now gated too
                 ul.innerHTML += `<li class="nav-item ${state.activeView==='ats'?'active':''}" onclick="state.activeView='ats';renderSidebar();renderMainContent()"><i class="fa-solid fa-briefcase"></i> <span>${t.ats}</span></li>`;
            }

            ul.innerHTML += `<li class="nav-item ${state.activeView==='performance'?'active':''}" onclick="state.activeView='performance';renderSidebar();renderMainContent()"><i class="fa-solid fa-star"></i> <span>${t.performance}</span></li>`;
            
            sec.appendChild(ul); container.appendChild(sec);
        }
        // 4. WORKSPACE (Everyone)
        const sec = document.createElement('div');
        sec.innerHTML = `<div class="nav-header">My Workspace</div>`;
        const ul = document.createElement('ul'); ul.className = 'nav-links';
        ul.innerHTML += `<li class="nav-item ${state.activeView==='attendance'?'active':''}" onclick="state.activeView='attendance';renderSidebar();renderMainContent()"><i class="fa-solid fa-clock"></i> <span>${t.attendance}</span></li>`;
        sec.appendChild(ul); container.appendChild(sec);
    }

    function exportDashboardPDF() {
        const element = document.getElementById('dash-content');
        const opt = { margin: 10, filename: `Dashboard_Snapshot_${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, backgroundColor: '#0f2027' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
        html2pdf().set(opt).from(element).save();
    }

    // --- ADD THIS FUNCTION TO FIX REPORTS EXPORT ---
    window.exportReportsSummary = async function() {
        const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
        if(error || !reports) return showToast("No data found to export", true);
        
        let csvContent = "data:text/csv;charset=utf-8,Employee,Role,Productivity Score,Total Cost,ROI Status\n";
        
        reports.forEach(r => {
            const row = `${r.full_name},${r.role},${r.productivity_score},${r.total_cost},Healthy`;
            csvContent += row + "\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Strategy_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- ADD THIS FUNCTION TO FIX ATTENDANCE EXPORT ---
   // --- UPDATED FIX FOR ATTENDANCE EXPORT (Safe Mode) ---
    window.handleExportAttendance = async function() {
        showToast("Generating CSV...");
        
        // Step 1: Fetch the raw logs WITHOUT trying to join tables
        const { data: logs, error } = await supabaseClient
            .from('wfm_activity')
            .select('*') 
            .eq('org_id', state.org.id)
            .order('clock_in_time', { ascending: false });

        if(error || !logs) {
            console.error("Export Error:", error);
            return showToast("Export Failed: " + (error?.message || "Unknown"), true);
        }

        // Step 2: Fetch the user names manually (prevents 400 Error)
        const userIds = [...new Set(logs.map(l => l.user_id))]; // Get unique User IDs
        const { data: profiles } = await supabaseClient
            .from('profiles')
            .select('user_id, full_name')
            .in('user_id', userIds);

        // Create a fast lookup map: ID -> Name
        const profileMap = {};
        if (profiles) {
            profiles.forEach(p => profileMap[p.user_id] = p.full_name);
        }

        // Step 3: Build the CSV using the map
        let csv = "data:text/csv;charset=utf-8,Employee,Date,Time In,Time Out,Status,Source\n";
        
        logs.forEach(l => {
            const name = profileMap[l.user_id] || 'Unknown User';
            const date = new Date(l.clock_in_time).toLocaleDateString();
            const timeIn = new Date(l.clock_in_time).toLocaleTimeString();
            const timeOut = l.clock_out_time ? new Date(l.clock_out_time).toLocaleTimeString() : 'Active';
            
            // Clean comma from names to avoid breaking CSV format
            const cleanName = name.replace(/,/g, " ");
            
            csv += `${cleanName},${date},${timeIn},${timeOut},${l.current_status},${l.record_source}\n`;
        });

        const encodedUri = encodeURI(csv);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Attendance_Log_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- OTHER HELPERS ---
    async function loadBatchData(batchId, element) { document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active')); if(element) element.classList.add('active'); const content = document.getElementById('payroll-content'); content.innerHTML = `<div style="padding:50px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Data...</div>`; const { data, error } = await supabaseClient.from('payroll_items').select('*').eq('batch_id', batchId).order('employee_name', { ascending: true }); if(error) { content.innerHTML = `<div style="padding:20px; color:var(--danger)">Error loading data</div>`; return; } renderPayrollTable(data, false); }
    async function handlePayrollUpload(input) { 
        const file = input.files[0]; 
        if(!file) return; 
        
        document.getElementById('payroll-content').classList.add('hidden'); 
        document.getElementById('payroll-loading').classList.remove('hidden'); 
        
        try { 
            const fileName = `${Date.now()}_${file.name}`; 
            
            // Upload File
            const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file); 
            if(uploadError) throw uploadError; 
            
            const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName); 
            
            // FIX: Simplified Insert to avoid 'app_role' type mismatch from trigger
            // The RLS check (auth.uid) will happen automatically. We don't need complex selects here.
            const { data: batchData, error: batchError } = await supabaseClient
                .from('payroll_batches')
                .insert({ 
                    org_id: state.org.id, 
                    uploaded_by: state.user.id, 
                    file_url: publicUrl, 
                    status: 'processing' 
                })
                .select()
                .single(); 
            
            if(batchError) {
                // Specific handling for RLS type errors
                if(batchError.code === '42804') {
                    throw new Error("Database Type Mismatch. Please ask admin to check 'get_my_profile_safe' return type.");
                }
                throw batchError; 
            }
            
            // Call AI
            const n8nResponse = await fetch(N8N_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ file_url: publicUrl, org_id: state.org.id, batch_id: batchData.id }) }); 
            if(!n8nResponse.ok) throw new Error("AI Analysis Failed"); 
            let aiData = await n8nResponse.json(); 
            if (typeof aiData === 'string') { try { aiData = JSON.parse(aiData); } catch(e) {} } 
            if (!Array.isArray(aiData)) { aiData = (aiData && typeof aiData === 'object') ? [aiData] : []; } 
            
            const itemsToInsert = aiData.map(item => ({ batch_id: batchData.id, employee_name: item.employee_name || 'Unknown', salary: item.salary || 0, bonus: item.bonus || 0, deductions: item.deductions || 0, net_pay: (item.salary || 0) + (item.bonus || 0) - (item.deductions || 0) })); 
            
            if(itemsToInsert.length > 0) { 
                const { data: savedItems, error: itemsError } = await supabaseClient.from('payroll_items').insert(itemsToInsert).select(); 
                if(itemsError) throw itemsError; 
                renderPayrollUI(document.getElementById('main-view')); 
            } else { 
                showToast("AI found no valid data", true); 
                renderPayrollUI(document.getElementById('main-view')); 
            } 
        } catch(err) { 
            console.error(err); 
            showToast(err.message, true); 
            renderPayrollUI(document.getElementById('main-view')); 
        } 
    }

    

    
    async function updatePayrollItem(id, field, newValue, oldValue) { if(newValue === oldValue) return; try { await supabaseClient.from('payroll_items').update({ [field]: newValue }).eq('id', id); await supabaseClient.from('payroll_history').insert({ item_id: id, changed_by: state.user.id, field_changed: field, old_value: oldValue, new_value: newValue }); showToast("Updated"); } catch(err) { showToast("Update Failed", true); } }
    function changePerfCycle(cycle) { state.perfCycle = cycle; renderPerformanceUI(document.getElementById('main-view')); }
    function openPerformanceModal() { document.getElementById('perf-modal').classList.remove('hidden'); }
    function setPerfInput(mode) { state.perfInputMode = mode; const btnFile = document.getElementById('btn-file-mode'); const btnManual = document.getElementById('btn-manual-mode'); const boxFile = document.getElementById('perf-input-file'); const boxManual = document.getElementById('perf-input-manual'); if (mode === 'file') { btnFile.style.borderColor = 'var(--primary)'; btnManual.style.borderColor = 'var(--glass-border)'; boxFile.classList.remove('hidden'); boxManual.classList.add('hidden'); } else { btnManual.style.borderColor = 'var(--primary)'; btnFile.style.borderColor = 'var(--glass-border)'; boxManual.classList.remove('hidden'); boxFile.classList.add('hidden'); } }
    async function handlePerformanceSubmit() { const btn = document.querySelector('#perf-modal .btn-primary'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...'; try { const dept = document.getElementById('perf-dept').value; let payloadData = ""; if (state.perfInputMode === 'file') { const fileInput = document.getElementById('perf-file'); if (!fileInput.files.length) throw new Error("Please select a file."); const file = fileInput.files[0]; const fileName = `perf_${Date.now()}_${file.name}`; const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file); if (uploadError) throw uploadError; const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName); payloadData = publicUrl; } else { payloadData = document.getElementById('perf-text').value; if (!payloadData) throw new Error("Please enter text logs."); } const response = await fetch(N8N_PERF_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "analyze_performance", org_id: state.org.id, department: dept, review_period: state.perfCycle, input_type: state.perfInputMode, data_content: payloadData }) }); if (!response.ok) throw new Error("AI Analysis Failed"); let aiResponse = await response.json(); if (Array.isArray(aiResponse) && aiResponse.length > 0) aiResponse = aiResponse[0]; if (typeof aiResponse === 'string') try { aiResponse = JSON.parse(aiResponse); } catch(e) {} const results = aiResponse.results || []; if (results.length === 0) throw new Error("AI returned no results."); let successCount = 0; for (const res of results) { const { data: userProfile } = await supabaseClient.from('profiles').select('user_id').eq('email', res.email).maybeSingle(); if (userProfile) { await supabaseClient.from('performance_reviews').insert({ org_id: state.org.id, user_id: userProfile.user_id, review_period: state.perfCycle, period_start: new Date(), period_end: new Date(), score_quality: res.score_quality || 0, score_speed: res.score_speed || 0, score_teamwork: res.score_teamwork || 0, score_efficiency: res.score_efficiency || 0, score_final: res.score_final || 0, ai_feedback: res.ai_feedback || "No feedback.", raw_data_source: state.perfInputMode }); successCount++; } } showToast(`Success! Saved ${successCount} reviews.`); document.getElementById('perf-modal').classList.add('hidden'); renderPerformanceUI(document.getElementById('main-view')); } catch (err) { console.error(err); showToast(err.message, true); } finally { btn.innerHTML = oldText; } }
    async function promoteCandidateToEmployee(candidateId) { const { data: candidate, error } = await supabaseClient.from('ats_applications').select('*, ats_jobs(title, department)').eq('id', candidateId).single(); if (error) { showToast("Error fetching details", true); return; } openOnboardModal(); document.getElementById('new-name').value = candidate.full_name; document.getElementById('new-email').value = candidate.email; document.getElementById('new-meta-phone').value = candidate.phone || ''; document.getElementById('new-meta-dept').value = candidate.ats_jobs?.department || ''; showToast("Candidate data pre-filled. Please set a password."); }
    function openOnboardModal() { const sel = document.getElementById('new-role'); sel.innerHTML=''; ['hr_manager','manager','employee'].forEach(r=>sel.innerHTML+=`<option value="${r}">${r}</option>`); document.getElementById('onboard-modal').classList.remove('hidden'); }
    function closeOnboardModal() { document.getElementById('onboard-modal').classList.add('hidden'); }
    async function executeOnboard() { const fullName = document.getElementById('new-name').value; const email = document.getElementById('new-email').value; const password = document.getElementById('new-pass').value; const role = document.getElementById('new-role').value; const phone = document.getElementById('new-meta-phone').value; const dept = document.getElementById('new-meta-dept').value; if(!fullName || !email || !password) { showToast("Fields Required", true); return; } const metaData = {}; if(phone) metaData.phone = phone; if(dept) metaData.department = dept; const btn = document.querySelector('#onboard-modal .btn-primary'); const oldText = btn.innerText; btn.innerText = "Creating..."; try { const dummyStorage = { getItem: () => null, setItem: () => {}, removeItem: () => {} }; const tempClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: false, storage: dummyStorage, autoRefreshToken: false, detectSessionInUrl: false } }); const { data: authData, error: authError } = await tempClient.auth.signUp({ email: email, password: password, options: { data: { full_name: fullName } } }); if (authError) throw authError; if (!authData.user) throw new Error("Auth Failed"); const { error: profileError } = await supabaseClient.rpc('admin_create_profile', { target_user_id: authData.user.id, user_email: email, full_name: fullName, user_role: role, target_org_id: state.org.id, user_meta: metaData, avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random` }); if (profileError) throw profileError; showToast(`Success! User created: ${email}`); closeOnboardModal(); loadEmployeesView(document.getElementById('main-view')); } catch (err) { console.error(err); showToast(err.message, true); } finally { btn.innerText = oldText; } }
    async function renderEmployeeWFM(container) { container.innerHTML = `<div class="page-title">My Schedule</div><div class="card" style="text-align:center; padding:50px;"><h2>09:00 AM - 05:00 PM</h2><p style="color:var(--text-muted); margin-bottom:20px;">Today's Shift</p><button class="btn-primary" onclick="showToast('Use Attendance Tab to Clock In')">Go to Attendance</button></div>`; }
    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) { var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1); var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); var d = R * c; return d * 1000; }
    function deg2rad(deg) { return deg * (Math.PI/180); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function showToast(msg, isError = false) { const t = document.getElementById('toast'); if(!t) return; document.getElementById('toast-msg').innerText = msg; t.style.background = isError ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)'; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function toggleLang() { state.lang = state.lang === 'en' ? 'ar' : 'en'; document.documentElement.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr'); renderSidebar(); renderMainContent(); }
    // --- 5. NEW HELPER FUNCTIONS (Paste at bottom of script) ---

    // DOCS LOGIC
    let activeDocUserId = null;
    
    window.openDocsModal = async function(userId, name) {
        activeDocUserId = userId;
        document.getElementById('docs-user-name').innerText = name;
        document.getElementById('docs-modal').classList.remove('hidden');
        loadDocsList(userId);
    }

    async function loadDocsList(userId) {
        const list = document.getElementById('docs-list');
        list.innerHTML = '<div style="text-align:center"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        
        const { data: docs } = await supabaseClient.from('employee_documents').select('*').eq('profile_id', userId);
        
        if(!docs || docs.length === 0) {
            list.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">No documents tracked.</div>';
            return;
        }

        let html = '';
        docs.forEach(d => {
            const isExpired = d.expiry_date ? new Date(d.expiry_date) < new Date() : false;
            const style = isExpired ? 'color:var(--danger); font-weight:bold;' : 'color:var(--success)';
            const linkHtml = d.external_link ? `<a href="${d.external_link}" target="_blank" style="color:var(--primary)"><i class="fa-solid fa-link"></i></a>` : '';
            
            html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--glass-border); align-items:center;">
                <span>${d.document_type}</span>
                <span style="${style}">${d.expiry_date || 'No Expiry'}</span>
                ${linkHtml}
            </div>`;
        });
        list.innerHTML = html;
    }

    window.saveEmployeeDoc = async function() {
        const type = document.getElementById('doc-type').value;
        const expiry = document.getElementById('doc-expiry').value;
        const link = document.getElementById('doc-link').value;
        const isChecklist = document.getElementById('doc-checklist').checked;

        if(!type) return showToast("Type is required", true);

        const { error } = await supabaseClient.from('employee_documents').insert({
            org_id: state.org.id,
            profile_id: activeDocUserId, // Uses the global variable set on open
            document_type: type,
            expiry_date: expiry || null,
            external_link: link || null,
            is_checklist_only: isChecklist
        });

        if(error) showToast("Error: " + error.message, true);
        else {
            showToast("Document Saved");
            loadDocsList(activeDocUserId); // Refresh list
            // Clear inputs
            document.getElementById('doc-type').value = '';
            document.getElementById('doc-link').value = '';
        }
    }

    // BROADCAST LOGIC
    window.sendBroadcast = async function() {
        const subject = document.getElementById('bc-subject').value;
        const msg = document.getElementById('bc-msg').value;
        const severity = document.getElementById('bc-severity').value;

        if(!msg) return showToast("Message required", true);

        const { error } = await supabaseClient.from('broadcast_messages').insert({
            org_id: state.org.id,
            sender_id: state.user.id,
            subject: subject,
            content: msg,
            severity: severity,
            target_roles: ['all']
        });

        if(error) showToast("Failed: " + error.message, true);
        else {
            showToast("Announcement Sent");
            document.getElementById('broadcast-modal').classList.add('hidden');
            loadDashboardView(document.getElementById('main-view')); // Refresh dash
        }
    }
    // --- AI ASSISTANT LOGIC ---
    function toggleAiWidget() {
        const win = document.getElementById('ai-window');
        win.classList.toggle('hidden');
        if(!win.classList.contains('hidden')) updateAiCredits();
    }

    async function updateAiCredits() {
        if(!state.org) return;
        // Uses the column 'ai_credits_balance' we added to DB
        const { data } = await supabaseClient.from('organizations').select('ai_credits_balance').eq('id', state.org.id).single();
        if(data) document.getElementById('ai-credits').innerText = `${data.ai_credits_balance || 0} Credits`;
    }

    async function sendAiMessage() {
        const input = document.getElementById('ai-input');
        const text = input.value;
        if(!text) return;

        // UI: Add User Message
        const body = document.getElementById('ai-chat-body');
        body.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><div style="background:var(--primary); color:white; padding:8px 12px; border-radius:10px; display:inline-block;">${text}</div></div>`;
        input.value = '';
        body.scrollTop = body.scrollHeight;

        // Logic: Call N8N or Mock Response
        // Note: You need to replace this URL with your actual AI Webhook if you have one separate from Payroll
        try {
            // Simulating API call...
            body.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><div style="background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:10px; display:inline-block;"><i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...</div></div>`;
            
            // For now, simple mock response to prove it works. 
            // Replace with fetch(N8N_WEBHOOK...) when ready.
            setTimeout(() => {
                body.lastElementChild.innerHTML = `<div style="background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:10px; display:inline-block;">I've received your request: "${text}". (Connect N8N to process real answers!)</div>`;
            }, 1000);

        } catch(e) {
            console.error(e);
        }
    }
</script>
    <div id="docs-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Employee Documents <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('docs-modal').classList.add('hidden')"></i></div>
            <h4 id="docs-user-name" style="color:var(--primary); margin-bottom:15px;"></h4>
            <div id="docs-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                <div style="font-weight:700; margin-bottom:10px;">Add New Document</div>
                <div class="form-group"><input type="text" id="doc-type" class="form-input" placeholder="Document Name (e.g. Passport)"></div>
                <div class="form-group"><input type="date" id="doc-expiry" class="form-input"></div>
                <div class="form-group"><input type="text" id="doc-link" class="form-input" placeholder="External Drive Link (Optional)"></div>
                <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" id="doc-checklist"> <label for="doc-checklist">Checklist Item Only (No File)</label>
                </div>
                <button class="btn-primary" style="width:100%" onclick="saveEmployeeDoc()">Save Record</button>
            </div>
        </div>
    </div>

    <div id="broadcast-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Send Company Announcement <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('broadcast-modal').classList.add('hidden')"></i></div>
            <div class="form-group"><label>Subject</label><input type="text" id="bc-subject" class="form-input"></div>
            <div class="form-group"><label>Message</label><textarea id="bc-msg" class="form-input" rows="4"></textarea></div>
            <div class="form-group"><label>Type</label>
                <select id="bc-severity" class="form-input" style="background:var(--sidebar-bg)">
                    <option value="info">General Info (Blue)</option>
                    <option value="urgent">Urgent Alert (Red)</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%" onclick="sendBroadcast()">Post Announcement</button>
        </div>
    </div>
    <div id="ai-widget" style="position:fixed; bottom:30px; left:30px; z-index:9999; display:flex; flex-direction:column; align-items:flex-start; gap:10px;">
    <div id="ai-window" class="hidden card" style="width:300px; height:400px; padding:0; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
        <div style="background:var(--primary); padding:15px; color:white; font-weight:bold; display:flex; justify-content:space-between;">
            <span><i class="fa-solid fa-robot"></i> HR Assistant</span>
            <span style="font-size:0.8rem; opacity:0.8" id="ai-credits">0 Credits</span>
        </div>
        <div id="ai-chat-body" style="flex-grow:1; background:rgba(0,0,0,0.2); padding:15px; overflow-y:auto; font-size:0.9rem;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:10px; margin-bottom:10px; display:inline-block;">
                Hello! I can help you draft emails, check policies, or analyze data.
            </div>
        </div>
        <div style="padding:10px; background:var(--glass-bg); display:flex; gap:5px; border-top:1px solid var(--glass-border);">
            <input type="text" id="ai-input" class="table-input" placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendAiMessage()">
            <button class="btn-primary" style="padding:8px 15px;" onclick="sendAiMessage()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
    
    <button onclick="toggleAiWidget()" style="width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #8e44ad, #9b59b6); border:none; color:white; font-size:1.5rem; cursor:pointer; box-shadow:0 5px 20px rgba(142, 68, 173, 0.4); display:flex; align-items:center; justify-content:center; transition:transform 0.2s;">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
</div>
    <div id="setup-modal" class="modal-overlay hidden">
    <div class="modal-card" style="text-align:center;">
        <i class="fa-solid fa-handshake" style="font-size:3rem; color:var(--success); margin-bottom:20px;"></i>
        <div class="modal-title" style="border:none; justify-content:center;">Welcome to Digitivia!</div>
        <p style="color:var(--text-muted); margin-bottom:25px; line-height:1.6;">
            We are thrilled to have you. To ensure your HR data is migrated correctly, we offer <b>2 Free Setup Calls</b> (30 mins each).
        </p>
        <div style="display:grid; gap:10px;">
            <a href="https://calendly.com" target="_blank" class="btn-primary" style="justify-content:center; text-decoration:none;">
                <i class="fa-solid fa-calendar-check"></i> Book Integration Call
            </a>
            <button class="btn-outline" onclick="document.getElementById('setup-modal').classList.add('hidden')">
                I'll explore on my own
            </button>
        </div>
    </div>
</div>
</body>
</html>
