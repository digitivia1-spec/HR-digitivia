<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITIVIA - Enterprise Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-body-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); 
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --blur-amount: 20px;
            --sidebar-bg: rgba(13, 27, 42, 0.90); 
            --sidebar-active: rgba(52, 152, 219, 0.4); 
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --text-header: #ffffff;
            --primary: #3498db; 
            --primary-hover: #2980b9;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --info: #9b59b6;
        }

        /* FORCE VERTICAL STACKING */
.main-content {
    display: flex !important;
    flex-direction: column !important; /* This forces Header on Top, Content Below */
    width: 100%;
    height: 100vh;
    overflow: hidden;
}
.content-scroll {
    flex-grow: 1;
    overflow-y: auto;
    width: 100%; /* Ensure it takes full width */
}

        html[dir="rtl"] { --sidebar-width: 270px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body-gradient); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

        /* --- LAYOUT & COMPONENTS --- */
        #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body-gradient); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .auth-card { background: rgba(13, 27, 42, 0.6); backdrop-filter: blur(30px); border: 1px solid var(--glass-border); padding: 40px; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* Logo Update */
        .auth-logo { height: 80px; margin-bottom: 20px; object-fit: contain; filter: drop-shadow(0 0 10px rgba(52,152,219,0.3)); }
        /* --- ARABIC SUPPORT --- */
html[lang="ar"] * { font-family: 'Cairo', sans-serif; }
html[lang="ar"] .fa-bars { margin-right: 0 !important; margin-left: 15px; }
        .auth-title { font-size: 1.8rem; font-weight: 700; color: white; margin-bottom: 10px; }
        .auth-subtitle { color: var(--text-muted); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white; outline: none; transition: 0.3s; }
        .form-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        .social-divider { display: flex; align-items: center; margin: 25px 0; color: var(--text-muted); font-size: 0.8rem; }
        .social-divider::before, .social-divider::after { content: ""; flex: 1; height: 1px; background: var(--glass-border); margin: 0 10px; }
        .social-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .social-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: white; cursor: pointer; transition: 0.3s; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .social-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .toggle-link { color: var(--primary); cursor: pointer; margin-top: 20px; display: inline-block; font-size: 0.9rem; }
        .toggle-link:hover { text-decoration: underline; }
        .hidden { display: none !important; }
        
        #app-container { display: flex; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; }
        #app-container.loaded { opacity: 1; }
        .sidebar { width: 270px; background: var(--sidebar-bg); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; transition: all 0.3s; flex-shrink: 0; height: 100vh; z-index: 1000; }
        html[dir="rtl"] .sidebar { border-right: none; border-left: 1px solid var(--glass-border); }
        /* Logo Area Update */
        .logo-area { height: 100px; display: flex; align-items: center; padding: 0 25px; border-bottom: 1px solid var(--glass-border); }
        .logo-area img { width: 100%; height: 60px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,255,255,0.1)); }
        
        #nav-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding-top: 15px; }
        .nav-header { padding: 20px 30px 10px 30px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); font-weight: 700; }
        .nav-links { list-style: none; padding: 0 15px; margin-bottom: 15px; }
        .nav-item { padding: 14px 15px; margin-bottom: 6px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; transition: all 0.25s ease; color: var(--text-muted); font-weight: 500; border: 1px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: var(--text-header); transform: translateX(5px); }
        .nav-item.active { background: var(--sidebar-active); color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item i { width: 25px; margin-right: 10px; text-align: center; font-size: 1.1em; }
        html[dir="rtl"] .nav-item i { margin-right: 0; margin-left: 10px; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-header { height: 80px; background: rgba(13, 27, 42, 0.4); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .branding-logos { display: flex; align-items: center; gap: 15px; margin-left: 20px; padding-left: 20px; border-left: 1px solid var(--glass-border); }
        html[dir="rtl"] .branding-logos { margin-left: 0; padding-left: 0; margin-right: 20px; padding-right: 20px; border-left: none; border-right: 1px solid var(--glass-border); }
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .icon-btn { cursor: pointer; color: var(--text-main); font-size: 1.2rem; position: relative; transition: 0.2s; }
        .icon-btn:hover { color: var(--primary); transform: scale(1.1); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: #fff; font-size: 0.6rem; padding: 2px 5px; border-radius: 50%; border: 1px solid var(--bg-body-gradient); }
        .dropdown { position: relative; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: 500; color: var(--text-header); }
        .dropdown img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .content-scroll { flex-grow: 1; overflow-y: auto; padding: 30px; }
        .page-title { margin-bottom: 30px; font-size: 2rem; font-weight: 700; color: var(--text-header); display: flex; justify-content: space-between; align-items: center; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .card { background: var(--glass-bg); backdrop-filter: blur(var(--blur-amount)); -webkit-backdrop-filter: blur(var(--blur-amount)); border-radius: 16px; padding: 25px; box-shadow: var(--glass-shadow); border: 1px solid var(--glass-border); height: 100%; transition: transform 0.3s ease, box-shadow 0.3s ease; color: var(--text-main); display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); border-color: rgba(255,255,255,0.25); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .card-title { font-weight: 700; color: var(--text-header); font-size: 1.1rem; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(41, 128, 185, 0.4); transition: all 0.2s; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(41, 128, 185, 0.6); }
        .btn-outline { background-color: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .btn-outline:hover { background-color: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: #fff; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 25px; align-items: stretch; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--glass-border); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: var(--text-header); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .payroll-table { table-layout: fixed; width: 100%; }
        .payroll-table th, .payroll-table td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .payroll-table .num { text-align: right; }
        .payroll-table th:nth-child(1) { width: 30%; }
        .payroll-table th:nth-child(2) { width: 15%; }
        .payroll-table th:nth-child(3) { width: 15%; }
        .payroll-table th:nth-child(4) { width: 15%; }
        .payroll-table th:nth-child(5) { width: 25%; }
        .table-input { background: transparent; border: 1px solid transparent; color: white; padding: 5px; border-radius: 4px; width: 100%; transition: 0.2s; }
        .table-input:hover { border-color: var(--glass-border); background: rgba(0,0,0,0.2); }
        .table-input:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); outline: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: rgba(46, 204, 113, 0.9); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999; backdrop-filter: blur(5px); }
        .toast.show { transform: translateY(0); }
/* --- RESPONSIVE UTILITIES --- */
.hide-on-mobile { display: flex; }
@media (max-width: 768px) {
    .hide-on-mobile { display: none !important; }
    /* Show hamburger menu on mobile */
    .header-left .fa-bars { display: block !important; margin-right: 15px; font-size: 1.2rem; cursor: pointer; }
    /* Make tables scrollable on mobile */
    .card { overflow-x: auto; } 
    /* Adjust padding for smaller screens */
    .main-content .content-scroll { padding: 15px; }
    .page-title { font-size: 1.5rem; flex-direction: column; align-items: flex-start; gap: 10px; }
    .page-title button { width: 100%; }
}

        /* --- PRICING MODAL STYLES --- */
.pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
.pricing-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; text-align: center; transition: 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
.pricing-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

/* Highlight Logic */
.pricing-card.popular { border: 1px solid var(--primary); background: linear-gradient(180deg, rgba(52, 152, 219, 0.1) 0%, rgba(0,0,0,0) 100%); }
.pricing-card.enterprise { border: 1px solid var(--info); background: linear-gradient(180deg, rgba(155, 89, 182, 0.1) 0%, rgba(0,0,0,0) 100%); }

.plan-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; color: white; }
.plan-price { font-size: 2rem; font-weight: 800; color: white; margin-bottom: 20px; }
.plan-price span { font-size: 0.9rem; font-weight: 400; color: var(--text-muted); }

.feature-list { list-style: none; padding: 0; text-align: left; margin-bottom: 20px; flex-grow: 1; }
.feature-list li { padding: 8px 0; color: var(--text-muted); font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
.feature-list li i { color: var(--success); margin-right: 8px; width: 15px; }
.feature-list li.locked i { color: var(--text-muted); opacity: 0.5; }

.plan-tag { position: absolute; top: 12px; right: 12px; background: var(--primary); color: white; font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }

/* Modal Checkbox */
.modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; color: var(--text-muted); font-size: 0.85rem; }
        /* New: Settings Inputs */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-section { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 20px; }
        .settings-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        @media (max-width: 1200px) { .dashboard-grid, .settings-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .sidebar { position: absolute; left: -270px; height: 100%; z-index: 2000; background: rgba(13, 27, 42, 0.98); } .sidebar.active { left: 0; box-shadow: 50px 0 100px rgba(0,0,0,0.5); } html[dir="rtl"] .sidebar { left: auto; right: -270px; } html[dir="rtl"] .sidebar.active { right: 0; } .branding-logos { display: none; } }

        /* PAYROLL LAYOUT */
        .payroll-layout { display: flex; height: calc(100vh - 140px); gap: 20px; }
        .payroll-sidebar { width: 300px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; overflow-y: auto; padding-right: 5px; }
        .payroll-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .history-item { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: rgba(255,255,255,0.1); }
        .history-item.active { background: var(--sidebar-active); border-color: var(--primary); }
        .history-date { font-weight: 700; color: #fff; margin-bottom: 5px; }
        .history-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        .history-badge { font-size: 0.7rem; background: var(--success); color: #fff; padding: 2px 6px; border-radius: 4px; }
        
        /* New: Dynamic Details */
        .details-json { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .details-btn { font-size: 0.75rem; cursor: pointer; color: var(--primary); margin-left: 10px; }

        /* New: Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-card { background: rgba(13, 27, 42, 0.95); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .close-modal { float: right; cursor: pointer; color: var(--text-muted); }
        .close-modal:hover { color: white; }

        /* --- ATS KANBAN STYLES --- */
        .ats-layout { display: flex; gap: 20px; height: calc(100vh - 160px); overflow-x: auto; padding-bottom: 20px; }
        
        /* UPDATED: Sidebar for Jobs */
        .ats-sidebar { width: 250px; background: rgba(255,255,255,0.03); border-right: 1px solid var(--glass-border); padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .ats-main-board { flex-grow: 1; display: flex; gap: 20px; overflow-x: auto; padding: 10px; }
        
        .ats-job-item { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .ats-job-item:hover { background: rgba(255,255,255,0.1); }
        .ats-job-item.active { border-color: var(--primary); background: rgba(52,152,219,0.1); }
        .ats-job-title { font-weight: 600; color: white; font-size: 0.9rem; }
        .ats-job-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; margin-top: 5px; }

        .ats-column { flex: 0 0 300px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; }
        .ats-col-header { padding: 15px; font-weight: 700; color: var(--text-header); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .ats-count { background: var(--glass-bg); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; color: var(--text-muted); }
        .ats-cards { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .ats-card { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 15px; border-radius: 8px; cursor: grab; transition: 0.2s; position: relative; }
        .ats-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ats-name { font-weight: 600; color: white; margin-bottom: 5px; }
        .ats-role { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; }
        .ats-actions { display: flex; justify-content: flex-end; gap: 5px; }
        .ats-btn-hire { font-size: 0.75rem; background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* --- PERFORMANCE STYLES --- */
        .perf-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .perf-high { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.4); }
        .perf-mid { background: rgba(241, 196, 15, 0.2); color: #f1c40f; border: 1px solid rgba(241, 196, 15, 0.4); }
        .perf-low { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.4); }
        .score-card { text-align: center; padding: 15px; border: 1px solid var(--glass-border); border-radius: 10px; background: rgba(255,255,255,0.03); }
        .score-val { font-size: 1.8rem; font-weight: 700; margin: 10px 0; }
        .cycle-switch { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px; border: 1px solid var(--glass-border); }
        .cycle-btn { padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); border: none; background: transparent; transition: 0.2s; }
        .cycle-btn.active { background: var(--primary); color: white; }

        /* ADDED: Styles for Weekday Selector in Settings Modal */
        .day-selector { display: flex; gap: 5px; margin-top: 5px; }
        .day-check { display: none; }
        .day-label { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .day-check:checked + .day-label { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-card" id="login-card">
            <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA" class="auth-logo">
            <div class="auth-title">Enterprise Access</div>
            <div class="auth-subtitle">Secure Login to Digitivia Operations</div>
            <div class="form-group"><label>Email Address</label><input type="email" id="login-email" class="form-input" placeholder="name@company.com"></div>
            <div class="form-group"><label>Password</label><input type="password" id="login-pass" class="form-input" placeholder="••••••••"></div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()">Login</button>
            <div class="social-divider">Or continue with</div>
            <div class="social-buttons">
                <div class="social-btn" onclick="socialLogin('google')" style="color:#DB4437"><i class="fa-brands fa-google"></i></div>
<div class="social-btn" onclick="socialLogin('linkedin_oidc')" style="color:#0077b5"><i class="fa-brands fa-linkedin-in"></i></div>                <div class="social-btn" onclick="socialLogin('azure')" style="color:#00a4ef"><i class="fa-brands fa-microsoft"></i></div>
            </div>
            <div class="toggle-link" onclick="toggleAuthMode('register')">Register New Organization</div>
        </div>
        <div class="auth-card hidden" id="register-card">
            <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA" class="auth-logo">
            <div class="auth-title">Start Your Business</div>
            <div class="auth-subtitle">Create Organization & CEO Account</div>
            <div class="form-group"><label>Organization Name</label><input type="text" id="reg-org-name" class="form-input" placeholder="e.g. Digitivia Corp"></div>
            <div class="form-group"><label>Full Name</label><input type="text" id="reg-name" class="form-input" placeholder="John Doe"></div>
            <div class="form-group"><label>Work Email</label><input type="email" id="reg-email" class="form-input" placeholder="ceo@company.com"></div>
            <div class="form-group"><label>Password</label><input type="password" id="reg-pass" class="form-input" placeholder="••••••••"></div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="handleRegister()">Create Organization</button>
            <div class="toggle-link" onclick="toggleAuthMode('login')">Already have an account? Login</div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="sidebar" id="sidebar">
            <div class="logo-area">
                <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA Logo">
            </div>
            <div id="nav-container"></div>
        </nav>
        <div class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <i class="fa-solid fa-bars icon-btn" onclick="toggleSidebar()" style="display:none; margin-right:10px;"></i> 
                    <span id="current-date" class="hide-on-mobile" style="font-size: 0.9rem; color: var(--text-muted);"></span>
                </div>
                <div class="header-right">
    <div class="branding-logos" style="border:none; padding:0; margin:0; display:flex; align-items:center; gap:15px;">
        <span id="org-display-name" style="font-weight:700; color:white; opacity:0.8; font-size:1.1rem; text-transform:uppercase; letter-spacing:1px;"></span>
        <span id="plan-badge-container"></span> </div>
    
    <div class="user-controls">
        <div id="role-display" class="btn-outline" style="cursor:default; border-color:var(--primary); color:var(--primary)">Loading...</div>
        <button class="btn-outline" onclick="toggleLang()" id="lang-btn">عربي</button>
        <div class="dropdown" onclick="openProfileModal()"> <img src="" alt="User" id="user-avatar">
        </div>
    </div>
</div>
            </header>
            <main class="content-scroll" id="main-view"></main>
            <div id="toast" class="toast"><i class="fa-solid fa-circle-check"></i> <span id="toast-msg">Success!</span></div>
        </div>
    </div>

    <div id="job-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Smart Job Wizard
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('job-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Job Title</label>
                <input type="text" id="job-title" class="form-input" placeholder="e.g. Senior Backend Engineer">
            </div>
            <div class="form-group">
                <label>Department</label>
                <input type="text" id="job-dept" class="form-input" placeholder="e.g. Engineering">
            </div>
            <div class="form-group">
                <label>Salary Range</label>
                <input type="text" id="job-salary" class="form-input" placeholder="e.g. $80k - $120k">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="job-status" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Open">Open</option>
                    <option value="Draft">Draft</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveNewJob()">
                <i class="fa-solid fa-rocket"></i> Publish Job
            </button>
        </div>
    </div>

<div id="onboard-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 700px;"> <div class="modal-title">
                Onboard New Hire
                <i class="fa-solid fa-xmark close-modal" onclick="closeOnboardModal()"></i>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h4 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">1. Employee Details</h4>
                    
                    <div class="form-group">
                        <label>Full Name <span style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-name" class="form-input" placeholder="Jane Doe">
                    </div>
                    <div class="form-group">
                        <label>Company Email <span style="color:var(--danger)">*</span></label>
                        <input type="email" id="new-email" class="form-input" placeholder="jane@company.com">
                    </div>
                    <div class="form-group">
                        <label>Temporary Password <span style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-pass" class="form-input" placeholder="Welcome123">
                    </div>
                    <div class="form-group">
                        <label>Role <span style="color:var(--danger)">*</span></label>
                        <select id="new-role" class="form-input" style="background:var(--sidebar-bg);">
                            <option value="employee">Employee</option>
                            <option value="manager">Manager</option>
                            <option value="hr_manager">HR Manager</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number <span style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-meta-phone" class="form-input" placeholder="+1 234 567 890">
                    </div>
                    <div class="form-group">
                        <label>Department (Optional)</label>
                        <input type="text" id="new-meta-dept" class="form-input" placeholder="Engineering">
                    </div>
                </div>

                <div style="border-left:1px solid var(--glass-border); padding-left:20px;">
                    <h4 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">2. Starter Documents</h4>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Add Contracts, IDs, or Passports immediately.</p>
                    
                    <div id="onboard-docs-list" style="max-height: 350px; overflow-y:auto; padding-right:5px; margin-bottom:10px;">
                        </div>

                    <button class="btn-outline" style="width:100%; font-size:0.85rem; padding:10px; border-style:dashed;" onclick="addObjDocRow()">
                        <i class="fa-solid fa-plus"></i> Add Document Row
                    </button>
                </div>
            </div>

            <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--glass-border);">
                <button class="btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="executeOnboard()">
                    <i class="fa-solid fa-check"></i> Create Employee & Save Docs
                </button>
            </div>
        </div>
    </div>
    
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Import Legacy Attendance
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('import-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Upload CSV</label>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Format: email, date, in_time, out_time</p>
                <input type="file" id="attendance-file" class="form-input" accept=".csv">
            </div>
            <div style="background:rgba(231,76,60,0.1); padding:10px; border-radius:8px; border:1px solid rgba(231,76,60,0.3); font-size:0.8rem; margin-bottom:15px;">
                <i class="fa-solid fa-triangle-exclamation"></i> Smart Merge Active: Rows that conflict with verified "Live" data will be skipped to preserve integrity.
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handleAttendanceImport()">
                Process Import
            </button>
        </div>
    </div>

    <div id="perf-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Upload Performance Data
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('perf-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label>Department Rules</label>
                <select id="perf-dept" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Engineering">Engineering (Qual 40 / Spd 30)</option>
                    <option value="Sales">Sales (Rev 50 / Spd 30)</option>
                    <option value="Support">Support (Qual 50 / Spd 30)</option>
                    <option value="General">General (Balanced)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Input Method</label>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn-outline" onclick="setPerfInput('file')" id="btn-file-mode" style="flex:1; border-color:var(--primary)">File Upload</button>
                    <button class="btn-outline" onclick="setPerfInput('manual')" id="btn-manual-mode" style="flex:1;">Manual Text</button>
                </div>
            </div>
            <div id="perf-input-file" class="form-group">
                <label>Upload CSV/Excel Log</label>
                <input type="file" id="perf-file" class="form-input">
            </div>
            <div id="perf-input-manual" class="form-group hidden">
                <label>Paste Raw Work Logs</label>
                <textarea id="perf-text" class="form-input" rows="5" placeholder="e.g. John completed 40 tickets with 2 errors. Sarah closed 5 deals..."></textarea>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handlePerformanceSubmit()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze with AI
            </button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Department Schedules (Option B)<i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('settings-modal').classList.add('hidden')"></i></div>
            <div class="form-group">
                <label>Department Name</label>
                <input type="text" id="set-dept" class="form-input" placeholder="e.g. Sales, Engineering, or Global">
            </div>
            <div class="form-group">
                <label>Work Days</label>
                <div class="day-selector">
                    <input type="checkbox" id="d0" class="day-check" value="0"><label for="d0" class="day-label">S</label>
                    <input type="checkbox" id="d1" class="day-check" value="1"><label for="d1" class="day-label">M</label>
                    <input type="checkbox" id="d2" class="day-check" value="2"><label for="d2" class="day-label">T</label>
                    <input type="checkbox" id="d3" class="day-check" value="3"><label for="d3" class="day-label">W</label>
                    <input type="checkbox" id="d4" class="day-check" value="4"><label for="d4" class="day-label">T</label>
                    <input type="checkbox" id="d5" class="day-check" value="5"><label for="d5" class="day-label">F</label>
                    <input type="checkbox" id="d6" class="day-check" value="6"><label for="d6" class="day-label">S</label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Start Time</label><input type="time" id="set-start" class="form-input" value="09:00"></div>
                <div class="form-group" style="flex:1"><label>End Time</label><input type="time" id="set-end" class="form-input" value="17:00"></div>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveDepartmentSchedule()">Save Rule</button>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://neepgsppcemzwapcexys.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZXBnc3BwY2VtendhcGNleHlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDI5NzEsImV4cCI6MjA4MzExODk3MX0.1gXea9dkLrE8CY80ho0wC0al04DCvMJK5UimqAj96e0';
    const N8N_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_hr_payroll'; 
    const N8N_PERF_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_performance'; 
    const N8N_ATS_CONNECT_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_ats_connect';
    // --- AI ASSISTANT CONFIG ---
const N8N_AI_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_ai_assistant';
const AI_CREDITS_COST_PER_MESSAGE = 1; // like Notion: each message costs credits

    
    // --- TESLA-GRADE ATTENDANCE CONFIG ---
    const OFFICE_COORDS = { lat: 30.0444, lng: 31.2357 }; // Change to your HQ
    const MAX_DISTANCE_METERS = 500; // Radius

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE ---
    const state = { 
        user: null, profile: null, org: null, lang: 'en', activeView: 'dashboard',
        perfCycle: 'Monthly', perfInputMode: 'file'
    };

    let atsOrgColumn = null;
    let atsOrderColumn = 'id';
    let atsUseJobOrgFilter = false;

    async function resolveAtsOrgColumn() {
        if (atsOrgColumn !== null) return atsOrgColumn;
        const { data, error } = await supabaseClient
            .from('ats_applications')
            .select('*')
            .limit(1);
        if (!error && Array.isArray(data) && data.length > 0) {
            if (Object.prototype.hasOwnProperty.call(data[0], 'org_id')) {
                atsOrgColumn = 'org_id';
                atsUseJobOrgFilter = false;
            } else {
                atsOrgColumn = '';
                atsUseJobOrgFilter = true;
            }
            if (Object.prototype.hasOwnProperty.call(data[0], 'created_at')) {
                atsOrderColumn = 'created_at';
            } else if (Object.prototype.hasOwnProperty.call(data[0], 'submitted_at')) {
                atsOrderColumn = 'submitted_at';
            } else if (Object.prototype.hasOwnProperty.call(data[0], 'applied_at')) {
                atsOrderColumn = 'applied_at';
            } else {
                atsOrderColumn = 'id';
            }
        } else {
            atsOrgColumn = '';
            atsUseJobOrgFilter = true;
        }
        return atsOrgColumn;
    }
// --- 1. INSERT AFTER 'const state = { ... }' ---

    // BUNDLE & FEATURE CONFIGURATION
    const BUNDLE_CONFIG = {
        'free': { 
            name: 'Standard', 
            features: ['attendance', 'basic_payroll', 'dashboard', 'employees'], 
            can_broadcast: false 
        },
        'bundle_2': { 
            name: 'Growth', 
            features: ['attendance', 'basic_payroll', 'dashboard', 'employees', 'wfm', 'ats', 'broadcast'], 
            can_broadcast: true 
        },
        'bundle_3': { 
            name: 'Enterprise', 
            features: ['all'], 
            can_broadcast: true 
        }
    };

    // Helper: Check if feature is allowed
    function hasAccess(featureKey) {
        if (!state.org) return false;
        const tier = state.org.subscription_tier || 'free';
        const config = BUNDLE_CONFIG[tier] || BUNDLE_CONFIG['free'];
        
        if (config.features.includes('all')) return true;
        return config.features.includes(featureKey);
    }
    // Translations
    // --- FULL TRANSLATIONS ---
const i18n = {
        en: { 
            welcome: "Welcome back,", 
            dashboard: "Dashboard", 
            org_profile: "Org Profile", 
            payroll: "Payroll Automation", 
            employees: "Employees", 
            attendance: "Attendance", 
            ats: "ATS Recruitment", 
            performance: "Performance AI", 
            reports: "Strategic Reports", 
            wfm: "Workforce WFM",
            total_staff: "Total Staff",
            online_now: "Online Now",
            open_jobs: "Open Jobs",
            late_today: "Late Today",
            recent_activity: "Recent Activity",
            expired_docs: "Expired Documents",
            connect_email: "Connect Email",
            add_candidate: "Add Candidate",
            post_job: "Post Job",
            view_report: "View Report"
        },
        ar: { 
            welcome: "مرحباً بعودتك،", 
            dashboard: "لوحة القيادة", 
            org_profile: "ملف المؤسسة", 
            payroll: "الرواتب الآلية", 
            employees: "الموظفين", 
            attendance: "الحضور والانصراف", 
            ats: "التوظيف ATS", 
            performance: "تحليل الأداء", 
            reports: "التقارير الاستراتيجية", 
            wfm: "إدارة القوى العاملة",
            total_staff: "إجمالي الموظفين",
            online_now: "متصل الآن",
            open_jobs: "وظائف مفتوحة",
            late_today: "تأخيرات اليوم",
            recent_activity: "النشاط الحديث",
            expired_docs: "وثائق منتهية الصلاحية",
            connect_email: "ربط البريد الإلكتروني",
            add_candidate: "إضافة مرشح",
            post_job: "نشر وظيفة",
            view_report: "عرض التقرير"
        }
    };
    /* -------------------------------------------------------------------------
       CRITICAL: ALL HELPER FUNCTIONS DEFINED FIRST TO AVOID "NOT DEFINED" ERRORS
       ------------------------------------------------------------------------- */

    // --- NEW: AUDIT & SECURITY HELPERS ---
    async function logSystemAction(action, target, details = {}) {
        try {
            await supabaseClient.from('audit_logs').insert({
                org_id: state.org.id,
                actor_id: state.user.id,
                action_type: action,
                target_record: target,
                details: details,
                ip_address: 'client-side'
            });
        } catch(e) { console.warn("Audit Log Failed:", e); }
    }

    async function checkRoleAccess(requiredRoles) {
        if (!requiredRoles.includes(state.profile.role)) {
            document.getElementById('main-view').innerHTML = `<div class="card" style="text-align:center; padding:50px;"><i class="fa-solid fa-lock" style="font-size:3rem; color:var(--danger)"></i><h2 style="margin-top:20px;">Access Denied</h2><p>You need ${requiredRoles.join(' or ')} privileges.</p></div>`;
            return false;
        }
        return true;
    }

    // --- HELPER: LEAFLET MAP ---
    async function initLiveMap() {
        if (!document.getElementById('work-map')) return;
        const map = L.map('work-map').setView([OFFICE_COORDS.lat, OFFICE_COORDS.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        const { data: profiles } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id);
        if(!profiles) return;
        for (const p of profiles) {
            const { data: act } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', p.user_id).order('clock_in_time', {ascending:false}).limit(1).maybeSingle();
            if (act && act.check_in_lat && act.check_in_long) {
                const isActive = act.clock_out_time === null;
                const color = isActive ? 'green' : 'grey';
                const iconHtml = `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin' });
                L.marker([act.check_in_lat, act.check_in_long], { icon: customIcon }).addTo(map)
                  .bindPopup(`<b>${p.full_name}</b><br>${isActive ? 'Online' : 'Offline'}<br>${new Date(act.clock_in_time).toLocaleTimeString()}`);
            }
        }
    }

    // --- HELPER: WFM ROSTER ---
    async function loadWFMRoster() {
        const list = document.getElementById('wfm-roster-list'); if(!list) return; 
        const { data: employees } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id).limit(50);
        if (!employees || employees.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No active employees found.</div>'; return; }
        const { data: active } = await supabaseClient.from('wfm_activity').select('user_id, current_status').eq('org_id', state.org.id).is('clock_out_time', null);
        const activeMap = {}; 
        if(active) active.forEach(a => activeMap[a.user_id] = a.current_status);
        let html = ''; 
        const colors = { 'On Queue': 'var(--success)', 'Break': 'var(--warning)', 'Meeting': 'var(--info)', 'Offline': 'var(--text-muted)' }; 
        employees.forEach(emp => { 
            const isActive = activeMap.hasOwnProperty(emp.user_id);
            const status = isActive ? (activeMap[emp.user_id] || 'Online') : 'Offline'; 
            const color = isActive ? colors[status] || 'var(--success)' : 'var(--text-muted)'; 
            html += `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid var(--glass-border); opacity:${isActive?1:0.6}"><img src="${emp.avatar_url || 'https://ui-avatars.com/api/?background=random'}" style="width:35px; height:35px; border-radius:50%;"><div style="flex-grow:1;"><div style="font-weight:600; color:#fff;">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted);">${emp.role}</div></div><span style="font-size:0.75rem; padding:4px 8px; border-radius:4px; background:${color}20; color:${color}; border:1px solid ${color}40;">${status}</span></div>`; 
        }); 
        list.innerHTML = html; 
    }

    // --- HELPER: WFM CHART ---
    async function initWFMChart() {
        setTimeout(async () => {
            const ctx = document.getElementById('wfmChart');
            if(!ctx) return; 
            try {
                const { data: schedules, error: schError } = await supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
                const defaultStart = 9; const defaultEnd = 17; 
                const todayStr = new Date().toISOString().split('T')[0];
                const { data: logs } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
                const hours = Array.from({length: 24}, (_, i) => i);
                const planned = new Array(24).fill(0);
                const actual = new Array(24).fill(0);
                const { count } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
                const totalStaff = count || 10;
                
                let sStart = defaultStart, sEnd = defaultEnd;
                if(schedules && schedules.length > 0) {
                    const s = schedules[0]; 
                    sStart = parseInt(s.shift_start.split(':')[0]);
                    sEnd = parseInt(s.shift_end.split(':')[0]);
                }
                hours.forEach(h => { if (h >= sStart && h < sEnd) planned[h] = totalStaff; });
                if(logs) { logs.forEach(l => { const inH = new Date(l.clock_in_time).getHours(); const outH = l.clock_out_time ? new Date(l.clock_out_time).getHours() : 23; for(let i=inH; i<=outH; i++) actual[i]++; }); }

                if(window.wfmChartInstance) window.wfmChartInstance.destroy();
                window.wfmChartInstance = new Chart(ctx, { type: 'line', data: { labels: hours.map(h => `${h}:00`), datasets: [ { label: 'Planned', data: planned, borderColor: '#95a5a6', borderDash: [5, 5], tension: 0.4 }, { label: 'Actual', data: actual, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: true, tension: 0.4 } ] }, options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } });
            } catch(err) { console.error("WFM Chart Error:", err); }
        }, 100);
    }

    // --- HELPER: ATTENDANCE HISTORY ---
    async function loadAttendanceHistory() {
        const histDiv = document.getElementById('attendance-history');
        if(!histDiv) return;

        const { data: logs, error } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).order('clock_in_time', { ascending: false }).limit(5);
        if(error || !logs) { return; }
        let html = `<table><thead><tr><th>Date</th><th>In</th><th>Out</th><th>Source</th><th>Proof</th></tr></thead><tbody>`;
        logs.forEach(log => {
            const date = new Date(log.clock_in_time).toLocaleDateString();
            const inTime = new Date(log.clock_in_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const outTime = log.clock_out_time ? new Date(log.clock_out_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '<span style="color:var(--success)">Active</span>';
            const sourceBadge = log.record_source === 'csv_upload' ? '<span class="badge" style="background:#95a5a6; position:static">Import</span>' : '<span class="badge" style="background:var(--success); position:static">Live</span>';
            const proofLink = log.check_in_photo ? `<a href="${log.check_in_photo}" target="_blank" style="color:var(--primary)">View Selfie</a>` : '-';
            html += `<tr><td>${date}</td><td>${inTime}</td><td>${outTime}</td><td>${sourceBadge}</td><td>${proofLink}</td></tr>`;
        });
        html += `</tbody></table>`;
        histDiv.innerHTML = html;
    }

    // --- HELPER: PAYROLL TABLE ---
    function normalizePayrollRows(payload) {
        let data = payload;
        if (typeof data === 'string') {
            const trimmed = data.trim();
            const cleaned = trimmed.startsWith('[Object:')
                ? trimmed.replace(/^\[Object:\s*/, '').replace(/\]$/, '')
                : trimmed;
            try { data = JSON.parse(cleaned); } catch (e) { return []; }
        }
        if (data && typeof data === 'object' && typeof data.rows === 'string') {
            try { data = { rows: JSON.parse(data.rows) }; } catch (e) {}
        }
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.rows)) return data.rows;
        if (data && Array.isArray(data.items)) return data.items;
        return [];
    }

    function coercePayrollNumber(value) {
        if (value === null || value === undefined) return 0;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const cleaned = String(value).replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function normalizePayrollRow(raw) {
        const row = (raw && typeof raw === 'object') ? raw : {};
        const name =
            row.employee_name ||
            row.employee ||
            row.name ||
            row.full_name ||
            row['Employee'] ||
            row['Employee Name'] ||
            row['Emp Name'] ||
            row['Employee_Name'] ||
            '';
        return {
            employee_name: String(name || '').trim() || 'Unknown',
            salary: coercePayrollNumber(row.salary ?? row.base_pay ?? row.base ?? row['Salary'] ?? row['Base Pay'] ?? row['Base'] ?? row['Gross']),
            bonus: coercePayrollNumber(row.bonus ?? row.overtime ?? row['Bonus'] ?? row['OT'] ?? row['Overtime']),
            deductions: coercePayrollNumber(row.deductions ?? row.deduction ?? row['Deductions'] ?? row['Tax'] ?? row['Taxes'] ?? row['Insurance'] ?? row['401k'] ?? row['401K'])
        };
    }

    function renderPayrollTable(items, isNew = true) { 
        const loader = document.getElementById('payroll-loading');
        if(loader) loader.classList.add('hidden'); 
        const container = document.getElementById('payroll-content'); 
        if (container) {
            container.classList.remove('hidden'); 
            const isReadOnly = (state.org?.subscription_tier || 'free') === 'free';
            const noteHtml = isReadOnly
                ? `<div style="font-size:0.75rem; color:var(--warning);">Read-only on Starter. Upgrade to edit payroll rows.</div>`
                : '';
            let html = `<div style="height:100%; overflow:hidden; display:flex; flex-direction:column;"><div class="card-header" style="padding:20px; flex-shrink:0; display:flex; justify-content:space-between; align-items:center;"><div><div class="card-title">Payroll Data</div>${noteHtml}</div><button class="btn-outline" onclick="renderPayrollUI(document.getElementById('main-view'))"><i class="fa-solid fa-rotate"></i> Refresh</button></div><div style="flex-grow:1; overflow-y:auto; padding:0 20px 20px 20px;"><table class="payroll-table"><thead><tr><th>Employee</th><th>Salary</th><th>Bonus</th><th>Deductions</th><th>Net Pay</th></tr></thead><tbody>`; 
            if(items) {
                items.forEach(item => { 
                    const nameCell = isReadOnly
                        ? `<td>${escapeHtml(item.employee_name)}</td>`
                        : `<td><input class="table-input" value="${escapeHtml(item.employee_name)}" onchange="updatePayrollItem('${item.id}', 'employee_name', this.value, '${item.employee_name}')"></td>`;
                    const salaryCell = isReadOnly
                        ? `<td class="num">${item.salary || 0}</td>`
                        : `<td class="num"><input type="number" class="table-input" value="${item.salary || 0}" onchange="updatePayrollItem('${item.id}', 'salary', this.value, '${item.salary}')"></td>`;
                    const bonusCell = isReadOnly
                        ? `<td class="num">${item.bonus || 0}</td>`
                        : `<td class="num"><input type="number" class="table-input" value="${item.bonus || 0}" onchange="updatePayrollItem('${item.id}', 'bonus', this.value, '${item.bonus}')"></td>`;
                    const deductionsCell = isReadOnly
                        ? `<td class="num">${item.deductions || 0}</td>`
                        : `<td class="num"><input type="number" class="table-input" value="${item.deductions || 0}" onchange="updatePayrollItem('${item.id}', 'deductions', this.value, '${item.deductions}')"></td>`;
                    html += `<tr>${nameCell}${salaryCell}${bonusCell}${deductionsCell}<td class="num" style="color:var(--success); font-weight:bold">${item.net_pay || 0}</td></tr>`; 
                }); 
            }
            html += `</tbody></table></div></div>`; 
            container.innerHTML = html; 
        }
    }

    // --- HELPER: PERFORMANCE TABLE (SHOWS ALL) ---
    async function renderPerformanceTable(filteredReviews) {
        const { data: allEmployees } = await supabaseClient.from('profiles').select('user_id, full_name, email, role').eq('org_id', state.org.id);
        if(!allEmployees) return;

        const reviewMap = {};
        if (filteredReviews) {
            filteredReviews.forEach(r => reviewMap[r.user_id] = r);
        }

        let html = `<table><thead><tr><th>Employee</th><th>Role</th><th>Quality</th><th>Speed</th><th>Score</th><th>AI Insight</th></tr></thead><tbody>`;
        
        allEmployees.forEach(emp => {
            const r = reviewMap[emp.user_id];
            
            if (r) {
                const scoreClass = r.score_final >= 90 ? 'perf-high' : (r.score_final >= 75 ? 'perf-mid' : 'perf-low');
                html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>${r.score_quality}</td><td>${r.score_speed}</td><td><span class="perf-badge ${scoreClass}">${r.score_final}</span></td><td><button class="btn-outline" style="font-size:0.75rem;" onclick="showToast('${(r.ai_feedback || "").replace(/'/g, "\\'")}')">View Analysis</button></td></tr>`;
            } else {
                html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>-</td><td>-</td><td><span class="perf-badge" style="background:rgba(255,255,255,0.1); color:#aaa;">Pending</span></td><td><span style="font-size:0.8rem; color:#666;">No data</span></td></tr>`;
            }
        });

        html += `</tbody></table>`;
        const perfContent = document.getElementById('perf-content');
        if (perfContent) perfContent.innerHTML = html;
    }

    // --- HELPER: ROI TABLE & CHARTS ---
    function renderROITable(data) { 
        const tbody = document.querySelector('#roi-table tbody'); 
        if(!tbody) return;
        let html = ''; 
        if(data) {
            data.forEach(r => { const roi = r.total_cost > 0 ? ((r.productivity_score / r.total_cost) * 1000).toFixed(1) : 'N/A'; html += `<tr><td>${r.full_name}</td><td>${r.role}</td><td>$${r.total_cost}</td><td>${r.productivity_score}</td><td>${roi}</td><td><span class="badge" style="background:var(--success); position:static">Healthy</span></td></tr>`; }); 
        }
        tbody.innerHTML = html; 
    }
    
    function initReportCharts(data) { 
        const ctx1 = document.getElementById('burnoutChart');
        const ctx2 = document.getElementById('efficiencyChart');
        if(!ctx1 || !ctx2 || !data) return;

        new Chart(ctx1, { type: 'bar', data: { labels: data.map(r => r.full_name), datasets: [ { label: 'Productivity', data: data.map(r => r.productivity_score), backgroundColor: '#3498db' } ] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } }); 
        const roles = [...new Set(data.map(r => r.role))]; const efficiency = roles.map(role => { const users = data.filter(r => r.role === role); return users.reduce((sum, u) => sum + u.productivity_score, 0) / users.length; }); 
        new Chart(ctx2, { type: 'radar', data: { labels: roles, datasets: [{ label: 'Avg Prod', data: efficiency, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)' }] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false } } } } }); 
    }

    // --- HELPER: GLOBAL FUNCTIONS FOR HTML BUTTONS ---
    window.handleClockOut = async function(activityId) {
        try {
            console.log("Attempting to end shift for Activity ID:", activityId);
            const { data, error } = await supabaseClient
                .from('wfm_activity')
                .update({ clock_out_time: new Date().toISOString(), current_status: 'Offline' })
                .eq('id', activityId)
                .select();
            
            if (error) throw error;
            if (!data || data.length === 0) {
                console.error("Update succeeded but 0 rows changed. Check RLS policies.");
                showToast("Database Permission Error: Run the SQL Fix!", true);
                return;
            }
            showToast("Shift Ended. Have a great evening!");
            await renderAttendanceUI(document.getElementById('main-view'));
        } catch (err) {
            console.error("Clock Out Error:", err);
            showToast("Failed: " + err.message, true);
        }
    }
    
    async function startClockInFlow() {
        const btn = document.getElementById('btn-scan');
        const locStatus = document.getElementById('loc-status');
        const vidContainer = document.getElementById('camera-preview');
        const vid = document.getElementById('vid');
        btn.classList.add('hidden'); locStatus.innerText = "Acquiring Secure GPS Signal...";
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const deviceType = isMobile ? 'mobile_app' : 'desktop_web';

        try {
            const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject));
            const { latitude, longitude } = position.coords;
            const dist = getDistanceFromLatLonInM(latitude, longitude, OFFICE_COORDS.lat, OFFICE_COORDS.lng);
            const workMode = dist < MAX_DISTANCE_METERS ? 'Office' : 'Remote';
            locStatus.innerText = `Verified: ${workMode} (${Math.round(dist)}m from HQ)`;
            locStatus.style.color = 'var(--success)';
            vidContainer.classList.remove('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            vid.srcObject = stream;
            setTimeout(async () => {
                const canvas = document.createElement('canvas'); canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
                canvas.getContext('2d').drawImage(vid, 0, 0);
                canvas.toBlob(async (blob) => {
                    const fileName = `selfie_${state.user.id}_${Date.now()}.jpg`;
                    const { error: upErr } = await supabaseClient.storage.from('attendance_photos').upload(fileName, blob);
                    if (upErr) throw upErr;
                    const { data: { publicUrl } } = supabaseClient.storage.from('attendance_photos').getPublicUrl(fileName);
                    await supabaseClient.from('wfm_activity').insert({
                        org_id: state.org.id, user_id: state.user.id, 
                        clock_in_time: new Date().toISOString(), 
                        current_status: 'On Queue',
                        check_in_lat: latitude, check_in_long: longitude, check_in_photo: publicUrl, device_info: navigator.userAgent,
                        record_source: deviceType
                    });
                    stream.getTracks().forEach(t => t.stop());
                    showToast("Identity Verified. Welcome back!");
                    renderAttendanceUI(document.getElementById('main-view'));
                }, 'image/jpeg');
            }, 1500);
        } catch (err) { console.error(err); showToast("Access Denied: " + err.message, true); btn.classList.remove('hidden'); if(stream) stream.getTracks().forEach(t => t.stop()); }
    }

    // --- NEW: MISSING FUNCTION: Save Dept Schedule ---
    window.saveDepartmentSchedule = async function() {
        const dept = document.getElementById('set-dept').value;
        const start = document.getElementById('set-start').value;
        const end = document.getElementById('set-end').value;
        
        const days = [];
        for(let i=0; i<=6; i++) {
            if(document.getElementById(`d${i}`).checked) days.push(i);
        }

        if(!dept) return showToast("Department name required", true);

        const { error } = await supabaseClient
            .from('wfm_schedules')
            .upsert({
                org_id: state.org.id,
                department: dept,
                shift_start: start,
                shift_end: end,
                work_days: days
            }, { onConflict: 'org_id, department' }); 

        if(error) return showToast("Save Failed: " + error.message, true);
        
        showToast(`Schedule saved for ${dept}`);
        document.getElementById('settings-modal').classList.add('hidden');
        renderWFMUI(document.getElementById('main-view')); 
    }

    // --- INIT & AUTH ---
  // --- INIT & AUTH ---
    window.addEventListener('DOMContentLoaded', async () => {
        const dateEl = document.getElementById('current-date');
        if (dateEl) dateEl.innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // 1. LISTEN for Auth State Changes (Handles both Redirects and Normal Session)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                // Clear URL junk (hashes and query params) for a clean look
                if (window.location.hash || window.location.search) {
                    window.history.replaceState(null, null, window.location.pathname);
                }
                
                // Load App if not already loaded
                if (!state.user) {
                    loadAppData(session.user);
                }
            } else if (event === 'SIGNED_OUT') {
                showAuthScreen();
            }
        });

        // 2. CHECK for Initial Session
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            loadAppData(session.user);
        } else {
            // 3. SMART REDIRECT CHECK (The Fix)
            // We only show the login screen if we are SURE this isn't a Google/LinkedIn redirect.
            // We check for both '#access_token' (Implicit) and '?code=' (PKCE).
            const isRedirect = window.location.hash.includes('access_token') || 
                               window.location.search.includes('code=');

            if (isRedirect) {
                // Show a loading spinner instead of the Login Form while Supabase processes the token
                document.getElementById('auth-container').innerHTML = `
                    <div class="auth-card" style="text-align:center;">
                        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i>
                        <h3 style="margin-top:20px; color:white;">Finishing Login...</h3>
                    </div>`;
            } else {
                showAuthScreen();
            }
        }
    });
    function toggleAuthMode(mode) { if(mode === 'register') { document.getElementById('login-card').classList.add('hidden'); document.getElementById('register-card').classList.remove('hidden'); } else { document.getElementById('register-card').classList.add('hidden'); document.getElementById('login-card').classList.remove('hidden'); } }
    async function handleLogin() { const email = document.getElementById('login-email').value; const password = document.getElementById('login-pass').value; try { const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) throw error; loadAppData(data.user); } catch (err) { showToast(err.message, true); } }
    async function handleRegister() { const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-pass').value; const fullName = document.getElementById('reg-name').value; const orgName = document.getElementById('reg-org-name').value; if(!email || !password || !fullName || !orgName) { showToast("Please fill all fields", true); return; } try { const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { full_name: fullName, org_name: orgName, avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random` } } }); if (error) throw error; showToast("Registration successful! Logging in..."); if(data.session) loadAppData(data.user); else showToast("Please check your email to confirm account", false); } catch (err) { showToast(err.message || "Server Error", true); } }
    async function socialLogin(provider) { 
        // FIX: Always use origin + pathname to strip existing hashes and prevent "Double Hash" errors
        const cleanRedirect = window.location.origin + window.location.pathname;
        
        await supabaseClient.auth.signInWithOAuth({ 
            provider: provider, 
            options: { 
                redirectTo: cleanRedirect,
                // Add scopes if needed for specific providers
                scopes: provider === 'azure' ? 'email profile openid' : undefined
            } 
        }); 
    }
    async function handleLogout() { await supabaseClient.auth.signOut(); window.location.reload(); }
    function showAuthScreen() { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }

    // --- MAIN DATA LOADER ---
    // --- MAIN DATA LOADER (Fixed for Corporate Logins) ---
  // --- MAIN DATA LOADER (CEO Edition) ---
  // --- MAIN DATA LOADER (Auto-Fix Edition) ---
// --- MAIN DATA LOADER (Safety Edition) ---
  async function loadAppData(user) {
        state.user = user;
        
        let { data: profileData, error: profileError } = await supabaseClient
            .from('profiles')
            .select('*, organizations(*)')
            .eq('user_id', user.id)
            .maybeSingle();

        // --- NEW USER SETUP FLOW ---
        if (!profileData) {
            console.log("New User or Orphaned Profile Detected...");
            const meta = user.user_metadata || {};
            const fullName = meta.full_name || meta.name || user.email.split('@')[0];
            const avatarUrl = meta.avatar_url || meta.picture || `https://ui-avatars.com/api/?name=${fullName}&background=random`;
            
            // Determine Org Name
            const emailDomain = user.email.split('@')[1];
            let orgName = `${fullName}'s Company`;
            const freeDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com'];
            if (emailDomain && !freeDomains.includes(emailDomain)) {
                const companyName = emailDomain.split('.')[0];
                orgName = companyName.charAt(0).toUpperCase() + companyName.slice(1);
            }

            try {
                // 1. Create Organization
                const { data: newOrg, error: orgError } = await supabaseClient
                    .from('organizations')
                    .insert({ name: orgName })
                    .select()
                    .single();
                
                if (orgError) {
                    console.error("Org Creation Blocked:", orgError);
                    if (orgError.code === '42501') {
                        showToast("Database Error: Run SQL Policy!", true);
                        document.getElementById('auth-container').innerHTML = `<div class="auth-card"><h3 style="color:var(--danger)">Setup Failed</h3><p>You need to run the SQL Policy to allow Organization Creation.</p><button class="btn-primary" onclick="location.reload()">Try Again</button></div>`;
                        return; 
                    }
                }

                const targetOrgId = newOrg ? newOrg.id : (state.org?.id || null);

                // 2. Create/Recover Profile
                const { data: newProfile, error: createError } = await supabaseClient
                    .from('profiles')
                    .insert({
                        user_id: user.id, email: user.email, full_name: fullName,
                        role: 'ceo', org_id: targetOrgId, avatar_url: avatarUrl
                    })
                    .select('*, organizations(*)')
                    .single();

                if (createError) {
                    if (createError.code === '23505') { 
                        console.warn("Claiming zombie profile...");
                        const { data: claimedProfile, error: claimError } = await supabaseClient
                            .from('profiles')
                            .update({ user_id: user.id, role: 'ceo', avatar_url: avatarUrl })
                            .eq('email', user.email)
                            .select('*, organizations(*)')
                            .single();
                        
                        if (claimError) throw claimError;
                        profileData = claimedProfile;
                    } else {
                        throw createError;
                    }
                } else {
                    profileData = newProfile;
                }
                showToast(`Welcome, CEO of ${orgName}!`);

            } catch (err) {
                console.error("Setup Fatal Error:", err);
                showToast("Login Failed: " + err.message, true);
                return;
            }
        }

        // --- LOAD APPLICATION ---
        if (!profileData || !profileData.organizations) {
            console.error("Critical: Profile loaded but Organization data is missing.");
            if (profileData && profileData.org_id) {
                 const { data: refetchOrg } = await supabaseClient.from('organizations').select('*').eq('id', profileData.org_id).single();
                 state.org = refetchOrg;
            }
            if (!state.org && profileData?.organizations) state.org = profileData.organizations;
            
            if (!state.org) {
                 showToast("Error: Account has no Organization linked.", true);
                 return; 
            }
        } else {
            state.profile = profileData; 
            state.org = profileData.organizations;
        }
document.getElementById('auth-container').classList.add('hidden'); 
        document.getElementById('app-container').classList.remove('hidden'); 
        setTimeout(() => document.getElementById('app-container').classList.add('loaded'), 100);
        
        // Fixed: Only update elements that exist
        const userNameEl = document.getElementById('user-name');
        if (userNameEl) userNameEl.innerText = state.profile.full_name;

        document.getElementById('user-avatar').src = state.profile.avatar_url || 'default.png';
        document.getElementById('role-display').innerText = state.profile.role.toUpperCase().replace('_', ' '); 
        document.getElementById('org-display-name').innerText = state.org.name;
        
        if (state.profile.role === 'employee') state.activeView = 'employee_dash';
        else state.activeView = 'dashboard';

        renderSidebar(); 
        
        // --- PLAN BADGE LOGIC ---
        const tier = state.org.subscription_tier || 'free';
        let planName = 'Starter';
        let planColor = '#94a3b8'; // Grey
        let planBg = 'rgba(255,255,255,0.1)';
        let icon = 'fa-seedling';

        if (tier === 'bundle_2') {
            planName = 'Growth Plus'; 
            planColor = '#f1c40f'; // Gold
            planBg = 'rgba(241, 196, 15, 0.2)';
            icon = 'fa-rocket';
        } else if (tier === 'bundle_3') {
            planName = 'Enterprise Pro'; 
            planColor = '#9b59b6'; // Purple
            planBg = 'rgba(155, 89, 182, 0.2)';
            icon = 'fa-gem';
        }

        const badgeHtml = `
            <span style="background:${planBg}; color:${planColor}; border:1px solid ${planColor}; padding:5px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; display:inline-flex; align-items:center; gap:8px; box-shadow:0 0 10px ${planBg};">
                <i class="fa-solid ${icon}"></i> ${planName}
            </span>`;
            
        const badgeContainer = document.getElementById('plan-badge-container');
        if(badgeContainer) badgeContainer.innerHTML = badgeHtml;

        // Show Setup Modal if new
        const isNew = new Date() - new Date(state.org.created_at) < 60000; 
        if (isNew) {
            document.getElementById('setup-modal').classList.remove('hidden');
        }
        
        renderMainContent();
        checkPricingPopup(); // Trigger the pricing modal check
    }
    // 1. DASHBOARD
  async function loadDashboardView(container) {
        const t = i18n[state.lang]; // Get translations

        // 1. Fetch Latest Broadcast
        const { data: broadcast } = await supabaseClient
            .from('broadcast_messages')
            .select('*')
            .eq('org_id', state.org.id)
            .order('sent_at', {ascending:false})
            .limit(1)
            .maybeSingle();

        let broadcastHTML = '';
        if (broadcast) {
            const severityColor = broadcast.severity === 'urgent' ? 'var(--danger)' : 'var(--primary)';
            broadcastHTML = `
            <div class="card" style="border-left: 4px solid ${severityColor}; background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 100%); margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-weight:700; color:${severityColor};"><i class="fa-solid fa-bullhorn"></i> ${broadcast.subject || 'Announcement'}</div>
                    <div style="font-size:0.8rem; opacity:0.7">${new Date(broadcast.sent_at).toLocaleDateString()}</div>
                </div>
                <div style="margin-top:5px; font-size:1rem;">${broadcast.content}</div>
            </div>`;
        }

        // 2. Fetch Expired Docs
        const todayStr = new Date().toISOString().split('T')[0];
        const { data: expiredDocs } = await supabaseClient
            .from('employee_documents')
            .select('*')
            .eq('org_id', state.org.id)
            .lt('expiry_date', todayStr)
            .order('expiry_date', { ascending: true });

        let expiredHTML = '<div style="padding:15px; text-align:center; color:var(--text-muted)">No expired documents. All good!</div>';
        
        if (expiredDocs && expiredDocs.length > 0) {
            const userIds = [...new Set(expiredDocs.map(d => d.profile_id))];
            const { data: owners } = await supabaseClient.from('profiles').select('id, full_name').in('id', userIds);
            const nameMap = {};
            if(owners) owners.forEach(o => nameMap[o.id] = o.full_name);

            expiredHTML = '<div style="max-height: 200px; overflow-y: auto;">';
            expiredDocs.forEach(doc => {
                const ownerName = nameMap[doc.profile_id] || 'Unknown';
                expiredHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(231, 76, 60, 0.3); background:rgba(231, 76, 60, 0.05); margin-bottom:5px; border-radius:6px;">
                    <div>
                        <div style="font-weight:600; font-size:0.9rem; color:var(--text-header)">${doc.document_type}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted)"><i class="fa-solid fa-user"></i> ${ownerName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem; color:var(--danger); font-weight:bold;">${new Date(doc.expiry_date).toLocaleDateString()}</div>
                        <div style="font-size:0.7rem; color:var(--danger); opacity:0.8">Expired</div>
                    </div>
                </div>`;
            });
            expiredHTML += '</div>';
        }

        // 3. Send Alert Button
        let sendAlertBtn = '';
        if (['ceo', 'hr_manager'].includes(state.profile.role) && hasAccess('broadcast')) {
            sendAlertBtn = `<button class="btn-outline" onclick="document.getElementById('broadcast-modal').classList.remove('hidden')"><i class="fa-solid fa-paper-plane"></i> Send Alert</button>`;
        }

        // 4. HEADER DEFINITION (Only Once)
        const header = `<div class="page-title">
            <span>${t.welcome} <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span> 
            <div style="display:flex; gap:10px;">
                ${sendAlertBtn}
                <button class="btn-outline" onclick="exportDashboardPDF()"><i class="fa-solid fa-file-pdf"></i> Export</button>
            </div>
        </div>
        ${broadcastHTML}`;

        // 5. Fetch Stats
        let query = supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
        if (state.profile.role === 'manager') query = query.eq('department', state.profile.department);
        const { count: totalStaff } = await query;

        let activeQuery = supabaseClient.from('wfm_activity').select('user_id').eq('org_id', state.org.id).is('clock_out_time', null);
        if (state.profile.role === 'manager') {
            const { data: teamIds } = await supabaseClient.from('profiles').select('user_id').eq('department', state.profile.department);
            if(teamIds) activeQuery = activeQuery.in('user_id', teamIds.map(t => t.user_id));
        }
        const { data: activeData } = await activeQuery;
        const activeCount = activeData ? activeData.length : 0;

        let jobQuery = supabaseClient.from('ats_jobs').select('*', { count: 'exact', head: true });
        if (state.profile.role === 'manager') { jobQuery = jobQuery.eq('department', state.profile.department); }
        const { count: openJobs } = await jobQuery;

        let schedQuery = supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
        const { data: schedules } = await schedQuery;
        let lateCount = 0; let lateListHTML = '';
        
        if (schedules && schedules.length > 0) {
            const todayStr = new Date().toISOString().split('T')[0];
            const { data: logs } = await supabaseClient.from('wfm_activity').select('clock_in_time, user_id').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
            if(logs && logs.length > 0) {
                const userIds = logs.map(l => l.user_id);
                const { data: logProfiles } = await supabaseClient.from('profiles').select('user_id, full_name, department').in('user_id', userIds);
                const profileMap = {};
                if(logProfiles) logProfiles.forEach(p => profileMap[p.user_id] = p);
                logs.forEach(log => {
                    const profile = profileMap[log.user_id];
                    if(!profile) return;
                    const rule = schedules.find(s => s.department === profile.department) || schedules[0]; 
                    if (rule) {
                        const ruleHour = parseInt(rule.shift_start.split(':')[0]);
                        const ruleMin = parseInt(rule.shift_start.split(':')[1]);
                        const clockTime = new Date(log.clock_in_time);
                        const ruleTime = new Date(log.clock_in_time); 
                        ruleTime.setHours(ruleHour, ruleMin, 0);
                        if (clockTime > ruleTime) {
                            lateCount++;
                            const diff = Math.round((clockTime - ruleTime) / 60000);
                            lateListHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between;"><span>${profile.full_name}</span> <span style="color:var(--danger)">+${diff} min</span></div>`;
                        }
                    }
                });
            }
        }
        if (lateListHTML === '') lateListHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No late arrivals today.</div>';

        // 6. RENDER DASHBOARD
        container.innerHTML = `
            ${header}
            <div id="dash-content">
                <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card"><div class="card-title">${t.total_staff}</div><div class="score-val" style="color:var(--text-main)">${totalStaff || 0}</div></div>
                    <div class="card"><div class="card-title">${t.online_now}</div><div class="score-val" style="color:var(--success)">${activeCount}</div></div>
                    <div class="card"><div class="card-title">${t.open_jobs}</div><div class="score-val" style="color:var(--info)">${openJobs || 0}</div></div>
                    <div class="card"><div class="card-title">${t.late_today}</div><div class="score-val" style="color:var(--danger)">${lateCount}</div></div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card"><div class="card-title" style="margin-bottom:15px; color:var(--danger)">${t.late_today} Ticker</div><div style="overflow-y:auto; max-height:200px;">${lateListHTML}</div></div>
                    <div class="card"><div class="card-title">Staff Distribution</div><div style="height:200px; position:relative;"><canvas id="dashPie"></canvas></div></div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-top:25px;">
                    <div class="card">
                        <div class="card-title">${t.recent_activity}</div>
                        <div id="dash-activity">Loading...</div>
                    </div>
                    <div class="card" style="border-top: 4px solid var(--danger);">
                        <div class="card-title" style="color:var(--danger)"><i class="fa-solid fa-triangle-exclamation"></i> ${t.expired_docs}</div>
                        ${expiredHTML}
                    </div>
                </div>
            </div>
        `;

        // 7. Charts & Feeds
        setTimeout(async () => {
            const chartCanvas = document.getElementById('dashPie');
            if (chartCanvas) {
                const { data: allProfs } = await supabaseClient.from('profiles').select('department').eq('org_id', state.org.id);
                if(allProfs) {
                    const deptCounts = {};
                    allProfs.forEach(p => { const d = p.department || 'Unassigned'; deptCounts[d] = (deptCounts[d] || 0) + 1; });
                    new Chart(chartCanvas, { type: 'doughnut', data: { labels: Object.keys(deptCounts), datasets: [{ data: Object.values(deptCounts), backgroundColor: ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color:'white' } } } } });
                }
            }
        }, 100);

        const { data: feed } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).order('clock_in_time', {ascending:false}).limit(5);
        let feedHTML = '';
        if(feed && feed.length > 0) {
            const feedUserIds = feed.map(f => f.user_id);
            const { data: feedProfiles } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', feedUserIds);
            const feedProfileMap = {};
            if(feedProfiles) feedProfiles.forEach(p => feedProfileMap[p.user_id] = p.full_name);
            feed.forEach(f => {
                const name = feedProfileMap[f.user_id] || 'Unknown User';
                feedHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); font-size:0.9rem;"><span style="font-weight:600; color:var(--primary)">${name}</span> clocked in via ${f.record_source} at ${new Date(f.clock_in_time).toLocaleTimeString()}</div>`;
            });
        } else {
            feedHTML = '<div style="padding:10px; color:var(--text-muted)">No recent activity</div>';
        }
        const activityDiv = document.getElementById('dash-activity');
        if(activityDiv) activityDiv.innerHTML = feedHTML;
    }
    // 1.5 EMPLOYEE DASHBOARD (New)
    async function renderEmployeeDashboard(container) {
        container.innerHTML = `
            <div class="page-title"><span>Welcome, <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span></div>
            <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-clock" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">On-Time Score</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">98%</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-money-check-dollar" style="font-size:2rem; color:var(--warning); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Latest Payslip</div>
                    <div style="font-size:1.5rem; color:white; margin-top:5px;">Processsed</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-list-check" style="font-size:2rem; color:var(--info); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Assigned Tasks</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">3 Pending</div>
                </div>
            </div>
            <div class="card" style="margin-top:20px; padding:40px; text-align:center;">
                <h3 style="margin-bottom:15px;">Quick Actions</h3>
                <button class="btn-primary" onclick="state.activeView='attendance'; renderSidebar(); renderMainContent();">Go to Time Clock</button>
            </div>
        `;
    }

    // 2. EMPLOYEES (Restored & Fixed Button Bug)
    async function loadEmployeesView(container) { 
        // FIX: Store the Header HTML in a variable first




        
        const header = `<div class="page-title">${i18n[state.lang].employees} <button class="btn-primary" onclick="openOnboardModal()"><i class="fa-solid fa-plus"></i> Onboard New Hire</button></div>`;
        
        container.innerHTML = `${header}<div class="card">Loading...</div>`; 
        
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('org_id', state.org.id); 
        if (error) { 
            container.innerHTML = `${header}<div class="card">Error: ${error.message}</div>`; 
            return; 
        }
        
        // FIX: Start the HTML string with the Header again, so it doesn't get wiped out
        let html = `${header}<div class="card"><table><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Details</th></tr></thead><tbody>`;
        
        data.forEach(emp => { 
            const meta = emp.meta_data || {}; 
            html += `<tr>
                <td>${emp.full_name}</td>
                <td>${emp.role}</td>
                <td>${emp.email}</td>
                <td>
                    <button class="btn-outline" style="font-size:0.75rem; padding:5px 10px; margin-right:5px;" onclick="openDocsModal('${emp.id}', '${emp.full_name}')"><i class="fa-solid fa-folder-open"></i> Docs</button>
                    <span class="details-btn" onclick="this.parentElement.querySelector('.details-json').style.display = 'block'">Meta</span>
                    <div class="details-json">${JSON.stringify(meta, null, 2)}</div>
                </td>
            </tr>`;

        }); 
        
        container.innerHTML = html + `</tbody></table></div>`; 
    }

    // 3. PAYROLL (Fixed Bad Request Error)
    async function renderPayrollUI(container) { 
        container.innerHTML = `<div class="page-title">Payroll Intelligence <button class="btn-primary" onclick="document.getElementById('payroll-file-input').click()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Payroll File</button><input type="file" id="payroll-file-input" style="display:none" accept=".csv, .xlsx, .xls" onchange="handlePayrollUpload(this)"></div><div class="payroll-layout"><div class="payroll-sidebar" id="payroll-history-list"><div class="card" style="text-align:center; padding:20px;">Loading History...</div></div><div class="payroll-main"><div id="payroll-loading" class="card hidden" style="text-align:center; padding:40px; justify-content:center;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i><h3 style="margin-top:20px;">AI Processing...</h3></div><div id="payroll-content" class="card" style="padding:0; overflow:hidden;"><div style="padding:50px; text-align:center; color:var(--text-muted)">Select a batch from history or upload a new file.</div></div></div></div>`; 
        const { data: history, error } = await supabaseClient.from('payroll_batch_summary').select('*').eq('org_id', state.org.id).order('created_at', { ascending: false }); 
        const historyList = document.getElementById('payroll-history-list'); 
        if (!historyList) return; // <--- THIS IS THE SAFETY CHECK YOU MUST ADD
        historyList.innerHTML = '';        if(error || !history || history.length === 0) { historyList.innerHTML = `<div class="card" style="padding:15px; text-align:center; color:var(--text-muted)">No upload history</div>`; return; } 
        history.forEach((batch, index) => { 
            const date = new Date(batch.created_at).toLocaleDateString(); const time = new Date(batch.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
            const div = document.createElement('div'); div.className = 'history-item'; 
            div.innerHTML = `<div class="history-date">${date} <span style="font-weight:400; font-size:0.8em; color:#aaa">${time}</span></div><div class="history-meta" style="margin-bottom:5px;"><span><i class="fa-solid fa-user"></i> ${batch.uploader_name || 'Unknown'}</span><span class="history-badge">AI Verified</span></div><div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-main);"><span>Employees: ${batch.employee_count}</span><span style="color:var(--success); font-weight:bold">$${batch.total_net_pay}</span></div>`; 
            div.onclick = () => loadBatchData(batch.id, div); historyList.appendChild(div); if(index === 0) loadBatchData(batch.id, div); 
        }); 
    }

    // 4. ATS (UPGRADED: With Active Jobs Sidebar)
  // 4. ATS (UPGRADED: With Safety Checks)
// 4. ATS (REMASTERED: AI Intelligence View)
    async function loadATSView(container) {
        // 1. Header: Only "Connect Email" remains (Simplicity)
        container.innerHTML = `
            <div class="page-title">
                ATS Recruitment
                <button class="btn-outline" onclick="openEmailConnectModal()">
                    <i class="fa-solid fa-envelope"></i> Connect Email Source
                </button>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:20px;">
                <div class="card" style="padding:18px;">
                    <div class="card-title"><i class="fa-solid fa-at" style="color:var(--primary)"></i> Connected Email</div>
                    <div id="ats-email-status" style="margin-top:10px; color:var(--text-muted);">Checking connection...</div>
                </div>
                <div class="card" style="padding:18px;">
                    <div class="card-title"><i class="fa-solid fa-robot" style="color:var(--info)"></i> Auto-Processing</div>
                    <div style="margin-top:10px; color:var(--text-muted); font-size:0.9rem;">CVs and portfolio links are analyzed automatically from the connected inbox.</div>
                </div>
            </div>
            
            <div class="card" style="padding:0; overflow:hidden; min-height: 500px;">
                <div class="card-header" style="padding:20px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--glass-border);">
                    <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles" style="color:var(--info)"></i> Incoming Candidates & AI Scores</div>
                </div>
                
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:rgba(255,255,255,0.02);">
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">Candidate</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">AI Match Score</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">AI Executive Summary</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">Status</th>
                                <th style="padding:15px; text-align:right; color:var(--text-muted);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ats-list-body">
                            <tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">Loading Intelligence...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>`;

        // 2. Load Connected Email
        await refreshAtsIntegrationStatus();

        // 3. Fetch Candidates (avoid invalid column errors)
        const orgColumn = await resolveAtsOrgColumn();
        const orderColumn = atsOrderColumn || 'id';
        let resp;

        if (orgColumn) {
            resp = await supabaseClient
                .from('ats_applications')
                .select('*, ats_jobs(title, department)')
                .eq(orgColumn, state.org.id)
                .order(orderColumn, { ascending: false });
        } else if (atsUseJobOrgFilter) {
            resp = await supabaseClient
                .from('ats_applications')
                .select('*, ats_jobs!inner(title, department, org_id)')
                .eq('ats_jobs.org_id', state.org.id)
                .order(orderColumn, { ascending: false });
        } else {
            resp = await supabaseClient
                .from('ats_applications')
                .select('*, ats_jobs(title, department)')
                .order(orderColumn, { ascending: false });
        }

        let candidates = resp.data;
        let error = resp.error;
            
        // --- Safety Check ---
        const tableBody = document.getElementById('ats-list-body');
        if (!tableBody) return;

        if (error) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--danger);">Error loading data: ${error.message}</td></tr>`;
            return;
        }

        if (!candidates || candidates.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">
                <i class="fa-solid fa-inbox" style="font-size:2rem; margin-bottom:10px; opacity:0.5"></i><br>
                No candidates yet. Connect your email to start auto-importing.
            </td></tr>`;
            return;
        }

        // 4. Render the "AI View" List
        let html = '';
        candidates.forEach(c => {
            // Determine Score Color
            const score = c.ai_score || 0;
            let scoreColor = 'var(--danger)';
            if(score >= 75) scoreColor = 'var(--success)';
            else if(score >= 50) scoreColor = 'var(--warning)';

            // Formatting
            const summary = c.ai_summary 
                ? (c.ai_summary.length > 120 ? c.ai_summary.substring(0, 120) + '...' : c.ai_summary)
                : '<span style="opacity:0.5; font-style:italic;">Processing analysis...</span>';
            
            const role = c.ats_jobs?.title || 'General Application';

            html += `
            <tr style="border-bottom:1px solid var(--glass-border); transition:0.2s;">
                <td style="padding:15px;">
                    <div style="font-weight:600; color:white; font-size:1rem;">${c.full_name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);"><i class="fa-solid fa-envelope"></i> ${c.email}</div>
                </td>
                <td style="padding:15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; border-radius:50%; border:3px solid ${scoreColor}; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.85rem; color:white;">
                            ${score}%
                        </div>
                    </div>
                </td>
                <td style="padding:15px; max-width:400px;">
                    <div style="font-size:0.9rem; color:var(--text-main); line-height:1.5;">${summary}</div>
                </td>
                <td style="padding:15px;">
                    <span class="badge" style="background:${c.status === 'Hired' ? 'var(--success)' : 'rgba(255,255,255,0.1)'}; padding:5px 10px; font-size:0.75rem;">
                        ${c.status || 'New'}
                    </span>
                </td>
                <td style="padding:15px; text-align:right;">
                    <button class="btn-outline" onclick="viewCandidateAI('${c.id}')" style="font-size:0.8rem;">
                        <i class="fa-regular fa-eye"></i> Full Report
                    </button>
                </td>
            </tr>`;
        });

        tableBody.innerHTML = html;
    }

    // 5. WFM (Restored)
   // 5. WFM (UPGRADED: With Map & Real-Time Status)
   // 5. WFM (UPGRADED: COMMAND CENTER & HISTORY)
// ---------------------------------------------------------
    // 5. WFM (MASTER EDITION: COMMAND CENTER + EXPORT + HISTORY)
    // ---------------------------------------------------------
// ---------------------------------------------------------
    // 5. WFM (EXECUTIVE EDITION: NO MANUAL RULES, PURE AI)
    // ---------------------------------------------------------

  // =========================================================
    // WFM MODULE: EXECUTION, HISTORY & EXPORT
    // =========================================================

    // 1. RENDER UI
    async function renderWFMUI(container) { 
        // Metric Cards with IDs for updates
        const metricsHtml = `
            <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Service Level (SL)</div>
                    <div id="wfm-metric-sl" style="font-size:1.8rem; font-weight:800; color:var(--success)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Target: 80/20</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Schedule Adherence</div>
                    <div id="wfm-metric-adh" style="font-size:1.8rem; font-weight:800; color:var(--warning)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Live vs Planned</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Occupancy Rate</div>
                    <div id="wfm-metric-occ" style="font-size:1.8rem; font-weight:800; color:var(--info)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Utilization</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Shrinkage</div>
                    <div id="wfm-metric-shr" style="font-size:1.8rem; font-weight:800; color:var(--danger)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Breaks/Meetings</div>
                </div>
            </div>`;

        // Main Layout
        container.innerHTML = `
            <div class="page-title">
                Workforce Command Center 
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="document.getElementById('wfm-upload-input').click()">
                        <i class="fa-solid fa-cloud-arrow-up"></i> AI Forecast Import
                    </button>
                    <input type="file" id="wfm-upload-input" style="display:none" accept=".csv, .xlsx" onchange="handleWFMUpload(this)">
                    
                    <button class="btn-outline" onclick="exportWFMData()">
                        <i class="fa-solid fa-file-export"></i> Export Report
                    </button>
                </div>
            </div>

            ${metricsHtml}

            <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fa-solid fa-brain" style="color:var(--info)"></i> AI Strategic Analysis</div>
                    </div>
                    <div id="wfm-insight-box" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; height:200px; overflow-y:auto; font-size:0.95rem; line-height:1.6; color:var(--text-main); border-left:4px solid var(--primary);">
                        <div style="color:var(--text-muted); text-align:center; padding-top:40px;">
                            Upload a file to generate a new strategy.
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:15px;">
                        <div style="font-size:0.9rem; font-weight:700; color:var(--text-muted); margin-bottom:10px;">
                            <i class="fa-solid fa-clock-rotate-left"></i> History
                        </div>
                        <div id="wfm-history-list" style="max-height:120px; overflow-y:auto;">Loading...</div>
                    </div>
                </div>

                <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:15px; border-bottom:1px solid var(--glass-border); font-weight:bold; background:rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center;">
                        <span>Live Floor</span>
                        <span class="badge" style="position:static; background:var(--success)">Real-Time</span>
                    </div>
                    <div id="wfm-roster-list" style="overflow-y:auto; flex-grow:1; padding:10px;">
                        <div style="text-align:center; padding:20px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-table"></i> Schedule Preview</div>
                </div>
                <div style="overflow:auto; max-height:320px;">
                    <table id="wfm-preview-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Date</th>
                                <th>Shift Start</th>
                                <th>Shift End</th>
                                <th>Break Start</th>
                                <th>Break End</th>
                                <th>Location</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" style="text-align:center; color:var(--text-muted);">
                                    Upload a file to preview schedule rows.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:500px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> Geo-Fenced Presence</div>
                </div>
                <div id="work-map" style="width:100%; height:100%; border-radius:12px; z-index:1;"></div>
            </div>`;
        
        loadWFMRoster(); 
        loadWFMHistory(); 
        setTimeout(initLiveMap, 500);
    }

    // 2. UPLOAD & ANALYZE (Robust)
   // =========================================================
    // WFM: FIRE & FORGET (Fixes ERR_CONNECTION_CLOSED)
    // =========================================================

    // 1. Upload & Start AI (Doesn't wait for answer)
    window.handleWFMUpload = async function(input) {
        const file = input.files[0];
        if (!file) return;

        // UI Feedback
        const btn = document.querySelector('.page-title .btn-primary');
        const oldHtml = btn ? btn.innerHTML : 'Import';
        if(btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting AI...';
        showToast("Uploading...", false);

        try {
            // A. Upload File to Supabase Storage
            const fileName = `wfm_forecast_${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file);
            if (uploadError) throw uploadError;
            
            const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName);

            // B. Trigger N8N (Fire & Forget)
            // We verify the request was SENT, but we DO NOT wait for the analysis to finish.
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Handshake limit

            try {
                await fetch('https://n8n.srv1174105.hstgr.cloud/webhook/workforce_hr_digitivia', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'wfm_forecast_analysis',
                        file_url: publicUrl,
                        file_name: fileName, // Important: Sent so N8N can save it to DB
                        org_id: state.org.id,
                        user_id: state.user.id,
                        bundle_tier: state.org.subscription_tier || 'free'
                    }),
                    signal: controller.signal
                });
            } catch (e) {
                // Ignore timeout errors here - it means N8N got the message and is working.
                if (e.name !== 'AbortError') console.warn("Webhook trigger warning:", e);
            }
            clearTimeout(timeoutId);

            // C. Start Looking for the Result in DB
            showToast("AI is analyzing. Results will appear automatically.", false);
            pollForWFMResults(fileName);

        } catch (err) {
            console.error("Upload Error:", err);
            showToast("Failed to start: " + err.message, true);
        } finally {
            if(btn) btn.innerHTML = oldHtml;
            if(input) input.value = '';
        }
    }

    // 2. Poll Database for Results (Bypasses Server Timeout)
    async function pollForWFMResults(targetFileName, attempts = 0) {
        // Stop after 3 minutes (60 attempts * 3s)
        if (attempts > 60) {
            showToast("Analysis taking longer than usual. Check history later.", true);
            return;
        }

        const box = document.getElementById('wfm-insight-box');
        if(box && attempts === 0) {
            box.innerHTML = '<div style="text-align:center; padding:40px; color:var(--info)"><i class="fa-solid fa-brain fa-bounce" style="font-size:2rem; margin-bottom:10px;"></i><br>AI is analyzing strategy...</div>';
        }

        // Look for a recent log entry for THIS file in Supabase
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .eq('org_id', state.org.id)
            .eq('action_type', 'WFM_FORECAST_GENERATED')
            .order('created_at', { ascending: false })
            .limit(1);

        if (logs && logs.length > 0) {
            const log = logs[0];
            // Check if this log matches the file we just uploaded
            if (log.details && log.details.file === targetFileName) {
                showToast("Analysis Complete!", false);
                loadWFMHistory(); // Update the UI
                return;
            }
        }

        // Not found yet? Wait 3s and look again
        setTimeout(() => pollForWFMResults(targetFileName, attempts + 1), 3000);
    }

    // 3. Load History & Update UI
    async function loadWFMHistory() {
        const listContainer = document.getElementById('wfm-history-list');
        if(!listContainer) return;

        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .eq('org_id', state.org.id)
            .eq('action_type', 'WFM_FORECAST_GENERATED')
            .order('created_at', { ascending: false })
            .limit(5);

        if (!logs || logs.length === 0) {
            return;
        }

        // Update Dashboard with LATEST entry
        const latest = logs[0].details?.metrics;
        const latestInsight = logs[0].details?.insight;
        
        if(latest) {
            const slEl = document.getElementById('wfm-metric-sl');
            if(slEl) {
                slEl.innerText = (latest.sl || 0) + "%";
                document.getElementById('wfm-metric-adh').innerText = (latest.adherence || 0) + "%";
                document.getElementById('wfm-metric-occ').innerText = (latest.occupancy || 0) + "%";
                document.getElementById('wfm-metric-shr').innerText = (latest.shrinkage || 0) + "%";
                document.getElementById('wfm-insight-box').innerHTML = (latestInsight || "").replace(/\n/g, '<br>');
            }
        }

        // Render List
        let html = '';
        logs.forEach(log => {
            const date = new Date(log.created_at).toLocaleDateString();
            const fileName = log.details?.file?.split('_').pop() || "Data File";
            // Escape quotes for onclick
            const safeInsight = (log.details?.insight || "").replace(/"/g, "&quot;").replace(/'/g, "\\'");

            html += `
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--info); cursor:pointer;" onclick="document.getElementById('wfm-insight-box').innerHTML='${safeInsight}'">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="font-weight:600; font-size:0.85rem; color:white;">${fileName}</span>
                    <span style="font-size:0.75rem; color:var(--text-muted);">${date}</span>
                </div>
                <div style="font-size:0.75rem; color:var(--primary);">Click to view</div>
            </div>`;
        });
        listContainer.innerHTML = html;
    }
    // 4. EXPORT FUNCTION
    window.exportWFMData = async function() {
        showToast("Generating Report...");
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .eq('org_id', state.org.id)
            .eq('action_type', 'WFM_FORECAST_GENERATED')
            .order('created_at', { ascending: false });

        if(!logs || logs.length === 0) return showToast("No data to export", true);

        let csv = "Date,File,Service Level,Adherence,Occupancy,Insight\n";
        logs.forEach(log => {
            const d = new Date(log.created_at).toLocaleDateString();
            const f = (log.details?.file || "Unknown").split('_').pop();
            const m = log.details?.metrics || {};
            const i = (log.details?.insight || "").replace(/,/g, " ").replace(/\n/g, " ");
            csv += `${d},${f},${m.sl||0}%,${m.adherence||0}%,${m.occupancy||0}%,${i.substring(0,100)}...\n`;
        });

        const link = document.createElement("a");
        link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        link.download = "WFM_Strategy_Report.csv";
        link.click();
    }

    // --- UPDATED: Handle Upload with CORRECT Webhook & Instant Reflection ---
 // --- UPDATED: Handle Upload with CORRECT Webhook & Error Fix ---
// --- UPDATED: Handle Upload with Robust Error Handling & Array Support ---
 
    // --- UPDATED: History Loader (Persists the Dashboard State) ---
    async function loadWFMHistory() {
        const listContainer = document.getElementById('wfm-history-list');
        if(!listContainer) return;

        // Fetch logs
        const { data: logs, error } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .eq('org_id', state.org.id)
            .eq('action_type', 'WFM_FORECAST_GENERATED')
            .order('created_at', { ascending: false })
            .limit(5);

        if (error || !logs || logs.length === 0) {
            return; // Keep default empty state
        }

        // 1. Restore the latest dashboard state automatically
        const latestDetails = parseWfmDetails(logs[0].details);
        const latestMetrics = latestDetails?.metrics;
        const latestInsight = latestDetails?.insight;
        const latestSchedule = extractWfmSchedule(latestDetails);
        
        if(latestMetrics || latestInsight) {
            const slEl = document.getElementById('wfm-metric-sl');
            if(slEl) {
                slEl.innerText = parsePercent(latestMetrics?.sl) + "%";
                const adhEl = document.getElementById('wfm-metric-adh');
                if (adhEl) adhEl.innerText = parsePercent(latestMetrics?.adherence) + "%";
                const occEl = document.getElementById('wfm-metric-occ');
                if (occEl) occEl.innerText = parsePercent(latestMetrics?.occupancy) + "%";
                const shrEl = document.getElementById('wfm-metric-shr');
                if (shrEl) shrEl.innerText = parsePercent(latestMetrics?.shrinkage) + "%";
                if (latestInsight) {
                    document.getElementById('wfm-insight-box').innerHTML = (latestInsight || "").replace(/\n/g, '<br>');
                }
            }
        }
        if (latestSchedule && latestSchedule.length) {
            renderWfmPreviewTable(latestSchedule);
        }

        // 2. Render History List
        let html = '';
        logs.forEach(log => {
            const details = parseWfmDetails(log.details);
            const date = new Date(log.created_at).toLocaleDateString();
            const fileName = details?.file?.split('_').pop() || "Forecast File";
            const safeInsight = (details?.insight || "").replace(/"/g, "&quot;").replace(/'/g, "\\'").replace(/\n/g, "<br>");
            html += `
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--info); cursor:pointer;" onclick="document.getElementById('wfm-insight-box').innerHTML='${safeInsight}'">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="font-weight:600; font-size:0.85rem; color:white;">${fileName}</span>
                    <span style="font-size:0.75rem; color:var(--text-muted);">${date}</span>
                </div>
                <div style="font-size:0.75rem; color:var(--primary);">Click to view</div>
            </div>`;
        });
        listContainer.innerHTML = html;
    }
    // 6. PERFORMANCE (UPGRADED: With Time Filters & Dependent Data)
    async function renderPerformanceUI(container) {
        container.innerHTML = `
            <div class="page-title">
                <div>Performance AI 
                    <div class="cycle-switch" style="display:inline-flex; margin-left:15px; vertical-align:middle;">
                        <button class="cycle-btn ${state.perfCycle==='Daily'?'active':''}" onclick="changePerfCycle('Daily')">Day</button>
                        <button class="cycle-btn ${state.perfCycle==='Weekly'?'active':''}" onclick="changePerfCycle('Weekly')">Week</button>
                        <button class="cycle-btn ${state.perfCycle==='Monthly'?'active':''}" onclick="changePerfCycle('Monthly')">Month</button>
                        <button class="cycle-btn ${state.perfCycle==='Quarterly'?'active':''}" onclick="changePerfCycle('Quarterly')">Qtr</button>
                    </div>
                </div>
                <button class="btn-primary" onclick="openPerformanceModal()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Data</button>
            </div>
            
            <div class="dashboard-grid" id="perf-dependent-stats">
               <div class="card">
                   <div class="card-title">Attendance Factor</div>
                   <div class="score-val" style="color:var(--success)">95%</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Avg On-Time Rate</div>
               </div>
               <div class="card">
                   <div class="card-title">Avg Payroll Bonus</div>
                   <div class="score-val" style="color:var(--warning)">$450</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Last Cycle</div>
               </div>
               <div class="card">
                   <div class="card-title">Manager AI Score</div>
                   <div class="score-val" style="color:var(--info)" id="ai-avg-score">--</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Based on Reviews</div>
               </div>
            </div>

            <div class="card" id="perf-content"><div style="padding:40px; text-align:center;">Loading Performance Data...</div></div>
        `;
        
        // Calculate Date Range based on selection
        let timeFilter = new Date();
        timeFilter.setHours(0,0,0,0); // Start of today default

        if(state.perfCycle === 'Daily') {
            // Already today
        } else if (state.perfCycle === 'Weekly') {
            timeFilter.setDate(timeFilter.getDate() - 7);
        } else if (state.perfCycle === 'Monthly') {
            timeFilter.setDate(timeFilter.getDate() - 30);
        } else if (state.perfCycle === 'Quarterly') {
            timeFilter.setDate(timeFilter.getDate() - 90);
        }

        const { data: reviews, error } = await supabaseClient
            .from('performance_reviews')
            .select(`*, profiles( full_name, email, role )`)
            .eq('org_id', state.org.id)
            .gte('period_start', timeFilter.toISOString())
            .order('score_final', { ascending: false });

        if (error) { 
            document.getElementById('perf-content').innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted)">Error loading data.</div>`; 
            return; 
        }
        
        // Calculate Avg AI Score if reviews exist
        if(reviews && reviews.length > 0) {
            const avgScore = (reviews.reduce((sum, r) => sum + (r.score_final || 0), 0) / reviews.length).toFixed(1);
            const scoreEl = document.getElementById('ai-avg-score');
            if(scoreEl) scoreEl.innerText = avgScore;
        }

        renderPerformanceTable(reviews);
    }

    // 7. REPORTS (Restored)
    async function renderReportsUI(container) { 
        container.innerHTML = `<div class="page-title">Strategic Reports <button class="btn-outline" onclick="exportReportsSummary()"><i class="fa-solid fa-download"></i> Export Summary</button></div><div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;"><div class="card"><div class="card-title">Burnout Risk (Hours Worked vs Scheduled)</div><canvas id="burnoutChart" height="200"></canvas></div><div class="card"><div class="card-title">Department Efficiency</div><canvas id="efficiencyChart" height="200"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Labor ROI Analysis</div><span class="badge" style="position:static; background:var(--info)">Live Data</span></div><div style="overflow-x:auto;"><table id="roi-table"><thead><tr><th>Employee</th><th>Role</th><th>Monthly Cost</th><th>Productivity</th><th>ROI Factor</th><th>Risk Status</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody></table></div></div>`; 
        const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
        if(error || !reports) { document.querySelector('#roi-table tbody').innerHTML = '<tr><td colspan="6" style="color:red">View not ready. Run SQL.</td></tr>'; return; }
        
        // SAFETY FIX: Wait for DOM
        setTimeout(() => { initReportCharts(reports); }, 100);
        renderROITable(reports); 
    }

// 8. ATTENDANCE (Personal View Only)
   // 8. ATTENDANCE (Personal View Only)
  // 8. ATTENDANCE (Personal View Only)
    async function renderAttendanceUI(container) {
        const { data: activity } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).is('clock_out_time', null).maybeSingle();
        const isClockedIn = !!activity;
        const startTime = activity ? new Date(activity.clock_in_time) : null;
        let durationHTML = '';
        
        if (isClockedIn) {
            const diffMs = new Date() - startTime; 
            const hrs = Math.floor(diffMs / 3600000); 
            const mins = Math.floor((diffMs % 3600000) / 60000);
            durationHTML = `<div style="text-align:center; margin-bottom:20px;"><div style="font-size:3rem; font-weight:700; color:var(--success); text-shadow:0 0 20px rgba(46,204,113,0.4);">${hrs}h ${mins}m</div><div class="perf-badge" style="background:rgba(46,204,113,0.2); color:var(--success);">Active Session</div></div>`;
        }
        
        const isAdmin = ['ceo','admin','hr_manager'].includes(state.profile.role);

        container.innerHTML = `
            <div class="page-title">
                My Attendance Workspace 
                ${isAdmin ? `<button class="btn-outline" onclick="document.getElementById('import-modal').classList.remove('hidden')"><i class="fa-solid fa-file-import"></i> Import Legacy</button>` : ''}
            </div>
            
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="card" style="align-items:center; justify-content:center; position:relative; overflow:hidden;">
                    ${durationHTML}
                    <div id="camera-preview" class="hidden" style="width:100%; max-width:300px; border-radius:12px; margin-bottom:15px; border:2px solid var(--primary);">
                        <video id="vid" autoplay style="width:100%; border-radius:10px;"></video>
                    </div>
                    ${!isClockedIn ? 
                        `<button id="btn-scan" class="btn-primary" style="padding:15px 40px; font-size:1.2rem;" onclick="startClockInFlow()"><i class="fa-solid fa-fingerprint"></i> Biometric Clock In</button><div id="loc-status" style="margin-top:10px; color:var(--text-muted); font-size:0.8rem;"><i class="fa-solid fa-location-dot"></i> Waiting for GPS...</div>` : 
                        `<button class="btn-outline" style="border-color:var(--danger); color:var(--danger); padding:15px 40px;" onclick="handleClockOut('${activity.id}')"><i class="fa-solid fa-power-off"></i> End Shift</button>`
                    }
                </div>
                
                <div class="card" style="overflow-y:auto">
                    <div class="card-title">My Recent Activity</div>
                    <div id="attendance-history" style="margin-top:15px;">Loading...</div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:450px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> Live Team Map</div>
                    <span class="badge" style="position:static; background:var(--success)">Online Staff</span>
                </div>
                <div id="work-map" style="width:100%; height:100%; border-radius:12px; z-index:1;"></div>
            </div>`;
            
        loadAttendanceHistory();
        setTimeout(initLiveMap, 500); // Reuses the map logic
    }
    // --- NEW: ORG PROFILE (CEO ONLY) ---
   // --- NEW: ORG PROFILE (CEO ONLY) - CLEANED ---
    async function renderOrgProfile(container) {
        if(!await checkRoleAccess(['ceo'])) return;

        container.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Settings...</div>`;
        
        // Fetch fresh org data
        const { data: org, error } = await supabaseClient.from('organizations').select('*').eq('id', state.org.id).single();
        if(error) return showToast("Failed to load org data", true);

        container.innerHTML = `
            <div class="page-title">Organization Settings <span class="badge" style="position:static; font-size:0.9rem; background:var(--info)">Enterprise Tier</span></div>
            
            <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fa-solid fa-building"></i> Corporate Identity</div></div>
                    <div class="form-group">
                        <label>Organization Name</label>
                        <input type="text" id="set-org-name" class="form-input" value="${org.name}">
                    </div>
                    <div class="form-group">
                        <label>CEO / Owner</label>
                        <input type="text" class="form-input" value="${state.profile.full_name}" disabled style="opacity:0.5">
                    </div>
                    <button class="btn-primary" onclick="saveOrgIdentity()">Save Changes</button>
                </div>
            </div>
            
            <div class="card" style="margin-top:20px;">
                <div class="card-header"><div class="card-title">Audit Trail (Recent Sensitive Actions)</div></div>
                <div id="audit-list">Loading logs...</div>
            </div>
        `;
        
        loadAuditLogs();
    }

    async function loadAuditLogs() {
        // FIX 1: Safety Check - Ensure element exists before loading
        const listContainer = document.getElementById('audit-list');
        if(!listContainer) return; 

        const { data: logs } = await supabaseClient.from('audit_logs').select('actor_id, action_type, target_record, created_at').eq('org_id', state.org.id).order('created_at', {ascending:false}).limit(10);
        let html = `<table style="font-size:0.9rem;"><thead><tr><th>Actor</th><th>Action</th><th>Target</th><th>Time</th></tr></thead><tbody>`;
        if(logs && logs.length > 0) {
            const actorIds = logs.map(l => l.actor_id);
            const { data: actors } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', actorIds);
            const actorMap = {};
            if(actors) actors.forEach(a => actorMap[a.user_id] = a.full_name);
            logs.forEach(l => {
                const name = actorMap[l.actor_id] || 'System';
                html += `<tr><td>${name}</td><td>${l.action_type}</td><td>${l.target_record || '-'}</td><td>${new Date(l.created_at).toLocaleString()}</td></tr>`;
            });
        } else { html += `<tr><td colspan="4" style="text-align:center">No logs found</td></tr>`; }
        html += `</tbody></table>`;
        
        // FIX 1: Use variable, don't query DOM again
        listContainer.innerHTML = html;
    }

    // --- SAVE FUNCTIONS (CEO ONLY) ---
    window.saveOrgIdentity = async function() {
        const newName = document.getElementById('set-org-name').value;
        const { error } = await supabaseClient.from('organizations').update({ name: newName }).eq('id', state.org.id);
        if(error) return showToast("Update Failed: " + error.message, true);
        await logSystemAction('UPDATE_ORG_IDENTITY', state.org.id, { old: state.org.name, new: newName });
        state.org.name = newName;
        showToast("Organization Updated");
        loadAuditLogs();
    }

    window.saveSecuritySettings = async function() {
        const settings = {
            security_settings: {
                mfa_enforced: document.getElementById('set-mfa').checked,
                session_timeout: parseInt(document.getElementById('set-timeout').value)
            },
            retention_policy: {
                cv_months: parseInt(document.getElementById('set-ret-cv').value),
                logs_months: parseInt(document.getElementById('set-ret-logs').value)
            }
        };
        const { error } = await supabaseClient.from('organizations').update(settings).eq('id', state.org.id);
        if(error) return showToast("Security Update Failed", true);
        await logSystemAction('UPDATE_SECURITY_POLICY', state.org.id, settings);
        showToast("Compliance Rules Saved");
        loadAuditLogs();
    }

    // --- MAIN ROUTER ---
    function renderMainContent() {
        const view = state.activeView; const main = document.getElementById('main-view'); if(!main) return; main.innerHTML = ''; 
        if(view === 'dashboard') loadDashboardView(main);
        else if(view === 'employee_dash') renderEmployeeDashboard(main); // NEW EMPLOYEE DASH
        else if(view === 'org_profile') renderOrgProfile(main); 
        else if(view === 'employees') { if(['ceo','hr_manager','manager'].includes(state.profile.role)) loadEmployeesView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'payroll') { if(['ceo','hr_manager'].includes(state.profile.role)) renderPayrollUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'wfm') { if(['ceo','admin','manager'].includes(state.profile.role)) renderWFMUI(main); else renderEmployeeWFM(main); }
        else if(view === 'reports') { if(['ceo','admin'].includes(state.profile.role)) renderReportsUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'ats') { if(['ceo','admin','hr_manager'].includes(state.profile.role)) loadATSView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'performance') { if(['ceo','admin','hr_manager','manager'].includes(state.profile.role)) renderPerformanceUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
        else if(view === 'attendance') { renderAttendanceUI(main); }
        else main.innerHTML = `<div class="card"><h2>${view.toUpperCase()}</h2><p>Module active for ${state.profile.role}</p></div>`;
    }

    // --- RBAC HIERARCHY SIDEBAR ---
   // --- RBAC HIERARCHY SIDEBAR ---
    function renderSidebar() {
        const t = i18n[state.lang]; const role = state.profile.role; 
        const container = document.getElementById('nav-container'); if(!container) return; container.innerHTML = '';
        
        // 0. EMPLOYEE VIEW
        if (role === 'employee') {
             const ul = document.createElement('ul'); ul.className = 'nav-links';
             ul.innerHTML += `<li class="nav-item ${state.activeView==='employee_dash'?'active':''}" onclick="state.activeView='employee_dash';renderSidebar();renderMainContent()"><i class="fa-solid fa-home"></i> <span>My Home</span></li>`;
             ul.innerHTML += `<li class="nav-item ${state.activeView==='attendance'?'active':''}" onclick="state.activeView='attendance';renderSidebar();renderMainContent()"><i class="fa-solid fa-clock"></i> <span>Time Clock</span></li>`;
             container.appendChild(ul);
             return;
        }

        // 1. EXECUTIVE SUITE (CEO + ADMIN + HR MANAGER)
        if (['ceo', 'admin', 'hr_manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">Executive Suite</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            ul.innerHTML += `<li class="nav-item ${state.activeView==='dashboard'?'active':''}" onclick="state.activeView='dashboard';renderSidebar();renderMainContent()"><i class="fa-solid fa-chart-pie"></i> <span>${t.dashboard}</span></li>`;
            
            // CEO Only: Org Settings
            if (role === 'ceo') {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='org_profile'?'active':''}" onclick="state.activeView='org_profile';renderSidebar();renderMainContent()"><i class="fa-solid fa-building-shield"></i> <span>${t.org_profile}</span></li>`;
            }
            // Reports
            if (['ceo', 'admin'].includes(role)) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='reports'?'active':''}" onclick="state.activeView='reports';renderSidebar();renderMainContent()"><i class="fa-solid fa-file-alt"></i> <span>${t.reports}</span></li>`;
            }
            sec.appendChild(ul); container.appendChild(sec);
        }

        // 2. HR OPERATIONS (CEO + HR MANAGER)
        if (['ceo', 'admin', 'hr_manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">HR Operations</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            
            ul.innerHTML += `<li class="nav-item ${state.activeView==='employees'?'active':''}" onclick="state.activeView='employees';renderSidebar();renderMainContent()"><i class="fa-solid fa-users"></i> <span>${t.employees}</span></li>`;
            
            // Payroll
            if(['ceo','hr_manager'].includes(role)) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='payroll'?'active':''}" onclick="state.activeView='payroll';renderSidebar();renderMainContent()"><i class="fa-solid fa-money-bill-wave"></i> <span>${t.payroll}</span></li>`;
            }
            
            // --- ATS MOVED HERE WITH GATING LOGIC ---
            if (hasAccess('ats')) { 
                 ul.innerHTML += `<li class="nav-item ${state.activeView==='ats'?'active':''}" onclick="state.activeView='ats';renderSidebar();renderMainContent()"><i class="fa-solid fa-briefcase"></i> <span>${t.ats}</span></li>`;
            } else {
                // LOCKED -> Opens Pricing Modal
                ul.innerHTML += `<li class="nav-item" style="opacity:0.5; cursor:pointer;" onclick="openPricingModal()"><i class="fa-solid fa-lock"></i> <span>${t.ats}</span></li>`;
            }
            
            sec.appendChild(ul); container.appendChild(sec);
        }

        // 3. TEAM MANAGEMENT (Managers + Admins)
        if (['ceo', 'admin', 'hr_manager', 'manager'].includes(role)) {
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">Team Management</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            
            // WFM Feature Gating
            if (hasAccess('wfm')) {
                ul.innerHTML += `<li class="nav-item ${state.activeView==='wfm'?'active':''}" onclick="state.activeView='wfm';renderSidebar();renderMainContent()"><i class="fa-solid fa-timeline"></i> <span>${t.wfm}</span></li>`;
            } else {
                ul.innerHTML += `<li class="nav-item" style="opacity:0.5; cursor:pointer;" onclick="openPricingModal()"><i class="fa-solid fa-lock"></i> <span>${t.wfm}</span></li>`;
            }

            // ATS was removed from here to prevent duplication

            ul.innerHTML += `<li class="nav-item ${state.activeView==='performance'?'active':''}" onclick="state.activeView='performance';renderSidebar();renderMainContent()"><i class="fa-solid fa-star"></i> <span>${t.performance}</span></li>`;
            
            sec.appendChild(ul); container.appendChild(sec);
        }

        // 4. WORKSPACE (Everyone)
        const sec = document.createElement('div');
        sec.innerHTML = `<div class="nav-header">My Workspace</div>`;
        const ul = document.createElement('ul'); ul.className = 'nav-links';
        ul.innerHTML += `<li class="nav-item ${state.activeView==='attendance'?'active':''}" onclick="state.activeView='attendance';renderSidebar();renderMainContent()"><i class="fa-solid fa-clock"></i> <span>${t.attendance}</span></li>`;
        sec.appendChild(ul); container.appendChild(sec);
    }
      

    function exportDashboardPDF() {
        const element = document.getElementById('dash-content');
        const opt = { margin: 10, filename: `Dashboard_Snapshot_${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, backgroundColor: '#0f2027' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
        html2pdf().set(opt).from(element).save();
    }

    // --- ADD THIS FUNCTION TO FIX REPORTS EXPORT ---
    window.exportReportsSummary = async function() {
        const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
        if(error || !reports) return showToast("No data found to export", true);
        
        let csvContent = "data:text/csv;charset=utf-8,Employee,Role,Productivity Score,Total Cost,ROI Status\n";
        
        reports.forEach(r => {
            const row = `${r.full_name},${r.role},${r.productivity_score},${r.total_cost},Healthy`;
            csvContent += row + "\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Strategy_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- ADD THIS FUNCTION TO FIX ATTENDANCE EXPORT ---
   // --- UPDATED FIX FOR ATTENDANCE EXPORT (Safe Mode) ---
    window.handleExportAttendance = async function() {
        showToast("Generating CSV...");
        
        // Step 1: Fetch the raw logs WITHOUT trying to join tables
        const { data: logs, error } = await supabaseClient
            .from('wfm_activity')
            .select('*') 
            .eq('org_id', state.org.id)
            .order('clock_in_time', { ascending: false });

        if(error || !logs) {
            console.error("Export Error:", error);
            return showToast("Export Failed: " + (error?.message || "Unknown"), true);
        }

        // Step 2: Fetch the user names manually (prevents 400 Error)
        const userIds = [...new Set(logs.map(l => l.user_id))]; // Get unique User IDs
        const { data: profiles } = await supabaseClient
            .from('profiles')
            .select('user_id, full_name')
            .in('user_id', userIds);

        // Create a fast lookup map: ID -> Name
        const profileMap = {};
        if (profiles) {
            profiles.forEach(p => profileMap[p.user_id] = p.full_name);
        }

        // Step 3: Build the CSV using the map
        let csv = "data:text/csv;charset=utf-8,Employee,Date,Time In,Time Out,Status,Source\n";
        
        logs.forEach(l => {
            const name = profileMap[l.user_id] || 'Unknown User';
            const date = new Date(l.clock_in_time).toLocaleDateString();
            const timeIn = new Date(l.clock_in_time).toLocaleTimeString();
            const timeOut = l.clock_out_time ? new Date(l.clock_out_time).toLocaleTimeString() : 'Active';
            
            // Clean comma from names to avoid breaking CSV format
            const cleanName = name.replace(/,/g, " ");
            
            csv += `${cleanName},${date},${timeIn},${timeOut},${l.current_status},${l.record_source}\n`;
        });

        const encodedUri = encodeURI(csv);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Attendance_Log_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- OTHER HELPERS ---
    async function loadBatchData(batchId, element) { document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active')); if(element) element.classList.add('active'); const content = document.getElementById('payroll-content'); content.innerHTML = `<div style="padding:50px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Data...</div>`; const { data, error } = await supabaseClient.from('payroll_items').select('*').eq('batch_id', batchId).order('employee_name', { ascending: true }); if(error) { content.innerHTML = `<div style="padding:20px; color:var(--danger)">Error loading data</div>`; return; } renderPayrollTable(data, false); }
    async function handlePayrollUpload(input) { 
        const file = input.files[0]; 
        if(!file) return; 
        
        document.getElementById('payroll-content').classList.add('hidden'); 
        document.getElementById('payroll-loading').classList.remove('hidden'); 
        
        try { 
            const fileName = `${Date.now()}_${file.name}`; 
            
            // Upload File
            const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file); 
            if(uploadError) throw uploadError; 
            
            const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName); 
            
            // FIX: Simplified Insert to avoid 'app_role' type mismatch from trigger
            // The RLS check (auth.uid) will happen automatically. We don't need complex selects here.
            const { data: batchData, error: batchError } = await supabaseClient
                .from('payroll_batches')
                .insert({ 
                    org_id: state.org.id, 
                    uploaded_by: state.user.id, 
                    file_url: publicUrl, 
                    status: 'processing' 
                })
                .select()
                .single(); 
            
            if(batchError) {
                // Specific handling for RLS type errors
                if(batchError.code === '42804') {
                    throw new Error("Database Type Mismatch. Please ask admin to check 'get_my_profile_safe' return type.");
                }
                throw batchError; 
            }
            
            // Call AI
            const n8nResponse = await fetch(N8N_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, // UPDATED: Sends Bundle Tier so N8N knows whether to apply Advanced Automation
body: JSON.stringify({ 
    file_url: publicUrl, 
    org_id: state.org.id, 
    batch_id: batchData.id,
    bundle_tier: state.org.subscription_tier || 'free' // <--- ADDED THIS
}) }); 
            if(!n8nResponse.ok) throw new Error("AI Analysis Failed"); 
            const aiPayload = await n8nResponse.json(); 
            const rows = normalizePayrollRows(aiPayload);
            const normalizedRows = rows.map(normalizePayrollRow);
            
            const itemsToInsert = normalizedRows.map(item => {
                const salary = Number(item.salary) || 0;
                const bonus = Number(item.bonus) || 0;
                const deductions = Number(item.deductions) || 0;
                return { 
                    batch_id: batchData.id, 
                    employee_name: item.employee_name || 'Unknown', 
                    salary: salary, 
                    bonus: bonus, 
                    deductions: deductions, 
                    net_pay: salary + bonus - deductions 
                };
            }); 
            
            if(itemsToInsert.length > 0) { 
                const { data: savedItems, error: itemsError } = await supabaseClient.from('payroll_items').insert(itemsToInsert).select(); 
                if(itemsError) throw itemsError; 
                renderPayrollUI(document.getElementById('main-view')); 
            } else { 
                showToast("AI found no valid data", true); 
                renderPayrollUI(document.getElementById('main-view')); 
            } 
        } catch(err) { 
            console.error(err); 
            showToast(err.message, true); 
            renderPayrollUI(document.getElementById('main-view')); 
        } 
    }

    

    
    async function updatePayrollItem(id, field, newValue, oldValue) { if(newValue === oldValue) return; try { await supabaseClient.from('payroll_items').update({ [field]: newValue }).eq('id', id); await supabaseClient.from('payroll_history').insert({ item_id: id, changed_by: state.user.id, field_changed: field, old_value: oldValue, new_value: newValue }); showToast("Updated"); } catch(err) { showToast("Update Failed", true); } }
    function changePerfCycle(cycle) { state.perfCycle = cycle; renderPerformanceUI(document.getElementById('main-view')); }
    function openPerformanceModal() { document.getElementById('perf-modal').classList.remove('hidden'); }
    function setPerfInput(mode) { state.perfInputMode = mode; const btnFile = document.getElementById('btn-file-mode'); const btnManual = document.getElementById('btn-manual-mode'); const boxFile = document.getElementById('perf-input-file'); const boxManual = document.getElementById('perf-input-manual'); if (mode === 'file') { btnFile.style.borderColor = 'var(--primary)'; btnManual.style.borderColor = 'var(--glass-border)'; boxFile.classList.remove('hidden'); boxManual.classList.add('hidden'); } else { btnManual.style.borderColor = 'var(--primary)'; btnFile.style.borderColor = 'var(--glass-border)'; boxManual.classList.remove('hidden'); boxFile.classList.add('hidden'); } }
    async function handlePerformanceSubmit() { const btn = document.querySelector('#perf-modal .btn-primary'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...'; try { const dept = document.getElementById('perf-dept').value; let payloadData = ""; if (state.perfInputMode === 'file') { const fileInput = document.getElementById('perf-file'); if (!fileInput.files.length) throw new Error("Please select a file."); const file = fileInput.files[0]; const fileName = `perf_${Date.now()}_${file.name}`; const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file); if (uploadError) throw uploadError; const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName); payloadData = publicUrl; } else { payloadData = document.getElementById('perf-text').value; if (!payloadData) throw new Error("Please enter text logs."); } const response = await fetch(N8N_PERF_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "analyze_performance", org_id: state.org.id, department: dept, review_period: state.perfCycle, input_type: state.perfInputMode, data_content: payloadData }) }); if (!response.ok) throw new Error("AI Analysis Failed"); let aiResponse = await response.json(); if (Array.isArray(aiResponse) && aiResponse.length > 0) aiResponse = aiResponse[0]; if (typeof aiResponse === 'string') try { aiResponse = JSON.parse(aiResponse); } catch(e) {} const results = aiResponse.results || []; if (results.length === 0) throw new Error("AI returned no results."); let successCount = 0; for (const res of results) { const { data: userProfile } = await supabaseClient.from('profiles').select('user_id').eq('email', res.email).maybeSingle(); if (userProfile) { await supabaseClient.from('performance_reviews').insert({ org_id: state.org.id, user_id: userProfile.user_id, review_period: state.perfCycle, period_start: new Date(), period_end: new Date(), score_quality: res.score_quality || 0, score_speed: res.score_speed || 0, score_teamwork: res.score_teamwork || 0, score_efficiency: res.score_efficiency || 0, score_final: res.score_final || 0, ai_feedback: res.ai_feedback || "No feedback.", raw_data_source: state.perfInputMode }); successCount++; } } showToast(`Success! Saved ${successCount} reviews.`); document.getElementById('perf-modal').classList.add('hidden'); renderPerformanceUI(document.getElementById('main-view')); } catch (err) { console.error(err); showToast(err.message, true); } finally { btn.innerHTML = oldText; } }
    async function promoteCandidateToEmployee(candidateId) { const { data: candidate, error } = await supabaseClient.from('ats_applications').select('*, ats_jobs(title, department)').eq('id', candidateId).single(); if (error) { showToast("Error fetching details", true); return; } openOnboardModal(); document.getElementById('new-name').value = candidate.full_name; document.getElementById('new-email').value = candidate.email; document.getElementById('new-meta-phone').value = candidate.phone || ''; document.getElementById('new-meta-dept').value = candidate.ats_jobs?.department || ''; showToast("Candidate data pre-filled. Please set a password."); }
    function openOnboardModal() { const sel = document.getElementById('new-role'); sel.innerHTML=''; ['hr_manager','manager','employee'].forEach(r=>sel.innerHTML+=`<option value="${r}">${r}</option>`); document.getElementById('onboard-modal').classList.remove('hidden'); }
    function closeOnboardModal() { document.getElementById('onboard-modal').classList.add('hidden'); }
// --- UPDATED ONBOARDING LOGIC ---
// --- 1. NEW HELPER: Adds a row to the document list inside the modal ---
    function addObjDocRow() {
        const container = document.getElementById('onboard-docs-list');
        const id = Date.now(); // Unique ID for UI handling
        const html = `
        <div id="doc-row-${id}" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid var(--glass-border);">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:0.8rem; font-weight:bold; color:var(--text-muted);">New Document</span>
                <i class="fa-solid fa-trash" style="color:var(--danger); cursor:pointer;" onclick="document.getElementById('doc-row-${id}').remove()"></i>
            </div>
            <input type="text" class="form-input doc-title" placeholder="Type (e.g. Passport)" style="margin-bottom:5px;">
            <input type="date" class="form-input doc-date" style="margin-bottom:5px;">
            <input type="text" class="form-input doc-link" placeholder="Paste File URL / Drive Link">
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- 2. UPDATED MAIN FUNCTION: Validates inputs & Saves Data ---
    async function executeOnboard() {
        const btn = document.querySelector('#onboard-modal .btn-primary');
        const oldText = btn.innerText;
        
        // A. GET VALUES
        const fullName = document.getElementById('new-name').value;
        const email = document.getElementById('new-email').value;
        const password = document.getElementById('new-pass').value;
        const role = document.getElementById('new-role').value;
        const phone = document.getElementById('new-meta-phone').value; 
        const dept = document.getElementById('new-meta-dept').value;

        // B. VALIDATION (Phone is now required)
        if(!fullName || !email || !password || !phone) { 
            return showToast("Error: Name, Email, Password, and Phone are REQUIRED.", true); 
        }

        btn.innerText = "Creating Profile...";

try {
        // 1. Create Auth User
        const dummyStorage = { getItem: () => null, setItem: () => {}, removeItem: () => {} };
        const tempClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { 
            auth: { persistSession: false, storage: dummyStorage, autoRefreshToken: false, detectSessionInUrl: false } 
        });
        
        const { data: authData, error: authError } = await tempClient.auth.signUp({ 
            email: email, password: password, options: { data: { full_name: fullName } } 
        });

        if (authError) throw authError;
        if (!authData.user) throw new Error("Auth Creation Failed");

        // 2. Create Profile (RPC)
        const metaData = { phone: phone, department: dept };
        const { error: profileError } = await supabaseClient.rpc('admin_create_profile', { 
            target_user_id: authData.user.id, user_email: email, full_name: fullName, 
            user_role: role, target_org_id: state.org.id, user_meta: metaData, 
            avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random` 
        });

        if (profileError) throw profileError;

        // 3. CRITICAL FIX: Fetch the new Profile ID to use for Documents
        const { data: newProfile, error: fetchError } = await supabaseClient
            .from('profiles')
            .select('id')
            .eq('user_id', authData.user.id)
            .single();

        if (fetchError || !newProfile) throw new Error("Could not retrieve new profile ID");

        // 4. Save Documents (Using the correct Profile ID)
        const docRows = document.querySelectorAll('#onboard-docs-list > div');
        if (docRows.length > 0) {
            btn.innerText = "Saving Docs...";
            const docsToInsert = [];
            
            docRows.forEach(row => {
                const title = row.querySelector('.doc-title').value;
                const date = row.querySelector('.doc-date').value;
                const link = row.querySelector('.doc-link').value;
                
                if(title && date) {
                    docsToInsert.push({
                        org_id: state.org.id,
                        profile_id: newProfile.id, // <--- USING CORRECT ID HERE
                        document_type: title,
                        expiry_date: date,
                        external_link: link || null,
                        is_checklist_only: false 
                    });
                }
            });

            if(docsToInsert.length > 0) {
                const { error: docError } = await supabaseClient.from('employee_documents').insert(docsToInsert);
                if(docError) {
                    console.error("Doc Error:", docError);
                    showToast("User created, but docs failed: " + docError.message, true);
                }
            }
        }

        showToast(`Success! ${fullName} onboarded.`);
        closeOnboardModal();
        if(state.activeView === 'employees') loadEmployeesView(document.getElementById('main-view'));

    } catch (err) {
        console.error(err);
        showToast(err.message, true);
    } finally {
        btn.innerText = oldText;
    }
    }    
    async function renderEmployeeWFM(container) { container.innerHTML = `<div class="page-title">My Schedule</div><div class="card" style="text-align:center; padding:50px;"><h2>09:00 AM - 05:00 PM</h2><p style="color:var(--text-muted); margin-bottom:20px;">Today's Shift</p><button class="btn-primary" onclick="showToast('Use Attendance Tab to Clock In')">Go to Attendance</button></div>`; }
    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) { var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1); var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); var d = R * c; return d * 1000; }
    function deg2rad(deg) { return deg * (Math.PI/180); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function showToast(msg, isError = false) { const t = document.getElementById('toast'); if(!t) return; document.getElementById('toast-msg').innerText = msg; t.style.background = isError ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)'; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
function toggleLang() {
    state.lang = state.lang === 'en' ? 'ar' : 'en';
    const t = i18n[state.lang];

    // 1. Update HTML tag for RTL/LTR
    document.documentElement.setAttribute('lang', state.lang);
    document.documentElement.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');

    // 2. Update the button text itself
    document.getElementById('lang-btn').innerText = t.langBtn;

    // 3. Re-render the UI to apply translations
    renderSidebar();
    renderMainContent();

    // 4. Update other static parts of the UI
    // Example: Update the profile modal title and labels
    // document.querySelector('#profile-modal .modal-title').firstChild.textContent = t.myProfile + ' ';
    // ... update other elements by ID ...
}    // --- 5. NEW HELPER FUNCTIONS (Paste at bottom of script) ---

    // DOCS LOGIC
    let activeDocUserId = null;
    
    window.openDocsModal = async function(userId, name) {
        activeDocUserId = userId;
        document.getElementById('docs-user-name').innerText = name;
        document.getElementById('docs-modal').classList.remove('hidden');
        loadDocsList(userId);
    }

    async function loadDocsList(userId) {
        const list = document.getElementById('docs-list');
        list.innerHTML = '<div style="text-align:center"><i class="fa-solid fa-spinner fa-spin"></i></div>';
        
        const { data: docs } = await supabaseClient.from('employee_documents').select('*').eq('profile_id', userId);
        
        if(!docs || docs.length === 0) {
            list.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">No documents tracked.</div>';
            return;
        }

        let html = '';
        docs.forEach(d => {
            const isExpired = d.expiry_date ? new Date(d.expiry_date) < new Date() : false;
            const style = isExpired ? 'color:var(--danger); font-weight:bold;' : 'color:var(--success)';
            const linkHtml = d.external_link ? `<a href="${d.external_link}" target="_blank" style="color:var(--primary)"><i class="fa-solid fa-link"></i></a>` : '';
            
            html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--glass-border); align-items:center;">
                <span>${d.document_type}</span>
                <span style="${style}">${d.expiry_date || 'No Expiry'}</span>
                ${linkHtml}
            </div>`;
        });
        list.innerHTML = html;
    }

    window.saveEmployeeDoc = async function() {
        const type = document.getElementById('doc-type').value;
        const expiry = document.getElementById('doc-expiry').value;
        const link = document.getElementById('doc-link').value;
        const isChecklist = document.getElementById('doc-checklist').checked;

        if(!type) return showToast("Type is required", true);

        const { error } = await supabaseClient.from('employee_documents').insert({
            org_id: state.org.id,
            profile_id: activeDocUserId, // Uses the global variable set on open
            document_type: type,
            expiry_date: expiry || null,
            external_link: link || null,
            is_checklist_only: isChecklist
        });

        if(error) showToast("Error: " + error.message, true);
        else {
            showToast("Document Saved");
            loadDocsList(activeDocUserId); // Refresh list
            // Clear inputs
            document.getElementById('doc-type').value = '';
            document.getElementById('doc-link').value = '';
        }
    }

    // BROADCAST LOGIC
    window.sendBroadcast = async function() {
        const subject = document.getElementById('bc-subject').value;
        const msg = document.getElementById('bc-msg').value;
        const severity = document.getElementById('bc-severity').value;

        if(!msg) return showToast("Message required", true);

        const { error } = await supabaseClient.from('broadcast_messages').insert({
            org_id: state.org.id,
            sender_id: state.user.id,
            subject: subject,
            content: msg,
            severity: severity,
            target_roles: ['all']
        });

        if(error) showToast("Failed: " + error.message, true);
        else {
            showToast("Announcement Sent");
            document.getElementById('broadcast-modal').classList.add('hidden');
            loadDashboardView(document.getElementById('main-view')); // Refresh dash
        }
    }
    // --- AI ASSISTANT LOGIC ---
    function toggleAiWidget() {
        const win = document.getElementById('ai-window');
        win.classList.toggle('hidden');
        if(!win.classList.contains('hidden')) updateAiCredits();
    }


    function escapeHtml(str = '') {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function addAiBubble(side, html, isHtml = false) {
  const body = document.getElementById('ai-chat-body');
  if (!body) return null;

  const wrap = document.createElement('div');
  wrap.style.textAlign = side === 'user' ? 'right' : 'left';
  wrap.style.marginBottom = '10px';

  const bubble = document.createElement('div');
  bubble.style.padding = '10px';
  bubble.style.borderRadius = '10px';
  bubble.style.display = 'inline-block';
  bubble.style.maxWidth = '90%';
  bubble.style.background = side === 'user'
    ? 'rgba(142,68,173,0.20)'
    : 'rgba(255,255,255,0.10)';

  const id = `ai-msg-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  bubble.id = id;

  if (isHtml) bubble.innerHTML = html;
  else bubble.textContent = html;

  wrap.appendChild(bubble);
  body.appendChild(wrap);
  body.scrollTop = body.scrollHeight;
  return id;
}

function updateAiBubble(id, html, isHtml = false) {
  const el = document.getElementById(id);
  if (!el) return;
  if (isHtml) el.innerHTML = html;
  else el.textContent = html;
  const body = document.getElementById('ai-chat-body');
  if (body) body.scrollTop = body.scrollHeight;
}

/**
 * ALLOWED actions ONLY (safety).
 * Your n8n response must return: { reply: "...", actions: [ ... ] }
 */
async function runAiActions(actions = []) {
  const results = [];

  for (const a of actions) {
    try {
      const type = (a?.type || '').toUpperCase();

      // 1) Navigate
      if (type === 'NAVIGATE') {
        if (!a.view) throw new Error('Missing view');
        state.activeView = a.view;
        renderSidebar();
        renderMainContent();
        results.push(`Opened ${a.view}`);
        continue;
      }

      // 2) Open modal (limited allowlist)
      if (type === 'OPEN_MODAL') {
        const modal = (a.modal || '').toUpperCase();
        if (modal === 'ONBOARD_EMPLOYEE') openOnboardModal();
        else if (modal === 'EMAIL_CONNECT') openEmailConnectModal();
        else throw new Error(`Modal not allowed: ${modal}`);
        results.push(`Opened ${modal}`);
        continue;
      }

      // 3) Create employee (uses your existing onboarding flow)
      if (type === 'CREATE_EMPLOYEE') {
        // REQUIRED FIELDS (you can relax later)
        const full_name = a.full_name || a.name;
        const email = a.email;
        const phone = a.phone || '';
        const department = a.department || '';
        const role = a.role || 'employee';

        if (!full_name || !email) throw new Error('CREATE_EMPLOYEE missing full_name/email');

        // Open modal + fill fields + execute
        openOnboardModal();
        await new Promise(r => setTimeout(r, 80)); // small DOM wait

        // These IDs exist in your file (used by executeOnboard)
        document.getElementById('new-name').value = full_name;
        document.getElementById('new-email').value = email;
        document.getElementById('new-meta-phone').value = phone;
        document.getElementById('new-meta-dept').value = department;
        document.getElementById('new-role').value = role;

        // Password: AI can send one, or we generate.
        const pwd = a.password || (Math.random().toString(36).slice(2) + '!A7');
        document.getElementById('new-pass').value = pwd;

        await executeOnboard();
        results.push(`Created employee: ${full_name} (${email})`);
        continue;
      }

      // Unknown action => blocked
      throw new Error(`Action not allowed: ${type}`);
    } catch (err) {
      console.error('AI action failed:', a, err);
      results.push(`❌ ${a?.type || 'UNKNOWN'} failed: ${err.message}`);
    }
  }

  return results;
}


   async function updateAiCredits() {
  try {
    if (!state.org?.id) return;

    const { data, error } = await supabaseClient
      .from('organizations')
      .select('ai_credits_balance')
      .eq('id', state.org.id)
      .single();

    if (error) throw error;

    const bal = data?.ai_credits_balance ?? 0;
    const el = document.getElementById('ai-credits');
    if (el) el.textContent = `${bal} Credits`;

    // Optional cache
    state.org.ai_credits_balance = bal;
    return bal;
  } catch (e) {
    console.warn('updateAiCredits failed:', e);
    return null;
  }
}


   async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const msg = (input?.value || '').trim();
  if (!msg) return;

  // UI: user bubble
  addAiBubble('user', msg, false);
  input.value = '';

  // UI: thinking bubble (we’ll replace it later)
  const thinkingId = addAiBubble(
    'ai',
    `<i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...`,
    true
  );

  // 1) Credits check (block if no credits)
  const bal = await updateAiCredits();
  const cost = AI_CREDITS_COST_PER_MESSAGE;

  if ((bal ?? 0) < cost) {
    updateAiBubble(
      thinkingId,
      `⚠️ You have <b>${bal ?? 0}</b> credits. Please top-up to use AI.`,
      true
    );
    return;
  }

  // 2) Call n8n webhook
  try {
    const payload = {
      message: msg,
      org_id: state.org?.id,
      user_id: state.user?.id,
      user_role: state.profile?.role,
      active_view: state.activeView,
      lang: state.lang,

      // Tell the AI what it is allowed to do (very important)
      allowed_actions: [
        { type: "NAVIGATE", fields: ["view"] },
        { type: "OPEN_MODAL", fields: ["modal"], values: ["ONBOARD_EMPLOYEE", "EMAIL_CONNECT"] },
        { type: "CREATE_EMPLOYEE", fields: ["full_name","email","phone","department","role","password"] }
      ]
    };

    const res = await fetch(N8N_AI_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`AI webhook failed: ${res.status} ${res.statusText}`);

    const out = await res.json();

    const reply =
      out.reply ||
      out.assistant_message ||
      out.message ||
      'Done.';

    updateAiBubble(thinkingId, escapeHtml(reply).replace(/\n/g, '<br>'), true);

    // 3) Run actions (if any)
    if (Array.isArray(out.actions) && out.actions.length > 0) {
      const results = await runAiActions(out.actions);
      if (results?.length) {
        addAiBubble('ai', `✅ Actions:<br>${results.map(r => `• ${escapeHtml(r)}`).join('<br>')}`, true);
      }
    }

    // 4) Deduct credits (simple version)
    // IMPORTANT: This needs the SQL function below. If you don’t add it, comment these lines.
    const { error: creditErr } = await supabaseClient.rpc('consume_ai_credits', {
      p_org_id: state.org.id,
      p_user_id: state.user.id,
      p_cost: cost,
      p_reason: 'ai_chat',
      p_meta: { message: msg }
    });

    if (creditErr) {
      console.warn('Credit deduction failed:', creditErr);
      addAiBubble('ai', '⚠️ AI worked, but credit deduction failed. Check your SQL function / RLS.', false);
    }

    await updateAiCredits();
  } catch (err) {
    console.error(err);
    updateAiBubble(thinkingId, `⚠️ Error: ${escapeHtml(err.message)}`, true);
  }
}

    // --- ATS CANDIDATE LOGIC ---
    function openCandidateModal() {
        // Create modal HTML dynamically if it doesn't exist
        if (!document.getElementById('candidate-modal')) {
            const modal = document.createElement('div');
            modal.id = 'candidate-modal';
            modal.className = 'modal-overlay hidden';
            modal.innerHTML = `
            <div class="modal-card">
                <div class="modal-title">Add Candidate <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('candidate-modal').classList.add('hidden')"></i></div>
                <div class="form-group"><label>Full Name</label><input type="text" id="cand-name" class="form-input"></div>
                <div class="form-group"><label>Email</label><input type="email" id="cand-email" class="form-input"></div>
                <div class="form-group"><label>Apply for Role (Job ID)</label><input type="text" id="cand-job" class="form-input" placeholder="Paste Job ID"></div>
                <div class="form-group"><label>Upload CV (PDF)</label><input type="file" id="cand-cv" class="form-input"></div>
                <button class="btn-primary" style="width:100%" onclick="saveCandidate()">Submit Application</button>
            </div>`;
            document.body.appendChild(modal);
        }
        document.getElementById('candidate-modal').classList.remove('hidden');
    }

    async function saveCandidate() {
        const name = document.getElementById('cand-name').value;
        const email = document.getElementById('cand-email').value;
        const jobId = document.getElementById('cand-job').value; // In a real app, this would be a dropdown
        const fileInput = document.getElementById('cand-cv');

        if (!name || !email) return showToast("Name and Email required", true);

        let cvUrl = null;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = `cvs/${Date.now()}_${file.name}`;
            const { error: upErr } = await supabaseClient.storage.from('resumes').upload(fileName, file);
            if (!upErr) {
                const { data } = supabaseClient.storage.from('resumes').getPublicUrl(fileName);
                cvUrl = data.publicUrl;
            }
        }

        const payload = {
            job_id: jobId || null,
            full_name: name,
            email: email,
            resume_url: cvUrl,
            status: 'Applied'
        };

        const orgColumn = await resolveAtsOrgColumn();
        if (!orgColumn && atsUseJobOrgFilter && !jobId) {
            showToast("Please provide a Job ID so we can link this candidate to your organization.", true);
            return;
        }
        if (orgColumn) payload[orgColumn] = state.org.id;

        const { error } = await supabaseClient.from('ats_applications').insert(payload);

        if (error) showToast("Error: " + error.message, true);
        else {
            showToast("Candidate Added");
            document.getElementById('candidate-modal').classList.add('hidden');
            loadATSView(document.getElementById('main-view'));
        }
    }

    // --- EMAIL INTEGRATION LOGIC ---
function openEmailConnectModal() { document.getElementById('email-connect-modal').classList.remove('hidden'); }

function toggleImapFields() {
    const type = document.getElementById('imap-provider').value;
    const box = document.getElementById('custom-imap');
    const host = document.getElementById('imap-host');
    if(type === 'custom') { box.classList.remove('hidden'); host.value = ''; }
    else { box.classList.add('hidden'); host.value = type === 'gmail' ? 'imap.gmail.com' : 'outlook.office365.com'; }
}

async function refreshAtsIntegrationStatus() {
    const box = document.getElementById('ats-email-status');
    if (!box || !state.org) return;

    const { data, error } = await supabaseClient
        .from('org_integrations')
        .select('integration_type, status, config, last_sync_at, created_at')
        .eq('org_id', state.org.id)
        .eq('integration_type', 'imap_email')
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (error || !data) {
        box.innerHTML = 'No email connected yet.';
        return;
    }

    const cfg = data.config || {};
    const provider = cfg.provider || cfg.host || 'custom';
    const email = cfg.email || 'unknown';
    const status = data.status || 'active';
    const lastSeenAt = data.last_sync_at || data.created_at;
    const updatedAt = lastSeenAt ? new Date(lastSeenAt).toLocaleString() : '';

    box.innerHTML = `
        <div style="font-weight:600; color:var(--text-header)">${email}</div>
        <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">
            Provider: ${provider} • Status: ${status}${updatedAt ? ` • Updated: ${updatedAt}` : ''}
        </div>`;
}

async function saveEmailIntegration() {
    const email = document.getElementById('imap-email').value;
    const pass = document.getElementById('imap-pass').value;
    const host = document.getElementById('imap-host').value;
    const port = document.getElementById('imap-port').value || 993;
    const provider = document.getElementById('imap-provider').value;

    if(!email || !pass) return showToast("Email and Password required", true);

    const payload = {
        org_id: state.org.id,
        integration_type: 'imap_email',
        provider,
        email,
        password: pass,
        host,
        port,
        tls: true,
        status: 'active'
    };

    try {
        const res = await fetch(N8N_ATS_CONNECT_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Webhook rejected the request");
        showToast("Connected! AI is now watching your inbox.");
        document.getElementById('email-connect-modal').classList.add('hidden');
        await refreshAtsIntegrationStatus();
    } catch (err) {
        console.error("ATS Connect Error:", err);
        showToast("Connect failed: " + err.message, true);
    }
}
    // OPEN CANDIDATE MODAL
window.viewCandidateAI = async function(candidateId) {
    document.getElementById('candidate-modal').classList.remove('hidden');
    
    const { data: c } = await supabaseClient.from('ats_applications').select('*').eq('id', candidateId).single();
    
    if(c) {
        // Update Score
        document.getElementById('ai-score-circle').innerText = `${c.ai_score || 0}%`;
        document.getElementById('ai-score-circle').style.borderColor = c.ai_score > 70 ? 'var(--success)' : (c.ai_score > 40 ? 'var(--warning)' : 'var(--danger)');
        
        // Update Text
        document.getElementById('ai-summary-text').innerText = c.ai_summary || "AI is processing this candidate...";
        document.getElementById('ai-source-text').innerText = c.resume_text || "No text extracted yet.";
        
        // Update Skills (Assume comma separated or JSON)
        let skillsHtml = '';
        if(c.skills) { // Assuming you save skills as JSON array or text
             const skills = Array.isArray(c.skills) ? c.skills : (c.skills || '').split(',');
             skills.forEach(s => skillsHtml += `<span class="badge" style="position:static; background:var(--primary); margin:2px;">${s}</span>`);
        }
        document.getElementById('ai-skills-tags').innerHTML = skillsHtml;
    }
}
    // --- PRICING MODAL LOGIC ---

function openPricingModal() {
    document.getElementById('pricing-modal').classList.remove('hidden');
}

function closePricingModal() {
    const checkbox = document.getElementById('dont-show-pricing');
    if (checkbox && checkbox.checked) {
        localStorage.setItem('digitivia_hide_pricing', 'true');
    }
    document.getElementById('pricing-modal').classList.add('hidden');
}

// Function to check and show on load
function checkPricingPopup() {
    // Only show for CEO role, and if not hidden by user preference
    if (state.profile && state.profile.role === 'ceo') {
        const shouldHide = localStorage.getItem('digitivia_hide_pricing');
        // Also, don't show if they are ALREADY on Bundle 3 (Enterprise)
        const currentTier = state.org.subscription_tier || 'free';
        
        if (!shouldHide && currentTier !== 'bundle_3') {
            setTimeout(() => {
                openPricingModal();
            }, 1500); // Small delay for nice effect after load
        }
    }
}
    // --- NEW: MY PROFILE MODAL ---
function openProfileModal() {
    const p = state.profile;
    document.getElementById('profile-modal-avatar').src = p.avatar_url || 'https://ui-avatars.com/api/?background=random';
    document.getElementById('profile-modal-name').innerText = p.full_name;
    document.getElementById('profile-modal-role').innerText = p.role.toUpperCase().replace('_', ' ');

    document.getElementById('profile-modal-email').value = p.email;
    document.getElementById('profile-modal-phone').value = p.meta_data?.phone || 'N/A';
    
    document.getElementById('profile-modal-org').value = state.org.name;
    document.getElementById('profile-modal-dept').value = p.department || 'N/A';

    document.getElementById('profile-modal').classList.remove('hidden');
}
        function closePricingModal() {
    if(document.getElementById('dont-show-pricing').checked) localStorage.setItem('hide_pricing', 'true');
    document.getElementById('pricing-modal').classList.add('hidden');
}

function checkPricingPopup() {
    if(state.profile.role === 'ceo' && !localStorage.getItem('hide_pricing') && state.org.subscription_tier !== 'bundle_3') {
        setTimeout(() => document.getElementById('pricing-modal').classList.remove('hidden'), 2000);
    }
}

    // =========================================================
    // WFM MODULE: INTEGRATED & CLEANED (Place at bottom of Script)
    // =========================================================

    // 1. Handle File Upload (Fire & Forget to avoid Timeout)
// =========================================================
    // WFM UPLOAD HANDLER (5-MINUTE TIMEOUT VERSION)
    // =========================================================
// =========================================================
    // WFM: FIRE & FORGET (Bypasses Server Timeouts)
    // =========================================================

    // 1. Upload & Start AI (Doesn't wait for answer)
  // =========================================================
    // WFM: FIRE & FORGET (With User ID Fix)
    // =========================================================

    function parseWfmDetails(details) {
        if (!details) return null;
        if (typeof details === 'string') {
            try {
                return JSON.parse(details);
            } catch (e) {
                return null;
            }
        }
        return details;
    }

    function parsePercent(value) {
        if (value === null || value === undefined) return 0;
        const num = parseFloat(String(value).replace('%', '').trim());
        return Number.isFinite(num) ? num : 0;
    }

    function escapeHtml(value) {
        return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function extractWfmSchedule(result) {
        if (!result) return [];
        if (Array.isArray(result.schedule)) return result.schedule;
        if (result.table && Array.isArray(result.table.rows)) return result.table.rows;
        return [];
    }

    function renderWfmPreviewTable(rows) {
        const table = document.getElementById('wfm-preview-table');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; color:var(--text-muted);">
                        No schedule rows found in this file.
                    </td>
                </tr>`;
            return;
        }

        let html = '';
        rows.forEach(row => {
            html += `
                <tr>
                    <td>${escapeHtml(row.employee_name)}</td>
                    <td>${escapeHtml(row.role)}</td>
                    <td>${escapeHtml(row.date)}</td>
                    <td>${escapeHtml(row.shift_start)}</td>
                    <td>${escapeHtml(row.shift_end)}</td>
                    <td>${escapeHtml(row.break_start)}</td>
                    <td>${escapeHtml(row.break_end)}</td>
                    <td>${escapeHtml(row.location)}</td>
                    <td>${escapeHtml(row.notes)}</td>
                </tr>`;
        });
        tbody.innerHTML = html;
    }

    function setWfmPreviewMessage(message) {
        const table = document.getElementById('wfm-preview-table');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align:center; color:var(--text-muted);">
                    ${escapeHtml(message)}
                </td>
            </tr>`;
    }

    function applyWfmResult(result) {
        if (!result) return false;
        const metrics = result.metrics || {};
        const insight = result.insight || "";
        const slEl = document.getElementById('wfm-metric-sl');
        if (slEl) {
            slEl.innerText = parsePercent(metrics.sl) + "%";
            const adhEl = document.getElementById('wfm-metric-adh');
            if (adhEl) adhEl.innerText = parsePercent(metrics.adherence) + "%";
            const occEl = document.getElementById('wfm-metric-occ');
            if (occEl) occEl.innerText = parsePercent(metrics.occupancy) + "%";
            const shrEl = document.getElementById('wfm-metric-shr');
            if (shrEl) shrEl.innerText = parsePercent(metrics.shrinkage) + "%";
        }
        const box = document.getElementById('wfm-insight-box');
        if (box) box.innerHTML = (insight || "").replace(/\n/g, '<br>');
        renderWfmPreviewTable(extractWfmSchedule(result));
        return Boolean(insight || Object.keys(metrics).length);
    }

    window.handleWFMUpload = async function(input) {
        const file = input.files[0];
        if (!file) return;

        // UI Feedback
        const btn = document.querySelector('.page-title .btn-primary');
        const oldHtml = btn ? btn.innerHTML : 'Import';
        if(btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting AI...';
        showToast("Uploading...", false);
        setWfmPreviewMessage("Parsing schedule preview...");

        try {
            // A. Upload File to Supabase
            const fileName = `wfm_forecast_${Date.now()}_${file.name}`;
            const startedAt = Date.now();
            const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file);
            if (uploadError) throw uploadError;
            
            const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName);

            // B. Trigger N8N (With User ID included)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Handshake limit
            let responseData = null;

            try {
                const res = await fetch('https://n8n.srv1174105.hstgr.cloud/webhook/workforce_hr_digitivia', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'wfm_forecast_analysis',
                        file_url: publicUrl,
                        
                        // --- THE MISSING FIELDS ---
                        file_name: fileName,        // So N8N knows the file name
                        user_id: state.user.id,     // So N8N knows the Actor ID
                        // --------------------------
                        
                        org_id: state.org.id,
                        bundle_tier: state.org.subscription_tier || 'free'
                    }),
                    signal: controller.signal
                });
                if (res && res.ok) {
                    const rawText = await res.text();
                    if (rawText) {
                        try {
                            responseData = JSON.parse(rawText);
                        } catch (e) {
                            responseData = null;
                        }
                    }
                }
            } catch (e) {
                if (e.name !== 'AbortError') console.warn("Webhook trigger warning:", e);
            }
            clearTimeout(timeoutId);

            // C. Start Polling
            const hasImmediateResult = responseData && (responseData.insight || responseData.metrics);
            if (hasImmediateResult) {
                applyWfmResult(responseData);
                showToast("Analysis Complete!", false);
            } else {
                showToast("AI Analysis Running... Please wait.", false);
            }
            pollForWFMResults(fileName, 0, startedAt, hasImmediateResult);

        } catch (err) {
            console.error("Upload Error:", err);
            showToast("Failed to start: " + err.message, true);
        } finally {
            if(btn) btn.innerHTML = oldHtml;
            if(input) input.value = '';
        }
    }

    // 2. Check Database Loop
    async function pollForWFMResults(fileNamePart, attempts = 0, startedAt = null, hasImmediateResult = false) {
        // Stop after 3 minutes (60 attempts * 3s)
        if (attempts > 60) {
            showToast("Analysis taking a while. Check history later.", true);
            return;
        }
        const baseline = startedAt || Date.now();

        const box = document.getElementById('wfm-insight-box');
        if(box && attempts === 0 && !hasImmediateResult) {
            box.innerHTML = '<div style="text-align:center; padding:40px; color:var(--info)"><i class="fa-solid fa-brain fa-bounce" style="font-size:2rem; margin-bottom:10px;"></i><br>AI is analyzing strategy...</div>';
        }

        // Look for a log entry created in the last 2 minutes matching this operation
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .eq('org_id', state.org.id)
            .eq('action_type', 'WFM_FORECAST_GENERATED')
            .order('created_at', { ascending: false })
            .limit(1);

        if (logs && logs.length > 0) {
            const log = logs[0];
            const logTime = new Date(log.created_at).getTime();
            const details = parseWfmDetails(log.details);
            const isFileMatch = details && details.file === fileNamePart;
            const isTimeMatch = logTime >= (baseline - 5000);
            if (isFileMatch || isTimeMatch) {
                if (details) applyWfmResult(details);
                showToast("Analysis Complete!", false);
                loadWFMHistory(); // Update UI
                return;
            }
        }

        // Not found? Wait 3s and look again
        setTimeout(() => pollForWFMResults(fileNamePart, attempts + 1, baseline, hasImmediateResult), 3000);
    }
</script>
    <div id="docs-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Employee Documents <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('docs-modal').classList.add('hidden')"></i></div>
            <h4 id="docs-user-name" style="color:var(--primary); margin-bottom:15px;"></h4>
            <div id="docs-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                <div style="font-weight:700; margin-bottom:10px;">Add New Document</div>
                <div class="form-group"><input type="text" id="doc-type" class="form-input" placeholder="Document Name (e.g. Passport)"></div>
                <div class="form-group"><input type="date" id="doc-expiry" class="form-input"></div>
                <div class="form-group"><input type="text" id="doc-link" class="form-input" placeholder="External Drive Link (Optional)"></div>
                <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" id="doc-checklist"> <label for="doc-checklist">Checklist Item Only (No File)</label>
                </div>
                <button class="btn-primary" style="width:100%" onclick="saveEmployeeDoc()">Save Record</button>
            </div>
        </div>
    </div>

    <div id="broadcast-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">Send Company Announcement <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('broadcast-modal').classList.add('hidden')"></i></div>
            <div class="form-group"><label>Subject</label><input type="text" id="bc-subject" class="form-input"></div>
            <div class="form-group"><label>Message</label><textarea id="bc-msg" class="form-input" rows="4"></textarea></div>
            <div class="form-group"><label>Type</label>
                <select id="bc-severity" class="form-input" style="background:var(--sidebar-bg)">
                    <option value="info">General Info (Blue)</option>
                    <option value="urgent">Urgent Alert (Red)</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%" onclick="sendBroadcast()">Post Announcement</button>
        </div>
    </div>
    <div id="ai-widget" style="position:fixed; bottom:30px; left:30px; z-index:9999; display:flex; flex-direction:column; align-items:flex-start; gap:10px;">
    <div id="ai-window" class="hidden card" style="width:300px; height:400px; padding:0; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
        <div style="background:var(--primary); padding:15px; color:white; font-weight:bold; display:flex; justify-content:space-between;">
            <span><i class="fa-solid fa-robot"></i> HR Assistant</span>
            <span style="font-size:0.8rem; opacity:0.8" id="ai-credits">0 Credits</span>
        </div>
        <div id="ai-chat-body" style="flex-grow:1; background:rgba(0,0,0,0.2); padding:15px; overflow-y:auto; font-size:0.9rem;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 12px; border-radius:10px; margin-bottom:10px; display:inline-block;">
                Hello! I can help you draft emails, check policies, or analyze data.
            </div>
        </div>
        <div style="padding:10px; background:var(--glass-bg); display:flex; gap:5px; border-top:1px solid var(--glass-border);">
            <input type="text" id="ai-input" class="table-input" placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendAiMessage()">
            <button class="btn-primary" style="padding:8px 15px;" onclick="sendAiMessage()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
    
    <button onclick="toggleAiWidget()" style="width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #8e44ad, #9b59b6); border:none; color:white; font-size:1.5rem; cursor:pointer; box-shadow:0 5px 20px rgba(142, 68, 173, 0.4); display:flex; align-items:center; justify-content:center; transition:transform 0.2s;">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
    </button>
</div>
    <div id="setup-modal" class="modal-overlay hidden">
    <div class="modal-card" style="text-align:center;">
        <i class="fa-solid fa-handshake" style="font-size:3rem; color:var(--success); margin-bottom:20px;"></i>
        <div class="modal-title" style="border:none; justify-content:center;">Welcome to Digitivia!</div>
        <p style="color:var(--text-muted); margin-bottom:25px; line-height:1.6;">
            We are thrilled to have you. To ensure your HR data is migrated correctly, we offer <b>2 Free Setup Calls</b> (30 mins each).
        </p>
        <div style="display:grid; gap:10px;">
            <a href="https://calendly.com" target="_blank" class="btn-primary" style="justify-content:center; text-decoration:none;">
                <i class="fa-solid fa-calendar-check"></i> Book Integration Call
            </a>
            <button class="btn-outline" onclick="document.getElementById('setup-modal').classList.add('hidden')">
                I'll explore on my own
            </button>
        </div>
    </div>
</div>
   <div id="email-connect-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                Connect Recruitment Email
                <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('email-connect-modal').classList.add('hidden')"></i>
            </div>
            
            <div style="background:rgba(52, 152, 219, 0.1); padding:15px; border-radius:8px; margin-bottom:20px; font-size:0.9rem; color:var(--text-main); border-left: 3px solid var(--primary);">
                <i class="fa-solid fa-robot"></i> <b>AI Auto-Scan:</b> The AI will connect via IMAP and scan this inbox every 10 minutes for emails with "Resume" or "CV" in the subject.
            </div>
            
            <div class="form-group">
                <label>
                    Email Provider 
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;" title="Choose 'Custom' if you use Zoho, GoDaddy, or a private server."></i>
                </label>
                <select id="imap-provider" class="form-input" style="background:var(--sidebar-bg)" onchange="toggleImapFields()" title="Select your email service provider">
                    <option value="gmail">Gmail</option>
                    <option value="outlook">Outlook / Office 365</option>
                    <option value="custom">Custom IMAP (Other)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    Email Address
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;" title="The email address where you receive job applications."></i>
                </label>
                <input type="email" id="imap-email" class="form-input" placeholder="careers@company.com" title="Enter the email address to scan">
            </div>

            <div class="form-group">
                <label>
                    App Password
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;" title="Do NOT use your login password. Generate a secure 'App Password' in your Google/Microsoft Account Security settings."></i>
                </label>
                <input type="password" id="imap-pass" class="form-input" placeholder="abcd xxxx yyyy zzzz" title="Paste your 16-character App Password here">
                <div style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">
                    <i class="fa-solid fa-shield-halved"></i> <strong>Security Tip:</strong> Use an 
                    <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color:var(--primary); text-decoration:underline;">App Password</a>, not your main password.
                </div>
            </div>
            
            <div id="custom-imap" class="hidden" style="padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:15px;">
                <div class="form-group">
                    <label>IMAP Host <i class="fa-solid fa-circle-question" title="e.g. imap.zoho.com or mail.yourdomain.com"></i></label>
                    <input type="text" id="imap-host" class="form-input" value="imap.gmail.com" placeholder="imap.server.com">
                </div>
                <div class="form-group">
                    <label>IMAP Port <i class="fa-solid fa-circle-question" title="Standard SSL port is 993"></i></label>
                    <input type="number" id="imap-port" class="form-input" value="993">
                </div>
            </div>

            <button class="btn-primary" style="width:100%" onclick="saveEmailIntegration()">
                <i class="fa-solid fa-plug"></i> Connect & Start AI Scanning
            </button>
        </div>
    </div>
    <div id="candidate-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width:800px; height:80vh; display:flex; flex-direction:column;">
        <div class="modal-title">
            AI Candidate Analysis
            <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('candidate-modal').classList.add('hidden')"></i>
        </div>
        <div style="display:flex; gap:20px; flex-grow:1; overflow:hidden;">
            <div style="width:300px; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; overflow-y:auto;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div id="ai-score-circle" style="width:100px; height:100px; border-radius:50%; border:5px solid var(--primary); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; margin:0 auto;">
                        0%
                    </div>
                    <div style="margin-top:10px; font-weight:bold;">Match Score</div>
                </div>
                <h4 style="color:var(--primary); border-bottom:1px solid var(--glass-border); padding-bottom:5px; margin-bottom:10px;">Executive Summary</h4>
                <p id="ai-summary-text" style="font-size:0.9rem; line-height:1.6; color:var(--text-main);">Loading...</p>
                
                <h4 style="color:var(--primary); border-bottom:1px solid var(--glass-border); padding-bottom:5px; margin-bottom:10px; margin-top:20px;">Extracted Skills</h4>
                <div id="ai-skills-tags" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>

            <div style="flex-grow:1; display:flex; flex-direction:column;">
                <h4 style="margin-bottom:10px;">Source Context (CV / Portfolio)</h4>
                <div id="ai-source-text" style="flex-grow:1; background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; overflow-y:auto; font-family:monospace; font-size:0.85rem; white-space:pre-wrap;">
                    Loading original text...
                </div>
            </div>
        </div>
    </div>
</div>
    <div id="pricing-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 1000px;">
        <div class="modal-title" style="text-align: center; border: none; font-size: 1.8rem;">
            Upgrade Your Operation
            <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 400; margin-top: 5px;">Choose the bundle that fits your scale.</div>
            <i class="fa-solid fa-xmark close-modal" onclick="closePricingModal()" style="position: absolute; right: 30px; top: 30px;"></i>
        </div>

        <div class="pricing-grid">
            <div class="pricing-card">
                <div class="plan-name">Starter</div>
                <div class="plan-price">Free<span>/mo</span></div>
                <ul class="feature-list">
                    <li><i class="fa-solid fa-check"></i> Time & Attendance</li>
                    <li><i class="fa-solid fa-check"></i> Basic Payroll</li>
                    <li><i class="fa-solid fa-check"></i> Employee Database</li>
                    <li><i class="fa-solid fa-check"></i> Live Dashboard</li>
                    <li class="locked"><i class="fa-solid fa-lock"></i> AI Recruitment</li>
                    <li class="locked"><i class="fa-solid fa-lock"></i> Workforce Management</li>
                </ul>
                <button class="btn-outline" style="width: 100%; opacity: 0.5; cursor: default;">Current Plan</button>
            </div>

            <div class="pricing-card popular">
                <div class="plan-tag">Recommended</div>
                <div class="plan-name" style="color:var(--primary)">Growth</div>
                <div class="plan-price">$49<span>/mo</span></div>
                <ul class="feature-list">
                    <li><i class="fa-solid fa-check"></i> <b>Everything in Starter</b></li>
                    <li><i class="fa-solid fa-check"></i> AI Recruitment (ATS)</li>
                    <li><i class="fa-solid fa-check"></i> Workforce WFM (Maps)</li>
                    <li><i class="fa-solid fa-check"></i> Internal Broadcasting</li>
                    <li><i class="fa-solid fa-check"></i> Adherence Charts</li>
                </ul>
                <a href="#" class="btn-primary" style="width: 100%; justify-content: center; text-decoration:none;">Upgrade to Growth</a>
            </div>

            <div class="pricing-card enterprise">
                <div class="plan-name" style="color:var(--info)">Enterprise</div>
                <div class="plan-price">$199<span>/mo</span></div>
                <ul class="feature-list">
                    <li><i class="fa-solid fa-check"></i> <b>Everything in Growth</b></li>
                    <li><i class="fa-solid fa-check"></i> Self-Hosted VPS Option</li>
                    <li><i class="fa-solid fa-check"></i> Advanced Payroll Automation</li>
                    <li><i class="fa-solid fa-check"></i> Custom Domain</li>
                    <li><i class="fa-solid fa-check"></i> Priority Support</li>
                </ul>
                <a href="#" class="btn-outline" style="width: 100%; justify-content: center; border-color: var(--info); color: var(--info); text-decoration:none;">Contact Sales</a>
            </div>
        </div>

        <div class="modal-footer">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="dont-show-pricing"> Don't show this automatically again
            </label>
            <button class="btn-outline" onclick="closePricingModal()" style="padding: 5px 15px; font-size: 0.8rem;">Close</button>
        </div>
    </div>
</div>
    <div id="profile-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 700px;">
        <div class="modal-title">
            My Profile
            <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('profile-modal').classList.add('hidden')"></i>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; padding: 20px; border-bottom: 1px solid var(--glass-border);">
            <img src="" alt="User Avatar" id="profile-modal-avatar" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px;">
            <div id="profile-modal-name" style="font-size: 1.5rem; font-weight: 700; color: white;"></div>
            <div id="profile-modal-role" style="color: var(--primary); font-weight: 500;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
            <div class="settings-section">
                <div class="settings-header"><i class="fa-solid fa-user-tag"></i> Basic Info</div>
                <div class="form-group"><label>Email</label><input type="text" id="profile-modal-email" class="form-input" disabled></div>
                <div class="form-group"><label>Phone</label><input type="text" id="profile-modal-phone" class="form-input" disabled></div>
            </div>
            <div class="settings-section">
                <div class="settings-header"><i class="fa-solid fa-building-user"></i> Company & Role</div>
                <div class="form-group"><label>Organization</label><input type="text" id="profile-modal-org" class="form-input" disabled></div>
                <div class="form-group"><label>Department</label><input type="text" id="profile-modal-dept" class="form-input" disabled></div>
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid var(--glass-border);">
            <button class="btn-outline" style="width: 100%; border-color: var(--danger); color: var(--danger); justify-content: center;" onclick="handleLogout()">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </div>
</div>
    <div id="pricing-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width: 1000px; text-align:center;">
        <div class="modal-title">Upgrade Your Plan <i class="fa-solid fa-xmark close-modal" onclick="closePricingModal()"></i></div>
        <div class="pricing-grid">
            <div class="pricing-card">
                <h3>Starter</h3><div class="plan-price">Free</div>
                <ul class="feature-list"><li>Basic HR</li><li>Attendance</li></ul>
            </div>
            <div class="pricing-card popular" style="border:2px solid var(--primary); transform:scale(1.05);">
                <div class="plan-tag">Best Value</div>
                <h3 style="color:var(--primary)">Growth Plus</h3><div class="plan-price">$49</div>
                <ul class="feature-list"><li><b>Everything in Starter</b></li><li>AI Recruitment</li><li>Workforce Maps</li></ul>
                <button class="btn-primary" style="width:100%">Upgrade Now</button>
            </div>
            <div class="pricing-card">
                <h3>Enterprise</h3><div class="plan-price">$199</div>
                <ul class="feature-list"><li>Custom Domain</li><li>Priority Support</li></ul>
            </div>
        </div>
        <div class="modal-footer">
            <label><input type="checkbox" id="dont-show-pricing"> Don't show again</label>
        </div>
    </div>
</div>
</body>
</html>
