<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITIVIA - Enterprise Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-body-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --blur-amount: 20px;
            --sidebar-bg: rgba(13, 27, 42, 0.90);
            --sidebar-active: rgba(52, 152, 219, 0.4);
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --text-header: #ffffff;
            --primary: #3498db;
            --primary-hover: #2980b9;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --info: #9b59b6;
        }

        /* FORCE VERTICAL STACKING */
        .main-content {
            display: flex !important;
            flex-direction: column !important;
            /* This forces Header on Top, Content Below */
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            width: 100%;
            /* Ensure it takes full width */
        }

        html[dir="rtl"] {
            --sidebar-width: 270px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg-body-gradient);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
        }

        /* --- LAYOUT & COMPONENTS --- */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body-gradient);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .auth-card {
            background: rgba(13, 27, 42, 0.6);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Logo Update */
        .auth-logo {
            height: 80px;
            margin-bottom: 20px;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(52, 152, 219, 0.3));
        }

        /* --- ARABIC SUPPORT --- */
        html[lang="ar"] * {
            font-family: 'Cairo', sans-serif;
        }

        html[lang="ar"] .fa-bars {
            margin-right: 0 !important;
            margin-left: 15px;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            outline: none;
            transition: 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .social-divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .social-divider::before,
        .social-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background: var(--glass-border);
            margin: 0 10px;
        }

        .social-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .social-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .toggle-link {
            color: var(--primary);
            cursor: pointer;
            margin-top: 20px;
            display: inline-block;
            font-size: 0.9rem;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none !important;
        }

        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s;
        }

        #app-container.loaded {
            opacity: 1;
        }

        .sidebar {
            width: 270px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            flex-shrink: 0;
            height: 100vh;
            z-index: 1000;
        }

        html[dir="rtl"] .sidebar {
            border-right: none;
            border-left: 1px solid var(--glass-border);
        }

        /* Logo Area Update */
        .logo-area {
            height: 100px;
            display: flex;
            align-items: center;
            padding: 0 25px;
            border-bottom: 1px solid var(--glass-border);
        }

        .logo-area img {
            width: 100%;
            height: 60px;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.1));
        }

        #nav-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-top: 15px;
        }

        .nav-header {
            padding: 20px 30px 10px 30px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted);
            font-weight: 700;
        }

        .nav-links {
            list-style: none;
            padding: 0 15px;
            margin-bottom: 15px;
        }

        .nav-item {
            padding: 14px 15px;
            margin-bottom: 6px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.25s ease;
            color: var(--text-muted);
            font-weight: 500;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-header);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: var(--sidebar-active);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item i {
            width: 25px;
            margin-right: 10px;
            text-align: center;
            font-size: 1.1em;
        }

        html[dir="rtl"] .nav-item i {
            margin-right: 0;
            margin-left: 10px;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            height: 80px;
            background: rgba(13, 27, 42, 0.4);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left .fa-bars {
            display: none;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .branding-logos {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid var(--glass-border);
        }

        html[dir="rtl"] .branding-logos {
            margin-left: 0;
            padding-left: 0;
            margin-right: 20px;
            padding-right: 20px;
            border-left: none;
            border-right: 1px solid var(--glass-border);
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .icon-btn {
            cursor: pointer;
            color: var(--text-main);
            font-size: 1.2rem;
            position: relative;
            transition: 0.2s;
        }

        .icon-btn:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: #fff;
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 50%;
            border: 1px solid var(--bg-body-gradient);
        }

        .fa-solid,
        .fa-regular,
        .fa-brands,
        .fa {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900;
        }

        .fa-regular {
            font-weight: 400;
        }

        .fa-brands {
            font-family: "Font Awesome 6 Brands" !important;
            font-weight: 400;
        }

        .dropdown {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-header);
        }

        .dropdown img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .content-scroll {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            padding-bottom: 90px;
        }

        .page-title {
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-header);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-weight: 700;
            color: var(--text-header);
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #2980b9 100%);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(41, 128, 185, 0.4);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41, 128, 185, 0.6);
        }

        .btn-outline {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .btn-outline:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: #fff;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 25px;
            align-items: stretch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-header);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .payroll-table {
            table-layout: fixed;
            width: 100%;
        }

        .payroll-table th,
        .payroll-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .payroll-table .num {
            text-align: right;
        }

        .payroll-table th:nth-child(1) {
            width: 30%;
        }

        .payroll-table th:nth-child(2) {
            width: 15%;
        }

        .payroll-table th:nth-child(3) {
            width: 15%;
        }

        .payroll-table th:nth-child(4) {
            width: 15%;
        }

        .payroll-table th:nth-child(5) {
            width: 25%;
        }

        .table-input {
            background: transparent;
            border: 1px solid transparent;
            color: white;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
            transition: 0.2s;
        }

        .table-input:hover {
            border-color: var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }

        .table-input:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.4);
            outline: none;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .toast.show {
            transform: translateY(0);
        }

        /* --- RESPONSIVE UTILITIES --- */
        .hide-on-mobile {
            display: flex;
        }

        @media (max-width: 768px) {
            .hide-on-mobile {
                display: none !important;
            }

            /* Show hamburger menu on mobile */
            .header-left .fa-bars {
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                margin-right: 15px;
                font-size: 1.2rem;
                cursor: pointer;
            }

            /* Make tables scrollable on mobile */
            .card {
                overflow-x: auto;
            }

            /* Adjust padding for smaller screens */
            .main-content .content-scroll {
                padding: 15px;
            }

            .page-title {
                font-size: 1.5rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .page-title button {
                width: 100%;
            }

            .top-header {
                height: auto;
                padding: 15px;
                gap: 10px;
                flex-wrap: wrap;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr !important;
            }

            .pricing-grid {
                grid-template-columns: 1fr;
            }

            .payroll-layout,
            .ats-layout {
                flex-direction: column;
                height: auto;
            }

            .payroll-sidebar,
            .payroll-main,
            .ats-sidebar {
                width: 100%;
            }

            .ats-main-board {
                flex-direction: column;
            }

            .ats-column {
                flex: 1 0 auto;
                min-width: 260px;
            }

            .modal-card {
                max-width: 95vw;
            }
        }

        @media (max-width: 600px) {
            .app-footer {
                flex-wrap: wrap;
                gap: 12px;
                text-align: center;
            }

            #pricing-modal .modal-card {
                padding: 18px;
            }

            #pricing-modal .modal-title {
                font-size: 1.4rem;
            }

            #pricing-modal .pricing-grid {
                gap: 14px;
            }

            #pricing-modal .pricing-card {
                padding: 18px;
                border-radius: 14px;
            }

            #pricing-modal .plan-price {
                font-size: 1.6rem;
            }

            #pricing-modal .feature-list li {
                font-size: 0.85rem;
            }

            #pricing-modal .plan-tag {
                font-size: 0.6rem;
                padding: 3px 8px;
            }

            #pricing-modal .modal-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            #pricing-modal .modal-footer button {
                width: 100%;
                justify-content: center;
            }

            #pricing-modal .modal-footer label {
                width: 100%;
            }

            .payroll-main {
                overflow: visible;
            }

            #payroll-content {
                overflow: auto !important;
            }

            #payroll-content>div {
                height: auto !important;
            }

            #payroll-content table {
                min-width: 640px;
            }

            .payroll-sidebar {
                max-height: 45vh;
            }
        }

        /* --- PRICING MODAL STYLES --- */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pricing-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pricing-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Highlight Logic */
        .pricing-card.popular {
            border: 1px solid var(--primary);
            background: linear-gradient(180deg, rgba(52, 152, 219, 0.1) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .pricing-card.enterprise {
            border: 1px solid var(--info);
            background: linear-gradient(180deg, rgba(155, 89, 182, 0.1) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .plan-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .plan-price span[data-price-plan] {
            font-size: 2rem;
            font-weight: 800;
            color: white;
        }

        .plan-price span[data-per-month] {
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .feature-list {
            list-style: none;
            padding: 0;
            text-align: left;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .feature-list li {
            padding: 8px 0;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .feature-list li i {
            color: var(--success);
            margin-right: 8px;
            width: 15px;
        }

        .feature-list li.locked i {
            color: var(--text-muted);
            opacity: 0.5;
        }

        .plan-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            font-size: 0.65rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .pricing-card.popular .plan-name {
            margin-top: 0;
        }

        /* Discount pricing styles */
        .price-discount-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .price-original {
            text-decoration: line-through;
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.7;
        }

        .price-discounted {
            color: var(--success);
            font-size: 2rem;
            font-weight: 800;
        }

        .discount-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            color: white;
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            margin-bottom: 4px;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            }

            50% {
                box-shadow: 0 4px 16px rgba(46, 204, 113, 0.6);
            }
        }

        .free-trial-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            text-align: center;
            line-height: 1.3;
        }

        /* RTL adjustments for discount */
        html[dir="rtl"] .discount-badge {
            letter-spacing: 0;
        }

        html[dir="rtl"] .plan-tag {
            right: auto;
            left: 12px;
        }

        /* Modal Checkbox */
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Pricing modal: mobile layout fixes */
        @media (max-width: 900px) {
            #pricing-modal .modal-card {
                max-width: 94vw;
                padding: 20px;
            }

            #pricing-modal .pricing-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            #pricing-modal .pricing-card {
                padding: 18px;
                text-align: left;
            }

            #pricing-modal .plan-name,
            #pricing-modal .plan-price {
                text-align: left;
            }

            #pricing-modal .feature-list li {
                display: flex;
                align-items: flex-start;
                gap: 8px;
            }

            #pricing-modal .feature-list li i {
                margin-right: 0;
                min-width: 16px;
            }
        }

        @media (max-width: 600px) {
            #pricing-modal .modal-title {
                font-size: 1.4rem;
            }

            #pricing-modal .plan-tag {
                position: static;
                align-self: flex-start;
                margin-bottom: 8px;
            }

            #pricing-modal .modal-footer {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            #pricing-modal .modal-footer button {
                width: 100%;
            }

            /* Mobile discount styling */
            .price-discount-wrapper {
                align-items: flex-start;
            }

            .price-discounted {
                font-size: 1.6rem;
            }

            .free-trial-label {
                font-size: 1rem;
            }

            .discount-badge {
                font-size: 0.65rem;
                padding: 3px 8px;
            }
        }

        /* New: Settings Inputs */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }

        .settings-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 1200px) {

            .dashboard-grid,
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: absolute;
                left: -270px;
                height: 100%;
                z-index: 2000;
                background: rgba(13, 27, 42, 0.98);
            }

            .sidebar.active {
                left: 0;
                box-shadow: 50px 0 100px rgba(0, 0, 0, 0.5);
            }

            html[dir="rtl"] .sidebar {
                left: auto;
                right: -270px;
            }

            html[dir="rtl"] .sidebar.active {
                right: 0;
            }

            .branding-logos {
                display: none;
            }
        }

        /* PAYROLL LAYOUT */
        .payroll-layout {
            display: flex;
            height: calc(100vh - 140px);
            gap: 20px;
        }

        .payroll-sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
            overflow-y: auto;
            padding-right: 5px;
        }

        .payroll-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-item.active {
            background: var(--sidebar-active);
            border-color: var(--primary);
        }

        .history-date {
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .history-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .history-badge {
            font-size: 0.7rem;
            background: var(--success);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* New: Dynamic Details */
        .details-json {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            display: none;
        }

        .details-btn {
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--primary);
            margin-left: 10px;
        }

        /* New: Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: rgba(13, 27, 42, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .close-modal {
            float: right;
            cursor: pointer;
            color: var(--text-muted);
        }

        .close-modal:hover {
            color: white;
        }

        /* --- ATS KANBAN STYLES --- */
        .ats-layout {
            display: flex;
            gap: 20px;
            height: calc(100vh - 160px);
            overflow-x: auto;
            padding-bottom: 20px;
        }

        /* UPDATED: Sidebar for Jobs */
        .ats-sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid var(--glass-border);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ats-main-board {
            flex-grow: 1;
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px;
        }

        .ats-job-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .ats-job-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .ats-job-item.active {
            border-color: var(--primary);
            background: rgba(52, 152, 219, 0.1);
        }

        .ats-job-title {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .ats-job-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .ats-column {
            flex: 0 0 300px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .ats-col-header {
            padding: 15px;
            font-weight: 700;
            color: var(--text-header);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ats-count {
            background: var(--glass-bg);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ats-cards {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ats-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 8px;
            cursor: grab;
            transition: 0.2s;
            position: relative;
        }

        .ats-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .ats-name {
            font-weight: 600;
            color: white;
            margin-bottom: 5px;
        }

        .ats-role {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .ats-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        .ats-btn-hire {
            font-size: 0.75rem;
            background: var(--success);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- PERFORMANCE STYLES --- */
        .perf-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .perf-high {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.4);
        }

        .perf-mid {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.4);
        }

        .perf-low {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        .score-card {
            text-align: center;
            padding: 15px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
        }

        .score-val {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .cycle-switch {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .cycle-btn {
            padding: 6px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-muted);
            border: none;
            background: transparent;
            transition: 0.2s;
        }

        .cycle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ADDED: Styles for Weekday Selector in Settings Modal */
        .day-selector {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .day-check {
            display: none;
        }

        .day-label {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .day-check:checked+.day-label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 12px 20px;
            background: rgba(13, 27, 42, 0.92);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: center;
            gap: 22px;
            z-index: 999;
            backdrop-filter: blur(12px);
        }

        html[dir="rtl"] .app-footer {
            right: 0;
            left: 0;
        }

        .app-footer a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .app-footer a:hover {
            color: #fff;
        }

        /* --- AI ASSISTANT --- */
        :root {
            --ai-panel-bg: rgba(10, 20, 32, 0.92);
            --ai-panel-border: rgba(255, 255, 255, 0.12);
            --ai-bubble-user: linear-gradient(135deg, #2c7fb8, #3498db);
            --ai-bubble-assistant: rgba(255, 255, 255, 0.08);
            --ai-bubble-text: #eaf2ff;
            --ai-launcher-bg: linear-gradient(135deg, #0f2a3d, #2c5364);
        }

        #ai-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            left: auto;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        html[dir="rtl"] #ai-widget {
            right: auto;
            left: 24px;
            align-items: flex-start;
        }

        #ai-window {
            width: 420px;
            max-width: 92vw;
            height: 560px;
            max-height: 75vh;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 18px;
            background: var(--ai-panel-bg);
            border: 1px solid var(--ai-panel-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        }

        #ai-window.hidden {
            display: none !important;
        }

        .ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px;
            background: rgba(52, 152, 219, 0.18);
            border-bottom: 1px solid var(--ai-panel-border);
        }

        .ai-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #fff;
        }

        .ai-credits {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.08);
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .ai-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--ai-panel-border);
            background: rgba(0, 0, 0, 0.18);
        }

        .ai-quick-btn {
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.08);
            color: #eaf2ff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .ai-quick-btn:hover {
            border-color: var(--primary);
            color: #fff;
        }

        .ai-chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: rgba(0, 0, 0, 0.15);
        }

        .ai-msg {
            display: flex;
            margin-bottom: 12px;
        }

        .ai-msg.user {
            justify-content: flex-end;
        }

        .ai-msg.assistant {
            justify-content: flex-start;
        }

        .ai-bubble {
            max-width: 78%;
            padding: 10px 12px;
            border-radius: 12px;
            color: var(--ai-bubble-text);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ai-msg.user .ai-bubble {
            background: var(--ai-bubble-user);
            color: #fff;
            border-bottom-right-radius: 4px;
        }

        .ai-msg.assistant .ai-bubble {
            background: var(--ai-bubble-assistant);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom-left-radius: 4px;
        }

        .ai-input-row {
            padding: 12px;
            background: rgba(15, 30, 45, 0.6);
            border-top: 1px solid var(--ai-panel-border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ai-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .ai-send-btn {
            padding: 10px 14px;
            border-radius: 10px;
        }

        .ai-launcher {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            background: var(--ai-launcher-bg);
            box-shadow: 0 10px 30px rgba(10, 30, 45, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .ai-launcher:hover {
            transform: translateY(-2px);
        }

        #ai-widget.ai-open {
            inset: auto 24px 24px auto;
        }

        html[dir="rtl"] #ai-widget.ai-open {
            inset: auto auto 24px 24px;
        }

        @media (max-width: 900px) {
            #ai-window {
                width: 92vw;
                height: 70vh;
            }
        }

        @media (max-width: 600px) {
            #ai-widget.ai-open {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                align-items: stretch;
                padding: 0;
            }

            html[dir="rtl"] #ai-widget.ai-open {
                left: 0;
                right: 0;
            }

            #ai-widget.ai-open #ai-window {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }

            .ai-bubble {
                max-width: 90%;
            }

            #ai-widget.ai-open .ai-launcher {
                position: absolute;
                bottom: 16px;
                right: 16px;
                left: auto;
            }

            html[dir="rtl"] #ai-widget.ai-open .ai-launcher {
                left: 16px;
                right: auto;
            }
        }
    </style>
</head>

<body>

    <div id="auth-container">
        <div class="auth-card" id="login-card">
            <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA" class="auth-logo">
            <div class="auth-title" data-i18n="login_title">Enterprise Access</div>
            <div class="auth-subtitle" data-i18n="login_subtitle">Secure Login to Digitivia Operations</div>
            <div class="form-group"><label data-i18n="login_email_label">Email Address</label><input type="email"
                    id="login-email" class="form-input" data-i18n-placeholder="login_email_placeholder"
                    placeholder="name@company.com"></div>
            <div class="form-group"><label data-i18n="login_password_label">Password</label><input type="password"
                    id="login-pass" class="form-input" data-i18n-placeholder="login_password_placeholder"
                    placeholder="••••••••"></div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()"><span
                    data-i18n="login_button">Login</span></button>
            <div class="social-divider" id="auth-divider" data-i18n="auth_divider">Log in or create an account with
            </div>
            <div class="social-buttons" style="grid-template-columns: 1fr 1fr;">
                <div class="social-btn" onclick="socialLogin('google')" style="color:#DB4437"><i
                        class="fa-brands fa-google"></i></div>
                <div class="social-btn" onclick="socialLogin('linkedin_oidc')" style="color:#0077b5"><i
                        class="fa-brands fa-linkedin-in"></i></div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="sidebar" id="sidebar">
            <div class="logo-area">
                <img src="https://i.ibb.co/Z1fFwrhZ/cropped-solid-logo-1.png" alt="DIGITIVIA Logo">
            </div>
            <div id="nav-container"></div>
        </nav>
        <div class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <i class="fa-solid fa-bars icon-btn" onclick="toggleSidebar()"></i>
                    <span id="current-date" class="hide-on-mobile"
                        style="font-size: 0.9rem; color: var(--text-muted);"></span>
                </div>
                <div class="header-right">
                    <div class="branding-logos"
                        style="border:none; padding:0; margin:0; display:flex; align-items:center; gap:15px;">
                        <span id="org-display-name"
                            style="font-weight:700; color:white; opacity:0.8; font-size:1.1rem; text-transform:uppercase; letter-spacing:1px;"></span>
                        <span id="plan-badge-container"></span>
                    </div>

                    <div class="header-actions">
                        <button class="btn-outline" onclick="openPricingModal()"><i class="fa-solid fa-tags"></i> <span
                                data-i18n="pricing_btn">Pricing</span></button>
                        <button class="btn-outline" onclick="openHelpModal()"><i
                                class="fa-solid fa-circle-question"></i> <span data-i18n="help_btn">Need
                                Help?</span></button>
                    </div>

                    <div class="user-controls">
                        <div id="role-display" class="btn-outline"
                            style="cursor:default; border-color:var(--primary); color:var(--primary)">Loading...</div>
                        <button class="btn-outline" onclick="toggleLang()" id="lang-btn"
                            data-i18n="lang_btn">عربي</button>
                        <div class="dropdown" onclick="openProfileModal()"> <img src="" alt="User" id="user-avatar">
                        </div>
                    </div>
                </div>
            </header>
            <main class="content-scroll" id="main-view"></main>
            <div id="toast" class="toast"><i class="fa-solid fa-circle-check"></i> <span id="toast-msg">Success!</span>
            </div>
        </div>
    </div>

    <div id="job-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                <span data-i18n="job_wizard_title">Smart Job Wizard</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('job-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label data-i18n="job_title_label">Job Title</label>
                <input type="text" id="job-title" class="form-input" data-i18n-placeholder="job_title_placeholder"
                    placeholder="e.g. Senior Backend Engineer">
            </div>
            <div class="form-group">
                <label data-i18n="job_dept_label">Department</label>
                <input type="text" id="job-dept" class="form-input" data-i18n-placeholder="job_dept_placeholder"
                    placeholder="e.g. Engineering">
            </div>
            <div class="form-group">
                <label data-i18n="job_salary_label">Salary Range</label>
                <input type="text" id="job-salary" class="form-input" data-i18n-placeholder="job_salary_placeholder"
                    placeholder="e.g. $80k - $120k">
            </div>
            <div class="form-group">
                <label data-i18n="job_status_label">Status</label>
                <select id="job-status" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Open" data-i18n="job_status_open">Open</option>
                    <option value="Draft" data-i18n="job_status_draft">Draft</option>
                    <option value="Closed" data-i18n="job_status_closed">Closed</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="saveNewJob()">
                <i class="fa-solid fa-rocket"></i> <span data-i18n="job_publish_btn">Publish Job</span>
            </button>
        </div>
    </div>

    <div id="onboard-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 700px;">
            <div class="modal-title">
                <span data-i18n="onboard_title">Onboard New Hire</span>
                <i class="fa-solid fa-xmark close-modal" onclick="closeOnboardModal()"></i>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h4 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;"
                        data-i18n="onboard_step1">1. Employee Details</h4>

                    <div class="form-group">
                        <label><span data-i18n="onboard_full_name">Full Name</span> <span
                                style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-name" class="form-input"
                            data-i18n-placeholder="onboard_full_name_placeholder" placeholder="Jane Doe">
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="onboard_email">Company Email</span> <span
                                style="color:var(--danger)">*</span></label>
                        <input type="email" id="new-email" class="form-input"
                            data-i18n-placeholder="onboard_email_placeholder" placeholder="jane@company.com">
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="onboard_password">Temporary Password</span> <span
                                style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-pass" class="form-input"
                            data-i18n-placeholder="onboard_password_placeholder" placeholder="Welcome123">
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="onboard_role">Role</span> <span
                                style="color:var(--danger)">*</span></label>
                        <select id="new-role" class="form-input" style="background:var(--sidebar-bg);">
                            <option value="employee" data-i18n="role_employee">Employee</option>
                            <option value="manager" data-i18n="role_manager">Manager</option>
                            <option value="hr_manager" data-i18n="role_hr_manager">HR Manager</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="onboard_phone">Phone Number</span> <span
                                style="color:var(--danger)">*</span></label>
                        <input type="text" id="new-meta-phone" class="form-input"
                            data-i18n-placeholder="onboard_phone_placeholder" placeholder="+1 234 567 890">
                    </div>
                    <div class="form-group">
                        <label data-i18n="onboard_dept">Department (Optional)</label>
                        <input type="text" id="new-meta-dept" class="form-input"
                            data-i18n-placeholder="onboard_dept_placeholder" placeholder="Engineering">
                    </div>
                </div>

                <div style="border-left:1px solid var(--glass-border); padding-left:20px;">
                    <h4 style="color:var(--primary); margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;"
                        data-i18n="onboard_step2">2. Starter Documents</h4>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;"
                        data-i18n="onboard_docs_hint">Add Contracts, IDs, or Passports immediately.</p>

                    <div id="onboard-docs-list"
                        style="max-height: 350px; overflow-y:auto; padding-right:5px; margin-bottom:10px;">
                    </div>

                    <button class="btn-outline"
                        style="width:100%; font-size:0.85rem; padding:10px; border-style:dashed;"
                        onclick="addObjDocRow()">
                        <i class="fa-solid fa-plus"></i> <span data-i18n="onboard_add_doc_row">Add Document Row</span>
                    </button>
                </div>
            </div>

            <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--glass-border);">
                <button class="btn-primary" style="width:100%; justify-content:center; padding:12px;"
                    onclick="executeOnboard()">
                    <i class="fa-solid fa-check"></i> <span data-i18n="onboard_submit">Create Employee & Save
                        Docs</span>
                </button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                <span data-i18n="import_title">Import Legacy Attendance</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('import-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label data-i18n="import_upload_label">Upload CSV</label>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;"
                    data-i18n="import_format_hint">Format: email, date, in_time, out_time</p>
                <input type="file" id="attendance-file" class="form-input" accept=".csv">
            </div>
            <div
                style="background:rgba(231,76,60,0.1); padding:10px; border-radius:8px; border:1px solid rgba(231,76,60,0.3); font-size:0.8rem; margin-bottom:15px;">
                <i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="import_warning">Smart Merge Active:
                    Rows that conflict with verified "Live" data will be skipped to preserve integrity.</span>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handleAttendanceImport()">
                <span data-i18n="import_process_btn">Process Import</span>
            </button>
        </div>
    </div>

    <div id="perf-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                <span data-i18n="perf_modal_title">Upload Performance Data</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('perf-modal').classList.add('hidden')"></i>
            </div>
            <div class="form-group">
                <label data-i18n="perf_dept_rules">Department Rules</label>
                <select id="perf-dept" class="form-input" style="background:rgba(255,255,255,0.05);">
                    <option value="Engineering" data-i18n="perf_dept_engineering">Engineering (Qual 40 / Spd 30)
                    </option>
                    <option value="Sales" data-i18n="perf_dept_sales">Sales (Rev 50 / Spd 30)</option>
                    <option value="Support" data-i18n="perf_dept_support">Support (Qual 50 / Spd 30)</option>
                    <option value="General" data-i18n="perf_dept_general">General (Balanced)</option>
                </select>
            </div>
            <div class="form-group">
                <label data-i18n="perf_input_method">Input Method</label>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn-outline" onclick="setPerfInput('file')" id="btn-file-mode"
                        style="flex:1; border-color:var(--primary)"><span data-i18n="perf_input_file">File
                            Upload</span></button>
                    <button class="btn-outline" onclick="setPerfInput('manual')" id="btn-manual-mode"
                        style="flex:1;"><span data-i18n="perf_input_manual">Manual Text</span></button>
                </div>
            </div>
            <div id="perf-input-file" class="form-group">
                <label data-i18n="perf_upload_label">Upload CSV/Excel Log</label>
                <input type="file" id="perf-file" class="form-input">
            </div>
            <div id="perf-input-manual" class="form-group hidden">
                <label data-i18n="perf_manual_label">Paste Raw Work Logs</label>
                <textarea id="perf-text" class="form-input" rows="5" data-i18n-placeholder="perf_manual_placeholder"
                    placeholder="e.g. John completed 40 tickets with 2 errors. Sarah closed 5 deals..."></textarea>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center" onclick="handlePerformanceSubmit()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="perf_analyze_btn">Analyze with
                    AI</span>
            </button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title"><span data-i18n="settings_title">Department Schedules (Option B)</span><i
                    class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('settings-modal').classList.add('hidden')"></i></div>
            <div class="form-group">
                <label data-i18n="settings_dept_label">Department Name</label>
                <input type="text" id="set-dept" class="form-input" data-i18n-placeholder="settings_dept_placeholder"
                    placeholder="e.g. Sales, Engineering, or Global">
            </div>
            <div class="form-group">
                <label data-i18n="settings_work_days">Work Days</label>
                <div class="day-selector">
                    <input type="checkbox" id="d0" class="day-check" value="0"><label for="d0"
                        class="day-label">S</label>
                    <input type="checkbox" id="d1" class="day-check" value="1"><label for="d1"
                        class="day-label">M</label>
                    <input type="checkbox" id="d2" class="day-check" value="2"><label for="d2"
                        class="day-label">T</label>
                    <input type="checkbox" id="d3" class="day-check" value="3"><label for="d3"
                        class="day-label">W</label>
                    <input type="checkbox" id="d4" class="day-check" value="4"><label for="d4"
                        class="day-label">T</label>
                    <input type="checkbox" id="d5" class="day-check" value="5"><label for="d5"
                        class="day-label">F</label>
                    <input type="checkbox" id="d6" class="day-check" value="6"><label for="d6"
                        class="day-label">S</label>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label data-i18n="settings_start_time">Start Time</label><input
                        type="time" id="set-start" class="form-input" value="09:00"></div>
                <div class="form-group" style="flex:1"><label data-i18n="settings_end_time">End Time</label><input
                        type="time" id="set-end" class="form-input" value="17:00"></div>
            </div>
            <button class="btn-primary" style="width:100%; justify-content:center"
                onclick="saveDepartmentSchedule()"><span data-i18n="settings_save_btn">Save Rule</span></button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://neepgsppcemzwapcexys.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZXBnc3BwY2VtendhcGNleHlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDI5NzEsImV4cCI6MjA4MzExODk3MX0.1gXea9dkLrE8CY80ho0wC0al04DCvMJK5UimqAj96e0';
        const N8N_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_hr_payroll';
        const N8N_PERF_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_performance';
        const N8N_ATS_CONNECT_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_ats_connect';
        const N8N_AI_WEBHOOK_URL = 'https://n8n.srv1174105.hstgr.cloud/webhook/digitivia_ai_assistant';
        const N8N_HR_ASSISTANT_URL = N8N_AI_WEBHOOK_URL;
        const AI_CREDIT_COST = 1;

        const HR_ASSISTANT_SYSTEM_PROMPT = `
You are "Digitivia HR Assistant", a senior HR operations consultant inside an HR SaaS dashboard.
Goals: fast, accurate, actionable answers with high information density.
Language: always respond in the same language as the user's last message.
Tone: concise, confident, friendly, business-like. Keep replies short and high signal.

Navigation guidance:
- Use these exact menu names when pointing users: Dashboard, Org Profile, Employees, Payroll Automation, Attendance, ATS Recruitment, Performance AI, Strategic Reports, Workforce WFM, My Workspace.
- If asked "where do I do X", provide the shortest path with steps.
- If the user asks to open/navigate to a section, respond with JSON ONLY:
{
  "action": "navigate",
  "view": "dashboard|org_profile|employees|payroll|attendance|ats|performance|reports|wfm|employee_dash",
  "reply": "short confirmation shown to user"
}

Employee creation via chat:
- Required fields: full_name, email, role (employee|manager|hr_manager), phone.
- Optional: department, temp_password.
- If any required field is missing, ask only for the missing fields.
- Only return create_employee if the user's plan is starter, growth, bundle_3, or custom AND user_role is ceo|hr_manager|manager.
- When the user confirms and all required fields exist, output a JSON object ONLY with this schema:
{
  "action": "create_employee",
  "auto_create": true,
  "employee": {
    "full_name": "",
    "email": "",
    "role": "",
    "phone": "",
    "department": "",
    "temp_password": ""
  },
  "reply": "short confirmation shown to user"
}
- Otherwise, respond normally (not JSON).

If the user asks for a job posting or ATS help, guide them to ATS Recruitment > Smart Job Wizard.
Keep replies short: 3-6 bullet points or 2-4 short paragraphs. Provide quick next steps.
Never invent data. Ask if unsure.`;


        // --- TESLA-GRADE ATTENDANCE CONFIG ---
        const OFFICE_COORDS = { lat: 30.0444, lng: 31.2357 }; // Change to your HQ
        const MAX_DISTANCE_METERS = 500; // Radius

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        const state = {
            user: null, profile: null, org: null, lang: 'en', activeView: 'dashboard',
            perfCycle: 'Monthly', perfInputMode: 'file', aiCredits: null
        };

        let atsOrgColumn = null;
        let atsOrderColumn = 'id';
        let atsUseJobOrgFilter = false;

        async function resolveAtsOrgColumn() {
            if (atsOrgColumn !== null) return atsOrgColumn;
            const { data, error } = await supabaseClient
                .from('ats_applications')
                .select('*')
                .limit(1);
            if (!error && Array.isArray(data) && data.length > 0) {
                if (Object.prototype.hasOwnProperty.call(data[0], 'org_id')) {
                    atsOrgColumn = 'org_id';
                    atsUseJobOrgFilter = false;
                } else {
                    atsOrgColumn = '';
                    atsUseJobOrgFilter = true;
                }
                if (Object.prototype.hasOwnProperty.call(data[0], 'created_at')) {
                    atsOrderColumn = 'created_at';
                } else if (Object.prototype.hasOwnProperty.call(data[0], 'submitted_at')) {
                    atsOrderColumn = 'submitted_at';
                } else if (Object.prototype.hasOwnProperty.call(data[0], 'applied_at')) {
                    atsOrderColumn = 'applied_at';
                } else {
                    atsOrderColumn = 'id';
                }
            } else {
                atsOrgColumn = '';
                atsUseJobOrgFilter = true;
            }
            return atsOrgColumn;
        }
        // --- 1. INSERT AFTER 'const state = { ... }' ---

        // BUNDLE & FEATURE CONFIGURATION
        const TIER_ALIASES = { bundle_2: 'starter', bundle_3: 'growth' };
        const BUNDLE_CONFIG = {
            free: { name: "Free", features: ["dashboard", "employees", "basic_hr", "ai_preview"], can_broadcast: false },
            starter: { name: "Starter", features: ["dashboard", "employees", "basic_hr", "ai_full"], can_broadcast: false },
            growth: { name: "Growth", features: ["dashboard", "employees", "basic_hr", "ai_full", "wfm", "ats", "broadcast"], can_broadcast: true },
            custom: { name: "Custom", features: ["all"], can_broadcast: true }
        };

        function normalizeTier(rawTier) {
            const tier = String(rawTier || 'free').toLowerCase();
            return TIER_ALIASES[tier] || tier;
        }

        function getTierConfig(tierKey) {
            return BUNDLE_CONFIG[tierKey] || BUNDLE_CONFIG.free;
        }

        // Helper: Check if feature is allowed
        function hasAccess(featureKey) {
            if (!state.org) return false;
            const tier = normalizeTier(state.org.subscription_tier);
            const config = getTierConfig(tier);
            if (config.features.includes('all')) return true;
            return config.features.includes(featureKey);
        }

        function requireFeature(featureKey, actionFn) {
            if (!hasAccess(featureKey)) {
                openPricingModal();
                return;
            }
            return actionFn();
        }

        function getPlanDisplayName(tierKey) {
            const config = getTierConfig(tierKey);
            return config?.name || 'Free';
        }

        function updatePlanBadge() {
            if (!state.org) return;
            const tier = normalizeTier(state.org.subscription_tier || 'free');
            let planName = getPlanDisplayName(tier);
            let planColor = '#94a3b8'; // Grey
            let planBg = 'rgba(148, 163, 184, 0.2)';
            let icon = 'fa-seedling';

            if (tier === 'starter') {
                planColor = '#3498db';
                planBg = 'rgba(52, 152, 219, 0.2)';
                icon = 'fa-layer-group';
            } else if (tier === 'growth') {
                planColor = '#f1c40f';
                planBg = 'rgba(241, 196, 15, 0.2)';
                icon = 'fa-rocket';
            } else if (tier === 'custom') {
                planColor = '#9b59b6';
                planBg = 'rgba(155, 89, 182, 0.2)';
                icon = 'fa-gem';
            }

            const badgeHtml = `
            <span style="background:${planBg}; color:${planColor}; border:1px solid ${planColor}; padding:5px 12px; border-radius:20px; font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; display:inline-flex; align-items:center; gap:8px; box-shadow:0 0 10px ${planBg};">
                <i class="fa-solid ${icon}"></i> ${planName}
            </span>`;

            const badgeContainer = document.getElementById('plan-badge-container');
            if (badgeContainer) badgeContainer.innerHTML = badgeHtml;
        }
        // Translations
        // --- FULL TRANSLATIONS ---
        const i18n = {
            en: {
                lang_btn: "عربي",
                welcome: "Welcome back,",
                dashboard: "Dashboard",
                org_profile: "Org Profile",
                payroll: "Payroll Automation",
                employees: "Employees",
                attendance: "Attendance",
                ats: "ATS Recruitment",
                performance: "Performance AI",
                reports: "Strategic Reports",
                wfm: "Workforce WFM",
                total_staff: "Total Staff",
                online_now: "Online Now",
                open_jobs: "Open Jobs",
                late_today: "Late Today",
                recent_activity: "Recent Activity",
                expired_docs: "Expired Documents",
                connect_email: "Connect Email",
                add_candidate: "Add Candidate",
                post_job: "Post Job",
                view_report: "View Report",
                loading: "Loading...",
                error_loading: "Error loading data.",
                access_denied: "Access Denied",
                pricing_btn: "Pricing",
                help_btn: "Need Help?",
                role_loading: "Loading...",
                login_title: "Enterprise Access",
                login_subtitle: "Secure Login to Digitivia Operations",
                login_email_label: "Email Address",
                login_email_placeholder: "name@company.com",
                login_password_label: "Password",
                login_password_placeholder: "••••••••",
                login_button: "Login",
                auth_divider: "Log in or create an account with",
                job_wizard_title: "Smart Job Wizard",
                job_title_label: "Job Title",
                job_title_placeholder: "e.g. Senior Backend Engineer",
                job_dept_label: "Department",
                job_dept_placeholder: "e.g. Engineering",
                job_salary_label: "Salary Range",
                job_salary_placeholder: "e.g. $80k - $120k",
                job_status_label: "Status",
                job_status_open: "Open",
                job_status_draft: "Draft",
                job_status_closed: "Closed",
                job_publish_btn: "Publish Job",
                onboard_title: "Onboard New Hire",
                onboard_step1: "1. Employee Details",
                onboard_full_name: "Full Name",
                onboard_full_name_placeholder: "Jane Doe",
                onboard_email: "Company Email",
                onboard_email_placeholder: "jane@company.com",
                onboard_password: "Temporary Password",
                onboard_password_placeholder: "Welcome123",
                onboard_role: "Role",
                onboard_phone: "Phone Number",
                onboard_phone_placeholder: "+1 234 567 890",
                onboard_dept: "Department (Optional)",
                onboard_dept_placeholder: "Engineering",
                onboard_step2: "2. Starter Documents",
                onboard_docs_hint: "Add Contracts, IDs, or Passports immediately.",
                onboard_add_doc_row: "Add Document Row",
                onboard_submit: "Create Employee & Save Docs",
                import_title: "Import Legacy Attendance",
                import_upload_label: "Upload CSV",
                import_format_hint: "Format: email, date, in_time, out_time",
                import_warning: "Smart Merge Active: Rows that conflict with verified \"Live\" data will be skipped to preserve integrity.",
                import_process_btn: "Process Import",
                perf_modal_title: "Upload Performance Data",
                perf_dept_rules: "Department Rules",
                perf_dept_engineering: "Engineering (Qual 40 / Spd 30)",
                perf_dept_sales: "Sales (Rev 50 / Spd 30)",
                perf_dept_support: "Support (Qual 50 / Spd 30)",
                perf_dept_general: "General (Balanced)",
                perf_input_method: "Input Method",
                perf_input_file: "File Upload",
                perf_input_manual: "Manual Text",
                perf_upload_label: "Upload CSV/Excel Log",
                perf_manual_label: "Paste Raw Work Logs",
                perf_manual_placeholder: "e.g. John completed 40 tickets with 2 errors. Sarah closed 5 deals...",
                perf_analyze_btn: "Analyze with AI",
                settings_title: "Department Schedules (Option B)",
                settings_dept_label: "Department Name",
                settings_dept_placeholder: "e.g. Sales, Engineering, or Global",
                settings_work_days: "Work Days",
                settings_start_time: "Start Time",
                settings_end_time: "End Time",
                settings_save_btn: "Save Rule",
                docs_title: "Employee Documents",
                docs_add_title: "Add New Document",
                docs_type_placeholder: "Document Name (e.g. Passport)",
                docs_expiry_label: "Expiry Date",
                docs_link_placeholder: "External Drive Link (Optional)",
                docs_checklist_label: "Checklist Item Only (No File)",
                docs_save_btn: "Save Record",
                broadcast_title: "Send Company Announcement",
                broadcast_subject: "Subject",
                broadcast_message: "Message",
                broadcast_type: "Type",
                broadcast_info: "General Info (Blue)",
                broadcast_urgent: "Urgent Alert (Red)",
                broadcast_post_btn: "Post Announcement",
                setup_title: "Welcome to Digitivia!",
                setup_body: "We are thrilled to have you. To ensure your HR data is migrated correctly, we offer <b>2 Free Setup Calls</b> (30 mins each).",
                setup_cta: "Book Integration Call",
                setup_skip: "I'll explore on my own",
                help_title: "Need Help?",
                help_body: "Book two free 30-minute sessions (1 hour total) and we will help you integrate and set up your HR workspace.",
                help_cta: "Book a Free Meeting",
                email_connect_title: "Connect Recruitment Email",
                email_auto_scan: "<i class=\"fa-solid fa-robot\"></i> <b>AI Auto-Scan:</b> The AI will connect via IMAP and scan this inbox every 10 minutes for emails with \"Resume\" or \"CV\" in the subject.",
                email_provider: "Email Provider",
                email_provider_tip: "Choose 'Custom' if you use Zoho, GoDaddy, or a private server.",
                email_provider_gmail: "Gmail",
                email_provider_outlook: "Outlook / Office 365",
                email_provider_custom: "Custom IMAP (Other)",
                email_address: "Email Address",
                email_address_tip: "The email address where you receive job applications.",
                email_address_placeholder: "careers@company.com",
                app_password: "App Password",
                app_password_tip: "Do NOT use your login password. Generate a secure 'App Password' in your Google/Microsoft Account Security settings.",
                app_password_placeholder: "abcd xxxx yyyy zzzz",
                security_tip: "<i class=\"fa-solid fa-shield-halved\"></i> <strong>Security Tip:</strong> Use an <a href=\"https://myaccount.google.com/apppasswords\" target=\"_blank\" style=\"color:var(--primary); text-decoration:underline;\">App Password</a>, not your main password.",
                imap_host: "IMAP Host",
                imap_host_placeholder: "imap.server.com",
                imap_port: "IMAP Port",
                email_connect_btn: "Connect & Start AI Scanning",
                candidate_ai_title: "AI Candidate Analysis",
                match_score: "Match Score",
                exec_summary: "Executive Summary",
                extracted_skills: "Extracted Skills",
                source_context: "Source Context (CV / Portfolio)",
                pricing_title: "Upgrade Your Operation",
                pricing_subtitle: "Choose the bundle that fits your scale.",
                plan_free: "Free Trial",
                plan_starter: "Starter",
                plan_growth: "Growth (Identity Verified)",
                plan_custom: "Custom",
                price_free: "$0",
                price_starter: "$5",
                price_growth: "$10",
                price_custom: "Contact Sales",
                per_month: "/mo",
                free_trial_duration: "14-day free trial",
                discount_badge: "50% OFF",
                discount_first_year: "First year only",
                discount_then_price: "then {price}/mo",
                feature_employee_db: "Employee Database",
                feature_live_dashboard: "Live Dashboard",
                feature_basic_hr: "Basic HR Suite",
                feature_ai_preview: "AI Assistant Preview",
                feature_ai_full: "AI Assistant Full Access",
                feature_everything_in_free: "Everything in Free",
                feature_everything_in_starter: "Everything in Starter",
                feature_ats: "AI Recruitment (ATS)",
                feature_wfm: "Workforce WFM (Maps)",
                feature_broadcast: "Internal Broadcasting",
                feature_adherence: "Adherence Charts",
                feature_everything_in_growth: "Everything in Growth",
                feature_self_hosted: "Self-Hosted VPS Option",
                feature_custom_domain: "Custom Domain",
                feature_priority_support: "Priority Support",
                current_plan: "Current Plan",
                recommended: "Recommended",
                cta_free: "Start free trial",
                cta_starter: "Start Starter",
                cta_growth: "Upgrade to Growth",
                cta_custom: "Contact Sales",
                contact_sales: "Contact Sales",
                billing_note: "Displayed in {currency}. Billed in USD.",
                billing_note_usd_only: "Displayed in USD. Billed in USD.",
                billing_status: "Status: {status}",
                billing_renews: "Renews on",
                billing_ends: "Ends on",
                dont_show_again: "Don't show this automatically again",
                currency_label: "Currency",
                close_btn: "Close",
                meeting_limit_reached: "Meeting limit reached for your organization.",
                profile_title: "My Profile",
                profile_basic_info: "Basic Info",
                profile_company_role: "Company & Role",
                profile_email: "Email",
                profile_phone: "Phone",
                profile_org: "Organization",
                profile_dept: "Department",
                sign_out: "Sign Out",
                footer_docs: "Documentation",
                footer_privacy: "Privacy Policy",
                footer_legal: "Legal Notes",
                role_ceo: "CEO",
                role_hr_manager: "HR Manager",
                role_manager: "Manager",
                role_employee: "Employee",
                ai_title: "Your HR Assistant",
                ai_intro: "Hello! I can help you navigate, onboard employees, and explain any HR feature.",
                ai_placeholder: "Ask anything...",
                ai_quick_add_employee: "Add employee",
                ai_quick_add_hr: "Add HR manager",
                ai_quick_payroll_help: "Payroll help",
                ai_quick_attendance_help: "Attendance help",
                ai_login_required: "Please log in or create an account with Google or LinkedIn to use the HR assistant.",
                ai_no_credits: "You are out of AI credits. Upgrade your plan to keep using the HR assistant.",
                ai_assistant_error: "Sorry, I could not reach the assistant right now. Please try again.",
                ai_credit_debit_failed: "Unable to debit AI credits.",
                ai_credits: "{count} Credits",
                ai_thinking: "Thinking...",
                ai_fallback: "I can help with navigation, onboarding, policies, and ATS workflows. Share your request and I will guide you.",
                ai_try_again: "Please try again.",
                ai_action_role_block: "Only CEO, HR Manager, or Manager can add employees via the assistant.",
                ai_action_upgrade_body: "Employee creation via the assistant is available on the Starter plan and above.\nI can still answer HR questions. Open Pricing to upgrade and unlock this.",
                ai_action_missing: "I need a bit more detail to create the employee.",
                ai_action_created: "Employee created successfully.",
                ai_action_field_name: "Name",
                ai_action_field_email: "Email",
                ai_action_field_role: "Role",
                ai_action_field_department: "Department",
                ai_action_field_phone: "Phone",
                ai_action_temp_password: "Temporary password",
                ai_action_next_steps: "Next steps: Review the record in Employees.",
                ai_navigate_confirm: "Opening that section now.",
                ai_navigate_invalid: "I can only open sections inside the main menu. Tell me which tab to open.",
                docs_modal_title: "Documentation",
                docs_modal_intro: "Digitivia unifies HR operations, payroll, attendance, recruiting, performance, and workforce management in one secure workspace.",
                docs_tabs_title: "What each tab does",
                docs_bundles_title: "Bundles",
                docs_cta: "Need a walkthrough? Book a free meeting.",
                docs_btn: "Docs",
                meta_btn: "Meta",
                docs_tab_dashboard: "Dashboard: live KPIs, activity, and risk highlights.",
                docs_tab_org_profile: "Org Profile: company identity and compliance settings (CEO only).",
                docs_tab_employees: "Employees: employee directory, profiles, and document tracking.",
                docs_tab_payroll: "Payroll Automation: upload files, review AI calculations, and approve batches.",
                docs_tab_attendance: "Attendance: clock-ins, geo-fence verification, and history.",
                docs_tab_ats: "ATS Recruitment: email intake, AI candidate scoring, and hiring flow.",
                docs_tab_performance: "Performance AI: upload reviews and track quality/speed scores.",
                docs_tab_reports: "Strategic Reports: ROI, burnout, and efficiency analytics.",
                docs_tab_wfm: "Workforce WFM: schedules, live roster, and coverage forecasting.",
                docs_tab_workspace: "My Workspace: personal attendance and tools.",
                docs_bundle_free: "Free: basic dashboard, employees, basic HR, AI assistant preview.",
                docs_bundle_starter: "Starter: everything in Free + full AI assistant.",
                docs_bundle_growth: "Growth: everything in Starter + ATS, workforce WFM, internal broadcasting.",
                docs_bundle_custom: "Custom: tailored plan with dedicated support.",
                ai_prompts: {
                    add_employee: "Add a new employee named John Doe, email john@company.com, role employee, phone +1 555 0100, department Sales",
                    add_hr: "Create an HR manager named Sara Ali, email sara@company.com, phone +1 555 0200, department HR",
                    payroll_help: "Where can I upload payroll files and run payroll?",
                    attendance_help: "Where do I view attendance and clock-in records?"
                },
                nav_exec_suite: "Executive Suite",
                nav_hr_ops: "HR Operations",
                nav_team_mgmt: "Team Management",
                nav_workspace: "My Workspace",
                nav_my_home: "My Home",
                nav_time_clock: "Time Clock"
            },
            ar: {
                lang_btn: "English",
                welcome: "مرحباً بعودتك،",
                dashboard: "لوحة القيادة",
                org_profile: "ملف المؤسسة",
                payroll: "أتمتة الرواتب",
                employees: "الموظفون",
                attendance: "الحضور والانصراف",
                ats: "التوظيف الذكي ATS",
                performance: "تحليل الأداء",
                reports: "التقارير الاستراتيجية",
                wfm: "إدارة القوى العاملة",
                total_staff: "إجمالي الموظفين",
                online_now: "متصل الآن",
                open_jobs: "وظائف مفتوحة",
                late_today: "تأخيرات اليوم",
                recent_activity: "النشاط الحديث",
                expired_docs: "وثائق منتهية الصلاحية",
                connect_email: "ربط البريد الإلكتروني",
                add_candidate: "إضافة مرشح",
                post_job: "نشر وظيفة",
                view_report: "عرض التقرير",
                loading: "جارٍ التحميل...",
                error_loading: "تعذر تحميل البيانات.",
                access_denied: "تم رفض الوصول",
                pricing_btn: "الأسعار",
                help_btn: "تحتاج مساعدة؟",
                role_loading: "جارٍ التحميل...",
                login_title: "الدخول للمؤسسات",
                login_subtitle: "تسجيل دخول آمن إلى عمليات ديجيتيفيا",
                login_email_label: "عنوان البريد الإلكتروني",
                login_email_placeholder: "name@company.com",
                login_password_label: "كلمة المرور",
                login_password_placeholder: "••••••••",
                login_button: "تسجيل الدخول",
                auth_divider: "سجّل الدخول أو أنشئ حساباً عبر",
                job_wizard_title: "معالج الوظائف الذكي",
                job_title_label: "المسمى الوظيفي",
                job_title_placeholder: "مثال: مهندس برمجيات أول",
                job_dept_label: "القسم",
                job_dept_placeholder: "مثال: الهندسة",
                job_salary_label: "نطاق الراتب",
                job_salary_placeholder: "مثال: 80 ألف - 120 ألف دولار",
                job_status_label: "الحالة",
                job_status_open: "مفتوحة",
                job_status_draft: "مسودة",
                job_status_closed: "مغلقة",
                job_publish_btn: "نشر الوظيفة",
                onboard_title: "تأهيل موظف جديد",
                onboard_step1: "1. بيانات الموظف",
                onboard_full_name: "الاسم الكامل",
                onboard_full_name_placeholder: "Jane Doe",
                onboard_email: "البريد الإلكتروني للشركة",
                onboard_email_placeholder: "jane@company.com",
                onboard_password: "كلمة المرور المؤقتة",
                onboard_password_placeholder: "Welcome123",
                onboard_role: "الدور الوظيفي",
                onboard_phone: "رقم الهاتف",
                onboard_phone_placeholder: "+1 234 567 890",
                onboard_dept: "القسم (اختياري)",
                onboard_dept_placeholder: "الهندسة",
                onboard_step2: "2. المستندات الأولية",
                onboard_docs_hint: "أضف العقود أو الهويات أو جوازات السفر مباشرة.",
                onboard_add_doc_row: "إضافة صف مستند",
                onboard_submit: "إنشاء الموظف وحفظ المستندات",
                import_title: "استيراد الحضور القديم",
                import_upload_label: "تحميل CSV",
                import_format_hint: "الصيغة: البريد الإلكتروني، التاريخ، وقت الدخول، وقت الخروج",
                import_warning: "الدمج الذكي مفعّل: سيتم تجاوز الصفوف المتعارضة مع البيانات المعتمدة للحفاظ على النزاهة.",
                import_process_btn: "تنفيذ الاستيراد",
                perf_modal_title: "رفع بيانات الأداء",
                perf_dept_rules: "قواعد القسم",
                perf_dept_engineering: "الهندسة (الجودة 40 / السرعة 30)",
                perf_dept_sales: "المبيعات (الإيراد 50 / السرعة 30)",
                perf_dept_support: "الدعم (الجودة 50 / السرعة 30)",
                perf_dept_general: "عام (متوازن)",
                perf_input_method: "طريقة الإدخال",
                perf_input_file: "تحميل ملف",
                perf_input_manual: "نص يدوي",
                perf_upload_label: "تحميل سجل CSV/Excel",
                perf_manual_label: "ألصق سجلات العمل الخام",
                perf_manual_placeholder: "مثال: أنجز أحمد 40 تذكرة مع خطأين. أغلقت سارة 5 صفقات...",
                perf_analyze_btn: "تحليل بالذكاء الاصطناعي",
                settings_title: "جداول الأقسام (الخيار ب)",
                settings_dept_label: "اسم القسم",
                settings_dept_placeholder: "مثال: المبيعات، الهندسة، أو عام",
                settings_work_days: "أيام العمل",
                settings_start_time: "وقت البداية",
                settings_end_time: "وقت النهاية",
                settings_save_btn: "حفظ القاعدة",
                docs_title: "مستندات الموظف",
                docs_add_title: "إضافة مستند جديد",
                docs_type_placeholder: "اسم المستند (مثال: جواز سفر)",
                docs_expiry_label: "تاريخ الانتهاء",
                docs_link_placeholder: "رابط خارجي (اختياري)",
                docs_checklist_label: "بند قائمة فقط (بدون ملف)",
                docs_save_btn: "حفظ السجل",
                broadcast_title: "إرسال إعلان للشركة",
                broadcast_subject: "الموضوع",
                broadcast_message: "الرسالة",
                broadcast_type: "النوع",
                broadcast_info: "معلومة عامة (أزرق)",
                broadcast_urgent: "تنبيه عاجل (أحمر)",
                broadcast_post_btn: "نشر الإعلان",
                setup_title: "مرحباً بك في ديجيتيفيا!",
                setup_body: "يسعدنا انضمامك. لضمان نقل بيانات الموارد البشرية بشكل صحيح، نوفر <b>مكالمتين مجانيتين</b> (30 دقيقة لكل مكالمة).",
                setup_cta: "احجز مكالمة إعداد",
                setup_skip: "سأستكشف بنفسي",
                help_title: "تحتاج مساعدة؟",
                help_body: "احجز جلستين مجانيتين مدة كل منهما 30 دقيقة (إجمالي ساعة واحدة) لمساعدتك في التكامل والإعداد.",
                help_cta: "احجز اجتماعاً مجانياً",
                email_connect_title: "ربط بريد التوظيف",
                email_auto_scan: "<i class=\"fa-solid fa-robot\"></i> <b>المسح الذكي:</b> سيقوم الذكاء الاصطناعي بالاتصال عبر IMAP وفحص البريد كل 10 دقائق للرسائل التي تحتوي على \"Resume\" أو \"CV\" في العنوان.",
                email_provider: "مزود البريد الإلكتروني",
                email_provider_tip: "اختر \"مخصص\" إذا كنت تستخدم Zoho أو GoDaddy أو خادماً خاصاً.",
                email_provider_gmail: "جيميل",
                email_provider_outlook: "أوتلوك / أوفيس 365",
                email_provider_custom: "IMAP مخصص (أخرى)",
                email_address: "عنوان البريد الإلكتروني",
                email_address_tip: "البريد الذي تستقبل عليه طلبات التوظيف.",
                email_address_placeholder: "careers@company.com",
                app_password: "كلمة مرور التطبيق",
                app_password_tip: "لا تستخدم كلمة المرور الأساسية. أنشئ كلمة مرور تطبيق آمنة من إعدادات حسابك.",
                app_password_placeholder: "abcd xxxx yyyy zzzz",
                security_tip: "<i class=\"fa-solid fa-shield-halved\"></i> <strong>نصيحة أمان:</strong> استخدم <a href=\"https://myaccount.google.com/apppasswords\" target=\"_blank\" style=\"color:var(--primary); text-decoration:underline;\">كلمة مرور التطبيق</a> وليس كلمة المرور الرئيسية.",
                imap_host: "خادم IMAP",
                imap_host_placeholder: "imap.server.com",
                imap_port: "منفذ IMAP",
                email_connect_btn: "ربط البريد وبدء المسح الذكي",
                candidate_ai_title: "تحليل المرشح بالذكاء الاصطناعي",
                match_score: "درجة المطابقة",
                exec_summary: "الملخص التنفيذي",
                extracted_skills: "المهارات المستخرجة",
                source_context: "المحتوى الأصلي (السيرة / البورتفوليو)",
                pricing_title: "ترقية عمليتك",
                pricing_subtitle: "اختر الباقة الأنسب لنطاق عملك.",
                plan_free: "تجربة مجانية",
                plan_starter: "الأساسية",
                plan_growth: "النمو (موثّق الهوية)",
                plan_custom: "مخصص",
                price_free: "0$",
                price_starter: "5$",
                price_growth: "10$",
                price_custom: "تواصل مع المبيعات",
                per_month: "/شهرياً",
                free_trial_duration: "تجربة مجانية 14 يوم",
                discount_badge: "خصم 50%",
                discount_first_year: "السنة الأولى فقط",
                discount_then_price: "ثم {price}/شهر",
                feature_employee_db: "قاعدة بيانات الموظفين",
                feature_live_dashboard: "لوحة معلومات مباشرة",
                feature_basic_hr: "مجموعة الموارد البشرية الأساسية",
                feature_ai_preview: "معاينة المساعد الذكي",
                feature_ai_full: "وصول كامل للمساعد الذكي",
                feature_everything_in_free: "كل مزايا الباقة المجانية",
                feature_everything_in_starter: "كل مزايا الباقة الأساسية",
                feature_ats: "التوظيف الذكي (ATS)",
                feature_wfm: "خرائط القوى العاملة",
                feature_broadcast: "البث الداخلي",
                feature_adherence: "مخططات الالتزام",
                feature_everything_in_growth: "كل مزايا باقة النمو",
                feature_self_hosted: "خيار استضافة ذاتية",
                feature_custom_domain: "نطاق مخصص",
                feature_priority_support: "دعم أولوية",
                current_plan: "الخطة الحالية",
                recommended: "موصى بها",
                cta_free: "ابدأ التجربة المجانية",
                cta_starter: "ابدأ الأساسية",
                cta_growth: "الترقية إلى النمو",
                cta_custom: "تواصل مع المبيعات",
                contact_sales: "تواصل مع المبيعات",
                billing_note: "يتم العرض بعملة {currency}. تتم الفوترة بالدولار الأمريكي.",
                billing_note_usd_only: "يتم العرض بالدولار الأمريكي. تتم الفوترة بالدولار الأمريكي.",
                billing_status: "الحالة: {status}",
                billing_renews: "تجدد في",
                billing_ends: "تنتهي في",
                dont_show_again: "لا تظهر هذا تلقائياً مرة أخرى",
                currency_label: "العملة",
                close_btn: "إغلاق",
                meeting_limit_reached: "تم الوصول إلى حد الاجتماعات للمؤسسة.",
                profile_title: "ملفي الشخصي",
                profile_basic_info: "المعلومات الأساسية",
                profile_company_role: "الشركة والدور",
                profile_email: "البريد الإلكتروني",
                profile_phone: "الهاتف",
                profile_org: "المؤسسة",
                profile_dept: "القسم",
                sign_out: "تسجيل الخروج",
                footer_docs: "التوثيق",
                footer_privacy: "سياسة الخصوصية",
                footer_legal: "ملاحظات قانونية",
                role_ceo: "المدير التنفيذي",
                role_hr_manager: "مدير الموارد البشرية",
                role_manager: "مدير",
                role_employee: "موظف",
                ai_title: "مساعد الموارد البشرية",
                ai_intro: "مرحباً! يمكنني مساعدتك في التنقل، تأهيل الموظفين، وشرح ميزات الموارد البشرية.",
                ai_placeholder: "اسأل أي شيء...",
                ai_quick_add_employee: "إضافة موظف",
                ai_quick_add_hr: "إضافة مدير موارد بشرية",
                ai_quick_payroll_help: "مساعدة الرواتب",
                ai_quick_attendance_help: "مساعدة الحضور",
                ai_login_required: "يرجى تسجيل الدخول أو إنشاء حساب عبر جوجل أو لينكدإن لاستخدام مساعد الموارد البشرية.",
                ai_no_credits: "لا توجد أرصدة كافية. قم بترقية خطتك للاستمرار في استخدام المساعد.",
                ai_assistant_error: "عذراً، تعذر الاتصال بالمساعد حالياً. يرجى المحاولة لاحقاً.",
                ai_credit_debit_failed: "تعذر خصم أرصدة الذكاء الاصطناعي.",
                ai_credits: "الرصيد: {count}",
                ai_thinking: "جارٍ التفكير...",
                ai_fallback: "يمكنني المساعدة في التنقل، التأهيل، السياسات، وتدفقات ATS. شارك طلبك وسأرشدك.",
                ai_try_again: "يرجى المحاولة مرة أخرى.",
                ai_action_role_block: "يمكن فقط للمدير التنفيذي أو مدير الموارد البشرية أو المدير إضافة موظفين عبر المساعد.",
                ai_action_upgrade_body: "إضافة الموظفين عبر المساعد متاحة في الباقة الأساسية فما فوق.\nيمكنني الاستمرار في الإجابة على الأسئلة. سنفتح نافذة الأسعار للترقية.",
                ai_action_missing: "أحتاج بعض التفاصيل الإضافية لإنشاء الموظف.",
                ai_action_created: "تم إنشاء الموظف بنجاح.",
                ai_action_field_name: "الاسم",
                ai_action_field_email: "البريد الإلكتروني",
                ai_action_field_role: "الدور",
                ai_action_field_department: "القسم",
                ai_action_field_phone: "الهاتف",
                ai_action_temp_password: "كلمة المرور المؤقتة",
                ai_action_next_steps: "الخطوة التالية: راجع السجل في صفحة الموظفين.",
                ai_navigate_confirm: "جارٍ فتح القسم الآن.",
                ai_navigate_invalid: "يمكنني فتح الأقسام الموجودة في القائمة فقط. أخبرني بأي تبويب تريد فتحه.",
                docs_modal_title: "التوثيق",
                docs_modal_intro: "Digitivia توحّد عمليات الموارد البشرية والرواتب والحضور والتوظيف والأداء وإدارة القوى العاملة في مساحة واحدة آمنة.",
                docs_tabs_title: "ماذا يفعل كل تبويب",
                docs_bundles_title: "الباقات",
                docs_cta: "تحتاج جولة تعريفية؟ احجز اجتماعاً مجانياً.",
                docs_btn: "المستندات",
                meta_btn: "البيانات",
                docs_tab_dashboard: "لوحة القيادة: مؤشرات حية، نشاطات، وتنبيهات المخاطر.",
                docs_tab_org_profile: "ملف المؤسسة: إعدادات الهوية والامتثال (للمدير التنفيذي فقط).",
                docs_tab_employees: "الموظفون: دليل الموظفين والملفات وتتبع المستندات.",
                docs_tab_payroll: "أتمتة الرواتب: رفع الملفات، مراجعة حسابات الذكاء الاصطناعي، واعتماد الدُفعات.",
                docs_tab_attendance: "الحضور والانصراف: تسجيل الدخول، التحقق الجغرافي، والسجل.",
                docs_tab_ats: "التوظيف الذكي ATS: استقبال البريد، تقييم المرشحين، ومسار التوظيف.",
                docs_tab_performance: "تحليل الأداء: رفع المراجعات وتتبع درجات الجودة والسرعة.",
                docs_tab_reports: "التقارير الاستراتيجية: ROI والاحتراق والإنتاجية.",
                docs_tab_wfm: "إدارة القوى العاملة: الجداول، قائمة الحضور الحية، والتنبؤ بالتغطية.",
                docs_tab_workspace: "مساحتي: الحضور والأدوات الشخصية.",
                docs_bundle_free: "الباقة المجانية: لوحة معلومات أساسية، الموظفون، موارد بشرية أساسية، ومعاينة المساعد الذكي.",
                docs_bundle_starter: "الباقة الأساسية: كل مزايا المجانية + وصول كامل للمساعد الذكي.",
                docs_bundle_growth: "باقة النمو: كل مزايا الأساسية + ATS، إدارة القوى العاملة، والبث الداخلي.",
                docs_bundle_custom: "باقة مخصصة: خطة مصممة حسب الحاجة مع دعم مخصص.",
                ai_prompts: {
                    add_employee: "أضف موظفاً جديداً باسم John Doe، البريد john@company.com، الدور موظف، الهاتف +1 555 0100، القسم المبيعات",
                    add_hr: "أنشئ مدير موارد بشرية باسم Sara Ali، البريد sara@company.com، الهاتف +1 555 0200، القسم الموارد البشرية",
                    payroll_help: "أين يمكنني رفع ملفات الرواتب وتشغيل الرواتب؟",
                    attendance_help: "أين يمكنني عرض سجلات الحضور والانصراف؟"
                },
                nav_exec_suite: "الجناح التنفيذي",
                nav_hr_ops: "عمليات الموارد البشرية",
                nav_team_mgmt: "إدارة الفريق",
                nav_workspace: "مساحتي",
                nav_my_home: "صفحتي",
                nav_time_clock: "سجل الوقت"
            }
        };

        function t(key, fallback = '') {
            const dict = i18n[state.lang] || i18n.en || {};
            const parts = String(key || '').split('.');
            let value = dict;
            for (const part of parts) {
                if (value && Object.prototype.hasOwnProperty.call(value, part)) {
                    value = value[part];
                } else {
                    value = null;
                    break;
                }
            }
            if (value === null || value === undefined) return fallback || key;
            return value;
        }

        function tf(key, vars = {}, fallback = '') {
            let str = t(key, fallback);
            if (typeof str !== 'string') return str;
            return str.replace(/\{(\w+)\}/g, (match, name) => {
                if (Object.prototype.hasOwnProperty.call(vars, name)) {
                    return vars[name];
                }
                return match;
            });
        }

        function applyStaticTranslations() {
            document.querySelectorAll('[data-i18n]').forEach((el) => {
                const key = el.getAttribute('data-i18n');
                const value = t(key);
                if (value) el.textContent = value;
            });
            document.querySelectorAll('[data-i18n-html]').forEach((el) => {
                const key = el.getAttribute('data-i18n-html');
                const value = t(key);
                if (value) el.innerHTML = value;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
                const key = el.getAttribute('data-i18n-placeholder');
                const value = t(key);
                if (value) el.setAttribute('placeholder', value);
            });
            document.querySelectorAll('[data-i18n-title]').forEach((el) => {
                const key = el.getAttribute('data-i18n-title');
                const value = t(key);
                if (value) el.setAttribute('title', value);
            });
        }
        /* -------------------------------------------------------------------------
           CRITICAL: ALL HELPER FUNCTIONS DEFINED FIRST TO AVOID "NOT DEFINED" ERRORS
           ------------------------------------------------------------------------- */

        // --- NEW: AUDIT & SECURITY HELPERS ---
        async function logSystemAction(action, target, details = {}) {
            try {
                await supabaseClient.from('audit_logs').insert({
                    org_id: state.org.id,
                    actor_id: state.user.id,
                    action_type: action,
                    target_record: target,
                    details: details,
                    ip_address: 'client-side'
                });
            } catch (e) { console.warn("Audit Log Failed:", e); }
        }

        async function checkRoleAccess(requiredRoles) {
            if (!requiredRoles.includes(state.profile.role)) {
                document.getElementById('main-view').innerHTML = `<div class="card" style="text-align:center; padding:50px;"><i class="fa-solid fa-lock" style="font-size:3rem; color:var(--danger)"></i><h2 style="margin-top:20px;">Access Denied</h2><p>You need ${requiredRoles.join(' or ')} privileges.</p></div>`;
                return false;
            }
            return true;
        }

        // --- HELPER: LEAFLET MAP ---
        async function initLiveMap() {
            if (!document.getElementById('work-map')) return;
            const map = L.map('work-map').setView([OFFICE_COORDS.lat, OFFICE_COORDS.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            const { data: profiles } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id);
            if (!profiles) return;
            for (const p of profiles) {
                const { data: act } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', p.user_id).order('clock_in_time', { ascending: false }).limit(1).maybeSingle();
                if (act && act.check_in_lat && act.check_in_long) {
                    const isActive = act.clock_out_time === null;
                    const color = isActive ? 'green' : 'grey';
                    const iconHtml = `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'custom-pin' });
                    L.marker([act.check_in_lat, act.check_in_long], { icon: customIcon }).addTo(map)
                        .bindPopup(`<b>${p.full_name}</b><br>${isActive ? 'Online' : 'Offline'}<br>${new Date(act.clock_in_time).toLocaleTimeString()}`);
                }
            }
        }

        // --- HELPER: WFM ROSTER ---
        async function loadWFMRoster() {
            const list = document.getElementById('wfm-roster-list'); if (!list) return;
            const { data: employees } = await supabaseClient.from('profiles').select('user_id, full_name, role, avatar_url').eq('org_id', state.org.id).limit(50);
            if (!employees || employees.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No active employees found.</div>'; return; }
            const { data: active } = await supabaseClient.from('wfm_activity').select('user_id, current_status').eq('org_id', state.org.id).is('clock_out_time', null);
            const activeMap = {};
            if (active) active.forEach(a => activeMap[a.user_id] = a.current_status);
            let html = '';
            const colors = { 'On Queue': 'var(--success)', 'Break': 'var(--warning)', 'Meeting': 'var(--info)', 'Offline': 'var(--text-muted)' };
            employees.forEach(emp => {
                const isActive = activeMap.hasOwnProperty(emp.user_id);
                const status = isActive ? (activeMap[emp.user_id] || 'Online') : 'Offline';
                const color = isActive ? colors[status] || 'var(--success)' : 'var(--text-muted)';
                html += `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid var(--glass-border); opacity:${isActive ? 1 : 0.6}"><img src="${emp.avatar_url || 'https://ui-avatars.com/api/?background=random'}" style="width:35px; height:35px; border-radius:50%;"><div style="flex-grow:1;"><div style="font-weight:600; color:#fff;">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted);">${emp.role}</div></div><span style="font-size:0.75rem; padding:4px 8px; border-radius:4px; background:${color}20; color:${color}; border:1px solid ${color}40;">${status}</span></div>`;
            });
            list.innerHTML = html;
        }

        // --- HELPER: WFM CHART ---
        async function initWFMChart() {
            setTimeout(async () => {
                const ctx = document.getElementById('wfmChart');
                if (!ctx) return;
                try {
                    const { data: schedules, error: schError } = await supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
                    const defaultStart = 9; const defaultEnd = 17;
                    const todayStr = new Date().toISOString().split('T')[0];
                    const { data: logs } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
                    const hours = Array.from({ length: 24 }, (_, i) => i);
                    const planned = new Array(24).fill(0);
                    const actual = new Array(24).fill(0);
                    const { count } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
                    const totalStaff = count || 10;

                    let sStart = defaultStart, sEnd = defaultEnd;
                    if (schedules && schedules.length > 0) {
                        const s = schedules[0];
                        sStart = parseInt(s.shift_start.split(':')[0]);
                        sEnd = parseInt(s.shift_end.split(':')[0]);
                    }
                    hours.forEach(h => { if (h >= sStart && h < sEnd) planned[h] = totalStaff; });
                    if (logs) { logs.forEach(l => { const inH = new Date(l.clock_in_time).getHours(); const outH = l.clock_out_time ? new Date(l.clock_out_time).getHours() : 23; for (let i = inH; i <= outH; i++) actual[i]++; }); }

                    if (window.wfmChartInstance) window.wfmChartInstance.destroy();
                    window.wfmChartInstance = new Chart(ctx, { type: 'line', data: { labels: hours.map(h => `${h}:00`), datasets: [{ label: 'Planned', data: planned, borderColor: '#95a5a6', borderDash: [5, 5], tension: 0.4 }, { label: 'Actual', data: actual, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: true, tension: 0.4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } });
                } catch (err) { console.error("WFM Chart Error:", err); }
            }, 100);
        }

        // --- HELPER: ATTENDANCE HISTORY ---
        async function loadAttendanceHistory() {
            const histDiv = document.getElementById('attendance-history');
            if (!histDiv) return;

            const { data: logs, error } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).order('clock_in_time', { ascending: false }).limit(5);
            if (error || !logs) { return; }
            let html = `<table><thead><tr><th>Date</th><th>In</th><th>Out</th><th>Source</th><th>Proof</th></tr></thead><tbody>`;
            logs.forEach(log => {
                const date = new Date(log.clock_in_time).toLocaleDateString();
                const inTime = new Date(log.clock_in_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const outTime = log.clock_out_time ? new Date(log.clock_out_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '<span style="color:var(--success)">Active</span>';
                const sourceBadge = log.record_source === 'csv_upload' ? '<span class="badge" style="background:#95a5a6; position:static">Import</span>' : '<span class="badge" style="background:var(--success); position:static">Live</span>';
                const proofLink = log.check_in_photo ? `<a href="${log.check_in_photo}" target="_blank" style="color:var(--primary)">View Selfie</a>` : '-';
                html += `<tr><td>${date}</td><td>${inTime}</td><td>${outTime}</td><td>${sourceBadge}</td><td>${proofLink}</td></tr>`;
            });
            html += `</tbody></table>`;
            histDiv.innerHTML = html;
        }

        // --- HELPER: PAYROLL TABLE ---
        function normalizePayrollRows(payload) {
            let data = payload;
            if (typeof data === 'string') {
                const trimmed = data.trim();
                const cleaned = trimmed.startsWith('[Object:')
                    ? trimmed.replace(/^\[Object:\s*/, '').replace(/\]$/, '')
                    : trimmed;
                try { data = JSON.parse(cleaned); } catch (e) { return []; }
            }
            if (data && typeof data === 'object' && typeof data.rows === 'string') {
                try { data = { rows: JSON.parse(data.rows) }; } catch (e) { }
            }
            if (Array.isArray(data)) return data;
            if (data && Array.isArray(data.rows)) return data.rows;
            if (data && Array.isArray(data.items)) return data.items;
            return [];
        }

        function coercePayrollNumber(value) {
            if (value === null || value === undefined) return 0;
            if (typeof value === 'number' && Number.isFinite(value)) return value;
            const cleaned = String(value).replace(/[^0-9.-]/g, '');
            const parsed = parseFloat(cleaned);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function normalizePayrollRow(raw) {
            const row = (raw && typeof raw === 'object') ? raw : {};
            const name =
                row.employee_name ||
                row.employee ||
                row.name ||
                row.full_name ||
                row['Employee'] ||
                row['Employee Name'] ||
                row['Emp Name'] ||
                row['Employee_Name'] ||
                '';
            return {
                employee_name: String(name || '').trim() || 'Unknown',
                salary: coercePayrollNumber(row.salary ?? row.base_pay ?? row.base ?? row['Salary'] ?? row['Base Pay'] ?? row['Base'] ?? row['Gross']),
                bonus: coercePayrollNumber(row.bonus ?? row.overtime ?? row['Bonus'] ?? row['OT'] ?? row['Overtime']),
                deductions: coercePayrollNumber(row.deductions ?? row.deduction ?? row['Deductions'] ?? row['Tax'] ?? row['Taxes'] ?? row['Insurance'] ?? row['401k'] ?? row['401K'])
            };
        }

        function renderPayrollTable(items, isNew = true) {
            const loader = document.getElementById('payroll-loading');
            if (loader) loader.classList.add('hidden');
            const container = document.getElementById('payroll-content');
            if (container) {
                container.classList.remove('hidden');
                const isReadOnly = normalizeTier(state.org?.subscription_tier || 'free') === 'free';
                const noteHtml = isReadOnly
                    ? `<div style="font-size:0.75rem; color:var(--warning);">Read-only on Free. Upgrade to edit payroll rows.</div>`
                    : '';
                let html = `<div style="height:100%; overflow:hidden; display:flex; flex-direction:column;"><div class="card-header" style="padding:20px; flex-shrink:0; display:flex; justify-content:space-between; align-items:center;"><div><div class="card-title">Payroll Data</div>${noteHtml}</div><button class="btn-outline" onclick="renderPayrollUI(document.getElementById('main-view'))"><i class="fa-solid fa-rotate"></i> Refresh</button></div><div style="flex-grow:1; overflow-y:auto; padding:0 20px 20px 20px;"><table class="payroll-table"><thead><tr><th>Employee</th><th>Salary</th><th>Bonus</th><th>Deductions</th><th>Net Pay</th></tr></thead><tbody>`;
                if (items) {
                    items.forEach(item => {
                        const nameCell = isReadOnly
                            ? `<td>${escapeHtml(item.employee_name)}</td>`
                            : `<td><input class="table-input" value="${escapeHtml(item.employee_name)}" onchange="updatePayrollItem('${item.id}', 'employee_name', this.value, '${item.employee_name}')"></td>`;
                        const salaryCell = isReadOnly
                            ? `<td class="num">${item.salary || 0}</td>`
                            : `<td class="num"><input type="number" class="table-input" value="${item.salary || 0}" onchange="updatePayrollItem('${item.id}', 'salary', this.value, '${item.salary}')"></td>`;
                        const bonusCell = isReadOnly
                            ? `<td class="num">${item.bonus || 0}</td>`
                            : `<td class="num"><input type="number" class="table-input" value="${item.bonus || 0}" onchange="updatePayrollItem('${item.id}', 'bonus', this.value, '${item.bonus}')"></td>`;
                        const deductionsCell = isReadOnly
                            ? `<td class="num">${item.deductions || 0}</td>`
                            : `<td class="num"><input type="number" class="table-input" value="${item.deductions || 0}" onchange="updatePayrollItem('${item.id}', 'deductions', this.value, '${item.deductions}')"></td>`;
                        html += `<tr>${nameCell}${salaryCell}${bonusCell}${deductionsCell}<td class="num" style="color:var(--success); font-weight:bold">${item.net_pay || 0}</td></tr>`;
                    });
                }
                html += `</tbody></table></div></div>`;
                container.innerHTML = html;
            }
        }

        // --- HELPER: PERFORMANCE TABLE (SHOWS ALL) ---
        async function renderPerformanceTable(filteredReviews) {
            const { data: allEmployees } = await supabaseClient.from('profiles').select('user_id, full_name, email, role').eq('org_id', state.org.id);
            if (!allEmployees) return;

            const reviewMap = {};
            if (filteredReviews) {
                filteredReviews.forEach(r => reviewMap[r.user_id] = r);
            }

            let html = `<table><thead><tr><th>Employee</th><th>Role</th><th>Quality</th><th>Speed</th><th>Score</th><th>AI Insight</th></tr></thead><tbody>`;

            allEmployees.forEach(emp => {
                const r = reviewMap[emp.user_id];

                if (r) {
                    const scoreClass = r.score_final >= 90 ? 'perf-high' : (r.score_final >= 75 ? 'perf-mid' : 'perf-low');
                    html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>${r.score_quality}</td><td>${r.score_speed}</td><td><span class="perf-badge ${scoreClass}">${r.score_final}</span></td><td><button class="btn-outline" style="font-size:0.75rem;" onclick="showToast('${(r.ai_feedback || "").replace(/'/g, "\\'")}')">View Analysis</button></td></tr>`;
                } else {
                    html += `<tr><td><div style="font-weight:600">${emp.full_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${emp.email}</div></td><td>${emp.role}</td><td>-</td><td>-</td><td><span class="perf-badge" style="background:rgba(255,255,255,0.1); color:#aaa;">Pending</span></td><td><span style="font-size:0.8rem; color:#666;">No data</span></td></tr>`;
                }
            });

            html += `</tbody></table>`;
            const perfContent = document.getElementById('perf-content');
            if (perfContent) perfContent.innerHTML = html;
        }

        // --- HELPER: ROI TABLE & CHARTS ---
        function renderROITable(data) {
            const tbody = document.querySelector('#roi-table tbody');
            if (!tbody) return;
            let html = '';
            if (data) {
                data.forEach(r => { const roi = r.total_cost > 0 ? ((r.productivity_score / r.total_cost) * 1000).toFixed(1) : 'N/A'; html += `<tr><td>${r.full_name}</td><td>${r.role}</td><td>$${r.total_cost}</td><td>${r.productivity_score}</td><td>${roi}</td><td><span class="badge" style="background:var(--success); position:static">Healthy</span></td></tr>`; });
            }
            tbody.innerHTML = html;
        }

        function initReportCharts(data) {
            const ctx1 = document.getElementById('burnoutChart');
            const ctx2 = document.getElementById('efficiencyChart');
            if (!ctx1 || !ctx2 || !data) return;

            new Chart(ctx1, { type: 'bar', data: { labels: data.map(r => r.full_name), datasets: [{ label: 'Productivity', data: data.map(r => r.productivity_score), backgroundColor: '#3498db' }] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } });
            const roles = [...new Set(data.map(r => r.role))]; const efficiency = roles.map(role => { const users = data.filter(r => r.role === role); return users.reduce((sum, u) => sum + u.productivity_score, 0) / users.length; });
            new Chart(ctx2, { type: 'radar', data: { labels: roles, datasets: [{ label: 'Avg Prod', data: efficiency, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)' }] }, options: { plugins: { legend: { labels: { color: 'white' } } }, scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false } } } } });
        }

        // --- HELPER: GLOBAL FUNCTIONS FOR HTML BUTTONS ---
        window.handleClockOut = async function (activityId) {
            try {
                console.log("Attempting to end shift for Activity ID:", activityId);
                const { data, error } = await supabaseClient
                    .from('wfm_activity')
                    .update({ clock_out_time: new Date().toISOString(), current_status: 'Offline' })
                    .eq('id', activityId)
                    .select();

                if (error) throw error;
                if (!data || data.length === 0) {
                    console.error("Update succeeded but 0 rows changed. Check RLS policies.");
                    showToast("Database Permission Error: Run the SQL Fix!", true);
                    return;
                }
                showToast("Shift Ended. Have a great evening!");
                await renderAttendanceUI(document.getElementById('main-view'));
            } catch (err) {
                console.error("Clock Out Error:", err);
                showToast("Failed: " + err.message, true);
            }
        }

        async function startClockInFlow() {
            const btn = document.getElementById('btn-scan');
            const locStatus = document.getElementById('loc-status');
            const vidContainer = document.getElementById('camera-preview');
            const vid = document.getElementById('vid');
            let stream = null; // Declare stream before try block to prevent ReferenceError in catch
            btn.classList.add('hidden'); locStatus.innerText = "Acquiring Secure GPS Signal...";

            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const deviceType = isMobile ? 'mobile_app' : 'desktop_web';

            try {
                // STEP 1: Check permission status FIRST using Permissions API
                locStatus.innerText = "Checking location permissions...";
                let permissionStatus;
                try {
                    permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    console.log('Geolocation permission status:', permissionStatus.state);

                    if (permissionStatus.state === 'denied') {
                        throw new Error('PERMISSION_BLOCKED_BY_BROWSER');
                    }
                } catch (permErr) {
                    console.warn('Permissions API not available or failed:', permErr);
                    // Continue anyway - older browsers don't support Permissions API
                }

                // STEP 2: Request geolocation with options
                locStatus.innerText = "Acquiring GPS location...";
                const geoOptions = {
                    enableHighAccuracy: true,
                    timeout: 15000,  // Increased to 15 seconds
                    maximumAge: 0    // Force fresh location
                };

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, geoOptions);
                });
                const { latitude, longitude } = position.coords;
                const dist = getDistanceFromLatLonInM(latitude, longitude, OFFICE_COORDS.lat, OFFICE_COORDS.lng);
                const workMode = dist < MAX_DISTANCE_METERS ? 'Office' : 'Remote';
                locStatus.innerText = `Verified: ${workMode} (${Math.round(dist)}m from HQ)`;
                locStatus.style.color = 'var(--success)';
                vidContainer.classList.remove('hidden');
                let publicUrl = null;

                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    vid.srcObject = stream;
                    await new Promise(r => setTimeout(r, 1500)); // Wait for camera to warm up

                    const blob = await new Promise(resolve => {
                        const canvas = document.createElement('canvas');
                        canvas.width = vid.videoWidth;
                        canvas.height = vid.videoHeight;
                        canvas.getContext('2d').drawImage(vid, 0, 0);
                        canvas.toBlob(resolve, 'image/jpeg');
                    });

                    if (blob) {
                        const fileName = `selfie_${state.user.id}_${Date.now()}.jpg`;
                        const { error: upErr } = await supabaseClient.storage.from('attendance_photos').upload(fileName, blob);
                        if (!upErr) {
                            const { data } = supabaseClient.storage.from('attendance_photos').getPublicUrl(fileName);
                            publicUrl = data.publicUrl;
                        }
                    }
                } catch (camErr) {
                    console.warn("Camera access failed or denied:", camErr);
                    showToast("⚠️ Camera denied - Proceeding without photo", true);
                }

                // PROCEED TO CLOCK IN (With or without photo)
                await supabaseClient.from('wfm_activity').insert({
                    org_id: state.org.id, user_id: state.user.id,
                    clock_in_time: new Date().toISOString(),
                    current_status: 'On Queue',
                    check_in_lat: latitude, check_in_long: longitude, check_in_photo: publicUrl, device_info: navigator.userAgent,
                    record_source: deviceType
                });

                if (stream) stream.getTracks().forEach(t => t.stop());
                showToast("✓ Clock-in successful" + (publicUrl ? "" : " (No Photo)"));
                renderAttendanceUI(document.getElementById('main-view'));
            } catch (err) {
                console.error('Clock-in error:', err);
                console.error('Error details - code:', err.code, 'message:', err.message, 'name:', err.name);

                let errorMsg = 'Clock-in failed';
                let instructions = '';

                // Custom error from Permissions API check
                if (err.message === 'PERMISSION_BLOCKED_BY_BROWSER') {
                    errorMsg = '🚫 Location is BLOCKED in Chrome Settings';
                    instructions = '\n\nTO FIX:\n1. Click the 3 dots menu (⋮) → Settings\n2. Search for "Site settings"\n3. Click "Location"\n4. Remove hr.digitivia.com from blocked list\n5. Refresh this page';
                }
                // Geolocation error codes: 1=PERMISSION_DENIED, 2=POSITION_UNAVAILABLE, 3=TIMEOUT
                else if (err.code >= 1 && err.code <= 3 && !err.bypassAttempted) {
                    // BYPASS: Geolocation failed, try camera-only with fallback coords
                    console.warn('Attempting bypass with office coordinates...');
                    err.bypassAttempted = true;
                    const latitude = OFFICE_COORDS.lat;
                    const longitude = OFFICE_COORDS.lng;
                    locStatus.innerText = `⚠️ GPS unavailable - Proceeding with Office Location`;
                    locStatus.style.color = 'var(--warning)';
                    vidContainer.classList.remove('hidden');
                    let bypassUrl = null;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        vid.srcObject = stream;
                        await new Promise(r => setTimeout(r, 1500));

                        const blob = await new Promise(resolve => {
                            const canvas = document.createElement('canvas');
                            canvas.width = vid.videoWidth;
                            canvas.height = vid.videoHeight;
                            canvas.getContext('2d').drawImage(vid, 0, 0);
                            canvas.toBlob(resolve, 'image/jpeg');
                        });

                        if (blob) {
                            const fileName = `selfie_${state.user.id}_${Date.now()}.jpg`;
                            const { error: upErr } = await supabaseClient.storage.from('attendance_photos').upload(fileName, blob);
                            if (!upErr) {
                                const { data } = supabaseClient.storage.from('attendance_photos').getPublicUrl(fileName);
                                bypassUrl = data.publicUrl;
                            }
                        }
                    } catch (camErr) {
                        console.warn("Camera failed during bypass:", camErr);
                        showToast("⚠️ Camera denied - Proceeding without photo", true);
                    }

                    // Proceed to clock in (bypass logic)
                    await supabaseClient.from('wfm_activity').insert({
                        org_id: state.org.id, user_id: state.user.id,
                        clock_in_time: new Date().toISOString(),
                        current_status: 'On Queue',
                        check_in_lat: latitude, check_in_long: longitude, check_in_photo: bypassUrl, device_info: navigator.userAgent,
                        record_source: deviceType
                    });

                    if (stream) stream.getTracks().forEach(t => t.stop());
                    showToast("✓ Clock-in successful (GPS bypass used)");
                    renderAttendanceUI(document.getElementById('main-view'));
                    return; // EXIT CATCH BLOCK
                } else if (err.code === 1) {
                    errorMsg = '🚫 Location Permission Denied';
                    instructions = '\n\nTO FIX:\n1. Look for the 🔒 or ⓘ icon in address bar\n2. Click it and find "Location"\n3. Change to "Allow"\n4. Refresh the page (F5)';
                } else if (err.code === 2) {
                    errorMsg = '📍 Unable to get your location';
                    instructions = '\n\nPossible fixes:\n• Enable GPS on your device\n• Move to area with better GPS signal\n• Check if browser has location services enabled';
                } else if (err.code === 3) {
                    errorMsg = '⏱️ Location request timed out';
                    instructions = '\n\nTry:\n• Check GPS/location services are on\n• Move closer to a window\n• Refresh and try again';
                } else if (err.name === 'NotAllowedError') {
                    errorMsg = '📷 Camera access denied';
                    instructions = '\n\nAllow camera permissions in browser settings';
                } else {
                    errorMsg = err.message || 'An error occurred during clock-in';
                }

                const fullMessage = errorMsg + instructions;
                showToast(errorMsg, true);
                locStatus.innerText = fullMessage;
                locStatus.style.color = 'var(--danger)';
                btn.classList.remove('hidden');
                if (stream) stream.getTracks().forEach(t => t.stop());
            }
        }

        // --- NEW: MISSING FUNCTION: Save Dept Schedule ---
        window.saveDepartmentSchedule = async function () {
            const dept = document.getElementById('set-dept').value;
            const start = document.getElementById('set-start').value;
            const end = document.getElementById('set-end').value;

            const days = [];
            for (let i = 0; i <= 6; i++) {
                if (document.getElementById(`d${i}`).checked) days.push(i);
            }

            if (!dept) return showToast("Department name required", true);

            const { error } = await supabaseClient
                .from('wfm_schedules')
                .upsert({
                    org_id: state.org.id,
                    department: dept,
                    shift_start: start,
                    shift_end: end,
                    work_days: days
                }, { onConflict: 'org_id, department' });

            if (error) return showToast("Save Failed: " + error.message, true);

            showToast(`Schedule saved for ${dept}`);
            document.getElementById('settings-modal').classList.add('hidden');
            renderWFMUI(document.getElementById('main-view'));
        }

        // --- INIT & AUTH ---
        // --- INIT & AUTH ---
        window.addEventListener('DOMContentLoaded', async () => {
            const dateEl = document.getElementById('current-date');
            if (dateEl) dateEl.innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            applyStaticTranslations();

            // 1. LISTEN for Auth State Changes (Handles both Redirects and Normal Session)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    // Clear URL junk (hashes and query params) for a clean look
                    if (window.location.hash || window.location.search) {
                        window.history.replaceState(null, null, window.location.pathname);
                    }

                    // Load App if not already loaded
                    if (!state.user) {
                        loadAppData(session.user);
                    }
                } else if (event === 'SIGNED_OUT') {
                    showAuthScreen();
                }
            });

            // 2. CHECK for Initial Session
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                loadAppData(session.user);
            } else {
                // 3. SMART REDIRECT CHECK (The Fix)
                // We only show the login screen if we are SURE this isn't a Google/LinkedIn redirect.
                // We check for both '#access_token' (Implicit) and '?code=' (PKCE).
                const isRedirect = window.location.hash.includes('access_token') ||
                    window.location.search.includes('code=');

                if (isRedirect) {
                    // Show a loading spinner instead of the Login Form while Supabase processes the token
                    document.getElementById('auth-container').innerHTML = `
                    <div class="auth-card" style="text-align:center;">
                        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i>
                        <h3 style="margin-top:20px; color:white;">Finishing Login...</h3>
                    </div>`;
                } else {
                    showAuthScreen();
                }
            }
        });
        async function handleLogin() { const email = document.getElementById('login-email').value; const password = document.getElementById('login-pass').value; try { const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) throw error; loadAppData(data.user); } catch (err) { showToast(err.message, true); } }
        async function handleRegister() { const email = document.getElementById('reg-email').value; const password = document.getElementById('reg-pass').value; const fullName = document.getElementById('reg-name').value; const orgName = document.getElementById('reg-org-name').value; if (!email || !password || !fullName || !orgName) { showToast("Please fill all fields", true); return; } try { const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { full_name: fullName, org_name: orgName, avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random` } } }); if (error) throw error; showToast("Registration successful! Logging in..."); if (data.session) loadAppData(data.user); else showToast("Please check your email to confirm account", false); } catch (err) { showToast(err.message || "Server Error", true); } }
        async function socialLogin(provider) {
            // FIX: Always use origin + pathname to strip existing hashes and prevent "Double Hash" errors
            const cleanRedirect = window.location.origin + window.location.pathname;

            await supabaseClient.auth.signInWithOAuth({
                provider: provider,
                options: {
                    redirectTo: cleanRedirect,
                    // Add scopes if needed for specific providers
                    scopes: provider === 'azure' ? 'email profile openid' : undefined
                }
            });
        }
        async function handleLogout() { await supabaseClient.auth.signOut(); window.location.reload(); }
        function showAuthScreen() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            applyStaticTranslations();
        }

        // --- MAIN DATA LOADER ---
        // --- MAIN DATA LOADER (Fixed for Corporate Logins) ---
        // --- MAIN DATA LOADER (CEO Edition) ---
        // --- MAIN DATA LOADER (Auto-Fix Edition) ---
        // --- MAIN DATA LOADER (Safety Edition) ---
        async function loadAppData(user) {
            state.user = user;

            let { data: profileData, error: profileError } = await supabaseClient
                .from('profiles')
                .select('*, organizations(*)')
                .eq('user_id', user.id)
                .maybeSingle();

            // --- NEW USER SETUP FLOW ---
            if (!profileData) {
                console.log("New User or Orphaned Profile Detected...");
                const meta = user.user_metadata || {};
                const fullName = meta.full_name || meta.name || user.email.split('@')[0];
                const avatarUrl = meta.avatar_url || meta.picture || `https://ui-avatars.com/api/?name=${fullName}&background=random`;

                // Determine Org Name
                const emailDomain = user.email.split('@')[1];
                let orgName = `${fullName}'s Company`;
                const freeDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com'];
                if (emailDomain && !freeDomains.includes(emailDomain)) {
                    const companyName = emailDomain.split('.')[0];
                    orgName = companyName.charAt(0).toUpperCase() + companyName.slice(1);
                }

                try {
                    // 1. Create Organization
                    const { data: newOrg, error: orgError } = await supabaseClient
                        .from('organizations')
                        .insert({ name: orgName })
                        .select()
                        .single();

                    if (orgError) {
                        console.error("Org Creation Blocked:", orgError);
                        if (orgError.code === '42501') {
                            showToast("Database Error: Run SQL Policy!", true);
                            document.getElementById('auth-container').innerHTML = `<div class="auth-card"><h3 style="color:var(--danger)">Setup Failed</h3><p>You need to run the SQL Policy to allow Organization Creation.</p><button class="btn-primary" onclick="location.reload()">Try Again</button></div>`;
                            return;
                        }
                    }

                    const targetOrgId = newOrg ? newOrg.id : (state.org?.id || null);

                    // 2. Create/Recover Profile
                    const { data: newProfile, error: createError } = await supabaseClient
                        .from('profiles')
                        .insert({
                            user_id: user.id, email: user.email, full_name: fullName,
                            role: 'ceo', org_id: targetOrgId, avatar_url: avatarUrl
                        })
                        .select('*, organizations(*)')
                        .single();

                    if (createError) {
                        if (createError.code === '23505') {
                            console.warn("Claiming zombie profile...");
                            const { data: claimedProfile, error: claimError } = await supabaseClient
                                .from('profiles')
                                .update({ user_id: user.id, role: 'ceo', avatar_url: avatarUrl })
                                .eq('email', user.email)
                                .select('*, organizations(*)')
                                .single();

                            if (claimError) throw claimError;
                            profileData = claimedProfile;
                        } else {
                            throw createError;
                        }
                    } else {
                        profileData = newProfile;
                    }
                    showToast(`Welcome, CEO of ${orgName}!`);

                } catch (err) {
                    console.error("Setup Fatal Error:", err);
                    showToast("Login Failed: " + err.message, true);
                    return;
                }
            }

            // --- LOAD APPLICATION ---
            if (!profileData || !profileData.organizations) {
                console.error("Critical: Profile loaded but Organization data is missing.");
                if (profileData && profileData.org_id) {
                    const { data: refetchOrg } = await supabaseClient.from('organizations').select('*').eq('id', profileData.org_id).single();
                    state.org = refetchOrg;
                }
                if (!state.org && profileData?.organizations) state.org = profileData.organizations;

                if (!state.org) {
                    showToast("Error: Account has no Organization linked.", true);
                    return;
                }
            } else {
                state.profile = profileData;
                state.org = profileData.organizations;
            }
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            setTimeout(() => document.getElementById('app-container').classList.add('loaded'), 100);

            // Fixed: Only update elements that exist
            const userNameEl = document.getElementById('user-name');
            if (userNameEl) userNameEl.innerText = state.profile.full_name;

            document.getElementById('user-avatar').src = state.profile.avatar_url || 'default.png';
            document.getElementById('role-display').innerText = formatRoleLabel(state.profile.role);
            document.getElementById('org-display-name').innerText = state.org.name;

            if (state.profile.role === 'employee') state.activeView = 'employee_dash';
            else state.activeView = 'dashboard';

            renderSidebar();

            updatePlanBadge();

            // Show Setup Modal if new
            const isNew = new Date() - new Date(state.org.created_at) < 60000;
            if (isNew) {
                document.getElementById('setup-modal').classList.remove('hidden');
            }

            renderMainContent();
            checkPricingPopup(); // Trigger the pricing modal check
            applyStaticTranslations();
            updatePricingDisplay();
            updateMeetingBookingVisibility();
            handleStripeSuccess();
        }
        // 1. DASHBOARD
        async function loadDashboardView(container) {
            const t = i18n[state.lang]; // Get translations

            // 1. Fetch Latest Broadcast
            const { data: broadcast } = await supabaseClient
                .from('broadcast_messages')
                .select('*')
                .eq('org_id', state.org.id)
                .order('sent_at', { ascending: false })
                .limit(1)
                .maybeSingle();

            let broadcastHTML = '';
            if (broadcast) {
                const severityColor = broadcast.severity === 'urgent' ? 'var(--danger)' : 'var(--primary)';
                broadcastHTML = `
            <div class="card" style="border-left: 4px solid ${severityColor}; background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 100%); margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-weight:700; color:${severityColor};"><i class="fa-solid fa-bullhorn"></i> ${broadcast.subject || 'Announcement'}</div>
                    <div style="font-size:0.8rem; opacity:0.7">${new Date(broadcast.sent_at).toLocaleDateString()}</div>
                </div>
                <div style="margin-top:5px; font-size:1rem;">${broadcast.content}</div>
            </div>`;
            }

            // 2. Fetch Expired Docs
            const todayStr = new Date().toISOString().split('T')[0];
            const { data: expiredDocs } = await supabaseClient
                .from('employee_documents')
                .select('*')
                .eq('org_id', state.org.id)
                .lt('expiry_date', todayStr)
                .order('expiry_date', { ascending: true });

            let expiredHTML = '<div style="padding:15px; text-align:center; color:var(--text-muted)">No expired documents. All good!</div>';

            if (expiredDocs && expiredDocs.length > 0) {
                const userIds = [...new Set(expiredDocs.map(d => d.profile_id))];
                const { data: owners } = await supabaseClient.from('profiles').select('id, full_name').in('id', userIds);
                const nameMap = {};
                if (owners) owners.forEach(o => nameMap[o.id] = o.full_name);

                expiredHTML = '<div style="max-height: 200px; overflow-y: auto;">';
                expiredDocs.forEach(doc => {
                    const ownerName = nameMap[doc.profile_id] || 'Unknown';
                    expiredHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(231, 76, 60, 0.3); background:rgba(231, 76, 60, 0.05); margin-bottom:5px; border-radius:6px;">
                    <div>
                        <div style="font-weight:600; font-size:0.9rem; color:var(--text-header)">${doc.document_type}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted)"><i class="fa-solid fa-user"></i> ${ownerName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem; color:var(--danger); font-weight:bold;">${new Date(doc.expiry_date).toLocaleDateString()}</div>
                        <div style="font-size:0.7rem; color:var(--danger); opacity:0.8">Expired</div>
                    </div>
                </div>`;
                });
                expiredHTML += '</div>';
            }

            // 3. HEADER DEFINITION (Only Once)
            const header = `<div class="page-title">
            <span>${t.welcome} <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span> 
            <div style="display:flex; gap:10px;">
                <button class="btn-outline" onclick="exportDashboardPDF()"><i class="fa-solid fa-file-pdf"></i> Export</button>
            </div>
        </div>
        ${broadcastHTML}`;

            // 5. Fetch Stats
            let query = supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('org_id', state.org.id);
            if (state.profile.role === 'manager') query = query.eq('department', state.profile.department);
            const { count: totalStaff } = await query;

            let activeQuery = supabaseClient.from('wfm_activity').select('user_id').eq('org_id', state.org.id).is('clock_out_time', null);
            if (state.profile.role === 'manager') {
                const { data: teamIds } = await supabaseClient.from('profiles').select('user_id').eq('department', state.profile.department);
                if (teamIds) activeQuery = activeQuery.in('user_id', teamIds.map(t => t.user_id));
            }
            const { data: activeData } = await activeQuery;
            const activeCount = activeData ? activeData.length : 0;

            let jobQuery = supabaseClient.from('ats_jobs').select('*', { count: 'exact', head: true });
            if (state.profile.role === 'manager') { jobQuery = jobQuery.eq('department', state.profile.department); }
            const { count: openJobs } = await jobQuery;

            let schedQuery = supabaseClient.from('wfm_schedules').select('*').eq('org_id', state.org.id);
            const { data: schedules } = await schedQuery;
            let lateCount = 0; let lateListHTML = '';

            if (schedules && schedules.length > 0) {
                const todayStr = new Date().toISOString().split('T')[0];
                const { data: logs } = await supabaseClient.from('wfm_activity').select('clock_in_time, user_id').eq('org_id', state.org.id).gte('clock_in_time', todayStr);
                if (logs && logs.length > 0) {
                    const userIds = logs.map(l => l.user_id);
                    const { data: logProfiles } = await supabaseClient.from('profiles').select('user_id, full_name, department').in('user_id', userIds);
                    const profileMap = {};
                    if (logProfiles) logProfiles.forEach(p => profileMap[p.user_id] = p);
                    logs.forEach(log => {
                        const profile = profileMap[log.user_id];
                        if (!profile) return;
                        const rule = schedules.find(s => s.department === profile.department) || schedules[0];
                        if (rule) {
                            const ruleHour = parseInt(rule.shift_start.split(':')[0]);
                            const ruleMin = parseInt(rule.shift_start.split(':')[1]);
                            const clockTime = new Date(log.clock_in_time);
                            const ruleTime = new Date(log.clock_in_time);
                            ruleTime.setHours(ruleHour, ruleMin, 0);
                            if (clockTime > ruleTime) {
                                lateCount++;
                                const diff = Math.round((clockTime - ruleTime) / 60000);
                                lateListHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between;"><span>${profile.full_name}</span> <span style="color:var(--danger)">+${diff} min</span></div>`;
                            }
                        }
                    });
                }
            }
            if (lateListHTML === '') lateListHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No late arrivals today.</div>';

            // 6. RENDER DASHBOARD
            container.innerHTML = `
            ${header}
            <div id="dash-content">
                <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card"><div class="card-title">${t.total_staff}</div><div class="score-val" style="color:var(--text-main)">${totalStaff || 0}</div></div>
                    <div class="card"><div class="card-title">${t.online_now}</div><div class="score-val" style="color:var(--success)">${activeCount}</div></div>
                    <div class="card"><div class="card-title">${t.open_jobs}</div><div class="score-val" style="color:var(--info)">${openJobs || 0}</div></div>
                    <div class="card"><div class="card-title">${t.late_today}</div><div class="score-val" style="color:var(--danger)">${lateCount}</div></div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card"><div class="card-title" style="margin-bottom:15px; color:var(--danger)">${t.late_today} Ticker</div><div style="overflow-y:auto; max-height:200px;">${lateListHTML}</div></div>
                    <div class="card"><div class="card-title">Staff Distribution</div><div style="height:200px; position:relative;"><canvas id="dashPie"></canvas></div></div>
                </div>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-top:25px;">
                    <div class="card">
                        <div class="card-title">${t.recent_activity}</div>
                        <div id="dash-activity">Loading...</div>
                    </div>
                    <div class="card" style="border-top: 4px solid var(--danger);">
                        <div class="card-title" style="color:var(--danger)"><i class="fa-solid fa-triangle-exclamation"></i> ${t.expired_docs}</div>
                        ${expiredHTML}
                    </div>
                </div>
            </div>
        `;

            // 7. Charts & Feeds
            setTimeout(async () => {
                const chartCanvas = document.getElementById('dashPie');
                if (chartCanvas) {
                    const { data: allProfs } = await supabaseClient.from('profiles').select('department').eq('org_id', state.org.id);
                    if (allProfs) {
                        const deptCounts = {};
                        allProfs.forEach(p => { const d = p.department || 'Unassigned'; deptCounts[d] = (deptCounts[d] || 0) + 1; });
                        new Chart(chartCanvas, { type: 'doughnut', data: { labels: Object.keys(deptCounts), datasets: [{ data: Object.values(deptCounts), backgroundColor: ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white' } } } } });
                    }
                }
            }, 100);

            const { data: feed } = await supabaseClient.from('wfm_activity').select('*').eq('org_id', state.org.id).order('clock_in_time', { ascending: false }).limit(5);
            let feedHTML = '';
            if (feed && feed.length > 0) {
                const feedUserIds = feed.map(f => f.user_id);
                const { data: feedProfiles } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', feedUserIds);
                const feedProfileMap = {};
                if (feedProfiles) feedProfiles.forEach(p => feedProfileMap[p.user_id] = p.full_name);
                feed.forEach(f => {
                    const name = feedProfileMap[f.user_id] || 'Unknown User';
                    feedHTML += `<div style="padding:10px; border-bottom:1px solid var(--glass-border); font-size:0.9rem;"><span style="font-weight:600; color:var(--primary)">${name}</span> clocked in via ${f.record_source} at ${new Date(f.clock_in_time).toLocaleTimeString()}</div>`;
                });
            } else {
                feedHTML = '<div style="padding:10px; color:var(--text-muted)">No recent activity</div>';
            }
            const activityDiv = document.getElementById('dash-activity');
            if (activityDiv) activityDiv.innerHTML = feedHTML;
        }
        // 1.5 EMPLOYEE DASHBOARD (New)
        async function renderEmployeeDashboard(container) {
            // Show loading state first
            container.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:2rem;"></i><p>Loading your dashboard...</p></div>`;

            // Fetch real data from database
            const userId = state.user.id;
            const orgId = state.org.id;

            // 1. Calculate On-Time Score from attendance history (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const { data: attendance } = await supabaseClient
                .from('wfm_activity')
                .select('clock_in_time, clock_out_time')
                .eq('user_id', userId)
                .gte('clock_in_time', thirtyDaysAgo.toISOString())
                .order('clock_in_time', { ascending: false });

            let onTimeScore = '--';
            let totalShifts = 0;
            let hoursThisMonth = 0;

            if (attendance && attendance.length > 0) {
                totalShifts = attendance.length;
                // Calculate hours worked
                attendance.forEach(shift => {
                    if (shift.clock_in_time && shift.clock_out_time) {
                        const inTime = new Date(shift.clock_in_time);
                        const outTime = new Date(shift.clock_out_time);
                        hoursThisMonth += (outTime - inTime) / (1000 * 60 * 60);
                    }
                });
                hoursThisMonth = Math.round(hoursThisMonth * 10) / 10;
                // Assume on-time if they clocked in (since we don't have late tracking)
                onTimeScore = totalShifts > 0 ? '100%' : '--';
            }

            // 2. Check latest payroll status (payroll_items uses employee_name, not user_id)
            const { data: payroll } = await supabaseClient
                .from('payroll_items')
                .select('updated_at, net_pay')
                .eq('org_id', orgId)
                .eq('employee_name', state.profile.full_name)
                .order('updated_at', { ascending: false })
                .limit(1);

            let payslipStatus = 'None';
            let payslipColor = 'var(--text-muted)';
            if (payroll && payroll.length > 0) {
                payslipStatus = 'Processed';
                payslipColor = 'var(--success)';
            }

            // 3. Check current clock-in status
            const { data: activeShift } = await supabaseClient
                .from('wfm_activity')
                .select('*')
                .eq('user_id', userId)
                .is('clock_out_time', null)
                .maybeSingle();

            const isClockedIn = !!activeShift;
            const statusBadge = isClockedIn
                ? `<span style="color:var(--success);"><i class="fa-solid fa-circle"></i> Currently Clocked In</span>`
                : `<span style="color:var(--text-muted);"><i class="fa-regular fa-circle"></i> Not Clocked In</span>`;

            container.innerHTML = `
            <div class="page-title"><span>Welcome, <span style="color:var(--primary)">${state.profile.full_name.split(' ')[0]}</span></span> ${statusBadge}</div>
            <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-calendar-check" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Shifts This Month</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">${totalShifts}</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">${hoursThisMonth} hours logged</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-money-check-dollar" style="font-size:2rem; color:var(--warning); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Latest Payslip</div>
                    <div style="font-size:1.5rem; color:${payslipColor}; margin-top:5px;">${payslipStatus}</div>
                </div>
                <div class="card" style="text-align:center; padding:30px;">
                    <i class="fa-solid fa-clock" style="font-size:2rem; color:var(--info); margin-bottom:10px;"></i>
                    <div style="font-size:1.2rem; font-weight:700;">Attendance Rate</div>
                    <div style="font-size:2rem; color:white; margin-top:5px;">${onTimeScore}</div>
                </div>
            </div>
            <div class="card" style="margin-top:20px; padding:40px; text-align:center;">
                <h3 style="margin-bottom:15px;">Quick Actions</h3>
                <button class="btn-primary" onclick="navigateTo('attendance')"><i class="fa-solid fa-fingerprint"></i> Go to Time Clock</button>
            </div>
        `;
        }

        // 2. EMPLOYEES (Restored & Fixed Button Bug)
        async function loadEmployeesView(container) {
            // FIX: Store the Header HTML in a variable first





            const header = `<div class="page-title">${i18n[state.lang].employees} <button class="btn-primary" onclick="openOnboardModal()"><i class="fa-solid fa-plus"></i> Onboard New Hire</button></div>`;

            container.innerHTML = `${header}<div class="card">Loading...</div>`;

            const { data, error } = await supabaseClient.from('profiles').select('*').eq('org_id', state.org.id);
            if (error) {
                container.innerHTML = `${header}<div class="card">Error: ${error.message}</div>`;
                return;
            }

            // FIX: Start the HTML string with the Header again, so it doesn't get wiped out
            let html = `${header}<div class="card"><table><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Details</th></tr></thead><tbody>`;

            data.forEach(emp => {
                const meta = emp.meta_data || {};
                html += `<tr>
                <td>${emp.full_name}</td>
                <td>${emp.role}</td>
                <td>${emp.email}</td>
                <td>
                    <button class="btn-outline" style="font-size:0.75rem; padding:5px 10px; margin-right:5px;" onclick="openDocsModal('${emp.id}', '${emp.full_name}')"><i class="fa-solid fa-folder-open"></i> ${t('docs_btn')}</button>
                    <span class="details-btn" onclick="this.parentElement.querySelector('.details-json').style.display = 'block'">${t('meta_btn')}</span>
                    <div class="details-json">${JSON.stringify(meta, null, 2)}</div>
                </td>
            </tr>`;

            });

            container.innerHTML = html + `</tbody></table></div>`;
        }

        // 3. PAYROLL (Fixed Bad Request Error)
        async function renderPayrollUI(container) {
            container.innerHTML = `<div class="page-title">Payroll Intelligence <button class="btn-primary" onclick="document.getElementById('payroll-file-input').click()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Payroll File</button><input type="file" id="payroll-file-input" style="display:none" accept=".csv, .xlsx, .xls" onchange="handlePayrollUpload(this)"></div><div class="payroll-layout"><div class="payroll-sidebar" id="payroll-history-list"><div class="card" style="text-align:center; padding:20px;">Loading History...</div></div><div class="payroll-main"><div id="payroll-loading" class="card hidden" style="text-align:center; padding:40px; justify-content:center;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i><h3 style="margin-top:20px;">AI Processing...</h3></div><div id="payroll-content" class="card" style="padding:0; overflow:hidden;"><div style="padding:50px; text-align:center; color:var(--text-muted)">Select a batch from history or upload a new file.</div></div></div></div>`;
            const { data: history, error } = await supabaseClient.from('payroll_batch_summary').select('*').eq('org_id', state.org.id).order('created_at', { ascending: false });
            const historyList = document.getElementById('payroll-history-list');
            if (!historyList) return; // <--- THIS IS THE SAFETY CHECK YOU MUST ADD
            historyList.innerHTML = ''; if (error || !history || history.length === 0) { historyList.innerHTML = `<div class="card" style="padding:15px; text-align:center; color:var(--text-muted)">No upload history</div>`; return; }
            history.forEach((batch, index) => {
                const date = new Date(batch.created_at).toLocaleDateString(); const time = new Date(batch.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div class="history-date">${date} <span style="font-weight:400; font-size:0.8em; color:#aaa">${time}</span></div><div class="history-meta" style="margin-bottom:5px;"><span><i class="fa-solid fa-user"></i> ${batch.uploader_name || 'Unknown'}</span><span class="history-badge">AI Verified</span></div><div style="display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-main);"><span>Employees: ${batch.employee_count}</span><span style="color:var(--success); font-weight:bold">$${batch.total_net_pay}</span></div>`;
                div.onclick = () => loadBatchData(batch.id, div); historyList.appendChild(div); if (index === 0) loadBatchData(batch.id, div);
            });
        }

        // 4. ATS (UPGRADED: With Active Jobs Sidebar)
        // 4. ATS (UPGRADED: With Safety Checks)
        // 4. ATS (REMASTERED: AI Intelligence View)
        async function loadATSView(container) {
            // 1. Header: Only "Connect Email" remains (Simplicity)
            container.innerHTML = `
            <div class="page-title">
                ATS Recruitment
                <button class="btn-outline" onclick="openEmailConnectModal()">
                    <i class="fa-solid fa-envelope"></i> Connect Email Source
                </button>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:20px;">
                <div class="card" style="padding:18px;">
                    <div class="card-title"><i class="fa-solid fa-at" style="color:var(--primary)"></i> Connected Email</div>
                    <div id="ats-email-status" style="margin-top:10px; color:var(--text-muted);">Checking connection...</div>
                </div>
                <div class="card" style="padding:18px;">
                    <div class="card-title"><i class="fa-solid fa-robot" style="color:var(--info)"></i> Auto-Processing</div>
                    <div style="margin-top:10px; color:var(--text-muted); font-size:0.9rem;">CVs and portfolio links are analyzed automatically from the connected inbox.</div>
                </div>
            </div>
            
            <div class="card" style="padding:0; overflow:hidden; min-height: 500px;">
                <div class="card-header" style="padding:20px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--glass-border);">
                    <div class="card-title"><i class="fa-solid fa-wand-magic-sparkles" style="color:var(--info)"></i> Incoming Candidates & AI Scores</div>
                </div>
                
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:rgba(255,255,255,0.02);">
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">Candidate</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">AI Match Score</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">AI Executive Summary</th>
                                <th style="padding:15px; text-align:left; color:var(--text-muted);">Status</th>
                                <th style="padding:15px; text-align:right; color:var(--text-muted);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ats-list-body">
                            <tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">Loading Intelligence...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>`;

            // 2. Load Connected Email
            await refreshAtsIntegrationStatus();

            // 3. Fetch Candidates (avoid invalid column errors)
            const orgColumn = await resolveAtsOrgColumn();
            const orderColumn = atsOrderColumn || 'id';
            let resp;

            if (orgColumn) {
                resp = await supabaseClient
                    .from('ats_applications')
                    .select('*, ats_jobs(title, department)')
                    .eq(orgColumn, state.org.id)
                    .order(orderColumn, { ascending: false });
            } else if (atsUseJobOrgFilter) {
                resp = await supabaseClient
                    .from('ats_applications')
                    .select('*, ats_jobs!inner(title, department, org_id)')
                    .eq('ats_jobs.org_id', state.org.id)
                    .order(orderColumn, { ascending: false });
            } else {
                resp = await supabaseClient
                    .from('ats_applications')
                    .select('*, ats_jobs(title, department)')
                    .order(orderColumn, { ascending: false });
            }

            let candidates = resp.data;
            let error = resp.error;

            // --- Safety Check ---
            const tableBody = document.getElementById('ats-list-body');
            if (!tableBody) return;

            if (error) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--danger);">Error loading data: ${error.message}</td></tr>`;
                return;
            }

            if (!candidates || candidates.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">
                <i class="fa-solid fa-inbox" style="font-size:2rem; margin-bottom:10px; opacity:0.5"></i><br>
                No candidates yet. Connect your email to start auto-importing.
            </td></tr>`;
                return;
            }

            // 4. Render the "AI View" List
            let html = '';
            candidates.forEach(c => {
                // Determine Score Color
                const score = c.ai_score || 0;
                let scoreColor = 'var(--danger)';
                if (score >= 75) scoreColor = 'var(--success)';
                else if (score >= 50) scoreColor = 'var(--warning)';

                // Formatting
                const summary = c.ai_summary
                    ? (c.ai_summary.length > 120 ? c.ai_summary.substring(0, 120) + '...' : c.ai_summary)
                    : '<span style="opacity:0.5; font-style:italic;">Processing analysis...</span>';

                const role = c.ats_jobs?.title || 'General Application';

                html += `
            <tr style="border-bottom:1px solid var(--glass-border); transition:0.2s;">
                <td style="padding:15px;">
                    <div style="font-weight:600; color:white; font-size:1rem;">${c.full_name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);"><i class="fa-solid fa-envelope"></i> ${c.email}</div>
                </td>
                <td style="padding:15px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; border-radius:50%; border:3px solid ${scoreColor}; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.85rem; color:white;">
                            ${score}%
                        </div>
                    </div>
                </td>
                <td style="padding:15px; max-width:400px;">
                    <div style="font-size:0.9rem; color:var(--text-main); line-height:1.5;">${summary}</div>
                </td>
                <td style="padding:15px;">
                    <span class="badge" style="background:${c.status === 'Hired' ? 'var(--success)' : 'rgba(255,255,255,0.1)'}; padding:5px 10px; font-size:0.75rem;">
                        ${c.status || 'New'}
                    </span>
                </td>
                <td style="padding:15px; text-align:right;">
                    <button class="btn-outline" onclick="viewCandidateAI('${c.id}')" style="font-size:0.8rem;">
                        <i class="fa-regular fa-eye"></i> Full Report
                    </button>
                </td>
            </tr>`;
            });

            tableBody.innerHTML = html;
        }

        // 5. WFM (Restored)
        // 5. WFM (UPGRADED: With Map & Real-Time Status)
        // 5. WFM (UPGRADED: COMMAND CENTER & HISTORY)
        // ---------------------------------------------------------
        // 5. WFM (MASTER EDITION: COMMAND CENTER + EXPORT + HISTORY)
        // ---------------------------------------------------------
        // ---------------------------------------------------------
        // 5. WFM (EXECUTIVE EDITION: NO MANUAL RULES, PURE AI)
        // ---------------------------------------------------------

        // =========================================================
        // WFM MODULE: EXECUTION, HISTORY & EXPORT
        // =========================================================

        // 1. RENDER UI
        async function renderWFMUI(container) {
            // Metric Cards with IDs for updates
            const metricsHtml = `
            <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Service Level (SL)</div>
                    <div id="wfm-metric-sl" style="font-size:1.8rem; font-weight:800; color:var(--success)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Target: 80/20</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Schedule Adherence</div>
                    <div id="wfm-metric-adh" style="font-size:1.8rem; font-weight:800; color:var(--warning)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Live vs Planned</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Occupancy Rate</div>
                    <div id="wfm-metric-occ" style="font-size:1.8rem; font-weight:800; color:var(--info)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Utilization</div>
                </div>
                <div class="card" style="padding:15px; text-align:center;">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Shrinkage</div>
                    <div id="wfm-metric-shr" style="font-size:1.8rem; font-weight:800; color:var(--danger)">--%</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Breaks/Meetings</div>
                </div>
            </div>`;

            // Main Layout
            container.innerHTML = `
            <div class="page-title">
                Workforce Command Center 
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="requireFeature('wfm', () => document.getElementById('wfm-upload-input').click())">
                        <i class="fa-solid fa-cloud-arrow-up"></i> AI Forecast Import
                    </button>
                    <input type="file" id="wfm-upload-input" style="display:none" accept=".csv, .xlsx" onchange="handleWFMUpload(this)">
                    
                    <button class="btn-outline" onclick="requireFeature('wfm', exportWFMData)">
                        <i class="fa-solid fa-file-export"></i> Export Report
                    </button>
                </div>
            </div>

            ${metricsHtml}

            <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fa-solid fa-brain" style="color:var(--info)"></i> AI Strategic Analysis</div>
                    </div>
                    <div id="wfm-insight-box" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; height:200px; overflow-y:auto; font-size:0.95rem; line-height:1.6; color:var(--text-main); border-left:4px solid var(--primary);">
                        <div style="color:var(--text-muted); text-align:center; padding-top:40px;">
                            Upload a file to generate a new strategy.
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:15px;">
                        <div style="font-size:0.9rem; font-weight:700; color:var(--text-muted); margin-bottom:10px;">
                            <i class="fa-solid fa-clock-rotate-left"></i> History
                        </div>
                        <div id="wfm-history-list" style="max-height:120px; overflow-y:auto;">Loading...</div>
                    </div>
                </div>

                <div class="card" style="padding:0; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="padding:15px; border-bottom:1px solid var(--glass-border); font-weight:bold; background:rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center;">
                        <span>Live Floor</span>
                        <span class="badge" style="position:static; background:var(--success)">Real-Time</span>
                    </div>
                    <div id="wfm-roster-list" style="overflow-y:auto; flex-grow:1; padding:10px;">
                        <div style="text-align:center; padding:20px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-table"></i> Schedule Preview</div>
                </div>
                <div style="overflow:auto; max-height:320px;">
                    <table id="wfm-preview-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Date</th>
                                <th>Shift Start</th>
                                <th>Shift End</th>
                                <th>Break Start</th>
                                <th>Break End</th>
                                <th>Location</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" style="text-align:center; color:var(--text-muted);">
                                    Upload a file to preview schedule rows.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:500px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> Geo-Fenced Presence</div>
                </div>
                <div id="work-map" style="width:100%; height:100%; border-radius:12px; z-index:1;"></div>
            </div>`;

            loadWFMRoster();
            loadWFMHistory();
            setTimeout(initLiveMap, 500);
        }

        // 2. UPLOAD & ANALYZE (Robust)
        // =========================================================
        // WFM: FIRE & FORGET (Fixes ERR_CONNECTION_CLOSED)
        // =========================================================

        // 1. Upload & Start AI (Doesn't wait for answer)
        window.handleWFMUpload = async function (input) {
            return requireFeature('wfm', async () => {
                const file = input.files[0];
                if (!file) return;

                // UI Feedback
                const btn = document.querySelector('.page-title .btn-primary');
                const oldHtml = btn ? btn.innerHTML : 'Import';
                if (btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting AI...';
                showToast("Uploading...", false);

                try {
                    // A. Upload File to Supabase Storage
                    const fileName = `wfm_forecast_${Date.now()}_${file.name}`;
                    const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file);
                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName);

                    // B. Trigger N8N (Fire & Forget)
                    // We verify the request was SENT, but we DO NOT wait for the analysis to finish.
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Handshake limit

                    try {
                        await fetch('https://n8n.srv1174105.hstgr.cloud/webhook/workforce_hr_digitivia', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'wfm_forecast_analysis',
                                file_url: publicUrl,
                                file_name: fileName, // Important: Sent so N8N can save it to DB
                                org_id: state.org.id,
                                user_id: state.user.id,
                                bundle_tier: state.org.subscription_tier || 'free'
                            }),
                            signal: controller.signal
                        });
                    } catch (e) {
                        // Ignore timeout errors here - it means N8N got the message and is working.
                        if (e.name !== 'AbortError') console.warn("Webhook trigger warning:", e);
                    }
                    clearTimeout(timeoutId);

                    // C. Start Looking for the Result in DB
                    showToast("AI is analyzing. Results will appear automatically.", false);
                    pollForWFMResults(fileName);

                } catch (err) {
                    console.error("Upload Error:", err);
                    showToast("Failed to start: " + err.message, true);
                } finally {
                    if (btn) btn.innerHTML = oldHtml;
                    if (input) input.value = '';
                }
            });
        }

        // 2. Poll Database for Results (Bypasses Server Timeout)
        async function pollForWFMResults(targetFileName, attempts = 0) {
            // Stop after 3 minutes (60 attempts * 3s)
            if (attempts > 60) {
                showToast("Analysis taking longer than usual. Check history later.", true);
                return;
            }

            const box = document.getElementById('wfm-insight-box');
            if (box && attempts === 0) {
                box.innerHTML = '<div style="text-align:center; padding:40px; color:var(--info)"><i class="fa-solid fa-brain fa-bounce" style="font-size:2rem; margin-bottom:10px;"></i><br>AI is analyzing strategy...</div>';
            }

            // Look for a recent log entry for THIS file in Supabase
            const { data: logs } = await supabaseClient
                .from('audit_logs')
                .select('*')
                .eq('org_id', state.org.id)
                .eq('action_type', 'WFM_FORECAST_GENERATED')
                .order('created_at', { ascending: false })
                .limit(1);

            if (logs && logs.length > 0) {
                const log = logs[0];
                // Check if this log matches the file we just uploaded
                if (log.details && log.details.file === targetFileName) {
                    showToast("Analysis Complete!", false);
                    loadWFMHistory(); // Update the UI
                    return;
                }
            }

            // Not found yet? Wait 3s and look again
            setTimeout(() => pollForWFMResults(targetFileName, attempts + 1), 3000);
        }

        // 3. Load History & Update UI
        async function loadWFMHistory() {
            const listContainer = document.getElementById('wfm-history-list');
            if (!listContainer) return;

            const { data: logs } = await supabaseClient
                .from('audit_logs')
                .select('*')
                .eq('org_id', state.org.id)
                .eq('action_type', 'WFM_FORECAST_GENERATED')
                .order('created_at', { ascending: false })
                .limit(5);

            if (!logs || logs.length === 0) {
                return;
            }

            // Update Dashboard with LATEST entry
            const latest = logs[0].details?.metrics;
            const latestInsight = logs[0].details?.insight;

            if (latest) {
                const slEl = document.getElementById('wfm-metric-sl');
                if (slEl) {
                    slEl.innerText = (latest.sl || 0) + "%";
                    document.getElementById('wfm-metric-adh').innerText = (latest.adherence || 0) + "%";
                    document.getElementById('wfm-metric-occ').innerText = (latest.occupancy || 0) + "%";
                    document.getElementById('wfm-metric-shr').innerText = (latest.shrinkage || 0) + "%";
                    document.getElementById('wfm-insight-box').innerHTML = (latestInsight || "").replace(/\n/g, '<br>');
                }
            }

            // Render List
            let html = '';
            logs.forEach(log => {
                const date = new Date(log.created_at).toLocaleDateString();
                const fileName = log.details?.file?.split('_').pop() || "Data File";
                // Escape quotes for onclick
                const safeInsight = (log.details?.insight || "").replace(/"/g, "&quot;").replace(/'/g, "\\'");

                html += `
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--info); cursor:pointer;" onclick="document.getElementById('wfm-insight-box').innerHTML='${safeInsight}'">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="font-weight:600; font-size:0.85rem; color:white;">${fileName}</span>
                    <span style="font-size:0.75rem; color:var(--text-muted);">${date}</span>
                </div>
                <div style="font-size:0.75rem; color:var(--primary);">Click to view</div>
            </div>`;
            });
            listContainer.innerHTML = html;
        }
        // 4. EXPORT FUNCTION
        window.exportWFMData = async function () {
            return requireFeature('wfm', async () => {
                showToast("Generating Report...");
                const { data: logs } = await supabaseClient
                    .from('audit_logs')
                    .select('*')
                    .eq('org_id', state.org.id)
                    .eq('action_type', 'WFM_FORECAST_GENERATED')
                    .order('created_at', { ascending: false });

                if (!logs || logs.length === 0) return showToast("No data to export", true);

                let csv = "Date,File,Service Level,Adherence,Occupancy,Insight\n";
                logs.forEach(log => {
                    const d = new Date(log.created_at).toLocaleDateString();
                    const f = (log.details?.file || "Unknown").split('_').pop();
                    const m = log.details?.metrics || {};
                    const i = (log.details?.insight || "").replace(/,/g, " ").replace(/\n/g, " ");
                    csv += `${d},${f},${m.sl || 0}%,${m.adherence || 0}%,${m.occupancy || 0}%,${i.substring(0, 100)}...\n`;
                });

                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                link.download = "WFM_Strategy_Report.csv";
                link.click();
            });
        }

        // --- UPDATED: Handle Upload with CORRECT Webhook & Instant Reflection ---
        // --- UPDATED: Handle Upload with CORRECT Webhook & Error Fix ---
        // --- UPDATED: Handle Upload with Robust Error Handling & Array Support ---

        // --- UPDATED: History Loader (Persists the Dashboard State) ---
        async function loadWFMHistory() {
            const listContainer = document.getElementById('wfm-history-list');
            if (!listContainer) return;

            // Fetch logs
            const { data: logs, error } = await supabaseClient
                .from('audit_logs')
                .select('*')
                .eq('org_id', state.org.id)
                .eq('action_type', 'WFM_FORECAST_GENERATED')
                .order('created_at', { ascending: false })
                .limit(5);

            if (error || !logs || logs.length === 0) {
                return; // Keep default empty state
            }

            // 1. Restore the latest dashboard state automatically
            const latestDetails = parseWfmDetails(logs[0].details);
            const latestMetrics = latestDetails?.metrics;
            const latestInsight = latestDetails?.insight;
            const latestSchedule = extractWfmSchedule(latestDetails);

            if (latestMetrics || latestInsight) {
                const slEl = document.getElementById('wfm-metric-sl');
                if (slEl) {
                    slEl.innerText = parsePercent(latestMetrics?.sl) + "%";
                    const adhEl = document.getElementById('wfm-metric-adh');
                    if (adhEl) adhEl.innerText = parsePercent(latestMetrics?.adherence) + "%";
                    const occEl = document.getElementById('wfm-metric-occ');
                    if (occEl) occEl.innerText = parsePercent(latestMetrics?.occupancy) + "%";
                    const shrEl = document.getElementById('wfm-metric-shr');
                    if (shrEl) shrEl.innerText = parsePercent(latestMetrics?.shrinkage) + "%";
                    if (latestInsight) {
                        document.getElementById('wfm-insight-box').innerHTML = (latestInsight || "").replace(/\n/g, '<br>');
                    }
                }
            }
            if (latestSchedule && latestSchedule.length) {
                renderWfmPreviewTable(latestSchedule);
            }

            // 2. Render History List
            let html = '';
            logs.forEach(log => {
                const details = parseWfmDetails(log.details);
                const date = new Date(log.created_at).toLocaleDateString();
                const fileName = details?.file?.split('_').pop() || "Forecast File";
                const safeInsight = (details?.insight || "").replace(/"/g, "&quot;").replace(/'/g, "\\'").replace(/\n/g, "<br>");
                html += `
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left:3px solid var(--info); cursor:pointer;" onclick="document.getElementById('wfm-insight-box').innerHTML='${safeInsight}'">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span style="font-weight:600; font-size:0.85rem; color:white;">${fileName}</span>
                    <span style="font-size:0.75rem; color:var(--text-muted);">${date}</span>
                </div>
                <div style="font-size:0.75rem; color:var(--primary);">Click to view</div>
            </div>`;
            });
            listContainer.innerHTML = html;
        }
        // 6. PERFORMANCE (UPGRADED: With Time Filters & Dependent Data)
        async function renderPerformanceUI(container) {
            container.innerHTML = `
            <div class="page-title">
                <div>Performance AI 
                    <div class="cycle-switch" style="display:inline-flex; margin-left:15px; vertical-align:middle;">
                        <button class="cycle-btn ${state.perfCycle === 'Daily' ? 'active' : ''}" onclick="changePerfCycle('Daily')">Day</button>
                        <button class="cycle-btn ${state.perfCycle === 'Weekly' ? 'active' : ''}" onclick="changePerfCycle('Weekly')">Week</button>
                        <button class="cycle-btn ${state.perfCycle === 'Monthly' ? 'active' : ''}" onclick="changePerfCycle('Monthly')">Month</button>
                        <button class="cycle-btn ${state.perfCycle === 'Quarterly' ? 'active' : ''}" onclick="changePerfCycle('Quarterly')">Qtr</button>
                    </div>
                </div>
                <button class="btn-primary" onclick="openPerformanceModal()"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Data</button>
            </div>
            
            <div class="dashboard-grid" id="perf-dependent-stats">
               <div class="card">
                   <div class="card-title">Attendance Factor</div>
                   <div class="score-val" style="color:var(--success)">95%</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Avg On-Time Rate</div>
               </div>
               <div class="card">
                   <div class="card-title">Avg Payroll Bonus</div>
                   <div class="score-val" style="color:var(--warning)">$450</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Last Cycle</div>
               </div>
               <div class="card">
                   <div class="card-title">Manager AI Score</div>
                   <div class="score-val" style="color:var(--info)" id="ai-avg-score">--</div>
                   <div style="font-size:0.8rem; color:var(--text-muted)">Based on Reviews</div>
               </div>
            </div>

            <div class="card" id="perf-content"><div style="padding:40px; text-align:center;">Loading Performance Data...</div></div>
        `;

            // Calculate Date Range based on selection
            let timeFilter = new Date();
            timeFilter.setHours(0, 0, 0, 0); // Start of today default

            if (state.perfCycle === 'Daily') {
                // Already today
            } else if (state.perfCycle === 'Weekly') {
                timeFilter.setDate(timeFilter.getDate() - 7);
            } else if (state.perfCycle === 'Monthly') {
                timeFilter.setDate(timeFilter.getDate() - 30);
            } else if (state.perfCycle === 'Quarterly') {
                timeFilter.setDate(timeFilter.getDate() - 90);
            }

            const { data: reviews, error } = await supabaseClient
                .from('performance_reviews')
                .select(`*, profiles( full_name, email, role )`)
                .eq('org_id', state.org.id)
                .gte('period_start', timeFilter.toISOString())
                .order('score_final', { ascending: false });

            if (error) {
                document.getElementById('perf-content').innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted)">Error loading data.</div>`;
                return;
            }

            // Calculate Avg AI Score if reviews exist
            if (reviews && reviews.length > 0) {
                const avgScore = (reviews.reduce((sum, r) => sum + (r.score_final || 0), 0) / reviews.length).toFixed(1);
                const scoreEl = document.getElementById('ai-avg-score');
                if (scoreEl) scoreEl.innerText = avgScore;
            }

            renderPerformanceTable(reviews);
        }

        // 7. REPORTS (Restored)
        async function renderReportsUI(container) {
            container.innerHTML = `<div class="page-title">Strategic Reports <button class="btn-outline" onclick="exportReportsSummary()"><i class="fa-solid fa-download"></i> Export Summary</button></div><div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;"><div class="card"><div class="card-title">Burnout Risk (Hours Worked vs Scheduled)</div><canvas id="burnoutChart" height="200"></canvas></div><div class="card"><div class="card-title">Department Efficiency</div><canvas id="efficiencyChart" height="200"></canvas></div></div><div class="card"><div class="card-header"><div class="card-title">Labor ROI Analysis</div><span class="badge" style="position:static; background:var(--info)">Live Data</span></div><div style="overflow-x:auto;"><table id="roi-table"><thead><tr><th>Employee</th><th>Role</th><th>Monthly Cost</th><th>Productivity</th><th>ROI Factor</th><th>Risk Status</th></tr></thead><tbody><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody></table></div></div>`;
            const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
            if (error || !reports) { document.querySelector('#roi-table tbody').innerHTML = '<tr><td colspan="6" style="color:red">View not ready. Run SQL.</td></tr>'; return; }

            // SAFETY FIX: Wait for DOM
            setTimeout(() => { initReportCharts(reports); }, 100);
            renderROITable(reports);
        }

        // 8. ATTENDANCE (Personal View Only)
        // 8. ATTENDANCE (Personal View Only)
        // 8. ATTENDANCE (Personal View Only)
        async function renderAttendanceUI(container) {
            const { data: activity } = await supabaseClient.from('wfm_activity').select('*').eq('user_id', state.user.id).is('clock_out_time', null).maybeSingle();
            const isClockedIn = !!activity;
            const startTime = activity ? new Date(activity.clock_in_time) : null;
            let durationHTML = '';

            if (isClockedIn) {
                const diffMs = new Date() - startTime;
                const hrs = Math.floor(diffMs / 3600000);
                const mins = Math.floor((diffMs % 3600000) / 60000);
                durationHTML = `<div style="text-align:center; margin-bottom:20px;"><div style="font-size:3rem; font-weight:700; color:var(--success); text-shadow:0 0 20px rgba(46,204,113,0.4);">${hrs}h ${mins}m</div><div class="perf-badge" style="background:rgba(46,204,113,0.2); color:var(--success);">Active Session</div></div>`;
            }

            const isAdmin = ['ceo', 'admin', 'hr_manager'].includes(state.profile.role);

            container.innerHTML = `
            <div class="page-title">
                My Attendance Workspace 
                ${isAdmin ? `<button class="btn-outline" onclick="document.getElementById('import-modal').classList.remove('hidden')"><i class="fa-solid fa-file-import"></i> Import Legacy</button>` : ''}
            </div>
            
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="card" style="align-items:center; justify-content:center; position:relative; overflow:hidden;">
                    ${durationHTML}
                    <div id="camera-preview" class="hidden" style="width:100%; max-width:300px; border-radius:12px; margin-bottom:15px; border:2px solid var(--primary);">
                        <video id="vid" autoplay style="width:100%; border-radius:10px;"></video>
                    </div>
                    ${!isClockedIn ?
                    `<button id="btn-scan" class="btn-primary" style="padding:15px 40px; font-size:1.2rem;" onclick="startClockInFlow()"><i class="fa-solid fa-fingerprint"></i> Biometric Clock In</button><div id="loc-status" style="margin-top:10px; color:var(--text-muted); font-size:0.8rem;"><i class="fa-solid fa-location-dot"></i> Waiting for GPS...</div>` :
                    `<button class="btn-outline" style="border-color:var(--danger); color:var(--danger); padding:15px 40px;" onclick="handleClockOut('${activity.id}')"><i class="fa-solid fa-power-off"></i> End Shift</button>`
                }
                </div>
                
                <div class="card" style="overflow-y:auto">
                    <div class="card-title">My Recent Activity</div>
                    <div id="attendance-history" style="margin-top:15px;">Loading...</div>
                </div>
            </div>

            <div class="card" style="margin-top:20px; height:450px;">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-map-location-dot"></i> Live Team Map</div>
                    <span class="badge" style="position:static; background:var(--success)">Online Staff</span>
                </div>
                <div id="work-map" style="width:100%; height:100%; border-radius:12px; z-index:1;"></div>
            </div>`;

            loadAttendanceHistory();
            setTimeout(initLiveMap, 500); // Reuses the map logic
        }
        // --- NEW: ORG PROFILE (CEO ONLY) ---
        // --- NEW: ORG PROFILE (CEO ONLY) - CLEANED ---
        async function renderOrgProfile(container) {
            if (!await checkRoleAccess(['ceo'])) return;

            container.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Settings...</div>`;

            // Fetch fresh org data
            const { data: org, error } = await supabaseClient.from('organizations').select('*').eq('id', state.org.id).single();
            if (error) return showToast("Failed to load org data", true);

            const tierLabel = getPlanDisplayName(normalizeTier(state.org?.subscription_tier || 'free'));

            container.innerHTML = `
            <div class="page-title">Organization Settings <span class="badge" style="position:static; font-size:0.9rem; background:var(--info)">${tierLabel} Tier</span></div>
            
            <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div class="card-header"><div class="card-title"><i class="fa-solid fa-building"></i> Corporate Identity</div></div>
                    <div class="form-group">
                        <label>Organization Name</label>
                        <input type="text" id="set-org-name" class="form-input" value="${org.name}">
                    </div>
                    <div class="form-group">
                        <label>CEO / Owner</label>
                        <input type="text" class="form-input" value="${state.profile.full_name}" disabled style="opacity:0.5">
                    </div>
                    <button class="btn-primary" onclick="saveOrgIdentity()">Save Changes</button>
                </div>
            </div>
            
            <div class="card" style="margin-top:20px;">
                <div class="card-header"><div class="card-title">Audit Trail (Recent Sensitive Actions)</div></div>
                <div id="audit-list">Loading logs...</div>
            </div>
        `;

            loadAuditLogs();
        }

        async function loadAuditLogs() {
            // FIX 1: Safety Check - Ensure element exists before loading
            const listContainer = document.getElementById('audit-list');
            if (!listContainer) return;

            const { data: logs } = await supabaseClient.from('audit_logs').select('actor_id, action_type, target_record, created_at').eq('org_id', state.org.id).order('created_at', { ascending: false }).limit(10);
            let html = `<table style="font-size:0.9rem;"><thead><tr><th>Actor</th><th>Action</th><th>Target</th><th>Time</th></tr></thead><tbody>`;
            if (logs && logs.length > 0) {
                const actorIds = logs.map(l => l.actor_id);
                const { data: actors } = await supabaseClient.from('profiles').select('user_id, full_name').in('user_id', actorIds);
                const actorMap = {};
                if (actors) actors.forEach(a => actorMap[a.user_id] = a.full_name);
                logs.forEach(l => {
                    const name = actorMap[l.actor_id] || 'System';
                    html += `<tr><td>${name}</td><td>${l.action_type}</td><td>${l.target_record || '-'}</td><td>${new Date(l.created_at).toLocaleString()}</td></tr>`;
                });
            } else { html += `<tr><td colspan="4" style="text-align:center">No logs found</td></tr>`; }
            html += `</tbody></table>`;

            // FIX 1: Use variable, don't query DOM again
            listContainer.innerHTML = html;
        }

        // --- SAVE FUNCTIONS (CEO ONLY) ---
        window.saveOrgIdentity = async function () {
            const newName = document.getElementById('set-org-name').value;
            const { error } = await supabaseClient.from('organizations').update({ name: newName }).eq('id', state.org.id);
            if (error) return showToast("Update Failed: " + error.message, true);
            await logSystemAction('UPDATE_ORG_IDENTITY', state.org.id, { old: state.org.name, new: newName });
            state.org.name = newName;
            showToast("Organization Updated");
            loadAuditLogs();
        }

        window.saveSecuritySettings = async function () {
            const settings = {
                security_settings: {
                    mfa_enforced: document.getElementById('set-mfa').checked,
                    session_timeout: parseInt(document.getElementById('set-timeout').value)
                },
                retention_policy: {
                    cv_months: parseInt(document.getElementById('set-ret-cv').value),
                    logs_months: parseInt(document.getElementById('set-ret-logs').value)
                }
            };
            const { error } = await supabaseClient.from('organizations').update(settings).eq('id', state.org.id);
            if (error) return showToast("Security Update Failed", true);
            await logSystemAction('UPDATE_SECURITY_POLICY', state.org.id, settings);
            showToast("Compliance Rules Saved");
            loadAuditLogs();
        }

        // --- MAIN ROUTER ---
        function renderMainContent() {
            const view = state.activeView; const main = document.getElementById('main-view'); if (!main) return; main.innerHTML = '';
            if (view === 'dashboard') loadDashboardView(main);
            else if (view === 'employee_dash') renderEmployeeDashboard(main); // NEW EMPLOYEE DASH
            else if (view === 'org_profile') renderOrgProfile(main);
            else if (view === 'employees') { if (['ceo', 'hr_manager', 'manager'].includes(state.profile.role)) loadEmployeesView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
            else if (view === 'payroll') { if (['ceo', 'hr_manager'].includes(state.profile.role)) renderPayrollUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
            else if (view === 'wfm') { if (['ceo', 'admin', 'manager', 'hr_manager'].includes(state.profile.role)) renderWFMUI(main); else renderEmployeeWFM(main); }
            else if (view === 'reports') { if (['ceo', 'admin'].includes(state.profile.role)) renderReportsUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
            else if (view === 'ats') { if (['ceo', 'admin', 'hr_manager'].includes(state.profile.role)) loadATSView(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
            else if (view === 'performance') { if (['ceo', 'admin', 'hr_manager', 'manager'].includes(state.profile.role)) renderPerformanceUI(main); else main.innerHTML = `<div class="card">Access Denied</div>`; }
            else if (view === 'attendance') { renderAttendanceUI(main); }
            else main.innerHTML = `<div class="card"><h2>${view.toUpperCase()}</h2><p>Module active for ${state.profile.role}</p></div>`;
        }

        function navigateTo(view) {
            state.activeView = view;
            renderSidebar();
            renderMainContent();
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.remove('active');
            }
        }

        // --- RBAC HIERARCHY SIDEBAR ---
        // --- RBAC HIERARCHY SIDEBAR ---
        function renderSidebar() {
            const t = i18n[state.lang]; const role = state.profile.role;
            const container = document.getElementById('nav-container'); if (!container) return; container.innerHTML = '';

            // 0. EMPLOYEE VIEW
            if (role === 'employee') {
                const ul = document.createElement('ul'); ul.className = 'nav-links';
                ul.innerHTML += `<li class="nav-item ${state.activeView === 'employee_dash' ? 'active' : ''}" onclick="navigateTo('employee_dash')"><i class="fa-solid fa-house"></i> <span>${t.nav_my_home}</span></li>`;
                ul.innerHTML += `<li class="nav-item ${state.activeView === 'attendance' ? 'active' : ''}" onclick="navigateTo('attendance')"><i class="fa-solid fa-clock"></i> <span>${t.nav_time_clock}</span></li>`;
                container.appendChild(ul);
                return;
            }

            // 1. EXECUTIVE SUITE (CEO + ADMIN + HR MANAGER)
            if (['ceo', 'admin', 'hr_manager'].includes(role)) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="nav-header">${t.nav_exec_suite}</div>`;
                const ul = document.createElement('ul'); ul.className = 'nav-links';
                ul.innerHTML += `<li class="nav-item ${state.activeView === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')"><i class="fa-solid fa-gauge-high"></i> <span>${t.dashboard}</span></li>`;

                // CEO Only: Org Settings
                if (role === 'ceo') {
                    ul.innerHTML += `<li class="nav-item ${state.activeView === 'org_profile' ? 'active' : ''}" onclick="navigateTo('org_profile')"><i class="fa-solid fa-building"></i> <span>${t.org_profile}</span></li>`;
                }
                // Reports
                if (['ceo', 'admin'].includes(role)) {
                    ul.innerHTML += `<li class="nav-item ${state.activeView === 'reports' ? 'active' : ''}" onclick="navigateTo('reports')"><i class="fa-solid fa-file-lines"></i> <span>${t.reports}</span></li>`;
                }
                sec.appendChild(ul); container.appendChild(sec);
            }

            // 2. HR OPERATIONS (CEO + HR MANAGER)
            if (['ceo', 'admin', 'hr_manager'].includes(role)) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="nav-header">${t.nav_hr_ops}</div>`;
                const ul = document.createElement('ul'); ul.className = 'nav-links';

                ul.innerHTML += `<li class="nav-item ${state.activeView === 'employees' ? 'active' : ''}" onclick="navigateTo('employees')"><i class="fa-solid fa-users"></i> <span>${t.employees}</span></li>`;

                // Payroll
                if (['ceo', 'hr_manager'].includes(role)) {
                    ul.innerHTML += `<li class="nav-item ${state.activeView === 'payroll' ? 'active' : ''}" onclick="navigateTo('payroll')"><i class="fa-solid fa-money-bill-wave"></i> <span>${t.payroll}</span></li>`;
                }

                ul.innerHTML += `<li class="nav-item ${state.activeView === 'ats' ? 'active' : ''}" onclick="navigateTo('ats')"><i class="fa-solid fa-briefcase"></i> <span>${t.ats}</span></li>`;

                sec.appendChild(ul); container.appendChild(sec);
            }

            // 3. TEAM MANAGEMENT (Managers + Admins)
            if (['ceo', 'admin', 'hr_manager', 'manager'].includes(role)) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="nav-header">${t.nav_team_mgmt}</div>`;
                const ul = document.createElement('ul'); ul.className = 'nav-links';

                ul.innerHTML += `<li class="nav-item ${state.activeView === 'wfm' ? 'active' : ''}" onclick="navigateTo('wfm')"><i class="fa-solid fa-chart-line"></i> <span>${t.wfm}</span></li>`;

                // ATS was removed from here to prevent duplication

                ul.innerHTML += `<li class="nav-item ${state.activeView === 'performance' ? 'active' : ''}" onclick="navigateTo('performance')"><i class="fa-solid fa-star"></i> <span>${t.performance}</span></li>`;

                sec.appendChild(ul); container.appendChild(sec);
            }

            // 4. WORKSPACE (Everyone)
            const sec = document.createElement('div');
            sec.innerHTML = `<div class="nav-header">${t.nav_workspace}</div>`;
            const ul = document.createElement('ul'); ul.className = 'nav-links';
            ul.innerHTML += `<li class="nav-item ${state.activeView === 'attendance' ? 'active' : ''}" onclick="navigateTo('attendance')"><i class="fa-solid fa-clock"></i> <span>${t.attendance}</span></li>`;
            sec.appendChild(ul); container.appendChild(sec);
        }


        function exportDashboardPDF() {
            const element = document.getElementById('dash-content');
            const opt = { margin: 10, filename: `Dashboard_Snapshot_${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, backgroundColor: '#0f2027' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
            html2pdf().set(opt).from(element).save();
        }

        // --- ADD THIS FUNCTION TO FIX REPORTS EXPORT ---
        window.exportReportsSummary = async function () {
            const { data: reports, error } = await supabaseClient.from('view_live_reports').select('*').eq('org_id', state.org.id);
            if (error || !reports) return showToast("No data found to export", true);

            let csvContent = "data:text/csv;charset=utf-8,Employee,Role,Productivity Score,Total Cost,ROI Status\n";

            reports.forEach(r => {
                const row = `${r.full_name},${r.role},${r.productivity_score},${r.total_cost},Healthy`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Strategy_Report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- ADD THIS FUNCTION TO FIX ATTENDANCE EXPORT ---
        // --- UPDATED FIX FOR ATTENDANCE EXPORT (Safe Mode) ---
        window.handleExportAttendance = async function () {
            showToast("Generating CSV...");

            // Step 1: Fetch the raw logs WITHOUT trying to join tables
            const { data: logs, error } = await supabaseClient
                .from('wfm_activity')
                .select('*')
                .eq('org_id', state.org.id)
                .order('clock_in_time', { ascending: false });

            if (error || !logs) {
                console.error("Export Error:", error);
                return showToast("Export Failed: " + (error?.message || "Unknown"), true);
            }

            // Step 2: Fetch the user names manually (prevents 400 Error)
            const userIds = [...new Set(logs.map(l => l.user_id))]; // Get unique User IDs
            const { data: profiles } = await supabaseClient
                .from('profiles')
                .select('user_id, full_name')
                .in('user_id', userIds);

            // Create a fast lookup map: ID -> Name
            const profileMap = {};
            if (profiles) {
                profiles.forEach(p => profileMap[p.user_id] = p.full_name);
            }

            // Step 3: Build the CSV using the map
            let csv = "data:text/csv;charset=utf-8,Employee,Date,Time In,Time Out,Status,Source\n";

            logs.forEach(l => {
                const name = profileMap[l.user_id] || 'Unknown User';
                const date = new Date(l.clock_in_time).toLocaleDateString();
                const timeIn = new Date(l.clock_in_time).toLocaleTimeString();
                const timeOut = l.clock_out_time ? new Date(l.clock_out_time).toLocaleTimeString() : 'Active';

                // Clean comma from names to avoid breaking CSV format
                const cleanName = name.replace(/,/g, " ");

                csv += `${cleanName},${date},${timeIn},${timeOut},${l.current_status},${l.record_source}\n`;
            });

            const encodedUri = encodeURI(csv);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Attendance_Log_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- OTHER HELPERS ---
        async function loadBatchData(batchId, element) { document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active')); if (element) element.classList.add('active'); const content = document.getElementById('payroll-content'); content.innerHTML = `<div style="padding:50px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading Data...</div>`; const { data, error } = await supabaseClient.from('payroll_items').select('*').eq('batch_id', batchId).order('employee_name', { ascending: true }); if (error) { content.innerHTML = `<div style="padding:20px; color:var(--danger)">Error loading data</div>`; return; } renderPayrollTable(data, false); if (window.innerWidth <= 768) { setTimeout(() => content.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50); } }
        async function handlePayrollUpload(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('payroll-content').classList.add('hidden');
            document.getElementById('payroll-loading').classList.remove('hidden');

            try {
                const fileName = `${Date.now()}_${file.name}`;

                // Upload File
                const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file);
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName);

                // FIX: Simplified Insert to avoid 'app_role' type mismatch from trigger
                // The RLS check (auth.uid) will happen automatically. We don't need complex selects here.
                const { data: batchData, error: batchError } = await supabaseClient
                    .from('payroll_batches')
                    .insert({
                        org_id: state.org.id,
                        uploaded_by: state.user.id,
                        file_url: publicUrl,
                        status: 'processing'
                    })
                    .select()
                    .single();

                if (batchError) {
                    // Specific handling for RLS type errors
                    if (batchError.code === '42804') {
                        throw new Error("Database Type Mismatch. Please ask admin to check 'get_my_profile_safe' return type.");
                    }
                    throw batchError;
                }

                // Call AI
                const n8nResponse = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, // UPDATED: Sends Bundle Tier so N8N knows whether to apply Advanced Automation
                    body: JSON.stringify({
                        file_url: publicUrl,
                        org_id: state.org.id,
                        batch_id: batchData.id,
                        bundle_tier: state.org.subscription_tier || 'free' // <--- ADDED THIS
                    })
                });
                if (!n8nResponse.ok) throw new Error("AI Analysis Failed");
                const aiPayload = await n8nResponse.json();
                const rows = normalizePayrollRows(aiPayload);
                const normalizedRows = rows.map(normalizePayrollRow);

                const itemsToInsert = normalizedRows.map(item => {
                    const salary = Number(item.salary) || 0;
                    const bonus = Number(item.bonus) || 0;
                    const deductions = Number(item.deductions) || 0;
                    return {
                        batch_id: batchData.id,
                        employee_name: item.employee_name || 'Unknown',
                        salary: salary,
                        bonus: bonus,
                        deductions: deductions,
                        net_pay: salary + bonus - deductions
                    };
                });

                if (itemsToInsert.length > 0) {
                    const { data: savedItems, error: itemsError } = await supabaseClient.from('payroll_items').insert(itemsToInsert).select();
                    if (itemsError) throw itemsError;
                    renderPayrollUI(document.getElementById('main-view'));
                } else {
                    showToast("AI found no valid data", true);
                    renderPayrollUI(document.getElementById('main-view'));
                }
            } catch (err) {
                console.error(err);
                showToast(err.message, true);
                renderPayrollUI(document.getElementById('main-view'));
            }
        }




        async function updatePayrollItem(id, field, newValue, oldValue) { if (newValue === oldValue) return; try { await supabaseClient.from('payroll_items').update({ [field]: newValue }).eq('id', id); await supabaseClient.from('payroll_history').insert({ item_id: id, changed_by: state.user.id, field_changed: field, old_value: oldValue, new_value: newValue }); showToast("Updated"); } catch (err) { showToast("Update Failed", true); } }
        function changePerfCycle(cycle) { state.perfCycle = cycle; renderPerformanceUI(document.getElementById('main-view')); }
        function openPerformanceModal() { document.getElementById('perf-modal').classList.remove('hidden'); }
        function setPerfInput(mode) { state.perfInputMode = mode; const btnFile = document.getElementById('btn-file-mode'); const btnManual = document.getElementById('btn-manual-mode'); const boxFile = document.getElementById('perf-input-file'); const boxManual = document.getElementById('perf-input-manual'); if (mode === 'file') { btnFile.style.borderColor = 'var(--primary)'; btnManual.style.borderColor = 'var(--glass-border)'; boxFile.classList.remove('hidden'); boxManual.classList.add('hidden'); } else { btnManual.style.borderColor = 'var(--primary)'; btnFile.style.borderColor = 'var(--glass-border)'; boxManual.classList.remove('hidden'); boxFile.classList.add('hidden'); } }
        async function handlePerformanceSubmit() { const btn = document.querySelector('#perf-modal .btn-primary'); const oldText = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...'; try { const dept = document.getElementById('perf-dept').value; let payloadData = ""; if (state.perfInputMode === 'file') { const fileInput = document.getElementById('perf-file'); if (!fileInput.files.length) throw new Error("Please select a file."); const file = fileInput.files[0]; const fileName = `perf_${Date.now()}_${file.name}`; const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file); if (uploadError) throw uploadError; const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName); payloadData = publicUrl; } else { payloadData = document.getElementById('perf-text').value; if (!payloadData) throw new Error("Please enter text logs."); } const response = await fetch(N8N_PERF_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "analyze_performance", org_id: state.org.id, department: dept, review_period: state.perfCycle, input_type: state.perfInputMode, data_content: payloadData }) }); if (!response.ok) throw new Error("AI Analysis Failed"); let aiResponse = await response.json(); if (Array.isArray(aiResponse) && aiResponse.length > 0) aiResponse = aiResponse[0]; if (typeof aiResponse === 'string') try { aiResponse = JSON.parse(aiResponse); } catch (e) { } const results = aiResponse.results || []; if (results.length === 0) throw new Error("AI returned no results."); let successCount = 0; for (const res of results) { const { data: userProfile } = await supabaseClient.from('profiles').select('user_id').eq('email', res.email).maybeSingle(); if (userProfile) { await supabaseClient.from('performance_reviews').insert({ org_id: state.org.id, user_id: userProfile.user_id, review_period: state.perfCycle, period_start: new Date(), period_end: new Date(), score_quality: res.score_quality || 0, score_speed: res.score_speed || 0, score_teamwork: res.score_teamwork || 0, score_efficiency: res.score_efficiency || 0, score_final: res.score_final || 0, ai_feedback: res.ai_feedback || "No feedback.", raw_data_source: state.perfInputMode }); successCount++; } } showToast(`Success! Saved ${successCount} reviews.`); document.getElementById('perf-modal').classList.add('hidden'); renderPerformanceUI(document.getElementById('main-view')); } catch (err) { console.error(err); showToast(err.message, true); } finally { btn.innerHTML = oldText; } }
        async function promoteCandidateToEmployee(candidateId) {
            return requireFeature('ats', async () => {
                const { data: candidate, error } = await supabaseClient
                    .from('ats_applications')
                    .select('*, ats_jobs(title, department)')
                    .eq('id', candidateId)
                    .single();
                if (error) {
                    showToast("Error fetching details", true);
                    return;
                }
                openOnboardModal();
                document.getElementById('new-name').value = candidate.full_name;
                document.getElementById('new-email').value = candidate.email;
                document.getElementById('new-meta-phone').value = candidate.phone || '';
                document.getElementById('new-meta-dept').value = candidate.ats_jobs?.department || '';
                showToast("Candidate data pre-filled. Please set a password.");
            });
        }
        function openOnboardModal() { const sel = document.getElementById('new-role'); sel.innerHTML = '';['hr_manager', 'manager', 'employee'].forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`); document.getElementById('onboard-modal').classList.remove('hidden'); }
        function closeOnboardModal() { document.getElementById('onboard-modal').classList.add('hidden'); }
        // --- UPDATED ONBOARDING LOGIC ---
        // --- 1. NEW HELPER: Adds a row to the document list inside the modal ---
        function addObjDocRow() {
            const container = document.getElementById('onboard-docs-list');
            const id = Date.now(); // Unique ID for UI handling
            const html = `
        <div id="doc-row-${id}" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid var(--glass-border);">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:0.8rem; font-weight:bold; color:var(--text-muted);">New Document</span>
                <i class="fa-solid fa-trash" style="color:var(--danger); cursor:pointer;" onclick="document.getElementById('doc-row-${id}').remove()"></i>
            </div>
            <input type="text" class="form-input doc-title" placeholder="Type (e.g. Passport)" style="margin-bottom:5px;">
            <input type="date" class="form-input doc-date" style="margin-bottom:5px;">
            <input type="text" class="form-input doc-link" placeholder="Paste File URL / Drive Link">
        </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // --- 2. UPDATED MAIN FUNCTION: Validates inputs & Saves Data ---
        async function executeOnboard() {
            const btn = document.querySelector('#onboard-modal .btn-primary');
            const oldText = btn.innerText;

            // A. GET VALUES
            const fullName = document.getElementById('new-name').value;
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-pass').value;
            const role = document.getElementById('new-role').value;
            const phone = document.getElementById('new-meta-phone').value;
            const dept = document.getElementById('new-meta-dept').value;

            // B. VALIDATION (Phone is now required)
            if (!fullName || !email || !password || !phone) {
                return showToast("Error: Name, Email, Password, and Phone are REQUIRED.", true);
            }

            btn.innerText = "Creating Profile...";

            try {
                // 1. Create Auth User
                const dummyStorage = { getItem: () => null, setItem: () => { }, removeItem: () => { } };
                const tempClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: { persistSession: false, storage: dummyStorage, autoRefreshToken: false, detectSessionInUrl: false }
                });

                const { data: authData, error: authError } = await tempClient.auth.signUp({
                    email: email, password: password, options: { data: { full_name: fullName } }
                });

                if (authError) throw authError;
                if (!authData.user) throw new Error("Auth Creation Failed");

                // 2. Create Profile (RPC)
                const metaData = { phone: phone, department: dept };
                const { error: profileError } = await supabaseClient.rpc('admin_create_profile', {
                    target_user_id: authData.user.id, user_email: email, full_name: fullName,
                    user_role: role, target_org_id: state.org.id, user_meta: metaData,
                    avatar_url: `https://ui-avatars.com/api/?name=${fullName}&background=random`
                });

                if (profileError) throw profileError;

                // 3. CRITICAL FIX: Fetch the new Profile ID to use for Documents
                const { data: newProfile, error: fetchError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('user_id', authData.user.id)
                    .single();

                if (fetchError || !newProfile) throw new Error("Could not retrieve new profile ID");

                // 4. Save Documents (Using the correct Profile ID)
                const docRows = document.querySelectorAll('#onboard-docs-list > div');
                if (docRows.length > 0) {
                    btn.innerText = "Saving Docs...";
                    const docsToInsert = [];

                    docRows.forEach(row => {
                        const title = row.querySelector('.doc-title').value;
                        const date = row.querySelector('.doc-date').value;
                        const link = row.querySelector('.doc-link').value;

                        if (title && date) {
                            docsToInsert.push({
                                org_id: state.org.id,
                                profile_id: newProfile.id, // <--- USING CORRECT ID HERE
                                document_type: title,
                                expiry_date: date,
                                external_link: link || null,
                                is_checklist_only: false
                            });
                        }
                    });

                    if (docsToInsert.length > 0) {
                        const { error: docError } = await supabaseClient.from('employee_documents').insert(docsToInsert);
                        if (docError) {
                            console.error("Doc Error:", docError);
                            showToast("User created, but docs failed: " + docError.message, true);
                        }
                    }
                }

                showToast(`Success! ${fullName} onboarded.`);
                closeOnboardModal();
                if (state.activeView === 'employees') loadEmployeesView(document.getElementById('main-view'));

            } catch (err) {
                console.error(err);
                showToast(err.message, true);
            } finally {
                btn.innerText = oldText;
            }
        }
        async function renderEmployeeWFM(container) { container.innerHTML = `<div class="page-title">My Schedule</div><div class="card" style="text-align:center; padding:50px;"><h2>09:00 AM - 05:00 PM</h2><p style="color:var(--text-muted); margin-bottom:20px;">Today's Shift</p><button class="btn-primary" onclick="showToast('Use Attendance Tab to Clock In')">Go to Attendance</button></div>`; }
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) { var R = 6371; var dLat = deg2rad(lat2 - lat1); var dLon = deg2rad(lon2 - lon1); var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); var d = R * c; return d * 1000; }
        function deg2rad(deg) { return deg * (Math.PI / 180); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function showToast(msg, isError = false) { const t = document.getElementById('toast'); if (!t) return; document.getElementById('toast-msg').innerText = msg; t.style.background = isError ? 'rgba(231, 76, 60, 0.9)' : 'rgba(46, 204, 113, 0.9)'; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleLang() {
            state.lang = state.lang === 'en' ? 'ar' : 'en';
            const t = i18n[state.lang];

            // 1. Update HTML tag for RTL/LTR
            document.documentElement.setAttribute('lang', state.lang);
            document.documentElement.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');

            // 2. Update the button text itself
            document.getElementById('lang-btn').innerText = t.lang_btn;

            // 3. Re-render the UI to apply translations
            renderSidebar();
            renderMainContent();
            applyStaticTranslations();
            updatePricingDisplay();
            updateMeetingBookingVisibility();
            const aiWindow = document.getElementById('ai-window');
            if (aiWindow && !aiWindow.classList.contains('hidden')) {
                updateAiCredits();
            }
            const roleDisplay = document.getElementById('role-display');
            if (roleDisplay && state.profile?.role) {
                roleDisplay.innerText = formatRoleLabel(state.profile.role);
            }

            // 4. Update other static parts of the UI
            // Example: Update the profile modal title and labels
            // document.querySelector('#profile-modal .modal-title').firstChild.textContent = t.myProfile + ' ';
            // ... update other elements by ID ...
        }    // --- 5. NEW HELPER FUNCTIONS (Paste at bottom of script) ---

        // DOCS LOGIC
        let activeDocUserId = null;

        window.openDocsModal = async function (userId, name) {
            activeDocUserId = userId;
            document.getElementById('docs-user-name').innerText = name;
            document.getElementById('docs-modal').classList.remove('hidden');
            loadDocsList(userId);
        }

        async function loadDocsList(userId) {
            const list = document.getElementById('docs-list');
            list.innerHTML = '<div style="text-align:center"><i class="fa-solid fa-spinner fa-spin"></i></div>';

            const { data: docs } = await supabaseClient.from('employee_documents').select('*').eq('profile_id', userId);

            if (!docs || docs.length === 0) {
                list.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">No documents tracked.</div>';
                return;
            }

            let html = '';
            docs.forEach(d => {
                const isExpired = d.expiry_date ? new Date(d.expiry_date) < new Date() : false;
                const style = isExpired ? 'color:var(--danger); font-weight:bold;' : 'color:var(--success)';
                const linkHtml = d.external_link ? `<a href="${d.external_link}" target="_blank" style="color:var(--primary)"><i class="fa-solid fa-link"></i></a>` : '';

                html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--glass-border); align-items:center;">
                <span>${d.document_type}</span>
                <span style="${style}">${d.expiry_date || 'No Expiry'}</span>
                ${linkHtml}
            </div>`;
            });
            list.innerHTML = html;
        }

        window.saveEmployeeDoc = async function () {
            const type = document.getElementById('doc-type').value;
            const expiry = document.getElementById('doc-expiry').value;
            const link = document.getElementById('doc-link').value;
            const isChecklist = document.getElementById('doc-checklist').checked;

            if (!type) return showToast("Type is required", true);

            const { error } = await supabaseClient.from('employee_documents').insert({
                org_id: state.org.id,
                profile_id: activeDocUserId, // Uses the global variable set on open
                document_type: type,
                expiry_date: expiry || null,
                external_link: link || null,
                is_checklist_only: isChecklist
            });

            if (error) showToast("Error: " + error.message, true);
            else {
                showToast("Document Saved");
                loadDocsList(activeDocUserId); // Refresh list
                // Clear inputs
                document.getElementById('doc-type').value = '';
                document.getElementById('doc-link').value = '';
            }
        }

        // BROADCAST LOGIC
        window.sendBroadcast = async function () {
            const subject = document.getElementById('bc-subject').value;
            const msg = document.getElementById('bc-msg').value;
            const severity = document.getElementById('bc-severity').value;

            if (!msg) return showToast("Message required", true);

            const { error } = await supabaseClient.from('broadcast_messages').insert({
                org_id: state.org.id,
                sender_id: state.user.id,
                subject: subject,
                content: msg,
                severity: severity,
                target_roles: ['all']
            });

            if (error) showToast("Failed: " + error.message, true);
            else {
                showToast("Announcement Sent");
                document.getElementById('broadcast-modal').classList.add('hidden');
                loadDashboardView(document.getElementById('main-view')); // Refresh dash
            }
        }
        // --- AI ASSISTANT LOGIC ---
        function toggleAiWidget() {
            const widget = document.getElementById('ai-widget');
            const win = document.getElementById('ai-window');
            const isHidden = win.classList.toggle('hidden');
            widget.classList.toggle('ai-open', !isHidden);
            if (!isHidden) {
                updateAiCredits();
                setTimeout(() => {
                    const input = document.getElementById('ai-input');
                    if (input) input.focus();
                }, 50);
            }
        }

        function formatAiText(value) {
            return escapeHtml(String(value || '')).replace(/\n/g, '<br>');
        }

        function appendAiMessage(content, role, allowHtml = false) {
            const body = document.getElementById('ai-chat-body');
            if (!body) return null;
            const wrapper = document.createElement('div');
            wrapper.className = `ai-msg ${role}`;
            const bubble = document.createElement('div');
            bubble.className = 'ai-bubble';
            bubble.innerHTML = allowHtml ? content : formatAiText(content);
            wrapper.appendChild(bubble);
            body.appendChild(wrapper);
            body.scrollTop = body.scrollHeight;
            return bubble;
        }

        function prefillAiPrompt(text) {
            const input = document.getElementById('ai-input');
            if (!input) return;
            input.value = text;
            input.focus();
        }

        async function updateAiCredits() {
            if (!state.org) return;
            const { data, error } = await supabaseClient.from('organizations').select('ai_credits_balance').eq('id', state.org.id).single();
            if (error) return;
            const credits = Number(data?.ai_credits_balance || 0);
            state.aiCredits = credits;
            const creditsEl = document.getElementById('ai-credits');
            if (creditsEl) creditsEl.innerText = tf('ai_credits', { count: credits }, `${credits} Credits`);
        }

        async function debitAiCredits(cost) {
            if (!state.org || !Number.isFinite(cost)) return true;
            let current = Number.isFinite(state.aiCredits) ? state.aiCredits : null;
            if (current === null) {
                const { data, error } = await supabaseClient.from('organizations').select('ai_credits_balance').eq('id', state.org.id).single();
                if (error) return false;
                current = Number(data?.ai_credits_balance || 0);
            }
            if (current < cost) return false;
            const next = Math.max(0, current - cost);
            const { error: updateError } = await supabaseClient.from('organizations').update({ ai_credits_balance: next }).eq('id', state.org.id);
            if (updateError) return false;
            state.aiCredits = next;
            const creditsEl = document.getElementById('ai-credits');
            if (creditsEl) creditsEl.innerText = tf('ai_credits', { count: next }, `${next} Credits`);
            return true;
        }

        function extractJsonPayload(raw) {
            if (!raw) return null;
            if (typeof raw === 'object') return raw;
            const text = String(raw).trim();
            if (!text) return null;
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');
            if (firstBrace === -1 || lastBrace === -1) return null;
            const candidate = text.slice(firstBrace, lastBrace + 1);
            try { return JSON.parse(candidate); } catch (e) { return null; }
        }

        function unwrapActionPayload(payload) {
            if (!payload || typeof payload !== 'object') return payload;
            if (payload.action) return payload;
            if (payload.response && typeof payload.response === 'object') return payload.response;
            if (payload.data && typeof payload.data === 'object') return payload.data;
            return payload;
        }

        function normalizeAssistantResponse(raw) {
            if (raw === null || raw === undefined) return { text: '' };
            if (typeof raw === 'string') return { text: raw };
            if (raw.reply || raw.message || raw.text) {
                return { text: raw.reply || raw.message || raw.text, action: raw.action, auto_create: raw.auto_create, employee: raw.employee, view: raw.view };
            }
            if (raw.output) return { text: typeof raw.output === 'string' ? raw.output : JSON.stringify(raw.output) };
            return { text: JSON.stringify(raw) };
        }

        function normalizeEmployeeRole(role) {
            const clean = String(role || '').toLowerCase().trim();
            if (clean === 'consultant') return 'consultant';
            if (clean === 'hr manager' || clean === 'hr' || clean === 'hr_manager') return 'hr_manager';
            if (clean === 'manager') return 'manager';
            if (clean === 'employee') return 'employee';
            return 'employee';
        }

        function generateTempPassword() {
            const rand = Math.floor(1000 + Math.random() * 9000);
            return `Welcome${rand}!`;
        }

        function canRunAiActions() {
            const tier = normalizeTier(state.org?.subscription_tier || 'free');
            const role = state.profile?.role || '';
            const eligibleTier = ['starter', 'growth', 'custom'].includes(tier);
            const eligibleRole = ['ceo', 'consultant', 'hr_manager', 'manager'].includes(role);
            if (!eligibleRole) {
                return { ok: false, reason: t('ai_action_role_block'), openPricing: false };
            }
            if (!eligibleTier) {
                return { ok: false, reason: t('ai_action_upgrade_body'), openPricing: true };
            }
            return { ok: true };
        }

        function formatRoleLabel(role) {
            const map = {
                ceo: t('role_ceo'),
                consultant: 'Consultant',
                hr_manager: t('role_hr_manager'),
                manager: t('role_manager'),
                employee: t('role_employee')
            };
            return map[role] || String(role || '').replace('_', ' ');
        }

        function formatEmployeeSummary(payload, tempPassword) {
            const lines = [
                t('ai_action_created'),
                `${t('ai_action_field_name')}: ${payload.full_name}`,
                `${t('ai_action_field_email')}: ${payload.email}`,
                `${t('ai_action_field_role')}: ${formatRoleLabel(payload.role)}`
            ];
            if (payload.department) lines.push(`${t('ai_action_field_department')}: ${payload.department}`);
            if (payload.phone) lines.push(`${t('ai_action_field_phone')}: ${payload.phone}`);
            if (tempPassword) lines.push(`${t('ai_action_temp_password')}: ${tempPassword}`);
            lines.push(t('ai_action_next_steps'));
            return lines.join('\n');
        }

        const AI_NAV_VIEWS = new Set([
            'dashboard',
            'org_profile',
            'employees',
            'payroll',
            'attendance',
            'ats',
            'performance',
            'reports',
            'wfm',
            'employee_dash'
        ]);

        async function createEmployeeFromChat(employee = {}) {
            if (!state.org || !state.user) return { ok: false, error: 'Not authenticated.' };
            const payload = {
                full_name: String(employee.full_name || '').trim(),
                email: String(employee.email || '').trim(),
                role: normalizeEmployeeRole(employee.role),
                phone: String(employee.phone || '').trim(),
                department: String(employee.department || '').trim(),
                temp_password: String(employee.temp_password || '').trim()
            };
            const missing = [];
            if (!payload.full_name) missing.push('full_name');
            if (!payload.email) missing.push('email');
            if (!payload.phone) missing.push('phone');
            if (!payload.role) missing.push('role');
            if (missing.length) return { ok: false, error: `Missing fields: ${missing.join(', ')}` };

            const tempPassword = payload.temp_password || generateTempPassword();
            const dummyStorage = { getItem: () => null, setItem: () => { }, removeItem: () => { } };
            const tempClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: { persistSession: false, storage: dummyStorage, autoRefreshToken: false, detectSessionInUrl: false }
            });

            const { data: authData, error: authError } = await tempClient.auth.signUp({
                email: payload.email,
                password: tempPassword,
                options: { data: { full_name: payload.full_name } }
            });

            if (authError) return { ok: false, error: authError.message };
            if (!authData?.user) return { ok: false, error: 'Auth creation failed.' };

            const metaData = { phone: payload.phone, department: payload.department };
            const { error: profileError } = await supabaseClient.rpc('admin_create_profile', {
                target_user_id: authData.user.id,
                user_email: payload.email,
                full_name: payload.full_name,
                user_role: payload.role,
                target_org_id: state.org.id,
                user_meta: metaData,
                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(payload.full_name)}&background=random`
            });

            if (profileError) return { ok: false, error: profileError.message };
            showToast(`Employee created: ${payload.full_name}`);
            if (state.activeView === 'employees') loadEmployeesView(document.getElementById('main-view'));
            return { ok: true, tempPassword };
        }

        async function sendAiMessage() {
            const input = document.getElementById('ai-input');
            const text = (input.value || '').trim();
            if (!text) return;

            appendAiMessage(text, 'user');
            input.value = '';
            if (!state.user || !state.org) {
                appendAiMessage(t('ai_login_required'), 'assistant');
                return;
            }

            const thinkingBubble = appendAiMessage(`<i class="fa-solid fa-circle-notch fa-spin"></i> ${escapeHtml(t('ai_thinking'))}`, 'assistant', true);
            if (state.aiCredits === null) await updateAiCredits();
            if (!Number.isFinite(state.aiCredits)) state.aiCredits = 0;
            if (state.aiCredits < AI_CREDIT_COST) {
                if (thinkingBubble) {
                    thinkingBubble.innerHTML = formatAiText(t('ai_no_credits'));
                }
                openPricingModal();
                return;
            }

            let replyText = '';
            let actionPayload = null;
            let didCallAi = false;

            try {
                if (!N8N_HR_ASSISTANT_URL) {
                    replyText = t('ai_fallback');
                } else {
                    const response = await fetch(N8N_HR_ASSISTANT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: text,
                            org_id: state.org?.id,
                            user_id: state.user?.id,
                            lang: state.lang,
                            system_prompt: HR_ASSISTANT_SYSTEM_PROMPT,
                            context: {
                                org_name: state.org?.name || '',
                                user_role: state.profile?.role || '',
                                plan: state.org?.subscription_tier || 'free'
                            }
                        })
                    });
                    if (!response.ok) throw new Error(`Assistant error: ${response.status}`);
                    didCallAi = true;
                    const raw = await response.text();
                    actionPayload = unwrapActionPayload(extractJsonPayload(raw));
                    if (actionPayload) {
                        const normalized = normalizeAssistantResponse(actionPayload);
                        replyText = normalized.text;
                        actionPayload = { ...actionPayload, ...normalized };
                    } else {
                        replyText = raw;
                    }
                }
            } catch (e) {
                console.error(e);
                replyText = t('ai_assistant_error');
            }

            if (actionPayload && actionPayload.action === 'navigate' && actionPayload.view) {
                if (AI_NAV_VIEWS.has(actionPayload.view)) {
                    navigateTo(actionPayload.view);
                    replyText = actionPayload.reply || t('ai_navigate_confirm');
                } else {
                    replyText = t('ai_navigate_invalid');
                }
            } else if (actionPayload && actionPayload.action === 'create_employee') {
                if (actionPayload.auto_create) {
                    const eligibility = canRunAiActions();
                    if (!eligibility.ok) {
                        replyText = eligibility.reason;
                        if (eligibility.openPricing) openPricingModal();
                    } else {
                        const result = await createEmployeeFromChat(actionPayload.employee || {});
                        if (result.ok) {
                            const summary = formatEmployeeSummary(
                                {
                                    ...actionPayload.employee,
                                    role: normalizeEmployeeRole(actionPayload.employee?.role)
                                },
                                result.tempPassword
                            );
                            replyText = actionPayload.reply ? `${actionPayload.reply}\n${summary}` : summary;
                        } else {
                            replyText = (actionPayload.reply || t('ai_action_missing')) + `\n${result.error}`;
                        }
                    }
                } else if (actionPayload.reply) {
                    replyText = actionPayload.reply;
                }
            }

            if (thinkingBubble) thinkingBubble.innerHTML = formatAiText(replyText || t('ai_try_again'));
            if (didCallAi) {
                const debited = await debitAiCredits(AI_CREDIT_COST);
                if (!debited) showToast(t('ai_credit_debit_failed'), true);
            }
        }
        // --- ATS CANDIDATE LOGIC ---
        function openCandidateModal() {
            return requireFeature('ats', () => {
                // Create modal HTML dynamically if it doesn't exist
                if (!document.getElementById('candidate-modal')) {
                    const modal = document.createElement('div');
                    modal.id = 'candidate-modal';
                    modal.className = 'modal-overlay hidden';
                    modal.innerHTML = `
                <div class="modal-card">
                    <div class="modal-title">Add Candidate <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('candidate-modal').classList.add('hidden')"></i></div>
                    <div class="form-group"><label>Full Name</label><input type="text" id="cand-name" class="form-input"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="cand-email" class="form-input"></div>
                    <div class="form-group"><label>Apply for Role (Job ID)</label><input type="text" id="cand-job" class="form-input" placeholder="Paste Job ID"></div>
                    <div class="form-group"><label>Upload CV (PDF)</label><input type="file" id="cand-cv" class="form-input"></div>
                    <button class="btn-primary" style="width:100%" onclick="saveCandidate()">Submit Application</button>
                </div>`;
                    document.body.appendChild(modal);
                }
                document.getElementById('candidate-modal').classList.remove('hidden');
            });
        }

        async function saveCandidate() {
            return requireFeature('ats', async () => {
                const name = document.getElementById('cand-name').value;
                const email = document.getElementById('cand-email').value;
                const jobId = document.getElementById('cand-job').value; // In a real app, this would be a dropdown
                const fileInput = document.getElementById('cand-cv');

                if (!name || !email) return showToast("Name and Email required", true);

                let cvUrl = null;
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `cvs/${Date.now()}_${file.name}`;
                    const { error: upErr } = await supabaseClient.storage.from('resumes').upload(fileName, file);
                    if (!upErr) {
                        const { data } = supabaseClient.storage.from('resumes').getPublicUrl(fileName);
                        cvUrl = data.publicUrl;
                    }
                }

                const payload = {
                    job_id: jobId || null,
                    full_name: name,
                    email: email,
                    resume_url: cvUrl,
                    status: 'Applied'
                };

                const orgColumn = await resolveAtsOrgColumn();
                if (!orgColumn && atsUseJobOrgFilter && !jobId) {
                    showToast("Please provide a Job ID so we can link this candidate to your organization.", true);
                    return;
                }
                if (orgColumn) payload[orgColumn] = state.org.id;

                const { error } = await supabaseClient.from('ats_applications').insert(payload);

                if (error) showToast("Error: " + error.message, true);
                else {
                    showToast("Candidate Added");
                    document.getElementById('candidate-modal').classList.add('hidden');
                    loadATSView(document.getElementById('main-view'));
                }
            });
        }

        // --- EMAIL INTEGRATION LOGIC ---
        function openEmailConnectModal() {
            return requireFeature('ats', () => {
                document.getElementById('email-connect-modal').classList.remove('hidden');
            });
        }

        function toggleImapFields() {
            const type = document.getElementById('imap-provider').value;
            const box = document.getElementById('custom-imap');
            const host = document.getElementById('imap-host');
            if (type === 'custom') { box.classList.remove('hidden'); host.value = ''; }
            else { box.classList.add('hidden'); host.value = type === 'gmail' ? 'imap.gmail.com' : 'outlook.office365.com'; }
        }

        async function refreshAtsIntegrationStatus() {
            const box = document.getElementById('ats-email-status');
            if (!box || !state.org) return;

            const { data, error } = await supabaseClient
                .from('org_integrations')
                .select('integration_type, status, config, last_sync_at, created_at')
                .eq('org_id', state.org.id)
                .eq('integration_type', 'imap_email')
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (error || !data) {
                box.innerHTML = 'No email connected yet.';
                return;
            }

            const cfg = data.config || {};
            const provider = cfg.provider || cfg.host || 'custom';
            const email = cfg.email || 'unknown';
            const status = data.status || 'active';
            const lastSeenAt = data.last_sync_at || data.created_at;
            const updatedAt = lastSeenAt ? new Date(lastSeenAt).toLocaleString() : '';

            box.innerHTML = `
        <div style="font-weight:600; color:var(--text-header)">${email}</div>
        <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">
            Provider: ${provider} • Status: ${status}${updatedAt ? ` • Updated: ${updatedAt}` : ''}
        </div>`;
        }

        async function saveEmailIntegration() {
            return requireFeature('ats', async () => {
                const email = document.getElementById('imap-email').value;
                const pass = document.getElementById('imap-pass').value;
                const host = document.getElementById('imap-host').value;
                const port = document.getElementById('imap-port').value || 993;
                const provider = document.getElementById('imap-provider').value;

                if (!email || !pass) return showToast("Email and Password required", true);

                const payload = {
                    org_id: state.org.id,
                    integration_type: 'imap_email',
                    provider,
                    email,
                    password: pass,
                    host,
                    port,
                    tls: true,
                    status: 'active'
                };

                try {
                    const res = await fetch(N8N_ATS_CONNECT_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error("Webhook rejected the request");
                    showToast("Connected! AI is now watching your inbox.");
                    document.getElementById('email-connect-modal').classList.add('hidden');
                    await refreshAtsIntegrationStatus();
                } catch (err) {
                    console.error("ATS Connect Error:", err);
                    showToast("Connect failed: " + err.message, true);
                }
            });
        }
        // OPEN CANDIDATE MODAL
        window.viewCandidateAI = async function (candidateId) {
            document.getElementById('candidate-modal').classList.remove('hidden');

            const { data: c } = await supabaseClient.from('ats_applications').select('*').eq('id', candidateId).single();

            if (c) {
                // Update Score
                document.getElementById('ai-score-circle').innerText = `${c.ai_score || 0}%`;
                document.getElementById('ai-score-circle').style.borderColor = c.ai_score > 70 ? 'var(--success)' : (c.ai_score > 40 ? 'var(--warning)' : 'var(--danger)');

                // Update Text
                document.getElementById('ai-summary-text').innerText = c.ai_summary || "AI is processing this candidate...";
                document.getElementById('ai-source-text').innerText = c.resume_text || "No text extracted yet.";

                // Update Skills (Assume comma separated or JSON)
                let skillsHtml = '';
                if (c.skills) { // Assuming you save skills as JSON array or text
                    const skills = Array.isArray(c.skills) ? c.skills : (c.skills || '').split(',');
                    skills.forEach(s => skillsHtml += `<span class="badge" style="position:static; background:var(--primary); margin:2px;">${s}</span>`);
                }
                document.getElementById('ai-skills-tags').innerHTML = skillsHtml;
            }
        }
        // --- PRICING MODAL LOGIC ---

        // Base prices: Starter = $5/mo, Growth = $10/mo
        const STARTER_DISPLAY_PRICES = {
            USD: { amount: 5.0, digits: 2 },
            AED: { amount: 18.36, digits: 2 },
            EGP: { amount: 236.42, digits: 2 },
            EUR: { amount: 4.29, digits: 2 },
            GBP: { amount: 3.72, digits: 2 },
            SAR: { amount: 18.75, digits: 2 }
        };
        const GROWTH_DISPLAY_PRICES = {
            USD: { amount: 10.0, digits: 2 },
            AED: { amount: 36.73, digits: 2 },
            EGP: { amount: 472.83, digits: 2 },
            EUR: { amount: 8.58, digits: 2 },
            GBP: { amount: 7.43, digits: 2 },
            SAR: { amount: 37.50, digits: 2 }
        };
        // 50% discount prices for first year
        const STARTER_DISCOUNT_PRICES = {
            USD: { amount: 2.5, digits: 2 },
            AED: { amount: 9.18, digits: 2 },
            EGP: { amount: 118.21, digits: 2 },
            EUR: { amount: 2.15, digits: 2 },
            GBP: { amount: 1.86, digits: 2 },
            SAR: { amount: 9.38, digits: 2 }
        };
        const GROWTH_DISCOUNT_PRICES = {
            USD: { amount: 5.0, digits: 2 },
            AED: { amount: 18.36, digits: 2 },
            EGP: { amount: 236.42, digits: 2 },
            EUR: { amount: 4.29, digits: 2 },
            GBP: { amount: 3.72, digits: 2 },
            SAR: { amount: 18.75, digits: 2 }
        };
        const DISCOUNT_INFO = { percentage: 50, durationMonths: 12 };
        const SUPPORTED_CURRENCIES = ['USD', 'EUR', 'GBP', 'EGP', 'AED', 'SAR'];
        const appStorage = (() => {
            try { return localStorage; } catch (e) { return { getItem: () => null, setItem: () => { }, removeItem: () => { } }; }
        })();

        function inferCurrency() {
            const lang = (navigator.language || '').toLowerCase();
            const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').toLowerCase();
            if (tz.includes('africa/cairo')) return 'EGP';
            if (lang.startsWith('ar') || tz.includes('asia/riyadh') || tz.includes('asia/kuwait') || tz.includes('asia/qatar') || tz.includes('asia/bahrain')) {
                return 'SAR';
            }
            if (tz.includes('asia/dubai')) return 'SAR';
            if (tz.startsWith('europe/') || lang.includes('-gb') || lang.includes('-ie')) {
                return lang.includes('-gb') ? 'GBP' : 'EUR';
            }
            if (lang.includes('en-gb')) return 'GBP';
            if (lang.includes('en-us') || tz.startsWith('america/')) return 'USD';
            return 'USD';
        }

        function getPricingCurrency() {
            const stored = appStorage.getItem('app_currency');
            if (stored && SUPPORTED_CURRENCIES.includes(stored)) return stored;
            const inferred = inferCurrency();
            appStorage.setItem('app_currency', inferred);
            return inferred;
        }

        function formatCurrencyAmount(amount, currency, digits = 2) {
            return new Intl.NumberFormat(undefined, {
                style: 'currency',
                currency,
                minimumFractionDigits: digits,
                maximumFractionDigits: digits
            }).format(amount);
        }

        function setPricingCurrency(currency) {
            const safeCurrency = SUPPORTED_CURRENCIES.includes(currency) ? currency : 'USD';
            appStorage.setItem('app_currency', safeCurrency);
            updatePricingDisplay(safeCurrency);
        }

        function updatePricingCtas() {
            const tier = normalizeTier(state.org?.subscription_tier || 'free');
            const ctas = {
                free: t('cta_free'),
                starter: t('cta_starter'),
                growth: t('cta_growth'),
                custom: t('cta_custom')
            };
            document.querySelectorAll('[data-cta-plan]').forEach((btn) => {
                const plan = btn.getAttribute('data-cta-plan');
                const isCurrent = plan === tier;
                const labelEl = btn.querySelector('[data-cta-label]') || btn;
                if (isCurrent) {
                    labelEl.textContent = t('current_plan');
                    btn.setAttribute('disabled', 'disabled');
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'default';
                    btn.onclick = null;
                } else {
                    labelEl.textContent = ctas[plan] || labelEl.textContent;
                    btn.removeAttribute('disabled');
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    const url = btn.getAttribute('data-plan-url');
                    if (url) {
                        btn.onclick = () => window.open(url, '_blank');
                    }
                }
            });
        }

        function updatePricingDisplay(forcedCurrency) {
            const currency = SUPPORTED_CURRENCIES.includes(forcedCurrency) ? forcedCurrency : getPricingCurrency();
            const select = document.getElementById('pricing-currency');
            if (select && select.value !== currency) select.value = currency;

            document.querySelectorAll('[data-price-plan]').forEach((el) => {
                const plan = el.getAttribute('data-price-plan');
                if (plan === 'custom') {
                    el.innerHTML = t('contact_sales');
                    return;
                }
                if (plan === 'free') {
                    // Show 14-day free trial instead of $0
                    el.innerHTML = `<span class="free-trial-label">${t('free_trial_duration')}</span>`;
                    return;
                }

                // Get price tables for the plan
                let baseTable = null;
                let discountTable = null;
                if (plan === 'starter') {
                    baseTable = STARTER_DISPLAY_PRICES;
                    discountTable = STARTER_DISCOUNT_PRICES;
                }
                if (plan === 'growth') {
                    baseTable = GROWTH_DISPLAY_PRICES;
                    discountTable = GROWTH_DISCOUNT_PRICES;
                }
                if (!baseTable) return;

                const baseEntry = baseTable[currency] || baseTable.USD;
                const discountEntry = discountTable[currency] || discountTable.USD;
                const currencyUsed = baseTable[currency] ? currency : 'USD';

                const originalPrice = formatCurrencyAmount(baseEntry.amount, currencyUsed, baseEntry.digits);
                const discountedPrice = formatCurrencyAmount(discountEntry.amount, currencyUsed, discountEntry.digits);

                // Display with discount styling
                el.innerHTML = `
                    <div class="price-discount-wrapper">
                        <span class="discount-badge">${t('discount_badge')}</span>
                        <span class="price-original">${originalPrice}</span>
                        <span class="price-discounted">${discountedPrice}</span>
                    </div>
                `;
            });

            // Update discount notes
            document.querySelectorAll('[data-price-note]').forEach((el) => {
                const plan = el.getAttribute('data-price-note');
                if (plan === 'free' || plan === 'custom') {
                    el.style.display = 'none';
                    return;
                }

                let baseTable = plan === 'starter' ? STARTER_DISPLAY_PRICES : GROWTH_DISPLAY_PRICES;
                const baseEntry = baseTable[currency] || baseTable.USD;
                const currencyUsed = baseTable[currency] ? currency : 'USD';
                const afterPrice = formatCurrencyAmount(baseEntry.amount, currencyUsed, baseEntry.digits);

                el.innerHTML = `${t('discount_first_year')} · ${tf('discount_then_price', { price: afterPrice })}`;
                el.style.display = 'block';
            });

            // Hide /mo for free plan since we show "14-day free trial"
            document.querySelectorAll('[data-per-month]').forEach((el) => {
                const plan = el.getAttribute('data-per-month');
                el.style.display = (plan === 'custom' || plan === 'free') ? 'none' : '';
            });

            updatePricingCtas();
            updateBillingStatus();
        }

        async function startCheckout(planId) {
            if (!planId) return;
            const currency = getPricingCurrency();
            const baseUrl = window.location.origin + window.location.pathname;
            const success_url = `${baseUrl}?stripe_success=1`;
            const cancel_url = `${baseUrl}?stripe_cancel=1`;

            const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
            if (sessionError || !sessionData?.session) {
                showToast("Please sign in again to proceed with checkout.", true);
                return;
            }

            const sessionToken = sessionData.session.access_token;
            const endpoint = `${SUPABASE_URL}/functions/v1/create-checkout-session`;
            const payload = { plan_id: planId, currency, success_url, cancel_url };

            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    mode: "cors",
                    credentials: "include",
                    headers: {
                        Authorization: `Bearer ${sessionToken}`, // use logged-in user token only
                        apikey: SUPABASE_KEY,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data?.error || "Checkout session failed");
                }

                if (!data?.url) {
                    throw new Error("Checkout session did not return a redirect URL");
                }

                window.location.href = data.url;
            } catch (err) {
                console.error("Checkout Error:", err);
                showToast("Checkout failed: " + err.message, true);
            }
        }

        function updateBillingStatus() {
            const statusEl = document.getElementById('billing-status');
            if (!statusEl) return;
            if (!state.org) {
                statusEl.textContent = '';
                return;
            }
            const status = state.org.subscription_status || 'inactive';
            const periodEnd = state.org.current_period_end;
            const cancelAtPeriodEnd = Boolean(state.org.cancel_at_period_end);
            if (!periodEnd) {
                statusEl.textContent = tf('billing_status', { status }, `Status: ${status}`);
                return;
            }
            const dateStr = new Date(periodEnd).toLocaleDateString();
            const timingLabel = cancelAtPeriodEnd ? t('billing_ends') : t('billing_renews');
            statusEl.textContent = `${tf('billing_status', { status }, `Status: ${status}`)} · ${timingLabel} ${dateStr}`;
        }

        async function refreshOrgState() {
            if (!state.org) return false;
            const previousTier = normalizeTier(state.org.subscription_tier || 'free');
            const { data, error } = await supabaseClient.from('organizations').select('*').eq('id', state.org.id).single();
            if (error || !data) return false;
            state.org = data;
            updatePlanBadge();
            updatePricingDisplay();
            return normalizeTier(state.org.subscription_tier || 'free') !== previousTier;
        }

        async function handleStripeSuccess() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('stripe_success') !== '1') return;
            showToast("Payment successful");
            params.delete('stripe_success');
            const nextQuery = params.toString();
            const nextUrl = nextQuery ? `${window.location.pathname}?${nextQuery}` : window.location.pathname;
            window.history.replaceState({}, '', nextUrl);

            const initialTier = normalizeTier(state.org?.subscription_tier || 'free');
            for (let i = 0; i < 3; i++) {
                const updated = await refreshOrgState();
                const currentTier = normalizeTier(state.org?.subscription_tier || 'free');
                if (updated || currentTier !== initialTier) break;
                if (i < 2) await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }

        function openPricingModal() {
            document.getElementById('pricing-modal').classList.remove('hidden');
            updatePricingDisplay();
        }

        function closePricingModal() {
            const checkbox = document.getElementById('dont-show-pricing');
            if (checkbox && checkbox.checked) {
                localStorage.setItem('digitivia_hide_pricing', 'true');
            }
            document.getElementById('pricing-modal').classList.add('hidden');
        }

        function openHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        function openDocumentationModal() {
            document.getElementById('documentation-modal').classList.remove('hidden');
        }

        function closeDocumentationModal() {
            document.getElementById('documentation-modal').classList.add('hidden');
        }

        let meetingBookingLocked = false;

        function updateMeetingBookingVisibility() {
            const isCeo = ['ceo', 'consultant'].includes(state.profile?.role);
            if (!isCeo) {
                document.querySelectorAll('[data-booking-button]').forEach((btn) => {
                    btn.style.display = 'none';
                });
                document.querySelectorAll('[data-booking-message]').forEach((msg) => msg.classList.add('hidden'));
                return;
            }
            if (meetingBookingLocked) {
                setMeetingLimitReached();
                return;
            }
            document.querySelectorAll('[data-booking-button]').forEach((btn) => {
                btn.style.display = '';
            });
            document.querySelectorAll('[data-booking-message]').forEach((msg) => msg.classList.add('hidden'));
        }

        function setMeetingLimitReached() {
            meetingBookingLocked = true;
            document.querySelectorAll('[data-booking-button]').forEach((btn) => {
                btn.style.display = 'none';
            });
            document.querySelectorAll('[data-booking-message]').forEach((msg) => {
                msg.classList.remove('hidden');
            });
        }

        async function handleMeetingBooking(event) {
            if (event) event.preventDefault();
            if (!state.profile || !['ceo', 'consultant'].includes(state.profile.role)) return false;
            if (meetingBookingLocked) {
                setMeetingLimitReached();
                return false;
            }
            const btn = event?.currentTarget;
            const url = btn?.getAttribute('data-booking-url');
            const source = btn?.getAttribute('data-booking-source') || 'unknown';
            const metadata = {
                source,
                user_id: state.user?.id,
                email: state.profile?.email,
                role: state.profile?.role,
                org_name: state.org?.name,
                timestamp: new Date().toISOString()
            };
            const { error } = await supabaseClient.rpc('book_org_meeting', { p_org_id: state.org.id, p_metadata: metadata });
            if (error) {
                if (error.code === 'MEETING_LIMIT_REACHED' || error.message === 'MEETING_LIMIT_REACHED') {
                    setMeetingLimitReached();
                    return false;
                }
                showToast("Booking failed: " + error.message, true);
                return false;
            }
            if (url) window.open(url, '_blank');
            return false;
        }

        // Function to check and show on load
        function checkPricingPopup() {
            // Only show for CEO/Consultant role, and if not hidden by user preference
            if (state.profile && ['ceo', 'consultant'].includes(state.profile.role)) {
                const shouldHide = localStorage.getItem('digitivia_hide_pricing');
                // Also, don't show if they are already on Growth or Custom
                const currentTier = normalizeTier(state.org.subscription_tier || 'free');

                if (!shouldHide && !['growth', 'custom'].includes(currentTier)) {
                    setTimeout(() => {
                        openPricingModal();
                    }, 1500); // Small delay for nice effect after load
                }
            }
        }
        // --- NEW: MY PROFILE MODAL ---
        function openProfileModal() {
            const p = state.profile;
            document.getElementById('profile-modal-avatar').src = p.avatar_url || 'https://ui-avatars.com/api/?background=random';
            document.getElementById('profile-modal-name').innerText = p.full_name;
            document.getElementById('profile-modal-role').innerText = formatRoleLabel(p.role);

            document.getElementById('profile-modal-email').value = p.email;
            document.getElementById('profile-modal-phone').value = p.meta_data?.phone || 'N/A';

            document.getElementById('profile-modal-org').value = state.org.name;
            document.getElementById('profile-modal-dept').value = p.department || 'N/A';

            document.getElementById('profile-modal').classList.remove('hidden');
        }

        // =========================================================
        // WFM MODULE: INTEGRATED & CLEANED (Place at bottom of Script)
        // =========================================================

        // 1. Handle File Upload (Fire & Forget to avoid Timeout)
        // =========================================================
        // WFM UPLOAD HANDLER (5-MINUTE TIMEOUT VERSION)
        // =========================================================
        // =========================================================
        // WFM: FIRE & FORGET (Bypasses Server Timeouts)
        // =========================================================

        // 1. Upload & Start AI (Doesn't wait for answer)
        // =========================================================
        // WFM: FIRE & FORGET (With User ID Fix)
        // =========================================================

        function parseWfmDetails(details) {
            if (!details) return null;
            if (typeof details === 'string') {
                try {
                    return JSON.parse(details);
                } catch (e) {
                    return null;
                }
            }
            return details;
        }

        function parsePercent(value) {
            if (value === null || value === undefined) return 0;
            const num = parseFloat(String(value).replace('%', '').trim());
            return Number.isFinite(num) ? num : 0;
        }

        function escapeHtml(value) {
            return String(value || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function extractWfmSchedule(result) {
            if (!result) return [];
            if (Array.isArray(result.schedule)) return result.schedule;
            if (result.table && Array.isArray(result.table.rows)) return result.table.rows;
            return [];
        }

        function renderWfmPreviewTable(rows) {
            const table = document.getElementById('wfm-preview-table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            if (!Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align:center; color:var(--text-muted);">
                        No schedule rows found in this file.
                    </td>
                </tr>`;
                return;
            }

            let html = '';
            rows.forEach(row => {
                html += `
                <tr>
                    <td>${escapeHtml(row.employee_name)}</td>
                    <td>${escapeHtml(row.role)}</td>
                    <td>${escapeHtml(row.date)}</td>
                    <td>${escapeHtml(row.shift_start)}</td>
                    <td>${escapeHtml(row.shift_end)}</td>
                    <td>${escapeHtml(row.break_start)}</td>
                    <td>${escapeHtml(row.break_end)}</td>
                    <td>${escapeHtml(row.location)}</td>
                    <td>${escapeHtml(row.notes)}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function setWfmPreviewMessage(message) {
            const table = document.getElementById('wfm-preview-table');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align:center; color:var(--text-muted);">
                    ${escapeHtml(message)}
                </td>
            </tr>`;
        }

        function applyWfmResult(result) {
            if (!result) return false;
            const metrics = result.metrics || {};
            const insight = result.insight || "";
            const slEl = document.getElementById('wfm-metric-sl');
            if (slEl) {
                slEl.innerText = parsePercent(metrics.sl) + "%";
                const adhEl = document.getElementById('wfm-metric-adh');
                if (adhEl) adhEl.innerText = parsePercent(metrics.adherence) + "%";
                const occEl = document.getElementById('wfm-metric-occ');
                if (occEl) occEl.innerText = parsePercent(metrics.occupancy) + "%";
                const shrEl = document.getElementById('wfm-metric-shr');
                if (shrEl) shrEl.innerText = parsePercent(metrics.shrinkage) + "%";
            }
            const box = document.getElementById('wfm-insight-box');
            if (box) box.innerHTML = (insight || "").replace(/\n/g, '<br>');
            renderWfmPreviewTable(extractWfmSchedule(result));
            return Boolean(insight || Object.keys(metrics).length);
        }

        window.handleWFMUpload = async function (input) {
            return requireFeature('wfm', async () => {
                const file = input.files[0];
                if (!file) return;

                // UI Feedback
                const btn = document.querySelector('.page-title .btn-primary');
                const oldHtml = btn ? btn.innerHTML : 'Import';
                if (btn) btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting AI...';
                showToast("Uploading...", false);
                setWfmPreviewMessage("Parsing schedule preview...");

                try {
                    // A. Upload File to Supabase
                    const fileName = `wfm_forecast_${Date.now()}_${file.name}`;
                    const startedAt = Date.now();
                    const { error: uploadError } = await supabaseClient.storage.from('payroll_files').upload(fileName, file);
                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabaseClient.storage.from('payroll_files').getPublicUrl(fileName);

                    // B. Trigger N8N (With User ID included)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s Handshake limit
                    let responseData = null;

                    try {
                        const res = await fetch('https://n8n.srv1174105.hstgr.cloud/webhook/workforce_hr_digitivia', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'wfm_forecast_analysis',
                                file_url: publicUrl,

                                // --- THE MISSING FIELDS ---
                                file_name: fileName,        // So N8N knows the file name
                                user_id: state.user.id,     // So N8N knows the Actor ID
                                // --------------------------

                                org_id: state.org.id,
                                bundle_tier: state.org.subscription_tier || 'free'
                            }),
                            signal: controller.signal
                        });
                        if (res && res.ok) {
                            const rawText = await res.text();
                            if (rawText) {
                                try {
                                    responseData = JSON.parse(rawText);
                                } catch (e) {
                                    responseData = null;
                                }
                            }
                        }
                    } catch (e) {
                        if (e.name !== 'AbortError') console.warn("Webhook trigger warning:", e);
                    }
                    clearTimeout(timeoutId);

                    // C. Start Polling
                    const hasImmediateResult = responseData && (responseData.insight || responseData.metrics);
                    if (hasImmediateResult) {
                        applyWfmResult(responseData);
                        showToast("Analysis Complete!", false);
                    } else {
                        showToast("AI Analysis Running... Please wait.", false);
                    }
                    pollForWFMResults(fileName, 0, startedAt, hasImmediateResult);

                } catch (err) {
                    console.error("Upload Error:", err);
                    showToast("Failed to start: " + err.message, true);
                } finally {
                    if (btn) btn.innerHTML = oldHtml;
                    if (input) input.value = '';
                }
            });
        }

        // 2. Check Database Loop
        async function pollForWFMResults(fileNamePart, attempts = 0, startedAt = null, hasImmediateResult = false) {
            // Stop after 3 minutes (60 attempts * 3s)
            if (attempts > 60) {
                showToast("Analysis taking a while. Check history later.", true);
                return;
            }
            const baseline = startedAt || Date.now();

            const box = document.getElementById('wfm-insight-box');
            if (box && attempts === 0 && !hasImmediateResult) {
                box.innerHTML = '<div style="text-align:center; padding:40px; color:var(--info)"><i class="fa-solid fa-brain fa-bounce" style="font-size:2rem; margin-bottom:10px;"></i><br>AI is analyzing strategy...</div>';
            }

            // Look for a log entry created in the last 2 minutes matching this operation
            const { data: logs } = await supabaseClient
                .from('audit_logs')
                .select('*')
                .eq('org_id', state.org.id)
                .eq('action_type', 'WFM_FORECAST_GENERATED')
                .order('created_at', { ascending: false })
                .limit(1);

            if (logs && logs.length > 0) {
                const log = logs[0];
                const logTime = new Date(log.created_at).getTime();
                const details = parseWfmDetails(log.details);
                const isFileMatch = details && details.file === fileNamePart;
                const isTimeMatch = logTime >= (baseline - 5000);
                if (isFileMatch || isTimeMatch) {
                    if (details) applyWfmResult(details);
                    showToast("Analysis Complete!", false);
                    loadWFMHistory(); // Update UI
                    return;
                }
            }

            // Not found? Wait 3s and look again
            setTimeout(() => pollForWFMResults(fileNamePart, attempts + 1, baseline, hasImmediateResult), 3000);
        }
    </script>
    <div id="docs-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title"><span data-i18n="docs_title">Employee Documents</span> <i
                    class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('docs-modal').classList.add('hidden')"></i></div>
            <h4 id="docs-user-name" style="color:var(--primary); margin-bottom:15px;"></h4>
            <div id="docs-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>

            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                <div style="font-weight:700; margin-bottom:10px;" data-i18n="docs_add_title">Add New Document</div>
                <div class="form-group"><input type="text" id="doc-type" class="form-input"
                        data-i18n-placeholder="docs_type_placeholder" placeholder="Document Name (e.g. Passport)"></div>
                <div class="form-group"><label data-i18n="docs_expiry_label">Expiry Date</label><input type="date"
                        id="doc-expiry" class="form-input"></div>
                <div class="form-group"><input type="text" id="doc-link" class="form-input"
                        data-i18n-placeholder="docs_link_placeholder" placeholder="External Drive Link (Optional)">
                </div>
                <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" id="doc-checklist"> <label for="doc-checklist"
                        data-i18n="docs_checklist_label">Checklist Item Only (No File)</label>
                </div>
                <button class="btn-primary" style="width:100%" onclick="saveEmployeeDoc()"><span
                        data-i18n="docs_save_btn">Save Record</span></button>
            </div>
        </div>
    </div>

    <div id="broadcast-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title"><span data-i18n="broadcast_title">Send Company Announcement</span> <i
                    class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('broadcast-modal').classList.add('hidden')"></i></div>
            <div class="form-group"><label data-i18n="broadcast_subject">Subject</label><input type="text"
                    id="bc-subject" class="form-input"></div>
            <div class="form-group"><label data-i18n="broadcast_message">Message</label><textarea id="bc-msg"
                    class="form-input" rows="4"></textarea></div>
            <div class="form-group"><label data-i18n="broadcast_type">Type</label>
                <select id="bc-severity" class="form-input" style="background:var(--sidebar-bg)">
                    <option value="info" data-i18n="broadcast_info">General Info (Blue)</option>
                    <option value="urgent" data-i18n="broadcast_urgent">Urgent Alert (Red)</option>
                </select>
            </div>
            <button class="btn-primary" style="width:100%" onclick="sendBroadcast()"><span
                    data-i18n="broadcast_post_btn">Post Announcement</span></button>
        </div>
    </div>
    <div id="ai-widget">
        <div id="ai-window" class="hidden">
            <div class="ai-header">
                <span class="ai-title"><i class="fa-solid fa-robot"></i> <span data-i18n="ai_title">Your HR
                        Assistant</span></span>
                <span class="ai-credits" id="ai-credits">0 Credits</span>
            </div>
            <div class="ai-quick-actions">
                <button class="ai-quick-btn" onclick="prefillAiPrompt(t('ai_prompts.add_employee'))"
                    data-i18n="ai_quick_add_employee">Add employee</button>
                <button class="ai-quick-btn" onclick="prefillAiPrompt(t('ai_prompts.add_hr'))"
                    data-i18n="ai_quick_add_hr">Add HR manager</button>
                <button class="ai-quick-btn" onclick="prefillAiPrompt(t('ai_prompts.payroll_help'))"
                    data-i18n="ai_quick_payroll_help">Payroll help</button>
                <button class="ai-quick-btn" onclick="prefillAiPrompt(t('ai_prompts.attendance_help'))"
                    data-i18n="ai_quick_attendance_help">Attendance help</button>
            </div>
            <div id="ai-chat-body" class="ai-chat-body">
                <div class="ai-msg assistant">
                    <div class="ai-bubble" data-i18n="ai_intro">Hello! I can help you navigate, onboard employees, and
                        explain any HR feature.</div>
                </div>
            </div>
            <div class="ai-input-row">
                <input type="text" id="ai-input" class="ai-input" data-i18n-placeholder="ai_placeholder"
                    placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendAiMessage()">
                <button class="btn-primary ai-send-btn" onclick="sendAiMessage()"><i
                        class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <button class="ai-launcher" onclick="toggleAiWidget()" aria-label="Open HR assistant">
            <i class="fa-solid fa-robot"></i>
        </button>
    </div>
    <footer class="app-footer">
        <a href="#" onclick="openDocumentationModal(); return false;" data-i18n="footer_docs">Documentation</a>
        <a href="#" onclick="return false;" data-i18n="footer_privacy">Privacy Policy</a>
        <a href="#" onclick="return false;" data-i18n="footer_legal">Legal Notes</a>
    </footer>
    <div id="setup-modal" class="modal-overlay hidden">
        <div class="modal-card" style="text-align:center;">
            <i class="fa-solid fa-handshake" style="font-size:3rem; color:var(--success); margin-bottom:20px;"></i>
            <div class="modal-title" style="border:none; justify-content:center;" data-i18n="setup_title">Welcome to
                Digitivia!</div>
            <p style="color:var(--text-muted); margin-bottom:25px; line-height:1.6;" data-i18n-html="setup_body">
                We are thrilled to have you. To ensure your HR data is migrated correctly, we offer <b>2 Free Setup
                    Calls</b> (30 mins each).
            </p>
            <div style="display:grid; gap:10px;">
                <a href="#" class="btn-primary" style="justify-content:center; text-decoration:none;"
                    data-booking-button data-booking-url="https://calendly.com" data-booking-source="setup"
                    onclick="return handleMeetingBooking(event)">
                    <i class="fa-solid fa-calendar-check"></i> <span data-i18n="setup_cta">Book Integration Call</span>
                </a>
                <div class="hidden" style="font-size:0.85rem; color:var(--warning);" data-i18n="meeting_limit_reached"
                    data-booking-message>Meeting limit reached for your organization.</div>
                <button class="btn-outline" onclick="document.getElementById('setup-modal').classList.add('hidden')">
                    <span data-i18n="setup_skip">I'll explore on my own</span>
                </button>
            </div>
        </div>
    </div>
    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width:560px; text-align:center;">
            <div class="modal-title">
                <span data-i18n="help_title">Need Help?</span>
                <i class="fa-solid fa-xmark close-modal" onclick="closeHelpModal()"></i>
            </div>
            <p style="color:var(--text-muted); margin-bottom:20px; line-height:1.6;" data-i18n="help_body">
                Book two free 30-minute sessions (1 hour total) and we will help you integrate and set up your HR
                workspace.
            </p>
            <a href="#" class="btn-primary" style="justify-content:center; text-decoration:none;" data-booking-button
                data-booking-url="https://calendar.app.google/aYZBqU3M32EX2fM57" data-booking-source="help"
                onclick="return handleMeetingBooking(event)">
                <i class="fa-solid fa-calendar-check"></i> <span data-i18n="help_cta">Book a Free Meeting</span>
            </a>
            <div class="hidden" style="font-size:0.85rem; color:var(--warning); margin-top:8px;"
                data-i18n="meeting_limit_reached" data-booking-message>Meeting limit reached for your organization.
            </div>
        </div>
    </div>
    <div id="documentation-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 860px;">
            <div class="modal-title">
                <span data-i18n="docs_modal_title">Documentation</span>
                <i class="fa-solid fa-xmark close-modal" onclick="closeDocumentationModal()"></i>
            </div>
            <p style="color:var(--text-muted); line-height:1.6; margin-bottom:20px;" data-i18n="docs_modal_intro">
                Digitivia unifies HR operations, payroll, attendance, recruiting, performance, and workforce management
                in one secure workspace.
            </p>
            <div class="settings-section" style="margin-bottom:20px;">
                <div class="settings-header"><i class="fa-solid fa-layer-group"></i> <span
                        data-i18n="docs_tabs_title">What each tab does</span></div>
                <ul class="feature-list">
                    <li data-i18n="docs_tab_dashboard">Dashboard: live KPIs, activity, and risk highlights.</li>
                    <li data-i18n="docs_tab_org_profile">Org Profile: company identity and compliance settings (CEO
                        only).</li>
                    <li data-i18n="docs_tab_employees">Employees: employee directory, profiles, and document tracking.
                    </li>
                    <li data-i18n="docs_tab_payroll">Payroll Automation: upload files, review AI calculations, and
                        approve batches.</li>
                    <li data-i18n="docs_tab_attendance">Attendance: clock-ins, geo-fence verification, and history.</li>
                    <li data-i18n="docs_tab_ats">ATS Recruitment: email intake, AI candidate scoring, and hiring flow.
                    </li>
                    <li data-i18n="docs_tab_performance">Performance AI: upload reviews and track quality/speed scores.
                    </li>
                    <li data-i18n="docs_tab_reports">Strategic Reports: ROI, burnout, and efficiency analytics.</li>
                    <li data-i18n="docs_tab_wfm">Workforce WFM: schedules, live roster, and coverage forecasting.</li>
                    <li data-i18n="docs_tab_workspace">My Workspace: personal attendance and tools.</li>
                </ul>
            </div>
            <div class="settings-section">
                <div class="settings-header"><i class="fa-solid fa-tags"></i> <span
                        data-i18n="docs_bundles_title">Bundles</span></div>
                <ul class="feature-list">
                    <li data-i18n="docs_bundle_free">Free: basic dashboard, employees, basic HR, AI assistant preview.
                    </li>
                    <li data-i18n="docs_bundle_starter">Starter: everything in Free + full AI assistant.</li>
                    <li data-i18n="docs_bundle_growth">Growth: everything in Starter + ATS, workforce WFM, internal
                        broadcasting.</li>
                    <li data-i18n="docs_bundle_custom">Custom: tailored plan with dedicated support.</li>
                </ul>
            </div>
            <div style="margin-top:20px; text-align:center;">
                <a href="#" class="btn-primary" style="justify-content:center; text-decoration:none;"
                    data-booking-button data-booking-url="https://calendar.app.google/aYZBqU3M32EX2fM57"
                    data-booking-source="docs" onclick="return handleMeetingBooking(event)">
                    <i class="fa-solid fa-calendar-check"></i> <span data-i18n="docs_cta">Need a walkthrough? Book a
                        free meeting.</span>
                </a>
                <div class="hidden" style="font-size:0.85rem; color:var(--warning); margin-top:8px;"
                    data-i18n="meeting_limit_reached" data-booking-message>Meeting limit reached for your organization.
                </div>
            </div>
        </div>
    </div>
    <div id="email-connect-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-title">
                <span data-i18n="email_connect_title">Connect Recruitment Email</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('email-connect-modal').classList.add('hidden')"></i>
            </div>

            <div style="background:rgba(52, 152, 219, 0.1); padding:15px; border-radius:8px; margin-bottom:20px; font-size:0.9rem; color:var(--text-main); border-left: 3px solid var(--primary);"
                data-i18n-html="email_auto_scan">
                <i class="fa-solid fa-robot"></i> <b>AI Auto-Scan:</b> The AI will connect via IMAP and scan this inbox
                every 10 minutes for emails with "Resume" or "CV" in the subject.
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="email_provider">Email Provider</span>
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;"
                        data-i18n-title="email_provider_tip"
                        title="Choose 'Custom' if you use Zoho, GoDaddy, or a private server."></i>
                </label>
                <select id="imap-provider" class="form-input" style="background:var(--sidebar-bg)"
                    onchange="toggleImapFields()" title="Select your email service provider">
                    <option value="gmail" data-i18n="email_provider_gmail">Gmail</option>
                    <option value="outlook" data-i18n="email_provider_outlook">Outlook / Office 365</option>
                    <option value="custom" data-i18n="email_provider_custom">Custom IMAP (Other)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="email_address">Email Address</span>
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;"
                        data-i18n-title="email_address_tip"
                        title="The email address where you receive job applications."></i>
                </label>
                <input type="email" id="imap-email" class="form-input" data-i18n-placeholder="email_address_placeholder"
                    placeholder="careers@company.com" title="Enter the email address to scan">
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="app_password">App Password</span>
                    <i class="fa-solid fa-circle-question" style="color:var(--primary); cursor:help;"
                        data-i18n-title="app_password_tip"
                        title="Do NOT use your login password. Generate a secure 'App Password' in your Google/Microsoft Account Security settings."></i>
                </label>
                <input type="password" id="imap-pass" class="form-input"
                    data-i18n-placeholder="app_password_placeholder" placeholder="abcd xxxx yyyy zzzz"
                    title="Paste your 16-character App Password here">
                <div style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;" data-i18n-html="security_tip">
                    <i class="fa-solid fa-shield-halved"></i> <strong>Security Tip:</strong> Use an
                    <a href="https://myaccount.google.com/apppasswords" target="_blank"
                        style="color:var(--primary); text-decoration:underline;">App Password</a>, not your main
                    password.
                </div>
            </div>

            <div id="custom-imap" class="hidden"
                style="padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:15px;">
                <div class="form-group">
                    <label><span data-i18n="imap_host">IMAP Host</span> <i class="fa-solid fa-circle-question"
                            title="e.g. imap.zoho.com or mail.yourdomain.com"></i></label>
                    <input type="text" id="imap-host" class="form-input" value="imap.gmail.com"
                        data-i18n-placeholder="imap_host_placeholder" placeholder="imap.server.com">
                </div>
                <div class="form-group">
                    <label><span data-i18n="imap_port">IMAP Port</span> <i class="fa-solid fa-circle-question"
                            title="Standard SSL port is 993"></i></label>
                    <input type="number" id="imap-port" class="form-input" value="993">
                </div>
            </div>

            <button class="btn-primary" style="width:100%" onclick="saveEmailIntegration()">
                <i class="fa-solid fa-plug"></i> <span data-i18n="email_connect_btn">Connect & Start AI Scanning</span>
            </button>
        </div>
    </div>
    <div id="candidate-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width:800px; height:80vh; display:flex; flex-direction:column;">
            <div class="modal-title">
                <span data-i18n="candidate_ai_title">AI Candidate Analysis</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('candidate-modal').classList.add('hidden')"></i>
            </div>
            <div style="display:flex; gap:20px; flex-grow:1; overflow:hidden;">
                <div
                    style="width:300px; background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; overflow-y:auto;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <div id="ai-score-circle"
                            style="width:100px; height:100px; border-radius:50%; border:5px solid var(--primary); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; margin:0 auto;">
                            0%
                        </div>
                        <div style="margin-top:10px; font-weight:bold;" data-i18n="match_score">Match Score</div>
                    </div>
                    <h4 style="color:var(--primary); border-bottom:1px solid var(--glass-border); padding-bottom:5px; margin-bottom:10px;"
                        data-i18n="exec_summary">Executive Summary</h4>
                    <p id="ai-summary-text" style="font-size:0.9rem; line-height:1.6; color:var(--text-main);">
                        Loading...</p>

                    <h4 style="color:var(--primary); border-bottom:1px solid var(--glass-border); padding-bottom:5px; margin-bottom:10px; margin-top:20px;"
                        data-i18n="extracted_skills">Extracted Skills</h4>
                    <div id="ai-skills-tags" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                </div>

                <div style="flex-grow:1; display:flex; flex-direction:column;">
                    <h4 style="margin-bottom:10px;" data-i18n="source_context">Source Context (CV / Portfolio)</h4>
                    <div id="ai-source-text"
                        style="flex-grow:1; background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; overflow-y:auto; font-family:monospace; font-size:0.85rem; white-space:pre-wrap;">
                        Loading original text...
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="pricing-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 1000px;">
            <div class="modal-title" style="text-align: center; border: none; font-size: 1.8rem;">
                <span data-i18n="pricing_title">Upgrade Your Operation</span>
                <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 400; margin-top: 5px;"
                    data-i18n="pricing_subtitle">Choose the bundle that fits your scale.</div>
                <i class="fa-solid fa-xmark close-modal" onclick="closePricingModal()"
                    style="position: absolute; right: 30px; top: 30px;"></i>
            </div>

            <div class="pricing-grid">
                <div class="pricing-card">
                    <div class="plan-name" data-i18n="plan_free">Free</div>
                    <div class="plan-price"><span data-price-plan="free">$0</span><span data-per-month="free"
                            data-i18n="per_month">/mo</span></div>
                    <ul class="feature-list">
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_live_dashboard">Live
                                Dashboard</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_employee_db">Employee
                                Database</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_basic_hr">Basic HR Suite</span>
                        </li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_ai_preview">AI Assistant
                                Preview</span></li>
                    </ul>
                    <button class="btn-outline" style="width: 100%;" data-cta-plan="free"><span data-i18n="cta_free"
                            data-cta-label>Get started for free</span></button>
                </div>

                <div class="pricing-card">
                    <div class="plan-name" data-i18n="plan_starter">Starter</div>
                    <div class="plan-price"><span data-price-plan="starter">$10.00</span><span data-per-month="starter"
                            data-i18n="per_month">/mo</span></div>
                    <div class="price-note" data-price-note="starter"
                        style="font-size:0.75rem; color:var(--text-muted); margin-top:6px;"></div>
                    <ul class="feature-list">
                        <li><i class="fa-solid fa-check"></i> <b data-i18n="feature_everything_in_free">Everything in
                                Free</b></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_ai_full">AI Assistant Full
                                Access</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_basic_hr">Basic HR Suite</span>
                        </li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_employee_db">Employee
                                Database</span></li>
                    </ul>
                    <button class="btn-primary" style="width: 100%;" data-cta-plan="starter"
                        onclick="startCheckout('starter')"><span data-i18n="cta_starter" data-cta-label>Start
                            Starter</span></button>
                </div>

                <div class="pricing-card popular">
                    <div class="plan-tag" data-i18n="recommended">Recommended</div>
                    <div class="plan-name" style="color:var(--primary)" data-i18n="plan_growth">Growth (Identity
                        Verified)</div>
                    <div class="plan-price"><span data-price-plan="growth">$18.00</span><span data-per-month="growth"
                            data-i18n="per_month">/mo</span></div>
                    <div class="price-note" data-price-note="growth"
                        style="font-size:0.75rem; color:var(--text-muted); margin-top:6px;"></div>
                    <ul class="feature-list">
                        <li><i class="fa-solid fa-check"></i> <b data-i18n="feature_everything_in_starter">Everything in
                                Starter</b></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_ats">AI Recruitment (ATS)</span>
                        </li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_wfm">Workforce WFM (Maps)</span>
                        </li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_broadcast">Internal
                                Broadcasting</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_adherence">Adherence
                                Charts</span></li>
                    </ul>
                    <button class="btn-primary" style="width: 100%;" data-cta-plan="growth"
                        onclick="startCheckout('growth')"><span data-i18n="cta_growth" data-cta-label>Upgrade to
                            Growth</span></button>
                </div>

                <div class="pricing-card enterprise">
                    <div class="plan-name" style="color:var(--info)" data-i18n="plan_custom">Custom</div>
                    <div class="plan-price"><span data-price-plan="custom">Contact Sales</span><span
                            data-per-month="custom" data-i18n="per_month">/mo</span></div>
                    <ul class="feature-list">
                        <li><i class="fa-solid fa-check"></i> <b data-i18n="feature_everything_in_growth">Everything in
                                Growth</b></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_self_hosted">Self-Hosted VPS
                                Option</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_custom_domain">Custom
                                Domain</span></li>
                        <li><i class="fa-solid fa-check"></i> <span data-i18n="feature_priority_support">Priority
                                Support</span></li>
                    </ul>
                    <button class="btn-outline"
                        style="width: 100%; justify-content: center; border-color: var(--info); color: var(--info);"
                        data-cta-plan="custom" data-plan-url="https://calendar.app.google/aYZBqU3M32EX2fM57"><span
                            data-i18n="cta_custom" data-cta-label>Contact Sales</span></button>
                </div>
            </div>

            <div class="modal-footer">
                <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="dont-show-pricing"> <span data-i18n="dont_show_again">Don't show this
                            automatically again</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <span data-i18n="currency_label">Currency</span>
                        <select id="pricing-currency" class="form-input"
                            style="max-width:160px; background:var(--sidebar-bg);"
                            onchange="setPricingCurrency(this.value)">
                            <option value="USD">USD (Dollar)</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="EGP">EGP</option>
                            <option value="AED">AED</option>
                            <option value="SAR">SAR</option>
                        </select>
                    </label>
                </div>
                <div id="billing-status" style="font-size:0.75rem; color:var(--text-muted);"></div>
                <button class="btn-outline" onclick="closePricingModal()"
                    style="padding: 5px 15px; font-size: 0.8rem;"><span data-i18n="close_btn">Close</span></button>
            </div>
        </div>
    </div>
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 700px;">
            <div class="modal-title">
                <span data-i18n="profile_title">My Profile</span>
                <i class="fa-solid fa-xmark close-modal"
                    onclick="document.getElementById('profile-modal').classList.add('hidden')"></i>
            </div>
            <div
                style="display: flex; flex-direction: column; align-items: center; padding: 20px; border-bottom: 1px solid var(--glass-border);">
                <img src="" alt="User Avatar" id="profile-modal-avatar"
                    style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px;">
                <div id="profile-modal-name" style="font-size: 1.5rem; font-weight: 700; color: white;"></div>
                <div id="profile-modal-role" style="color: var(--primary); font-weight: 500;"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                <div class="settings-section">
                    <div class="settings-header"><i class="fa-solid fa-user-tag"></i> <span
                            data-i18n="profile_basic_info">Basic Info</span></div>
                    <div class="form-group"><label data-i18n="profile_email">Email</label><input type="text"
                            id="profile-modal-email" class="form-input" disabled></div>
                    <div class="form-group"><label data-i18n="profile_phone">Phone</label><input type="text"
                            id="profile-modal-phone" class="form-input" disabled></div>
                </div>
                <div class="settings-section">
                    <div class="settings-header"><i class="fa-solid fa-building-user"></i> <span
                            data-i18n="profile_company_role">Company & Role</span></div>
                    <div class="form-group"><label data-i18n="profile_org">Organization</label><input type="text"
                            id="profile-modal-org" class="form-input" disabled></div>
                    <div class="form-group"><label data-i18n="profile_dept">Department</label><input type="text"
                            id="profile-modal-dept" class="form-input" disabled></div>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--glass-border);">
                <button class="btn-outline"
                    style="width: 100%; border-color: var(--danger); color: var(--danger); justify-content: center;"
                    onclick="handleLogout()">
                    <i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="sign_out">Sign Out</span>
                </button>
            </div>
        </div>
    </div>
</body>

</html>